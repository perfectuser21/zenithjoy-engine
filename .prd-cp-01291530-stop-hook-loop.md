---
id: prd-stop-hook-loop
version: 1.0.0
created: 2026-01-29
---

# Stop Hook 作为循环控制器（替代 Ralph Loop）

## 目标

用自定义 Stop Hook 替代 Ralph Loop 插件，实现：
1. Stop Hook 作为循环引擎
2. 所有检查（worktree、分支保护）属于 /dev 流程
3. Worktree 自动检测
4. 不同入口（/dev、/creators）有不同逻辑

## 核心架构

```
/dev 启动 → 创建 .dev-mode
    ↓
执行流程...
    ↓
会话尝试结束 → Stop Hook 触发
    ↓
检测 .dev-mode → 检查完成条件
    ↓
├─ PR 未合并 → exit 2 → Claude 继续
└─ PR 已合并 → 删除 .dev-mode → exit 0
```

## 功能描述

### 1. 重写 Stop Hook（~80行）

逻辑：
1. 检查 .dev-mode 是否存在
2. 不存在 → exit 0（普通会话）
3. 存在 → 检查完成条件：
   - PR 创建？
   - CI 通过？
   - PR 合并？
4. 全部满足 → 删除 .dev-mode → exit 0
5. 未满足 → 输出提示 → exit 2

### 2. .dev-mode 状态文件管理

格式:
```
dev
branch: cp-xxx
prd: .prd-xxx.md
started: 2026-01-29T10:00:00Z
```

生命周期:
- Step 1 (PRD) 创建
- Step 11 (Cleanup) 删除
- 或完成条件满足时由 Stop Hook 删除

### 3. Worktree 自动检测

在 Step 2 (Detect) 添加：如果 .dev-mode 存在且是主仓库，建议使用 worktree

### 4. 无头模式兼容

Stop Hook 检测到 `CECELIA_HEADLESS=true` 时直接 exit 0，让外部 while 循环控制

## 涉及文件

- hooks/stop.sh（重写）
- skills/dev/SKILL.md（更新）
- skills/dev/steps/01-prd.md（添加 .dev-mode 创建）
- skills/dev/steps/02-detect.md（添加 worktree 检测）
- skills/dev/steps/11-cleanup.md（添加 .dev-mode 删除）
- ~/.claude/settings.json（添加 Stop hook 配置）

## 删除/清理

- Ralph Loop 相关文档 → 更新 SKILL.md
- p0/p1/p2 阶段检测 → 从 Stop Hook 移除

## 成功标准

- [ ] Stop Hook 能检测 .dev-mode 文件
- [ ] PR 未合并时 exit 2 阻止会话结束
- [ ] PR 合并后 exit 0 并清理 .dev-mode
- [ ] 无头模式 (CECELIA_HEADLESS) 直接 exit 0
- [ ] Worktree 检测提示正常工作
- [ ] SKILL.md 不再依赖 Ralph Loop
