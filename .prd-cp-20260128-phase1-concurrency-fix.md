---
id: phase1-concurrency-fix
version: 1.0.0
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.0: 初始版本
---

# Phase 1: 并发安全修复

## 背景

深度分析发现 zenithjoy-engine 存在 13 个 CRITICAL 级别问题，其中 5 个与并发安全相关。这些问题会导致：
- 多终端同时运行时状态文件损坏
- 锁泄露导致任务无法启动
- 跨分支状态污染

## 目标

修复所有 P0 级别的并发安全问题，确保多终端、多分支场景下的数据一致性。

## 验收标准

### T-001: track.sh 原子写入 | code | none

**问题**: `track.sh:36` 使用 `echo > file` 非原子写入，并发时会损坏

**修复**:
```bash
save_run_id() {
  local tmp_file
  tmp_file=$(mktemp) || return 1
  echo "$1" > "$tmp_file" || { rm -f "$tmp_file"; return 1; }
  mv "$tmp_file" "$TRACK_FILE" 2>/dev/null || { rm -f "$tmp_file"; return 1; }
}
```

**验收**:
- [ ] save_run_id 函数使用 mktemp + mv 模式
- [ ] 错误时清理临时文件

### T-002: 状态文件分支隔离 | code | T-001

**问题**: `.cecelia-run-id` 在项目根目录，多分支共用会冲突

**修复**:
- 状态文件改为 `.cecelia-run-id-${BRANCH_NAME}`
- 兼容旧格式（读取时先查新格式，再查旧格式）

**验收**:
- [ ] TRACK_FILE 包含分支名
- [ ] 向后兼容旧格式文件

### T-003: cecelia-api update-task 命令修复 | code | T-001

**问题**: `track.sh:155` 调用不存在的 `update-task` 命令

**修复**:
- 移除 update-task 调用
- 或改用存在的 `update-checkpoint` 命令

**验收**:
- [ ] 不再调用不存在的 API 命令
- [ ] PR 完成时状态正确更新

### T-004: pr-gate-v2.sh trap 覆盖修复 | code | none

**问题**: 多个 `trap ... EXIT` 互相覆盖，临时文件未清理

**修复**:
```bash
TEMP_FILES=()
cleanup_temp() {
  for f in "${TEMP_FILES[@]}"; do
    rm -f "$f" 2>/dev/null || true
  done
}
trap cleanup_temp EXIT

# 使用时
PREFLIGHT_OUTPUT=$(mktemp)
TEMP_FILES+=("$PREFLIGHT_OUTPUT")
```

**验收**:
- [ ] 使用数组管理临时文件
- [ ] 单一 trap 清理所有临时文件

### T-005: quality-gate 文件分支隔离 | code | T-002

**问题**: `.quality-gate-passed` 无分支隔离，多分支会误判

**修复**:
- 改为 `.quality-gate-passed-${BRANCH_NAME}`
- pr-gate-v2.sh 中更新文件名逻辑

**验收**:
- [ ] 质检文件包含分支名
- [ ] 不同分支的质检结果互不影响

## 技术方案

### 影响范围

| 文件 | 修改内容 |
|------|---------|
| skills/dev/scripts/track.sh | T-001, T-002, T-003 |
| hooks/pr-gate-v2.sh | T-004, T-005 |
| skills/dev/scripts/cleanup.sh | 同步更新文件名模式 |

### 风险评估

- **低风险**: 所有修改向后兼容
- **测试覆盖**: 现有 CI 测试 + 手动验证多分支场景

## 非目标

以下问题留到后续 Phase 处理：
- 跨仓库兼容性（Phase 2）
- Worktree 支持（Phase 2）
- 状态机 Promise 统一（Phase 3）
- 文档矛盾清理（Phase 4）
