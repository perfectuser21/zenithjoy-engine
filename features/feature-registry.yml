---
# ============================================================================
# Feature Registry - ZenithJoy Engine
# ============================================================================
# 版本: 2.0.0 (Contract Rebase - 对齐两阶段工作流)
# 更新: 2026-01-24
#
# 核心原则:
# - Feature Registry 回答"系统有什么能力"（What）
# - Regression Contract 回答"哪些能力必须永远不坏"（How）
# - 本文件是"单一事实源"，其他文档只能引用或由脚本生成
#
# 分层:
# - platform_features: 平台基础设施（Hook机制、质检流程、阶段检测）
# - product_features:  引擎核心能力（工作流、测试、报告、自动化）
# ============================================================================

version: "2.46.0"
updated: "2026-02-01"
changelog:
  - 2.46.0: v11.20.0 - AI 自我检测硬规则（skills/dev + CLAUDE.md 添加禁止话术和关键词自检机制）
  - 2.45.0: v11.19.0 - G3 修复 dev 工作流 gate skill 调用方式（Task → Skill 调用，删除冗长内联 prompt）
  - 2.44.0: v11.16.0 - W6 Worktree 自动检测与创建（Step 0 前置 + 僵尸清理 + flock 锁 + Step 3 兜底）
  - 2.43.0: v11.14.2 - P0-3 Stop Hook 会话隔离（检查 .dev-mode 中的 branch 是否与当前分支匹配，防止多会话"串线"）
  - 2.42.0: v11.14.1 - 统一 Subagent Gate 命名和规则挂载（gate:prd/dod/qa/audit/test/learning 规则嵌入 prompt）
  - 2.41.0: v11.14.0 - P3 cleanup.sh v1.8 PRD/DoD 归档到 .history/ 目录
  - 2.40.0: v11.13.1 - H1 支持 monorepo 子目录 PRD/DoD 文件检测
  - 2.39.0: v11.12.4 - 本地版本检查（警告模式）+ P2/P3 一致性分析
  - 2.38.0: v11.11.0 - 并发安全修复（P0-2 Stop Hook flock锁 + P0-3 超时保护 + P0-4 CI白名单 + P1-6 正则修复）
  - 2.37.0: v11.10.0 - Gate v3 安全机制（TTL 过期 + tree_sha/repo_id 绑定 + 验证器软警告 + Stop Hook 自动清理）
  - 2.36.0: v11.9.0 - /dev 工作流 v3（Gate/Quality/CI 三层分离 + Audit 前置 + Subagent 并行）
  - 2.35.0: v11.8.0 - Gate v2 方案 A 改造（防误用字段 + exit code 分层 + 硬失败）
  - 2.33.0: v11.7.0 - Gate 强制执行机制（签名防伪 + pr-gate-v2 检查）
  - 2.32.0: v11.6.0 - Gate Skill 家族（独立质量审核：prd, dod, test, audit）
  - 2.31.0: v11.5.0 - 放宽 skills 保护（只保护 Engine skills：dev, qa, audit, semver）
  - 2.30.0: v11.4.1 - 修复 Stop Hook 跳过 Cleanup bug（cleanup_done 检测 + PR 合并时 exit 2）
  - 2.29.0: v11.4.0 - Task Checkpoint 强制执行（branch-protect v18 检查 tasks_created 字段）
  - 2.28.0: v11.3.2 - 移除 Ralph Loop（统一用 Stop Hook，.dev-mode 移到 Step 3 创建）
  - 2.27.0: v11.3.1 - Worktree 强制检查（Step 3 阻止主仓库有活跃任务时创建分支，P5 重新激活）
  - 2.26.0: v11.3.0 - Stop Hook 循环控制器（H7 重新激活）
  - 2.25.0: v11.2.12 - Credential Guard Hook（凭据保护，防止代码泄露）
  - 2.24.0: v11.2.10 - rm -rf 安全验证（safe_rm_rf 函数，路径验证防误删）
  - 2.23.0: v11.2.9 - 关键清理（删除 contracts/、H7/W5 废弃、移除未实现脚本引用）
  - 2.22.0: v11.2.8 - 文档矛盾清理（归档过时文档、修正 Step 编号、删除不存在引用）
  - 2.21.0: v11.2.7 - Promise 信号统一（DONE 替代 QUALITY_GATE_PASSED/CI_PASSED）
  - 2.20.0: v11.2.6 - 跨仓库兼容性 + Worktree 支持（-e .git、develop/main fallback）
  - 2.19.0: v11.2.5 - 并发安全修复 Phase 1（原子写入、分支级别状态文件、trap 修复）
  - 2.18.0: v11.2.0 - 分支级别 PRD/DoD 文件命名（H1/H2 向后兼容扩展）
  - 2.17.0: v11.0.0 - QA/Audit 三层架构重构（Q1 RISK SCORE + Q2 Structured Audit）
  - 2.16.0: v10.13.1 - /dev 文档修复（循环机制说明） + pr-gate 降级为提示型（exit 0）
  - 2.15.0: v10.13.0 - /dev Skill v2.2.0（删除阶段检测，统一完成条件，强制 Task Checkpoint）
  - 2.14.0: v10.12.0 - Ralph Loop Wrapper 修复（用户直接调用，dev-with-loop 命令，v2.1.0）
  - 2.13.0: v10.10.0 - Ralph Loop 自动化（Step 7/9 自动启动，解决 SHA 死循环，自动更新版本号）
  - 2.12.0: v10.9.5 - 修正 Ralph Loop 文档（删除 Stop Hook 配合描述，明确独立循环机制）
  - 2.11.0: v10.8.7 - 自动化质检与自我进化机制（3个自动化脚本 + detect-priority优化 + CI已知失败支持 + RCI覆盖）
  - 2.10.0: v10.8.6 - 修复 p1 阶段 AI 停顿（恢复 while 循环 + Stop Hook 强制 + Session-start 提示）
  - 2.9.0: v10.8.5 - 彻底修复 AI 停顿点（Skill Node 强制继续 + Stop Hook 语义 + Pending 退出）
  - 2.8.0: v10.8.4 - 修复 /dev 自动执行 + PR Gate 质检缓存（W1 + H2）
  - 2.7.0: W1 v10.8.0 - 修复阶段检测（detect-phase.sh 脚本新增）
  - 2.6.0: Q4 v10.6.0 - CI 分层完善（L2B + L3-fast + Preflight + AI Review）
  - 2.5.0: W1 v10.5.1 - Ralph Loop 文档 + 运行时文件清理 + 测试修复
  - 2.4.0: H2 v10.4.4 - 真正移除 FAST_MODE（修复 PR #273 假修复）
  - 2.3.0: 术语更新 Checkpoint → Task（避免与官方 Checkpoint 混淆）
  - 2.2.0: /dev Skills 清理 + 多 Feature 支持文档
  - 2.1.0: 新增 P0 质检强制三件套 (Q1/Q2/Q3)

# ============================================================================
# Platform Core 5 - 平台基础设施（按"断了就全死"排序）
# ============================================================================
platform_features:
  # --------------------------------------------------------------------------
  # H1: Branch Protection - 分支保护
  # --------------------------------------------------------------------------
  - id: H1
    name: Branch Protection
    status: Committed
    priority: P0
    version: "11.13.1"
    updated: "2026-01-31"
    description: |
      防止在 main/develop 分支直接写代码，强制使用 cp-*/feature/* 工作分支
      v11.13.1: 支持 monorepo 子目录 PRD/DoD 文件检测（如 apps/core/.prd.md）
      v11.11.0: P1-6 修复 - 使用 grep -Eq 替代 bash regex 进行 skills 路径匹配（修复分组失败问题）
      v11.5.0: 放宽 skills 保护（只保护 Engine skills：dev, qa, audit, semver，其他 skills 可从任何 repo 部署）
      v11.4.0: 添加 Task Checkpoint 检查（.dev-mode 必须包含 tasks_created: true）
      v11.2.6: 移除硬编码路径 + develop/main 自动检测 fallback
      v11.2.0: 支持分支级别 PRD/DoD 文件（.prd-{branch}.md，向后兼容 .prd.md）

    entrypoints:
      - type: hook
        event: PreToolUse:Write, PreToolUse:Edit
        file: hooks/branch-protect.sh

    golden_path: |
      检测当前分支 → main/develop → exit 2 (阻止) | cp-*/feature/* → exit 0 (放行)

    minimal_paths:
      - "在 main 分支尝试写代码 → 被阻止"
      - "在 cp-* 分支写代码 → 放行"

    tests:
      - type: auto
        file: tests/hooks/branch-protect.test.ts
        coverage: H1-001, H1-002, H1-003, H1-010, H1-011

    rcis:
      - H1-001  # 拦截 main/develop 写入
      - H1-002  # cp-* 分支允许写入
      - H1-003  # feature/* 分支允许写入
      - H1-010  # JSON 注入防护
      - H1-011  # 路径遍历防护

  # --------------------------------------------------------------------------
  # H7: Stop Hook Loop Controller - 循环控制器
  # --------------------------------------------------------------------------
  - id: H7
    name: Stop Hook Loop Controller
    status: Committed
    priority: P0
    version: "11.18.0"
    updated: "2026-01-31"
    description: |
      Stop Hook 作为 /dev 工作流的循环控制器，替代 Ralph Loop 插件：
      - 检测 .dev-mode 文件决定是否为 /dev 会话
      - 检查完成条件：PR 创建 + CI 通过 + PR 合并
      - 未完成时 exit 2 阻止会话结束，Claude 继续执行
      - 完成时（cleanup_done: true）删除 .dev-mode 并 exit 0
      - 无头模式 (CECELIA_HEADLESS=true) 直接 exit 0，由外部循环控制
      v11.18.0: H7-008 - TTY 会话隔离，有头模式下按 terminal (/dev/pts/N) 隔离
      v11.15.0: P0-4 修复 - session_id 验证 + 共享锁工具库(lib/lock-utils.sh) + 统一 CI 查询(lib/ci-status.sh)
      v11.14.2: P0-3 修复 - 会话隔离，检查 .dev-mode 中的 branch 是否与当前分支匹配，防止多会话"串线"
      v11.11.0: P0-2 修复 - 添加 flock 并发锁防止多个会话同时操作 .dev-mode 文件
      v11.10.0: PR 合并后自动执行 cleanup（删除 .dev-mode、切换分支、删除本地分支），不再悬空
      v11.4.1: 修复跳过 Cleanup bug（cleanup_done 检测 + PR 合并时 exit 2）
      v11.3.0: 首次实现，替代 Ralph Loop 插件

    entrypoints:
      - type: hook
        event: Stop
        file: hooks/stop.sh

    golden_path: |
      会话结束 → 检测 .dev-mode → 检查完成条件 → exit 2 (继续) | exit 0 (结束)

    minimal_paths:
      - "无 .dev-mode → exit 0 (普通会话)"
      - "有 .dev-mode + PR 未创建 → exit 2 (继续)"
      - "有 .dev-mode + PR 已合并 → 删除 .dev-mode + exit 0 (完成)"

    tests:
      - type: manual
        evidence: manual:stop-hook-loop-controller

    rcis:
      - H7-001  # .dev-mode 检测
      - H7-002  # 完成条件检查
      - H7-003  # exit 2 阻止会话结束
      - H7-006  # session_id 验证
      - H7-007  # 共享锁工具库原子操作
      - H7-008  # TTY 会话隔离

  # --------------------------------------------------------------------------
  # H2: PR Gate (Dual Mode) - 提交门禁
  # --------------------------------------------------------------------------
  - id: H2
    name: PR Gate (Dual Mode)
    status: Committed
    priority: P0
    version: "11.11.0"
    updated: "2026-01-30"
    description: |
      PR 创建前的质检门禁，支持双模式：
      - PR 模式: L1 (测试) + L2A (审计) + L2B-min (证据)
      - Release 模式: L1 + L2A + L2B-full (证据) + L3 (验收)
      - v11.11.0: P0-3 修复 - verify-gate-signature.sh 调用添加 10 秒超时保护（防止卡死）
      - v11.10.0: P0-1 修复 - 验证器缺失时改为软警告（不再阻止），支持 v3 exit code (7/8/9)
      - v11.8.0: Gate 验证器硬失败（脚本缺失时 exit 2）+ 分层 exit code 错误提示
      - v11.2.6: .git 检测使用 -e 替代 -d（兼容 worktree）+ develop/main fallback
      - v11.2.5: 并发安全修复（TEMP_FILES 数组管理、分支级别质检文件）
      - v11.2.0: 支持分支级别 PRD/DoD 文件（.prd-{branch}.md，向后兼容 .prd.md）
      - v10.13.1: 降级为提示型 Gate（检查失败 exit 0，不阻断），CI 是唯一门槛
      - v10.8.4: 信任新鲜质检结果（5分钟内），避免重复测试导致不稳定
      - v10.6.0: 新增 Part 0.5 (CI Preflight) 和 L2B-min 检查
      - v10.4.4: 真正移除 FAST_MODE，100% 强制本地 L1+L2A 检查

    entrypoints:
      - type: hook
        event: PreToolUse:Bash (gh pr create)
        file: hooks/pr-gate-v2.sh

    golden_path: |
      检测命令 (gh pr create) → 判断模式 (PR/Release) → 检查产物 → 通过/阻止

    minimal_paths:
      - "PR 模式: 检查 PRD + DoD + QA-DECISION + AUDIT-REPORT (PASS) + L1"
      - "Release 模式: 额外检查 .layer2-evidence.md + DoD 全勾"

    tests:
      - type: auto
        file: tests/hooks/pr-gate.test.ts
        coverage: H2-001, H2-002, H2-003, H2-004

    rcis:
      - H2-001  # 拦截 gh pr create
      - H2-002  # L1 失败阻止
      - H2-003  # 双模式检测
      - H2-004  # 产物检查

  # --------------------------------------------------------------------------
  # W1: Two-Phase Dev Workflow - 两阶段工作流（v2.0.0）
  # --------------------------------------------------------------------------
  - id: W1
    name: Unified Dev Workflow
    status: Committed
    priority: P0
    version: "11.19.0"
    updated: "2026-02-01"
    description: |
      v2.2.0 统一开发工作流（删除阶段检测 + 强制 Task Checkpoint）：
      - 统一完成条件：PR 创建 + CI 通过 + PR 合并 = DONE
      - Task Checkpoint：TaskCreate/TaskUpdate 追踪进度
      - 从头到尾一直执行，不在 PR 创建后停止
      - Ralph Loop: 用户直接在 Claude Code 会话内输入 /ralph-loop 命令
      - v11.19.0: G3 修复 gate skill 调用方式（6 个 gates 从 Task(general-purpose) 改为 Skill() 调用，删除冗长内联 prompt）
      - v11.2.7: Promise 信号统一（DONE 替代 QUALITY_GATE_PASSED/CI_PASSED）
      - v10.14.0: 清理 Ralph Loop 架构（删除 dev-with-loop、detect-phase.sh、RALPH_LOOP_WRAPPER.md）
      - v10.13.1: 修复 Skill 调用返回后行为的矛盾描述（澄清 Ralph Loop 作用，删除"立即返回"误导）
      - v10.13.0: /dev Skill v2.2.0（删除阶段检测，统一完成条件，强制 Task Checkpoint）
      - v10.12.0: Ralph Loop Wrapper 修复（用户直接调用，dev-with-loop 命令，skills/dev v2.1.0）
      - v10.10.0: Ralph Loop 自动化（Step 7/9 自动启动，max-iterations=20，解决 SHA 死循环）
      - v10.9.5: 修正 Ralph Loop 文档，删除 Stop Hook 配合描述，明确循环机制
      - v10.8.4: 添加强制连续执行规则，禁止 AI 在步骤间停顿

    entrypoints:
      - type: cli
        command: /dev
        file: skills/dev/SKILL.md

    golden_path: |
      /dev → PRD → Branch → DoD (QA Node) → Code → Quality (Audit Node) →
      PR (p0 结束) → CI fail (p1 唤醒) → Fix → Push → CI pass (p2 自动 merge)

    minimal_paths:
      - "p0: PRD → DoD → Code → Audit (PASS) → Test (L1) → PR → 结束"
      - "p1: CI fail → 修复 → push → 退出（不等 CI）"
      - "p2: CI pass → 自动 merge → Learning → Cleanup"

    optimal_path: |
      完整的 Golden Path（11 步）：
      1. PRD 确定
      2. 环境检测
      3. 分支创建 (cp-MMDDTTTT-xxx)
      4. DoD 定稿 (含 QA Decision Node)
      5. 写代码
      6. 写测试
      7. 质检循环 (Audit + L1, Stop Hook 强制)
      8. 提交 PR (p0 结束)
      9. CI 修复 (p1 事件驱动)
      10. Learning
      11. Cleanup

    tests:
      - type: manual
        description: Golden Path 手动验证
        coverage: W1-001, W1-002, W1-003, W1-004, W1-005

    rcis:
      - W1-001  # /dev 入口可调用
      - W1-002  # PRD/DoD 生成
      - W1-003  # 阶段检测正确
      - W1-004  # p0 阶段完整流程（Step 8 不调用 Step 9）
      - W1-005  # p1 阶段事件驱动修复
      - W1-006  # p2 阶段自动 merge
      - W1-008  # p1 阶段轮询循环

  # --------------------------------------------------------------------------
  # Q1: Impact Check - 能力变更强制登记（P0-1）
  # --------------------------------------------------------------------------
  - id: Q1
    name: Impact Check
    status: Committed
    priority: P0
    description: |
      防止能力变更不登记：改了核心能力文件必须同时更新 feature-registry.yml
      - 前向一致：改能力→必须登记 | 改登记→允许（不要求改能力）
      - CI 远端强制执行

    entrypoints:
      - type: ci
        job: impact-check
        file: scripts/devgate/impact-check.sh

    golden_path: |
      PR 改动核心文件 → impact-check.sh 检测 → 验证 registry 同时更新 → 通过/失败

    minimal_paths:
      - "改 hooks/ 不改 registry → CI FAIL"
      - "改 hooks/ 同时改 registry → CI PASS"
      - "只改 registry → CI PASS（允许文档更新）"

    tests:
      - type: manual
        description: 手动验证 impact-check 逻辑
        coverage: manual:p0-1-trigger, manual:p0-1-pass, manual:p0-1-fail, manual:p0-1-doc-only

    rcis:
      - Q1-001  # 检测核心文件改动
      - Q1-002  # 验证 registry 更新
      - Q1-003  # 前向一致性验证

  # --------------------------------------------------------------------------
  # Q2: Evidence Gate - 质检证据门控（P0-2）
  # --------------------------------------------------------------------------
  - id: Q2
    name: Evidence Gate
    status: Committed
    priority: P0
    description: |
      防止口头通过无证据：质检通过要有机器可验的 JSON 证据
      - 生成: qa-with-gate.sh 自动生成 .quality-evidence.json
      - 验证: CI 检查 SHA 匹配、字段齐全、Decision PASS
      - SHA 验证是关键（防老文件冒用）

    entrypoints:
      - type: script
        file: scripts/qa-with-gate.sh
        output: .quality-evidence.json
      - type: ci
        job: evidence-gate

    golden_path: |
      npm run qa:gate → 生成 .quality-evidence.json → CI 验证 SHA/字段 → 通过/失败

    minimal_paths:
      - "无证据文件 → CI FAIL"
      - "SHA 不匹配 HEAD → CI FAIL"
      - "证据完整 → CI PASS"

    tests:
      - type: manual
        description: 手动验证 evidence-gate 逻辑
        coverage: manual:p0-2-generate, manual:p0-2-sha, manual:p0-2-missing

    rcis:
      - Q2-001  # 证据文件生成
      - Q2-002  # SHA 验证
      - Q2-003  # 字段验证

  # --------------------------------------------------------------------------
  # Q3: Anti-Bypass Contract - 远端强制兜底（P0-3）
  # --------------------------------------------------------------------------
  - id: Q3
    name: Anti-Bypass Contract
    status: Committed
    priority: P0
    description: |
      承认本地可绕过，用远端 CI + Branch Protection 强制
      - 本地 Hooks = 加速失败
      - 远端 CI + Branch Protection = 最终强制
      - 文档清晰说明职责边界

    entrypoints:
      - type: doc
        file: docs/contracts/QUALITY-CONTRACT.md

    golden_path: |
      开发者理解质量契约 → 本地 Hook 提前反馈 → 远端 CI 最终强制 → Branch Protection 物理阻止

    minimal_paths:
      - "文档说明本地 vs 远端职责"
      - "文档说明为何不用脚本验证 Branch Protection"

    tests:
      - type: manual
        description: 文档审查
        coverage: manual:p0-3-doc

    rcis:
      - Q3-001  # 文档完整性
      - Q3-002  # 职责映射表清晰

  # --------------------------------------------------------------------------
  # Q4: CI Layering (L2B + L3-fast + Preflight + AI Review) - CI 分层完善
  # --------------------------------------------------------------------------
  - id: Q4
    name: CI Layering (L2B + L3-fast + Preflight + AI Review)
    status: Committed
    priority: P1
    version: "10.6.0"
    updated: "2026-01-25"
    description: |
      完善 CI 质检分层体系，填补三个关键缺口：
      - L2B 可复核证据：PR to develop 也需要 .layer2-evidence.md（L2B-min）
      - L3-fast 快速检查：lint/format 检查（占位符，未来扩展）
      - CI Preflight：本地快速预检（L1-fast + L3-fast + L2A-min，120s 内）
      - AI Review (L2C)：语义和影响面审查（VPS API 集成）

    entrypoints:
      - type: script
        file: scripts/devgate/l2b-check.sh
      - type: script
        file: scripts/devgate/l3-fast.sh
      - type: script
        file: scripts/devgate/ci-preflight.sh
      - type: hook
        event: PreToolUse:Bash (pr-gate-v2.sh Part 0.5)
        file: hooks/pr-gate-v2.sh
      - type: ci
        job: l2b-check
        file: .github/workflows/ci.yml
      - type: ci
        job: ai-review
        file: .github/workflows/ci.yml

    golden_path: |
      本地 → ci:preflight (快速预检) → L2B 证据创建 → PR Gate (L2B-min) →
      CI → l2b-check job → ai-review job → 通过/失败

    minimal_paths:
      - "L2B-min: .layer2-evidence.md 存在 + 格式有效 + 至少 1 条可复核证据"
      - "L3-fast: npm run lint/format:check（--if-present 占位符）"
      - "Preflight: typecheck + test + L3-fast + L2A-min（120s 内）"
      - "AI Review: 调用 VPS Review API，L2C 专用提示词"

    tests:
      - type: manual
        description: L2B/L3/Preflight 集成验证
        coverage: manual:q4-l2b, manual:q4-l3, manual:q4-preflight, manual:q4-ai-review

    rcis:
      - Q4-001  # L2B-min 检查脚本
      - Q4-002  # L2B-min CI job
      - Q4-003  # L3-fast 脚本
      - Q4-004  # CI Preflight 脚本
      - Q4-005  # PR Gate Part 0.5 集成
      - Q4-006  # AI Review CI job

  # --------------------------------------------------------------------------
  # Q5: RISK SCORE Trigger - QA Decision 自动触发机制
  # --------------------------------------------------------------------------
  - id: Q5
    name: RISK SCORE Trigger
    status: Committed
    priority: P1
    version: "11.0.0"
    updated: "2026-01-27"
    description: |
      基于 R1-R8 规则的 RISK SCORE 自动触发机制：
      - 每个规则 1 分，≥3 分自动触发 QA Decision Node
      - 三层架构：Skills (SKILL.md) + Scripts (*.cjs) + Templates (*.md)
      - 集成到 /dev 工作流 Step 3

    entrypoints:
      - type: script
        file: scripts/qa/risk-score.cjs
      - type: script
        file: scripts/qa/detect-scope.cjs
      - type: script
        file: scripts/qa/detect-forbidden.cjs
      - type: skill
        file: skills/qa/SKILL.md

    golden_path: |
      /dev Step 3 → risk-score.cjs (计算分数) → ≥3 分 → 执行完整 QA Decision Node →
      生成 docs/QA-DECISION.md

    minimal_paths:
      - "risk-score.cjs: 计算 R1-R8 规则，输出 JSON"
      - "detect-scope.cjs: 自动建议允许的 Scope"
      - "detect-forbidden.cjs: 列出常见禁区"

    tests:
      - type: manual
        description: 手动验证脚本执行正确
        coverage: Q1-001, Q1-002

    rcis:
      - Q5-001  # RISK SCORE 计算准确性
      - Q5-002  # ≥3 分触发 QA Node

  # --------------------------------------------------------------------------
  # Q6: Structured Audit - 结构化 Audit 验证流程
  # --------------------------------------------------------------------------
  - id: Q6
    name: Structured Audit
    status: Committed
    priority: P1
    version: "11.0.0"
    updated: "2026-01-27"
    description: |
      结构化 Audit 验证流程，四步自动化检查：
      - Scope 验证：对比实际改动与 QA-DECISION.md
      - Forbidden 检查：确保未触碰禁区
      - Proof 验证：检查测试证据完成度
      - Report 生成：自动生成 AUDIT-REPORT.md

    entrypoints:
      - type: script
        file: scripts/audit/compare-scope.cjs
      - type: script
        file: scripts/audit/check-forbidden.cjs
      - type: script
        file: scripts/audit/check-proof.cjs
      - type: script
        file: scripts/audit/generate-report.cjs
      - type: skill
        file: skills/audit/SKILL.md

    golden_path: |
      /dev Step 6 → compare-scope.cjs (验证范围) → check-forbidden.cjs (检查禁区) →
      check-proof.cjs (验证证据) → generate-report.cjs (生成报告) →
      AUDIT-REPORT.md (Decision: PASS/FAIL)

    minimal_paths:
      - "compare-scope.cjs: 对比实际改动与允许范围"
      - "check-forbidden.cjs: 检查是否触碰禁区"
      - "check-proof.cjs: 验证 Tests 字段完成度"
      - "generate-report.cjs: 生成结构化报告"

    tests:
      - type: manual
        description: 手动验证脚本执行正确
        coverage: Q2-001, Q2-002

    rcis:
      - Q6-001  # Scope/Forbidden/Proof 验证准确性
      - Q6-002  # AUDIT-REPORT.md 生成正确

# ============================================================================
# Product Core 5 - 引擎核心能力
# ============================================================================
product_features:
  # --------------------------------------------------------------------------
  # P1: Regression Testing Framework - 回归测试框架
  # --------------------------------------------------------------------------
  - id: P1
    name: Regression Testing Framework
    status: Committed
    priority: P0
    description: |
      基于 regression-contract.yaml 的回归测试框架
      - 定义: 回归契约 (RCI) 定义必须永远不坏的能力
      - 过滤: rc-filter.sh 按 trigger (PR/Release/Nightly) 过滤
      - 执行: run-regression.sh 执行对应测试集合

    entrypoints:
      - type: script
        file: scripts/run-regression.sh
      - type: script
        file: scripts/rc-filter.sh
      - type: config
        file: regression-contract.yaml

    golden_path: |
      定义 RCI (regression-contract.yaml) → rc-filter.sh 过滤 →
      run-regression.sh 执行 → 验证契约不被破坏

    minimal_paths:
      - "PR: rc-filter.sh pr → 跑 trigger=[PR] 的 RCI"
      - "Release: rc-filter.sh release → 跑 trigger=[Release] 的 RCI"
      - "Nightly: run-regression.sh nightly → 跑全部 RCI"

    tests:
      - type: auto
        file: tests/regression/*.test.ts
        description: RCI 自动化测试集合

    rcis:
      - P1-001  # rc-filter.sh 正确过滤
      - P1-002  # run-regression.sh 执行
      - P1-003  # regression-contract.yaml 解析

  # --------------------------------------------------------------------------
  # P2: DevGate - 开发门禁检查
  # --------------------------------------------------------------------------
  - id: P2
    name: DevGate
    status: Committed
    priority: P0
    description: |
      CI 中的开发门禁检查（三合一）：
      1. DoD 映射检查: 每个 DoD 验收项必须有对应测试
      2. P0/P1 RCI 更新检查: P0/P1 修复必须更新 regression-contract.yaml
      3. RCI 覆盖率检查: 新增业务入口必须有对应 RCI 条目

    entrypoints:
      - type: ci
        job: test → DevGate checks
        scripts:
          - scripts/devgate/check-dod-mapping.cjs
          - scripts/devgate/require-rci-update-if-p0p1.sh
          - scripts/devgate/scan-rci-coverage.cjs

    golden_path: |
      CI test job → DevGate checks → 三个检查全部通过 → CI 继续

    minimal_paths:
      - "DoD 映射: .dod.md 每项 → 对应测试文件存在"
      - "P0/P1 检查: PR title 含 P0/P1 → regression-contract.yaml 必须更新"
      - "RCI 覆盖率: 新增入口 → 必须有对应 RCI"

    tests:
      - type: ci
        description: GitHub Actions CI 中执行
        coverage: C6-001, C7-001, C7-002, C7-003

    rcis:
      - C6-001  # DoD 映射检查
      - C7-001  # P0/P1 检测
      - C7-002  # RCI 更新检查
      - C7-003  # RCI 覆盖率检查

  # --------------------------------------------------------------------------
  # P3: Quality Reporting - 质量报告导出
  # --------------------------------------------------------------------------
  - id: P3
    name: Quality Reporting
    status: Committed
    priority: P1
    version: "11.14.0"
    updated: "2026-01-31"
    description: |
      导出质量审计和开发会话报告（JSON + TXT）：
      - E1: QA Reporting - 生成 QA 审计 JSON
      - E2: Dev Session Reporting - 生成开发任务报告
      v11.14.0: cleanup.sh v1.8 - PRD/DoD 归档到 .history/ 目录（而非直接删除）

    entrypoints:
      - type: script
        file: scripts/qa-report.sh
        output: qa-report.json
      - type: script
        file: skills/dev/scripts/generate-report.sh
        output: dev-session-report.json + .txt

    golden_path: |
      执行脚本 → 扫描 repo 结构 → 生成 JSON/TXT 报告 → 供 Dashboard 使用

    minimal_paths:
      - "QA Report: bash scripts/qa-report.sh → qa-report.json"
      - "Dev Session: bash skills/dev/scripts/generate-report.sh → dev-session-report.*"

    tests:
      - type: auto
        coverage: E1-001, E1-002, E1-003, E2-001, E2-002, E2-003

    rcis:
      - E1-001  # QA Report 生成
      - E1-002  # 格式验证
      - E1-003  # 数据完整性
      - E2-001  # Dev Session Report 生成
      - E2-002  # 格式验证
      - E2-003  # 数据完整性

  # --------------------------------------------------------------------------
  # P4: CI Quality Gates - CI 质量门禁
  # --------------------------------------------------------------------------
  - id: P4
    name: CI Quality Gates
    status: Committed
    priority: P0
    description: |
      GitHub Actions CI 中的质量门禁：
      - version-check: 检查 package.json 版本号更新
      - test job: L1 自动化测试 + DevGate 检查
      - release-check: Release 模式额外检查 (L3 回归 + L4 Evidence)

    entrypoints:
      - type: ci
        file: .github/workflows/ci.yml
        jobs:
          - version-check
          - test
          - release-check
          - ci-passed
          - notify-failure

    golden_path: |
      PR 创建 → CI 触发 → version-check + test + DevGate → 全部通过 → ci-passed

    minimal_paths:
      - "version-check: PR 时检查版本号更新"
      - "test: 跑 L1 (typecheck + test + build) + DevGate"
      - "release-check: PR to main 时跑 L3 回归 + L4 Evidence"

    tests:
      - type: ci
        description: GitHub Actions 自动执行
        coverage: C1-001, C1-002, C1-003, C2-001, C3-001, C5-001

    rcis:
      - C1-001  # version-check 执行
      - C1-002  # version-check 正确性
      - C1-003  # version-check 错误检测
      - C2-001  # test job L1 执行
      - C3-001  # shell scripts 语法检查
      - C5-001  # release-check 执行

  # --------------------------------------------------------------------------
  # P5: Worktree 并行开发
  # --------------------------------------------------------------------------
  - id: P5
    name: Worktree Parallel Development
    status: Committed
    priority: P1
    version: "11.16.0"
    updated: "2026-01-31"
    description: |
      自动检测 .dev-mode 冲突，自动创建 worktree 并 cd，支持并行开发：
      v11.16.0: Step 0 前置自动检测 + 僵尸 .dev-mode 清理 + flock 并发锁 + Step 3 兜底
      v11.3.1: Step 3 强制检查 worktree（主仓库有活跃任务时阻止创建分支）

    entrypoints:
      - type: step
        file: skills/dev/steps/00-worktree-auto.md
      - type: script
        file: skills/dev/scripts/worktree-manage.sh
      - type: step
        file: skills/dev/steps/03-branch.md

    golden_path: |
      /dev 启动 → Step 0 检测 .dev-mode → 僵尸则清理 → 活跃则自动创建 worktree + cd → 继续正常流程

    minimal_paths:
      - "主仓库无冲突 → 跳过，正常流程"
      - "主仓库有活跃 .dev-mode → 自动创建 worktree + cd"
      - "僵尸 .dev-mode（>2h 或分支不存在）→ 自动清理"

    tests:
      - type: manual
        description: 手动验证 worktree 自动创建
        coverage: W6-001

    rcis:
      - W6-001  # worktree 脚本可执行

  # --------------------------------------------------------------------------
  # P6: 自动化质检脚本 - Self-Evolution Automation
  # --------------------------------------------------------------------------
  - id: P6
    name: Self-Evolution Automation
    status: Committed
    priority: P2
    description: |
      自动化质检与自我进化机制：
      - squash-evidence.sh: 自动合并 evidence commit（解决 SHA 不匹配）
      - auto-generate-views.sh: 检测 feature-registry.yml 变更时自动生成派生视图
      - post-pr-checklist.sh: PR 合并后自动检查（PRD/DoD残留、派生视图同步、临时文件、未push的commit）
      - detect-priority.cjs 优化：优先读取 QA-DECISION.md，避免文本误识别
      - CI 已知失败支持：允许标记预期的测试失败不阻止 CI

    entrypoints:
      - type: script
        file: scripts/squash-evidence.sh
      - type: script
        file: scripts/auto-generate-views.sh
      - type: script
        file: scripts/post-pr-checklist.sh
      - type: script
        file: scripts/devgate/detect-priority.cjs
      - type: ci
        file: .github/workflows/ci.yml
        description: 支持已知失败模式

    golden_path: |
      问题发现 → 记录到 docs/SELF-EVOLUTION.md → 创建检查项 → 自动化脚本 → 集成到流程

    minimal_paths:
      - "Step 8: squash-evidence.sh 自动合并 evidence commit"
      - "Step 7: auto-generate-views.sh 自动生成派生视图"
      - "Step 11: post-pr-checklist.sh 自动运行 4 项检查"
      - "detect-priority.cjs 优先读取 QA-DECISION.md（不解析文本）"
      - "CI: 检测 .quality-evidence.json 中的 'known failures' 标记"

    tests:
      - type: auto
        file: tests/scripts/squash-evidence.test.ts
        coverage: S1-001
      - type: auto
        file: tests/scripts/auto-generate-views.test.ts
        coverage: S2-001, S2-002
      - type: auto
        file: tests/scripts/post-pr-checklist.test.ts
        coverage: S3-001, S3-002, S3-003, S3-004

    rcis:
      - S1-001  # squash-evidence.sh 自动合并
      - S2-001  # auto-generate-views.sh 检测变更
      - S2-002  # auto-generate-views.sh 无变更时跳过
      - S3-001  # post-pr-checklist.sh PRD/DoD 检查
      - S3-002  # post-pr-checklist.sh 派生视图版本检查
      - S3-003  # post-pr-checklist.sh 临时文件检查
      - S3-004  # post-pr-checklist.sh 未 push 的 commit 检查

# ============================================================================
# 视图生成规则
# ============================================================================
#
# MINIMAL-PATHS.md  = 每个 feature 的 minimal_paths 聚合
# OPTIMAL-PATHS.md  = 每个 feature 的 optimal_path 聚合
# GOLDEN-PATHS.md   = 每个 feature 的 golden_path 聚合
#
# 生成脚本: scripts/generate-path-views.sh (TODO)
# ============================================================================

  # --------------------------------------------------------------------------
  # H8: Credential Guard - 凭据保护 Hook
  # --------------------------------------------------------------------------
  - id: H8
    name: Credential Guard
    status: Committed
    priority: P0
    version: "11.2.12"
    updated: "2026-01-28"
    description: |
      防止将真实凭据写入代码文件：
      - 检测 Notion、GitHub、OpenAI、JWT、DigitalOcean、Feishu 等 token 模式
      - 允许占位符（YOUR_XXX）和 ~/.credentials/ 目录
      - 全局生效，保护所有开源仓库

    entrypoints:
      - type: hook
        event: PreToolUse:Write, PreToolUse:Edit
        file: hooks/credential-guard.sh

    golden_path: |
      写入代码 → credential-guard.sh 检测 → 真实凭据 → exit 2 (阻止) | 占位符/credentials目录 → exit 0 (放行)

    minimal_paths:
      - "代码中写真实 token → 被阻止"
      - "代码中写占位符 YOUR_XXX → 放行"
      - "写入 ~/.credentials/ → 放行"

    tests:
      - type: manual
        description: 手动验证检测模式
        coverage: H8-001, H8-002, H8-003

    rcis:
      - H8-001  # 检测真实凭据
      - H8-002  # 放行占位符
      - H8-003  # 放行 credentials 目录

  # --------------------------------------------------------------------------
  # G1: Gate Skill Family - 独立质量审核
  # --------------------------------------------------------------------------
  - id: G1
    name: Gate Skill Family
    status: Committed
    priority: P0
    version: "11.17.0"
    updated: "2026-01-31"
    description: |
      独立质量审核 Skill 家族，每个 gate 是"守门 Subagent"：
      - gate:prd - PRD 完整性、需求可验收性审核
      - gate:dod - PRD↔DoD 覆盖率、Test 映射有效性审核
      - gate:qa - RCI 判断、测试方法决策审核
      - gate:test - 测试↔DoD 覆盖率、边界用例审核
      - gate:audit - 审计证据真实性、风险点识别审核
      - gate:learning - 开发经验记录审核

      v11.17.0 硬门禁令牌机制：
      - PostToolUse[Task] hook (mark-subagent-done.sh) 在 gate subagent PASS 后写令牌
      - PreToolUse[Bash] hook (require-subagent-token.sh) 校验令牌才放行 generate-gate-file.sh
      - 令牌绑定 session_id + nonce，一次性消费，防跨会话复用
      - 修复 pr-gate-v2.sh 的 || true 吞 exit code bug
      - Branch Protection 改用 ci-passed 作为 required status check

      v11.14.1 规则挂载优化：
      - 统一 Gate 命名规范（gate:prd/dod/qa/audit/test/learning）
      - 完整规则直接嵌入 Subagent prompt（解决 general-purpose 类型无法访问 skills 问题）
      - 明确循环逻辑：Subagent FAIL → 主 Agent 修复 → 再次启动 Subagent → 直到 PASS

      v11.10.0 Gate v3 安全机制：
      - 新增 expires_at/expires_at_epoch 字段，默认 30 分钟过期（GATE_TTL_SECONDS 可配置）
      - 新增 tree_sha 字段，绑定代码树防止 amend 后复用
      - 新增 repo_id 字段（SHA256(remote_url)），防止跨仓库复用
      - Secret 读取优先级：env → keychain → ~/.config/cecelia/gate-secret → ~/.claude/.gate-secret → auto-generate
      - Verify 脚本 exit code 扩展：7=过期、8=HEAD 不匹配、9=repo 不匹配
      - 向后兼容 v2 格式（带警告）

      v11.8.0 方案 A 改造：
      - Gate 文件增加防误用字段：head_sha, generated_at, task_id, tool_version
      - Verify 脚本 exit code 分层：0/3/4/5/6
      - PR Gate 硬失败：脚本缺失时 exit 2
      - 设计哲学：Gate 是本地"自我约束"，CI 是"真正裁判"

      v11.7.0 强制执行机制：
      - 创建 PR 时检查所有 4 个 gate 文件（.gate-*-passed）
      - 签名防伪：sha256(gate:decision:timestamp:branch:secret)
      - 分支匹配：防止跨分支复用 gate 文件

      解决问题：
      - PRD/DoD/QA/Audit 可以写空壳文件应付检查
      - CI 只检查文件存在，不检查内容质量
      - 主 Agent 自己写、自己检查 = 自己给自己打分

    entrypoints:
      - type: skill
        file: skills/gate/SKILL.md
      - type: skill
        file: skills/gate/gates/prd.md
      - type: skill
        file: skills/gate/gates/dod.md
      - type: skill
        file: skills/gate/gates/test.md
      - type: skill
        file: skills/gate/gates/audit.md
      - type: hook
        file: hooks/mark-subagent-done.sh
      - type: hook
        file: hooks/require-subagent-token.sh

    golden_path: |
      主 Agent 产出 → Gate Subagent 审核 → PASS → PostToolUse 写令牌 → PreToolUse 校验令牌 → generate-gate-file.sh → 继续

    minimal_paths:
      - "写完 DoD → gate:dod 审核 → FAIL → 修改 → 再审核 → PASS"
      - "写完测试 → gate:test 审核 → PASS → 继续质检"

    tests:
      - type: auto
        description: Gate 令牌机制测试
        file: tests/hooks/gate-token.test.ts
        coverage: G1-005, G1-006
      - type: manual
        description: 手动验证审核循环
        coverage: G1-001, G1-002, G1-003, G1-004

    rcis:
      - G1-001  # gate:prd 审核 PRD 完整性
      - G1-002  # gate:dod 审核 DoD 覆盖率
      - G1-003  # gate:test 审核测试覆盖率
      - G1-004  # gate:audit 审核证据真实性
      - G1-005  # gate 令牌生成（PostToolUse hook）
      - G1-006  # gate 令牌校验 + 一次性消费（PreToolUse hook）
