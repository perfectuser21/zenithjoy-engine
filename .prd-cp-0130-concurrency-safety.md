# PRD: 并发安全与 CI 硬化

## 背景

深度审计发现 5 个 P0 级问题，其中 3 个涉及并发安全和 CI 绕过：

1. **P0-2**: Stop Hook .dev-mode 竞态条件 - 并发会话可能破坏状态
2. **P0-3**: pr-gate 超时保护不完整 - ci-preflight.sh 可能无限挂起
3. **P0-4**: CI known-failures 绕过漏洞 - 任意文字可跳过所有测试
4. **P1-6**: branch-protect skills 正则有 bug - Engine skills 保护失效

## 目标

- 并发会话不会互相破坏状态
- 所有外部命令有超时保护
- CI 是死线，不能被任意绕过
- Engine skills (dev/qa/audit/semver) 受到正确保护

## 成功标准

1. 两个 Claude Code 会话同时操作同一分支：一个成功，另一个明确提示 busy
2. 任意卡死命令最多 120s 超时退出
3. 非法 known-failures 输入直接 CI fail
4. 未授权修改 skills 目录被阻止

## 技术方案

### P0-2: flock + 原子写
- stop.sh 加 flock 锁
- .dev-mode 写入改为临时文件 + mv 原子替换

### P0-3: run_with_timeout 封装
- pr-gate-v2.sh 引入 run_with_timeout 函数
- 包住 verify-gate-signature.sh、ci-preflight.sh、gh 命令

### P0-4: known-failures 白名单
- 创建 ci/known-failures.json 权威清单
- CI 中加 schema 校验，非法输入直接 fail
- 最多跳过 3 项，必须在白名单中

### P1-6: 修复正则
- 使用 grep -Eq 强锚点匹配
- 明确路径：^\.claude/skills/(dev|qa|audit|semver)(/|$)
