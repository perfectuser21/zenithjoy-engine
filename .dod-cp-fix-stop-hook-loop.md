---
id: dod-fix-stop-hook-loop
version: 1.0.0
created: 2026-02-01
prd: .prd-fix-stop-hook-loop.md
qa: docs/QA-DECISION-cp-fix-stop-hook-loop.md
---

# DoD - 修复 Stop Hook 循环机制

## 验收标准

### 必要项

#### 1. Stop Hook 重试机制修复

- [ ] 删除 stop_hook_active 检查（hooks/stop.sh Line 84-96）
      Test: tests/hooks/stop-hook-retry.test.ts

- [ ] 实现 20 次计数器（retry_count 字段）
      Test: tests/hooks/stop-hook-retry.test.ts

- [ ] 20 次后上报失败并退出
      Test: tests/hooks/stop-hook-retry.test.ts

#### 2. Stop Hook 退出条件优化

- [ ] 删除 PR 合并后的提前退出（Line 197-233）
      Test: tests/hooks/stop-hook-exit.test.ts

- [ ] 修复分支不匹配时的 .dev-mode 泄漏（Line 130-133）
      Test: tests/hooks/stop-hook-exit.test.ts

- [ ] 统一退出条件：只有 cleanup_done: true
      Test: tests/hooks/stop-hook-exit.test.ts

#### 3. 11 步 Checklist 实现

- [ ] .dev-mode 文件包含 step_1-11 状态字段
      Test: tests/dev/checklist.test.ts

- [ ] 每个 Step 完成时追加 step_N_xxx: done
      Test: tests/dev/checklist.test.ts

- [ ] Stop Hook 检查所有步骤是否完成
      Test: tests/hooks/stop-hook-exit.test.ts

#### 4. 步骤提示优化

- [ ] skills/dev/steps/05-code.md 末尾统一格式
      Test: manual: 检查文件内容

- [ ] skills/dev/steps/06-test.md 末尾统一格式
      Test: manual: 检查文件内容

- [ ] 所有 steps/*.md 包含"立即执行下一步"提示
      Test: manual: 检查所有 steps 文件

#### 5. Cleanup 完善

- [ ] 扩展清理文件列表（添加 gate 文件）
      Test: tests/scripts/cleanup.test.ts

- [ ] 显式清理 .dev-mode 文件
      Test: tests/scripts/cleanup.test.ts

- [ ] 设置 cleanup_done: true 标记
      Test: tests/scripts/cleanup.test.ts

### 集成测试

- [ ] 完整流程测试（Step 1-11 连续执行）
      Test: tests/integration/full-flow.test.ts

- [ ] 中断恢复测试（Step 5 中断后恢复）
      Test: tests/integration/resume.test.ts

- [ ] 失败场景测试（20 次重试后失败）
      Test: tests/integration/failure.test.ts

### 可选项

- [ ] Stop Hook 超时检查（24 小时自动失败）
      Test: tests/hooks/timeout.test.ts

- [ ] 步骤执行时间统计
      Test: tests/dev/timing.test.ts

- [ ] 失败时自动生成诊断报告
      Test: tests/integration/diagnostic.test.ts

---

## 回归契约更新

需要更新以下 RCI：

- **H1-001**: Stop Hook 循环控制
- **H1-002**: .dev-mode 文件生命周期
- **W6-003**: 11 步流程完整性

---

## 验收流程

1. **代码修改**：完成所有必要项的代码改动
2. **测试编写**：编写 6 个自动化测试 + 2 个手动验证
3. **本地验证**：`npm run qa` 全部通过
4. **更新文档**：更新 regression-contract.yaml
5. **提交 PR**：版本号 +1 patch
6. **CI 验证**：等待 CI 全部通过
7. **合并**：Squash merge 到 develop

---

## 成功标准

- 所有必要项复选框 ✅
- 所有自动化测试通过
- CI 绿色
- regression-contract.yaml 已更新
