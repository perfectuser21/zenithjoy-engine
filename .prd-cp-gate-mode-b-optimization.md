## PRD - Gate 循环模式 B 优化（完成剩余工作）

**需求来源**: 架构决策 - 深度分析后确认使用模式 B（主 Agent 改 + 外部循环）

**背景**:
- 已完成部分优化：skills/gate/SKILL.md 和 gates/prd.md 已更新
- 需要完成剩余的 gate 文件、步骤文件、脚本修复和文档记录

**功能描述**:
系统性地将所有 Gate Subagent 改为模式 B，确保：
1. 所有 Gate Subagent 只审核，不修改文件
2. 主 Agent 控制循环逻辑，最大 3 轮
3. 统一 Required Fixes 格式
4. 修复 generate-gate-file.sh 支持 qa|learning
5. 创建完整的决策分析文档

**涉及文件**:

### 需要更新的 Gate 规则文件
- `skills/gate/gates/dod.md` - 添加"只审核"说明
- `skills/gate/gates/test.md` - 添加"只审核"说明
- `skills/gate/gates/audit.md` - 添加"只审核"说明
- `skills/gate/gates/qa.md` - 新建文件（当前不存在）
- `skills/gate/gates/learning.md` - 新建文件（当前不存在）

### 需要更新的步骤文件
- `skills/dev/steps/01-prd.md` - 添加完整的循环控制代码（最大 3 轮）
- `skills/dev/steps/04-dod.md` - 添加 gate:dod 和 gate:qa 的循环控制
- `skills/dev/steps/05-code.md` - 添加 gate:audit 的循环控制
- `skills/dev/steps/06-test.md` - 添加 gate:test 的循环控制
- `skills/dev/steps/10-learning.md` - 添加 gate:learning 的循环控制

### 需要修复的脚本
- `scripts/gate/generate-gate-file.sh` - 第 29 行添加 `|qa|learning` 支持

### 需要创建的文档
- `docs/GATE-LOOP-MODE-ANALYSIS.md` - 记录模式 A vs B 的完整分析报告

**模式 B 核心要求**:

所有 Gate Subagent Prompt 必须包含：
```
**重要**: 只审核，不修改文件。返回 PASS 或 FAIL + 详细反馈。

[审核标准 checklist...]

**记住**: 不要调用 Edit/Write 工具修改文件，只返回审核结果。
```

所有步骤文件的循环控制代码模板：
```javascript
const MAX_GATE_ATTEMPTS = 3;
let attempts = 0;

while (attempts < MAX_GATE_ATTEMPTS) {
  const result = await Skill({ skill: "gate:xxx" });

  if (result.decision === "PASS") {
    await Bash({ command: "bash scripts/gate/generate-gate-file.sh xxx" });
    break;
  }

  // 主 Agent 根据反馈修改
  for (const fix of result.requiredFixes) {
    await Edit({
      file_path: fix.location,
      old_string: "...",
      new_string: "..."
    });
  }

  attempts++;
}

if (attempts >= MAX_GATE_ATTEMPTS) {
  throw new Error("gate:xxx 审核失败，已重试 3 次");
}
```

**Required Fixes 统一格式**:
```yaml
1. issue: "具体问题描述"
   location: "文件路径 + 行号（如 .prd.md L25-30）"
   suggestion: "具体修复建议"
   example: "示例内容（可选）"
```

**成功标准**:

1. **所有 Gate 规则文件包含"只审核"说明**
   - dod.md, test.md, audit.md 的 Subagent Prompt 添加"不修改"警告
   - qa.md 和 learning.md 新建完整的审核标准文件
   Test: manual:GATE-MODE-B-01

2. **所有步骤文件包含循环控制代码**
   - 01-prd.md, 04-dod.md, 05-code.md, 06-test.md, 10-learning.md
   - 每个都有完整的 while 循环 + MAX_GATE_ATTEMPTS 检查
   Test: manual:GATE-MODE-B-02

3. **generate-gate-file.sh 支持所有 6 种 gate**
   - 第 29 行正则包含 `prd|dod|test|audit|qa|learning`
   Test: tests/gate/generate-gate-file.test.ts

4. **决策分析文档完整**
   - docs/GATE-LOOP-MODE-ANALYSIS.md 包含 10 维度分析
   - 包含决策矩阵（4.85 vs 2.05 分）
   - 包含 5 个实际场景模拟
   Test: manual:GATE-MODE-B-03

5. **qa.md 和 learning.md 规则文件符合标准**
   - 包含触发时机、审核标准、Subagent Prompt 模板
   - 包含 PASS/FAIL 条件
   - 格式与其他 gate 文件一致
   Test: manual:GATE-MODE-B-04

**非目标**:
- 不修改现有的 Hook 逻辑（branch-protect.sh, pr-gate-v2.sh 等）
- 不改变 Stop Hook 的循环控制机制
- 不影响已有的 gate 文件签名机制（generate-gate-file.sh 的其他逻辑）
- 不修改 CI 配置（.github/workflows/ci.yml）

**优先级**: P0-CRITICAL（架构核心决策，必须完成）

**预估影响**:
- 修改文件数: 约 12 个
- 新建文件数: 3 个（qa.md, learning.md, GATE-LOOP-MODE-ANALYSIS.md）
- 测试需求: 4 个手动验证 + 1 个自动化测试

**依赖**:
- 已完成: skills/gate/SKILL.md, skills/gate/gates/prd.md
- 参考: 模式 B 深度分析报告（agentId: a63dd17）
