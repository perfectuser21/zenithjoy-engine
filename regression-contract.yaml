# ============================================================================
# Regression Contract - ZenithJoy Engine
# ============================================================================
# Schema: regression-contract-v1.yaml (internal)
#
# 全量回归的唯一合法定义来源
#
# Trigger 规则：
#   - PR Gate:      跑 trigger 包含 PR 的条目
#   - Release Gate: 跑 trigger 包含 Release 的条目
#   - Nightly:      跑全部条目（忽略 trigger 过滤）
#
# Method 规则：
#   - auto:   必须有 test 字段指向自动化测试
#   - manual: 无 test 字段，需人工验证
#
# ============================================================================

# NOTE: version 需要与 package.json 保持同步
# 更新 package.json 时同步更新此处
version: "11.13.1"
updated: "2026-01-30"

# ============================================================================
# Hooks 回归契约
# ============================================================================
hooks:
  # --------------------------------------------------------------------------
  # H1: branch-protect
  # --------------------------------------------------------------------------
  - id: H1-001
    feature: H1
    name: "分支保护拦截 main/develop 写入"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [branch, write-protect, security]
    owner: infra
    steps:
      given: "当前在 main 或 develop 分支"
      when: "尝试写入代码文件（Write/Edit 工具）"
      then: "Hook 阻止并提示切换到 cp-* 或 feature/* 分支"
    evidence:
      type: log
      contains: "请先创建工作分支"
    test: "tests/hooks/branch-protect.test.ts"

  - id: H1-002
    feature: H1
    name: "cp-* 分支允许写入"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [branch, write-protect]
    owner: infra
    steps:
      given: "当前在 cp-* 分支"
      when: "尝试写入代码文件"
      then: "Hook 放行（exit 0）"
    evidence:
      type: exit_code
      equals: 0
    test: "tests/hooks/branch-protect.test.ts"

  - id: H1-003
    feature: H1
    name: "feature/* 分支允许写入"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [branch, write-protect]
    owner: infra
    steps:
      given: "当前在 feature/* 分支"
      when: "尝试写入代码文件"
      then: "Hook 放行（exit 0）"
    evidence:
      type: exit_code
      equals: 0
    test: "tests/hooks/branch-protect.test.ts"

  # --------------------------------------------------------------------------
  # H1-010~H1-012: v8.24.0 安全修复 (branch-protect.sh)
  # --------------------------------------------------------------------------
  - id: H1-010
    feature: H1
    name: "JSON 预验证防止注入 (branch-protect)"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, json, injection, v8.24.0]
    owner: infra
    steps:
      given: "Hook 接收包含特殊字符的输入"
      when: "解析 JSON 输入前"
      then: "使用 jq 预验证 JSON 格式，无效 JSON 直接报错退出"
    evidence:
      type: code
      file: "hooks/branch-protect.sh"
      contains: "jq -e . >/dev/null 2>&1"
    test: "tests/hooks/branch-protect.test.ts"

  - id: H1-011
    feature: H1
    name: "路径遍历检查 (branch-protect)"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, path-traversal, v8.24.0]
    owner: infra
    steps:
      given: "Hook 接收文件路径参数"
      when: "处理路径前"
      then: "拒绝包含 .. 的路径，防止目录遍历攻击"
    evidence:
      type: code
      file: "hooks/branch-protect.sh"
      contains: "reject_path_traversal"
    test: "tests/hooks/branch-protect.test.ts"

  # --------------------------------------------------------------------------
  # H7: stop.sh - 循环控制器
  # --------------------------------------------------------------------------
  - id: H7-001
    feature: H7
    name: "Stop Hook 检测 .dev-mode 文件"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [stop, loop, dev-mode]
    owner: infra
    steps:
      given: "会话尝试结束"
      when: "Stop Hook 触发"
      then: "检测 .dev-mode 文件，存在则检查完成条件"
    evidence:
      type: code
      file: "hooks/stop.sh"
      contains: ".dev-mode"

  - id: H7-002
    feature: H7
    name: "Stop Hook 检查完成条件"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [stop, loop, completion]
    owner: infra
    steps:
      given: ".dev-mode 文件存在"
      when: "Stop Hook 检查完成条件"
      then: "检查 PR 创建 + CI 通过 + PR 合并"
    evidence:
      type: code
      file: "hooks/stop.sh"
      contains: "gh pr list"

  - id: H7-003
    feature: H7
    name: "Stop Hook exit 2 阻止会话结束"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [stop, loop, continue]
    owner: infra
    steps:
      given: ".dev-mode 存在且完成条件未满足"
      when: "Stop Hook 检查结果"
      then: "返回 exit 2 阻止会话结束"
    evidence:
      type: code
      file: "hooks/stop.sh"
      contains: "exit 2"

  # --------------------------------------------------------------------------
  # H2: pr-gate-v2
  # --------------------------------------------------------------------------
  - id: H2-001
    feature: H2
    name: "PR Gate 拦截 gh pr create"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality]
    owner: infra
    steps:
      given: "在任意分支"
      when: "执行包含 'gh pr create' 的 Bash 命令"
      then: "Hook 运行 L1 质检"
    evidence:
      type: log
      contains: "PR GATE"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-002
    feature: H2
    name: "L1 失败阻止 PR 创建"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality]
    owner: infra
    steps:
      given: "typecheck 或 test 或 build 失败"
      when: "执行 gh pr create"
      then: "Hook 阻止并返回 exit 2"
    evidence:
      type: exit_code
      equals: 2
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-003
    feature: H2
    name: "L1 通过允许 PR 创建"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality, v10.4.4]
    owner: infra
    steps:
      given: "npm run qa 全绿"
      when: "执行 gh pr create"
      then: "Hook 放行（exit 0）"
    note: "v10.4.4: 移除 FAST_MODE，100% 强制本地 L1+L2A 检查（无快速跳过）"
    evidence:
      type: log
      contains: "✅ PR Gate 通过"
    verification:
      - desc: "确认 hooks/pr-gate-v2.sh 中不含 FAST_MODE"
        command: "! grep -q 'FAST_MODE' hooks/pr-gate-v2.sh"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-004
    feature: H2
    name: "双模式：--base main 触发 Release 模式"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [pr, gate, release]
    owner: infra
    steps:
      given: "执行 gh pr create --base main"
      when: "Hook 解析命令"
      then: "自动切换到 Release 模式，检查 L2B + L3"
    evidence:
      type: log
      contains: "Release 模式"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-005
    feature: H2
    name: "双模式：默认 PR 模式只检查 L1"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate]
    owner: infra
    steps:
      given: "执行 gh pr create（无 --base main）"
      when: "Hook 解析命令"
      then: "使用 PR 模式，只检查 L1"
    evidence:
      type: log
      contains: "PR 模式 (L1 only)"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-006
    feature: H2
    name: "DoD 文件检查（PR 模式）"
    scope: hook
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, dod]
    owner: infra
    steps:
      given: "PR 模式下"
      when: ".dod.md 不存在或未更新"
      then: "Hook 报错并阻止 PR"
    evidence:
      type: log
      contains: "DoD"
    test: "tests/hooks/pr-gate.test.ts"

  # --------------------------------------------------------------------------
  # H2-007: Phase 1 - DoD 映射检查
  # --------------------------------------------------------------------------
  - id: H2-007
    feature: H2
    name: "DoD ↔ Test 映射检查"
    scope: hook
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, dod, phase1]
    owner: infra
    steps:
      given: "PR 模式下"
      when: "执行 gh pr create"
      then: "Hook 调用 check-dod-mapping.cjs 验证每条 DoD 有 Test 字段"
    evidence:
      type: log
      contains: "DoD ↔ Test 映射检查"
    test: "tests/hooks/pr-gate-phase1.test.ts"

  - id: H2-008
    feature: H2
    name: "P0/P1 强制 RCI 更新"
    scope: hook
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, rci, phase1]
    owner: infra
    steps:
      given: "PR 优先级为 P0 或 P1"
      when: "执行 gh pr create"
      then: "Hook 调用 require-rci-update-if-p0p1.sh 验证 RCI 已更新"
    evidence:
      type: log
      contains: "P0/P1 → RCI 更新检查"
    test: "tests/hooks/pr-gate-phase1.test.ts"

  # --------------------------------------------------------------------------
  # H2-009: Phase 2 - PRD/DoD 快照
  # --------------------------------------------------------------------------
  - id: H2-009
    feature: H2
    name: "PRD/DoD 快照功能"
    scope: hook
    priority: P2
    trigger: [Release]
    method: auto
    tags: [pr, gate, snapshot, phase2]
    owner: infra
    steps:
      given: "PR 创建成功"
      when: "/dev 流程调用 snapshot-prd-dod.sh"
      then: "PRD/DoD 复制到 .history/ 目录，文件名包含 PR 号和时间戳"
    evidence:
      type: file
      path: ".history/PR-*.prd.md"
      exists: true
    test: "tests/hooks/pr-gate-phase2.test.ts"

  # --------------------------------------------------------------------------
  # H2-010: Phase 6 - Skill 产物检查
  # --------------------------------------------------------------------------
  - id: H2-010
    feature: H2
    name: "Skill 产物检查（QA-DECISION + AUDIT-REPORT）"
    scope: hook
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, skill, phase6]
    owner: infra
    steps:
      given: "PR 模式下"
      when: "执行 gh pr create"
      then: "Hook 检查 docs/QA-DECISION.md 和 docs/AUDIT-REPORT.md 存在，且审计通过"
    evidence:
      type: log
      contains: "Phase 6: Skill 产物检查"
    test: "tests/hooks/pr-gate.test.ts"

  # --------------------------------------------------------------------------
  # H2-011~H2-013: v8.24.0 安全修复 (pr-gate-v2.sh)
  # --------------------------------------------------------------------------
  - id: H2-011
    feature: H2
    name: "JSON 预验证防止注入 (pr-gate)"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, json, injection, v8.24.0]
    owner: infra
    steps:
      given: "Hook 接收包含特殊字符的输入"
      when: "解析 JSON 输入前"
      then: "使用 jq 预验证 JSON 格式，无效 JSON 直接报错退出"
    evidence:
      type: code
      file: "hooks/pr-gate-v2.sh"
      contains: "jq -e . >/dev/null 2>&1"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-012
    feature: H2
    name: "sed 注入防护 (pr-gate)"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, sed, injection, v8.24.0]
    owner: infra
    steps:
      given: "Hook 使用 sed 处理用户输入"
      when: "构造 sed 命令"
      then: "使用 # 作为分隔符，避免 / 分隔符被路径中的 / 破坏"
    evidence:
      type: code
      file: "hooks/pr-gate-v2.sh"
      contains: "sed -n 's#"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-013
    feature: H2
    name: "CRITICAL/HIGH → P0/P1 优先级映射"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, priority, mapping, v8.24.0]
    owner: infra
    steps:
      given: "PR 包含 CRITICAL/HIGH 关键字"
      when: "detect-priority.cjs 检测优先级"
      then: "CRITICAL 映射为 P0，HIGH 映射为 P1，security 前缀映射为 P0"
    evidence:
      type: code
      file: "scripts/devgate/detect-priority.cjs"
      contains: "CRITICAL|HIGH|security"
    test: "tests/hooks/detect-priority.test.ts"

  # [DEPRECATED] H7 Stop Hook 从未实现，已被 Ralph Loop + PR Gate 替代
  # - id: H7-004
  #   feature: H7
  #   name: "stop.sh v10.0.0 两阶段语义对齐"
  #   deprecated_since: "11.2.9"
  #   deprecated_reason: "hooks/stop.sh 从未实现"

  # --------------------------------------------------------------------------
  # H8: Session End Hook
  # --------------------------------------------------------------------------
  - id: H8-001
    feature: H8
    name: "session-end.sh 会话结束状态追踪"
    scope: hook
    priority: P2
    trigger: [Release]
    method: manual
    tags: [session, tracking, v10.0.0]
    owner: infra
    steps:
      given: "Claude Code 会话结束时"
      when: "hooks/session-end.sh 触发"
      then: "记录会话结束状态，清理临时文件"
    evidence:
      type: manual
      desc: "检查会话结束后的清理效果"

  # --------------------------------------------------------------------------
  # H3: Phase 3 - Hook Core 多仓库治理
  # --------------------------------------------------------------------------
  - id: H3-001
    feature: H3
    name: "hook-core 安装功能"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [hook-core, install, phase3]
    owner: infra
    steps:
      given: "目标项目是 git 仓库"
      when: "运行 bash scripts/install-hooks.sh <target_dir>"
      then: "hook-core 安装到目标项目，包含 hooks/, scripts/devgate/, .claude/settings.json"
    evidence:
      type: command
      run: "bash scripts/install-hooks.sh --version"
      contains: "hook-core version:"
    test: "tests/hooks/install-hooks.test.ts"

  # --------------------------------------------------------------------------
  # H4: Phase 4 - DevGate Metrics 指标面板
  # --------------------------------------------------------------------------
  - id: H4-001
    feature: H4
    name: "DevGate Metrics 指标计算"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [metrics, devgate, phase4]
    owner: infra
    steps:
      given: ".history/ 目录包含带 meta 的快照文件"
      when: "运行 bash scripts/devgate/metrics.sh"
      then: "输出 P0/P1 PR 数、RCI 覆盖率、新增 RCI 数、DoD 条目数"
    evidence:
      type: command
      run: "bash scripts/devgate/metrics.sh --format json"
      contains: "rci_coverage"
    test: "tests/hooks/metrics.test.ts"

  - id: H4-002
    feature: H4
    name: "快照 Meta 格式增强"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [snapshot, meta, phase4]
    owner: infra
    steps:
      given: "存在 .prd.md 和 .dod.md"
      when: "运行 snapshot-prd-dod.sh 创建快照"
      then: "快照顶部包含完整 meta: pr, base, priority, head, merged, created"
    evidence:
      type: file
      path: ".history/PR-*.dod.md"
      contains: "<!-- pr:"
    test: "tests/hooks/metrics.test.ts"

  # --------------------------------------------------------------------------
  # H4-003: v8.24.0 安全修复 (run-regression.sh)
  # --------------------------------------------------------------------------
  - id: H4-003
    feature: H4
    name: "RCI ID 格式白名单验证"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, validation, whitelist, v8.24.0]
    owner: infra
    steps:
      given: "run-regression.sh 接收 RCI ID 参数"
      when: "处理 ID 前"
      then: "验证 ID 符合 [A-Z][0-9]-[0-9]{3} 格式，拒绝非法字符防止命令注入"
    evidence:
      type: code
      file: "scripts/run-regression.sh"
      contains: "^[A-Z][0-9]-[0-9]{3}$"
    test: "tests/hooks/run-regression.test.ts"

# ============================================================================
# Workflow 回归契约
# ============================================================================
# TODO: W1 系列当前为 manual 测试，需要添加自动化测试
# 自动化方向：使用 expect 脚本或 playwright 模拟交互式会话
workflow:
  # --------------------------------------------------------------------------
  # W1: /dev 11 步流程
  # --------------------------------------------------------------------------
  - id: W1-001
    feature: W1
    name: "/dev 流程可启动"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, entry]
    owner: workflow
    steps:
      given: "用户在项目根目录"
      when: "运行 /dev 或说开发需求"
      then: "Skill 加载，显示 PRD 确认步骤"
    evidence:
      type: screenshot
      description: "Skill 加载截图"

  - id: W1-002
    feature: W1
    name: "分支自动创建"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, branch]
    owner: workflow
    steps:
      given: "PRD 确认后进入 Step 3"
      when: "Claude 执行分支创建"
      then: "创建 cp-MMDDHHNN-task 格式分支"
    evidence:
      type: command
      run: "git branch --show-current"
      contains: "cp-"

  - id: W1-003
    feature: W1
    name: "DoD 自动生成"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, dod]
    owner: workflow
    steps:
      given: "分支创建后进入 Step 4"
      when: "Claude 推演 DoD"
      then: "生成 .dod.md 文件，包含验收标准"
    evidence:
      type: file
      path: ".dod.md"
      exists: true

  - id: W1-004
    feature: W1
    name: "p0 阶段完整流程"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, p0, v2.0.0, two-phase]
    owner: workflow
    steps:
      given: "进入 p0 阶段（本地开发）"
      when: "执行 PRD → DoD → Code → Audit (PASS) → Test (L1) → PR（Step 8 不调用 Step 9）"
      then: "创建 PR 后结束，不等待 CI（Stop Hook 检查 phase=p0，直接 exit 0）"
    evidence:
      type: log
      description: "PR 创建后 Stop Hook 输出 'p0 阶段: PR 已创建 → exit 0'；Step 8 结尾不包含 Step 9 调用"

  - id: W1-005
    feature: W1
    name: "p1 阶段事件驱动修复"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, p1, v2.0.0, two-phase, event-driven]
    owner: workflow
    steps:
      given: "PR 已创建，CI 检测到失败（phase=p1）"
      when: "CI fail 事件触发（n8n 轮询 Notion / GitHub webhook / cron）"
      then: "PHASE_OVERRIDE=p1 启动 → 诊断 → 修复 → push → 退出（不等待 CI，等下次唤醒）"
    evidence:
      type: log
      contains: "p1 阶段.*CI.*fail.*修复.*push.*exit 0"

  - id: W1-006
    feature: W1
    name: "p2 阶段自动 merge"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, p2, v2.0.0, two-phase, auto-merge]
    owner: workflow
    steps:
      given: "PR CI 全部通过（phase=p2）"
      when: "CI pass 事件触发（GitHub Actions auto-merge job）"
      then: "自动合并 PR → Learning（总结经验）→ Cleanup（清理分支）→ 完成"
    evidence:
      type: log
      contains: "p2 阶段.*CI pass.*merge.*learning.*cleanup"

  - id: W1-008
    feature: W1
    name: "p1 阶段轮询循环"
    scope: workflow
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [dev, p1, v2.0.0, polling-loop]
    owner: workflow
    steps:
      given: "PR 已创建，CI 检测到失败（phase=p1）"
      when: "用户问'怎么样了'触发 P1 阶段"
      then: "进入轮询循环：检查 CI → 运行中则 sleep 30s → 失败则修复并 continue → 成功则 merge 并 break"
    evidence:
      type: code
      description: "skills/dev/steps/09-ci.md 包含 while true 循环；失败后 continue 继续循环（不退出）；超时保护 1 小时"

  # --------------------------------------------------------------------------
  # W3: 循环回退
  # --------------------------------------------------------------------------
  - id: W3-001
    feature: W3
    name: "质检失败触发回退"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, loop, quality]
    owner: workflow
    steps:
      given: "Step 7 质检（npm run qa）失败"
      when: "Claude 检测到失败"
      then: "自动返回 Step 5 继续修复，而非中止流程"
    evidence:
      type: log
      description: "对话记录显示循环回退"

  - id: W3-002
    feature: W3
    name: "CI 失败触发回退"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, loop, ci]
    owner: workflow
    steps:
      given: "Step 9 CI 红"
      when: "wait-for-merge.sh 检测到 CI 失败"
      then: "自动返回 Step 5 重新循环，而非中止"
    evidence:
      type: log
      contains: "CI 失败"

  # --------------------------------------------------------------------------
  # W5: 模式自动检测
  # --------------------------------------------------------------------------
  - id: W5-001
    feature: W5
    name: "new 模式：在 develop/main 检测为新任务"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, mode, detect]
    owner: workflow
    steps:
      given: "当前在 develop 或 main 分支"
      when: "运行 /dev"
      then: "检测为 new 模式，开始完整流程"
    evidence:
      type: log
      contains: "检测到模式: new"

  - id: W5-002
    feature: W5
    name: "continue 模式：cp-* 无 PR 检测为继续开发"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, mode, detect]
    owner: workflow
    steps:
      given: "当前在 cp-* 分支且没有打开的 PR"
      when: "运行 /dev"
      then: "检测为 continue 模式，直接进入 Loop 1"
    evidence:
      type: log
      contains: "检测到模式: continue"

  - id: W5-003
    feature: W5
    name: "fix 模式：有 PR + CI 红检测为修复"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, mode, detect]
    owner: workflow
    steps:
      given: "当前分支有打开的 PR 且 CI 失败"
      when: "运行 /dev"
      then: "检测为 fix 模式，直接进入 Loop 2"
    evidence:
      type: log
      contains: "检测到模式: fix"

  - id: W5-004
    feature: W5
    name: "merge 模式：有 PR + CI 绿检测为合并"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, mode, detect]
    owner: workflow
    steps:
      given: "当前分支有打开的 PR 且 CI 通过"
      when: "运行 /dev"
      then: "检测为 merge 模式，进入清理和合并"
    evidence:
      type: log
      contains: "检测到模式: merge"

  # --------------------------------------------------------------------------
  # W6: Worktree 并行开发
  # --------------------------------------------------------------------------
  - id: W6-001
    feature: W6
    name: "检测活跃的功能分支"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, worktree, parallel]
    owner: workflow
    steps:
      given: "在 develop 分支，有未合并的功能分支"
      when: "运行 /dev 进入新任务模式"
      then: "Step 2.5 检测到活跃分支并显示选项"
    evidence:
      type: log
      contains: "检测到并行开发"

  - id: W6-002
    feature: W6
    name: "worktree-manage.sh create 创建 worktree"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: auto
    tags: [dev, worktree, script]
    owner: workflow
    steps:
      given: "在主工作区"
      when: "运行 worktree-manage.sh create <task-name>"
      then: "创建新 worktree 目录和对应分支"
    evidence:
      type: exit_code
      equals: 0
    test: "manual:script-test"

  - id: W6-003
    feature: W6
    name: "cleanup.sh 清理关联的 worktree"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, worktree, cleanup]
    owner: workflow
    steps:
      given: "功能分支有关联的 worktree"
      when: "运行 cleanup.sh"
      then: "Step 4.5 检测并移除关联的 worktree"
    evidence:
      type: log
      contains: "已移除 worktree"

  # --------------------------------------------------------------------------
  # W7: Ralph Loop 自动化
  # --------------------------------------------------------------------------
  - id: W7-001
    feature: W7
    name: "Ralph Loop 统一完成条件（v2.2.0）"
    scope: workflow
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [dev, ralph-loop, automation, v2.2.0]
    owner: workflow
    steps:
      given: "用户需要执行开发任务"
      when: "在 Claude Code 会话内输入 /ralph-loop \"/dev .prd.md\" --completion-promise \"DONE\" --max-iterations 20"
      then: "从头到尾一直执行，直到 PR 创建 + CI 通过 + PR 合并，才输出 DONE"
    note: "v2.2.0: 删除阶段检测（不再分 p0/p1/p2），统一完成条件，不在 PR 创建后停止"
    evidence:
      type: log
      description: "日志显示 Ralph Loop 一直执行到 PR 合并才输出 DONE"

  - id: W7-002
    feature: W7
    name: "一次性提交避免 SHA 死循环"
    scope: workflow
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [dev, commit, sha-check]
    owner: workflow
    steps:
      given: "Step 7 质检完成，需要提交代码"
      when: "执行自动化检查并提交"
      then: "所有改动（代码+版本号+registry+视图+evidence）在一个 commit，evidence SHA 匹配 commit SHA"
    evidence:
      type: command
      run: "git log --oneline -1"
      description: "单个 commit 包含所有改动，CI SHA 检查通过"

  - id: W7-003
    feature: W7
    name: "Task Checkpoint 追踪进度（v2.2.0）"
    scope: workflow
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [dev, task-checkpoint, progress-tracking, v2.2.0]
    owner: workflow
    steps:
      given: "/dev 开始执行"
      when: "创建所有步骤的 Task（TaskCreate）并在执行中更新状态（TaskUpdate）"
      then: "用户可以实时看到执行进度（哪一步 in_progress），中断后可恢复"
    note: "v2.2.0: 强制使用官方 Task Checkpoint 追踪进度，替代旧的阶段检测"
    evidence:
      type: log
      description: "日志显示 TaskCreate/TaskUpdate 调用，TaskList 显示实时进度"

# ============================================================================
# CI/Release 回归契约
# ============================================================================
ci:
  # --------------------------------------------------------------------------
  # C1: version-check
  # --------------------------------------------------------------------------
  - id: C1-001
    feature: C1
    name: "PR 版本号必须递增"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, version]
    owner: infra
    steps:
      given: "PR 包含代码改动"
      when: "CI 运行 version-check job"
      then: "package.json 版本号 > develop 分支版本"
    evidence:
      type: ci_job
      name: "version-check"
      status: success
    # CI jobs are tested by running the workflow; no separate test file
    test: "tests/ci/version-check.test.ts"

  # --------------------------------------------------------------------------
  # C1-002~C1-003: v8.24.0 安全修复 (ci.yml)
  # --------------------------------------------------------------------------
  - id: C1-002
    feature: C1
    name: "CI Job 权限最小化声明"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, ci, permissions, v8.24.0]
    owner: infra
    steps:
      given: "CI workflow 文件"
      when: "定义 job"
      then: "每个 job 显式声明 permissions，遵循最小权限原则"
    evidence:
      type: code
      file: ".github/workflows/ci.yml"
      contains: "permissions:"
    # Evidence check: grep for 'permissions:' in ci.yml
    test: "tests/ci/permissions.test.ts"

  - id: C1-003
    feature: C1
    name: "curl JSON 安全生成"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [security, ci, json, v8.24.0]
    owner: infra
    steps:
      given: "CI 需要发送 JSON 数据"
      when: "构造 curl 请求"
      then: "使用 jq -n 生成 JSON，避免字符串拼接注入"
    evidence:
      type: code
      file: ".github/workflows/ci.yml"
      contains: "jq -n"
    # Evidence check: grep for 'jq -n' in ci.yml
    test: "tests/ci/json-safety.test.ts"

  # --------------------------------------------------------------------------
  # C2: test job
  # --------------------------------------------------------------------------
  - id: C2-001
    feature: C2
    name: "CI 运行 npm run qa"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, test, l1, v10.5.0]
    owner: infra
    steps:
      given: "PR 提交"
      when: "CI 运行 test job"
      then: "typecheck + test + build 全绿 + L2A check (pr mode)"
    note: "v10.5.0: test job 新增 L2A check (pr mode)"
    evidence:
      type: ci_job
      name: "test"
      status: success
    test: "tests/ci/test-job.test.ts"

  - id: C2-002
    feature: C2
    name: "CI L2A Gate (pr mode)"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, l2a, gate, v10.5.0]
    owner: infra
    steps:
      given: "PR 提交"
      when: "CI test job 运行"
      then: "l2a-check.sh pr 检查通过（.prd.md + .dod.md + QA-DECISION + AUDIT-REPORT）"
    evidence:
      type: ci_log
      contains: "L2A_SUMMARY: passed=4 failed=0"
    verification:
      - desc: "确认 .prd.md 存在 + 至少 3 行"
        command: "test -f .prd.md && [ $(grep -cv '^\\s*$' .prd.md) -ge 3 ]"
      - desc: "确认 .dod.md 存在 + 包含 QA:"
        command: "test -f .dod.md && grep -q 'QA:' .dod.md"
      - desc: "确认 docs/QA-DECISION.md 存在 + 包含 Decision:"
        command: "test -f docs/QA-DECISION.md && grep -q 'Decision:' docs/QA-DECISION.md"
      - desc: "确认 docs/AUDIT-REPORT.md 存在 + Decision: PASS"
        command: "test -f docs/AUDIT-REPORT.md && grep -q 'Decision: PASS' docs/AUDIT-REPORT.md"
    test: "tests/devgate/l2a-check.test.ts"

  - id: C2-003
    feature: C2
    name: "CI L2A Gate (release mode)"
    scope: ci
    priority: P0
    trigger: [Release]
    method: auto
    tags: [ci, l2a, gate, release, v10.5.0]
    owner: infra
    steps:
      given: "PR to main"
      when: "CI release-check job 运行"
      then: "l2a-check.sh release 检查通过（更严格：DoD 全勾 + QA PASS）"
    note: "release 模式比 pr 模式更严格，要求 DoD 全勾选 + QA-DECISION 必须 PASS"
    evidence:
      type: ci_log
      contains: "L2A_SUMMARY: passed=4 failed=0"
    verification:
      - desc: "确认 .dod.md 全勾选（无 - [ ]）"
        command: "! grep -qE '^\\s*-\\s*\\[\\s*\\]' .dod.md"
      - desc: "确认 docs/QA-DECISION.md Decision: PASS"
        command: "grep -q 'Decision: PASS' docs/QA-DECISION.md"
    test: "tests/devgate/l2a-check.test.ts"

  # --------------------------------------------------------------------------
  # C3: shell syntax check
  # --------------------------------------------------------------------------
  - id: C3-001
    feature: C3
    name: "Shell 脚本语法检查"
    scope: ci
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [ci, shell, lint]
    owner: infra
    steps:
      given: "仓库包含 .sh 文件"
      when: "CI 运行 shell-check"
      then: "所有 .sh 文件 bash -n 通过"
    evidence:
      type: ci_job
      name: "shell-check"
      status: success
    # Shell check is part of test job, validated by CI
    test: "tests/ci/shell-check.test.ts"

  # --------------------------------------------------------------------------
  # C6: Phase 1 DevGate
  # --------------------------------------------------------------------------
  - id: C6-001
    feature: C6
    name: "CI DevGate 检查步骤"
    scope: ci
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [ci, devgate, phase1]
    owner: infra
    steps:
      given: "PR 提交到 develop"
      when: "CI 运行 DevGate checks step"
      then: "DoD 映射检查 + P0/P1 RCI 检查通过"
    evidence:
      type: ci_job
      name: "DevGate checks"
      status: success
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # C7: Nightly DevGate Metrics
  # --------------------------------------------------------------------------
  - id: C7-001
    feature: C7
    name: "Nightly DevGate Metrics 收集"
    scope: ci
    priority: P2
    trigger: [Release]
    method: auto
    tags: [ci, nightly, metrics, phase4]
    owner: infra
    steps:
      given: "Nightly workflow 运行"
      when: "执行 DevGate Metrics step"
      then: "生成 JSON 报告并上传为 artifact"
    evidence:
      type: ci_job
      name: "DevGate Metrics"
      status: success
    test: ".github/workflows/nightly.yml"

  - id: C7-002
    feature: C7
    name: "Nightly L2 阈值检查"
    scope: ci
    priority: P1
    trigger: [Release]
    method: auto
    tags: [ci, nightly, threshold, phase41]
    owner: infra
    steps:
      given: "devgate-metrics.json 已生成"
      when: "执行 DevGate Threshold Check (L2) step"
      then: "P0/P1 RCI 覆盖率 100% 且 P0 manual tests = 0"
    evidence:
      type: ci_job
      name: "DevGate Threshold Check (L2)"
      status: success
    test: ".github/workflows/nightly.yml"

  - id: C7-003
    feature: C7
    name: "LEARNINGS 自动写回"
    scope: ci
    priority: P2
    trigger: [Release]
    method: auto
    tags: [ci, nightly, learnings, phase5]
    owner: infra
    steps:
      given: "devgate-metrics.json 已生成"
      when: "执行 Append to LEARNINGS step"
      then: "月度报告追加到 docs/LEARNINGS.md 并 commit/push"
    evidence:
      type: ci_job
      name: "Append to LEARNINGS"
      status: success
    test: ".github/workflows/nightly.yml"

  # --------------------------------------------------------------------------
  # C8: Evidence CI (SSOT)
  # --------------------------------------------------------------------------
  - id: C8-001
    feature: C8
    name: "CI Evidence 生成脚本正常工作"
    scope: ci
    priority: P0
    # Note: Only PR trigger because release-check depends on test job which already validates evidence
    trigger: [PR]
    method: auto
    tags: [ci, evidence, ssot, quality-gate]
    owner: infra
    steps:
      given: "CI test job 运行"
      when: "执行 Generate Evidence step"
      then: "生成 .quality-evidence.<SHA>.json 文件，包含所需字段"
    evidence:
      type: file
      path: ".quality-evidence.*.json"
      contains: ["sha", "ci_run_id", "timestamp", "qa_gate_passed", "audit_decision"]
      run: "bash ci/scripts/generate-evidence.sh"
    test: "ci/scripts/generate-evidence.sh"

  - id: C8-002
    feature: C8
    name: "Evidence Gate 校验通过"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, evidence, gate, validation]
    owner: infra
    steps:
      given: "Evidence 文件已生成"
      when: "执行 Evidence Gate step"
      then: "校验 JSON 格式、SHA 匹配、必需字段存在"
    evidence:
      type: ci_job
      name: "Evidence Gate"
      status: success
      run: "bash ci/scripts/evidence-gate.sh"
    test: "ci/scripts/evidence-gate.sh"

  - id: C8-003
    feature: C8
    name: "本地 qa:local 只跑 typecheck"
    scope: dev
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [local, fast-fail, typecheck]
    owner: dev
    steps:
      given: "开发者在本地运行 qa:local"
      when: "npm run qa:local"
      then: "只执行 typecheck，不跑 test/build（快速反馈）"
    evidence:
      type: script
      contains: "npm run typecheck"
    test: "package.json"

  # --------------------------------------------------------------------------
  # C4: regression-pr (develop PR L3 subset)
  # --------------------------------------------------------------------------
  - id: C4-001
    feature: C4
    name: "develop PR 回归测试（L3 子集）"
    scope: ci
    priority: P1
    trigger: [PR]
    method: auto
    tags: [ci, regression, pr, develop, v10.5.0]
    owner: infra
    steps:
      given: "PR to develop"
      when: "CI regression-pr job 运行"
      then: "跑 trigger 包含 PR 的 RCI 子集，防止 develop 分支腐烂"
    note: "v10.5.0: 新增 regression-pr job，develop PR 也跑回归测试子集"
    evidence:
      type: ci_job
      name: "regression-pr"
      status: success
    verification:
      - desc: "确认 regression-pr job 存在于 ci.yml"
        command: "grep -q 'regression-pr:' .github/workflows/ci.yml"
      - desc: "确认调用 scripts/run-regression.sh pr"
        command: "grep -q 'run-regression.sh pr' .github/workflows/ci.yml"
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # C5: release-check
  # --------------------------------------------------------------------------
  - id: C5-001
    feature: C5
    name: "Release 前 DoD 完成度检查"
    scope: ci
    priority: P1
    # Note: Only PR trigger because running scripts/release-check.sh inside
    # the release-check job creates a circular dependency (C5-001 calls
    # release-check.sh which is already being run by run-regression.sh)
    trigger: [PR]
    method: auto
    tags: [ci, release, dod]
    owner: infra
    steps:
      given: "PR 到 main 分支"
      when: "运行 npm run release:check"
      then: "DoD 所有必要项完成，Evidence 引用正确"
    evidence:
      type: command
      run: "bash scripts/release-check.sh"
      contains: "Release 检查通过"
    test: "scripts/release-check.sh"

# --------------------------------------------------------------------------
  # C8: Evidence Truth System (P0-1)
  # --------------------------------------------------------------------------
  - id: C8-001
    feature: C8
    name: "Evidence 来自真实 CI 结果"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, evidence, security, v11.12.1]
    owner: infra
    steps:
      given: "CI 运行完成"
      when: "generate-evidence.sh 生成 evidence"
      then: "qa_gate_passed 从 ci/out/checks/*.json 计算，不再硬编码"
    note: "v11.12.1 P0-1: 修复 evidence 硬编码漏洞"
    evidence:
      type: code
      file: "ci/scripts/generate-evidence.sh"
      not_contains: "qa_gate_passed: true"
    test: "tests/ci/evidence.test.ts"

  - id: C8-002
    feature: C8
    name: "Evidence Gate 验证 required checks"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, evidence, gate, security, v11.12.1]
    owner: infra
    steps:
      given: "evidence 文件已生成"
      when: "evidence-gate.sh 运行"
      then: "验证 typecheck/test/build/shell-check 全存在且 ok=true"
    evidence:
      type: code
      file: "ci/scripts/evidence-gate.sh"
      contains: "REQUIRED_CHECKS"
    test: "tests/ci/evidence.test.ts"

  - id: C8-003
    feature: C8
    name: "Evidence hash 防篡改"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, evidence, hash, security, v11.12.1]
    owner: infra
    steps:
      given: "evidence 文件包含 file_hash"
      when: "evidence-gate.sh 验证"
      then: "重新计算 hash 并比对，不匹配则 FAIL"
    evidence:
      type: code
      file: "ci/scripts/evidence-gate.sh"
      contains: "sha256sum"
    test: "tests/ci/evidence.test.ts"

  # --------------------------------------------------------------------------
  # C9: DoD manual: backdoor fix (P0-2)
  # --------------------------------------------------------------------------
  - id: C9-001
    feature: C9
    name: "manual: Test 必须有 evidence 记录"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [devgate, dod, manual, security, v11.12.1]
    owner: infra
    steps:
      given: "DoD 包含 Test: manual:xxx"
      when: "check-dod-mapping.cjs 验证"
      then: "必须在 evidence 的 manual_verifications 中找到匹配记录"
    note: "v11.12.1 P0-2: 修复 manual: 后门漏洞"
    evidence:
      type: code
      file: "scripts/devgate/check-dod-mapping.cjs"
      contains: "validateManualEvidence"
    test: "tests/gate/scan-rci-coverage.test.ts"

  - id: C9-002
    feature: C9
    name: "manual_verifications 必须包含必需字段"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [devgate, dod, manual, security, v11.12.1]
    owner: infra
    steps:
      given: "manual_verifications 记录存在"
      when: "validateManualEvidence 检查"
      then: "必须包含 actor, timestamp, evidence 三个字段"
    evidence:
      type: code
      file: "scripts/devgate/check-dod-mapping.cjs"
      contains: "!verification.actor || !verification.timestamp || !verification.evidence"
    test: "tests/gate/scan-rci-coverage.test.ts"

  # --------------------------------------------------------------------------
  # C10: CI Security Fixes (P0 v11.12.2)
  # --------------------------------------------------------------------------
  - id: C10-001
    feature: C10
    name: "auto-merge 不再有 check_suite 触发器"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, security, auto-merge, v11.12.2]
    owner: infra
    steps:
      given: "auto-merge.yml 文件存在"
      when: "检查触发器配置"
      then: "不包含 check_suite 触发器"
    note: "v11.12.2 P0-1: 防止外部 CI 绕过 approval 直接合并"
    evidence:
      type: code
      file: ".github/workflows/auto-merge.yml"
      not_contains: "check_suite:"
    test: "tests/ci/auto-merge.test.ts"

  - id: C10-002
    feature: C10
    name: "ci-passed 条件根据目标分支检查"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, security, ci-passed, v11.12.2]
    owner: infra
    steps:
      given: "ci.yml 中 ci-passed job 定义"
      when: "PR 到 develop 时"
      then: "regression-pr 必须成功（不允许 skipped）"
    note: "v11.12.2 P0-2: 防止关键检查被静默跳过"
    evidence:
      type: code
      file: ".github/workflows/ci.yml"
      contains: "github.base_ref != 'develop' || needs.regression-pr.result == 'success'"
    test: "tests/ci/ci-passed.test.ts"

  - id: C10-003
    feature: C10
    name: "ai-review 不再有 continue-on-error"
    scope: ci
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [ci, security, ai-review, v11.12.2]
    owner: infra
    steps:
      given: "ci.yml 中 ai-review job 定义"
      when: "检查错误处理配置"
      then: "不包含 continue-on-error: true"
    note: "v11.12.2 P1-1: 让 AI review 失败正确报告"
    evidence:
      type: code
      file: ".github/workflows/ci.yml"
      job: "ai-review"
      not_contains: "continue-on-error: true"
    test: "tests/ci/ai-review.test.ts"

# ============================================================================
# Export 回归契约
# ============================================================================
export:
  # --------------------------------------------------------------------------
  # E1: QA Reporting
  # --------------------------------------------------------------------------
  - id: E1-001
    feature: E1
    name: "QA 审计脚本输出合法 JSON"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, qa, json]
    owner: infra
    steps:
      given: "项目包含 regression-contract.yaml 和 FEATURES.md"
      when: "运行 bash scripts/qa-report.sh"
      then: "输出合法的 JSON 格式"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh | jq . > /dev/null && echo valid"
      contains: "valid"
    test: "scripts/qa-report.sh"

  - id: E1-002
    feature: E1
    name: "QA JSON 包含完整结构"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, qa, json, schema]
    owner: infra
    steps:
      given: "运行 qa-report.sh"
      when: "解析 JSON 输出"
      then: "包含 repo, version, timestamp, summary, features, rcis, golden_paths, gates 字段"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh | jq 'keys'"
      contains: "repo"
    test: "scripts/qa-report.sh"

  - id: E1-003
    feature: E1
    name: "QA 审计 summary 计算正确"
    scope: export
    priority: P2
    trigger: [Release]
    method: auto
    tags: [export, qa, summary]
    owner: infra
    steps:
      given: "项目包含完整的 QA 基础设施"
      when: "解析 summary 字段"
      then: "meta, unit, e2e 百分比在 0-100 范围内"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh --fast | jq '.summary.overall'"
      contains: "[0-9]+"
      description: "返回 0-100 的数字"
    test: "scripts/qa-report.sh"

  # --------------------------------------------------------------------------
  # E2: Dev Session Reporting
  # --------------------------------------------------------------------------
  - id: E2-001
    feature: E2
    name: "开发任务报告生成 JSON"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, dev, session, json]
    owner: workflow
    steps:
      given: "完成一次 /dev 流程"
      when: "cleanup 阶段调用 generate-report.sh"
      then: "在 .dev-runs/ 生成 JSON 报告"
    evidence:
      type: file
      path: ".dev-runs/*-report.json"
      exists: true
    test: "skills/dev/scripts/generate-report.sh"

  - id: E2-002
    feature: E2
    name: "报告包含 mode 字段"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, dev, session, mode]
    owner: workflow
    steps:
      given: "生成开发任务报告"
      when: "解析 JSON"
      then: "包含 mode 字段（interactive 或 headless）"
    evidence:
      type: command
      run: "jq '.mode' .dev-runs/*-report.json"
      contains: "interactive|headless"
      description: "返回 interactive 或 headless"
    test: "skills/dev/scripts/generate-report.sh"

  - id: E2-003
    feature: E2
    name: "报告包含质检结果"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, dev, session, quality]
    owner: workflow
    steps:
      given: "生成开发任务报告"
      when: "解析 JSON"
      then: "包含 quality_report 字段（L1/L2/L3 状态）"
    evidence:
      type: command
      run: "jq '.quality_report' .dev-runs/*-report.json"
      contains: "L1_automated|L2_verification|L3_acceptance"
      description: "返回 L1/L2/L3 状态对象"
    test: "skills/dev/scripts/generate-report.sh"

# ============================================================================
# N8N Integration 回归契约
# ============================================================================
n8n:
  # --------------------------------------------------------------------------
  # P1: Regression Testing Framework - 回归测试框架
  # --------------------------------------------------------------------------
  - id: P1-001
    feature: P1
    name: "rc-filter.sh 正确过滤 RCI"
    scope: regression
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [regression, filter, pr, release]
    owner: qa
    steps:
      given: "regression-contract.yaml 存在多个 trigger 的 RCI"
      when: "运行 bash scripts/rc-filter.sh pr"
      then: "只输出 trigger 包含 PR 的 RCI id"
    evidence:
      type: command
      run: "bash scripts/rc-filter.sh pr | head -5"
      contains: "H1-001|H2-001"
    test: "bash scripts/rc-filter.sh pr && bash scripts/rc-filter.sh release"

  - id: P1-002
    feature: P1
    name: "run-regression.sh 执行回归测试"
    scope: regression
    priority: P0
    trigger: [Release]
    method: auto
    tags: [regression, execution]
    owner: qa
    steps:
      given: "RCI 定义存在"
      when: "运行 bash scripts/run-regression.sh"
      then: "执行对应的自动化测试"
    evidence:
      type: command
      run: "bash scripts/run-regression.sh --dry-run"
      contains: "tests/"
    test: "bash scripts/run-regression.sh --dry-run"

  - id: P1-003
    feature: P1
    name: "regression-contract.yaml 格式解析"
    scope: regression
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [regression, yaml, validation]
    owner: qa
    steps:
      given: "regression-contract.yaml 存在"
      when: "使用 yq 解析 YAML 结构"
      then: "成功解析 rci_definitions 数组"
    evidence:
      type: command
      run: "yq '.rci_definitions | length' regression-contract.yaml"
      contains: "[0-9]+"
    test: "yq '.rci_definitions[] | select(.id == \"H1-001\")' regression-contract.yaml"

  # --------------------------------------------------------------------------
  # P2: DevGate Quality Checks
  # --------------------------------------------------------------------------
  - id: P2-001
    feature: P2
    name: "qa-with-gate.sh 执行"
    scope: devgate
    priority: P2
    trigger: [Release]
    method: manual
    tags: [devgate, qa, v10.0.0]
    owner: qa
    steps:
      given: "执行 QA 检查"
      when: "运行 scripts/qa-with-gate.sh"
      then: "执行完整的 QA 检查流程，输出结果"
    evidence:
      type: manual
      desc: "验证 QA 检查流程完整性"

  # --------------------------------------------------------------------------
  # N1: Infrastructure Scripts
  # --------------------------------------------------------------------------
  - id: N1-001
    feature: N1
    name: "generate-path-views.sh 视图生成"
    scope: infrastructure
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [contract, views, v10.0.0, contract-rebase]
    owner: infra
    steps:
      given: "feature-registry.yml 已更新"
      when: "运行 scripts/generate-path-views.sh"
      then: "生成 MINIMAL/GOLDEN/OPTIMAL-PATHS.md 派生视图"
    evidence:
      type: manual
      desc: "验证视图生成无 git diff"

  - id: N1-002
    feature: N1
    name: "sync-version.sh 版本同步"
    scope: infrastructure
    priority: P2
    trigger: [PR]
    method: manual
    tags: [version, v11.13.0]
    owner: infra
    steps:
      given: "package.json 版本已更新"
      when: "运行 scripts/sync-version.sh"
      then: "VERSION, hook-core/VERSION, regression-contract.yaml 版本同步"
    evidence:
      type: manual
      desc: "验证 --check 模式无差异"

# ============================================================================
# Golden Paths (E2E 关键链路)
# ============================================================================
#
# Golden Path = 端到端链路验证，跨多个 RCI 的组合断言
# Engine 的 GP = 流程链路（/dev → PR → CI）
# 业务 repo 的 GP = 用户链路（登录 → 操作 → 结果）
#
# ============================================================================
golden_paths:
  # --------------------------------------------------------------------------
  # GP-001: 完整开发流程
  # --------------------------------------------------------------------------
  - id: GP-001
    name: "完整开发流程"
    description: "/dev → 模式检测 → 分支 → DoD → 循环修复 → PR Gate → CI → 合并"
    trigger: [Release]
    method: manual
    rcis:
      - W5-001  # new 模式检测
      - W5-002  # continue 模式检测
      - W1-001  # /dev 流程可启动
      - W1-002  # 分支自动创建
      - W1-003  # DoD 自动生成
      - W3-001  # 质检失败触发回退
      - W3-002  # CI 失败触发回退
      - H2-003  # L1 通过允许 PR 创建
      - C1-001  # PR 版本号必须递增
      - C2-001  # CI 运行 npm run qa
    verification:
      type: end-to-end
      steps:
        - "运行 /dev，确认模式检测（new/continue）"
        - "确认 cp-* 分支自动创建"
        - "确认 .dod.md 生成"
        - "运行 npm run qa，确认通过"
        - "若失败，确认自动回退到修复循环"
        - "创建 PR，确认 PR Gate 放行"
        - "等待 CI 通过，确认可合并"

  # --------------------------------------------------------------------------
  # GP-002: 分支保护链路
  # --------------------------------------------------------------------------
  - id: GP-002
    name: "分支保护链路"
    description: "main 写 → 拦截 → cp-* 写 → 通过"
    trigger: [Release]
    method: auto
    rcis:
      - H1-001  # 分支保护拦截 main/develop 写入
      - H1-002  # cp-* 分支允许写入
    verification:
      type: end-to-end
      steps:
        - "切换到 main 分支"
        - "尝试写入代码文件，确认被 Hook 拦截"
        - "创建 cp-test 分支"
        - "尝试写入代码文件，确认 Hook 放行"
    test: "tests/hooks/branch-protect.test.ts"

  # --------------------------------------------------------------------------
  # GP-003: PR Gate 链路
  # --------------------------------------------------------------------------
  - id: GP-003
    name: "PR Gate 链路"
    description: "L1 失败 → 阻止 / L1 通过 → 放行"
    trigger: [Release]
    method: auto
    rcis:
      - H2-001  # PR Gate 拦截 gh pr create
      - H2-002  # L1 失败阻止 PR 创建
      - H2-003  # L1 通过允许 PR 创建
      - H2-005  # 默认 PR 模式只检查 L1
    verification:
      type: end-to-end
      steps:
        - "引入一个 typecheck 错误"
        - "运行 gh pr create，确认被 Hook 阻止"
        - "修复错误，npm run qa 通过"
        - "运行 gh pr create，确认 Hook 放行"
    test: "tests/hooks/pr-gate.test.ts"

  # --------------------------------------------------------------------------
  # GP-004: CI 链路
  # --------------------------------------------------------------------------
  - id: GP-004
    name: "CI 链路"
    description: "PR → 版本检查 → 测试 → Shell 检查 → Release 检查"
    trigger: [Release]
    method: auto
    rcis:
      - C1-001  # PR 版本号必须递增
      - C2-001  # CI 运行 npm run qa
      - C3-001  # Shell 脚本语法检查
      - C5-001  # Release 前 DoD 完成度检查
    verification:
      type: ci
      steps:
        - "创建 PR（不更新版本号）→ 确认 version-check 失败"
        - "更新版本号，推送 → 确认 version-check 通过"
        - "确认 test job 执行 typecheck + test + build"
        - "确认 shell-check job 检查所有 .sh 文件"
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # GP-005: Export 链路
  # --------------------------------------------------------------------------
  - id: GP-005
    name: "Export 链路"
    description: "QA 审计 + Dev Session 报告输出"
    trigger: [Release]
    method: auto
    rcis:
      - E1-001  # QA 审计脚本输出合法 JSON
      - E1-002  # QA JSON 包含完整结构
      - E2-001  # 开发任务报告生成 JSON
      - E2-002  # 报告包含 mode 字段
      - E2-003  # 报告包含质检结果
    verification:
      type: end-to-end
      steps:
        - "运行 bash scripts/qa-report.sh，确认输出合法 JSON"
        - "完成一次 /dev 流程，确认 .dev-runs/ 生成报告"
        - "检查报告包含 mode 字段（interactive/headless）"
    test: "scripts/qa-report.sh"

  # --------------------------------------------------------------------------
  # GP-006: N8N/Cecilia 无头链路
  # --------------------------------------------------------------------------
  - id: GP-006
    name: "N8N/Cecilia 无头链路"
    description: "N8N Webhook → cecilia CLI → PRD 执行 → JSON 结果"
    trigger: [Release]
    method: auto
    rcis:
      - N1-001  # Cecilia CLI 健康检查
      - N1-002  # Cecilia 执行 PRD Task
      - N1-003  # N8N Workflow 定义存在
      - E2-002  # 报告包含 mode 字段 (headless)
    verification:
      type: end-to-end
      steps:
        - "运行 cecilia --health，确认返回 healthy: true"
        - "运行 cecelia -p test-prd.json -t T-001，确认执行成功"
        - "检查输出 JSON 包含 success 字段"
        - "确认 N8N workflow JSON 文件存在"
    test: "cecilia --health"

# ============================================================================
# P0 质检强制三件套（Q1/Q2/Q3）
# ============================================================================
quality_enforcement:
  # --------------------------------------------------------------------------
  # Q1: Impact Check - 能力变更强制登记
  # --------------------------------------------------------------------------
  - id: Q1-001
    feature: Q1
    name: "Impact Check 检测核心文件改动"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [devgate, feature-registry, capability]
    owner: infra
    steps:
      given: "PR 改动了 hooks/, skills/, scripts/detect-phase.sh, scripts/qa-with-gate.sh"
      when: "CI 运行 impact-check job"
      then: "检测到核心文件改动，验证 feature-registry.yml 同时更新"
    evidence:
      type: ci-log
      contains: "检测到核心能力文件改动"
    verification:
      type: manual
      description: "创建 PR 改动 hooks/，观察 CI impact-check job 是否检测到"

  - id: Q1-002
    feature: Q1
    name: "Impact Check 验证 registry 同时更新"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [devgate, feature-registry]
    owner: infra
    steps:
      given: "核心文件已改动"
      when: "impact-check.sh 检查 feature-registry.yml"
      then: "如果 registry 未更新，CI 失败；如果已更新，CI 通过"
    evidence:
      type: ci-status
      expected: "改动核心文件不改 registry → FAIL；同时改动 → PASS"
    verification:
      type: manual
      description: "本 PR 会验证（改了 scripts/qa-with-gate.sh + registry）"

  - id: Q1-003
    feature: Q1
    name: "Impact Check 前向一致性"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [devgate, forward-consistency]
    owner: infra
    steps:
      given: "PR 只改动 feature-registry.yml（未改核心文件）"
      when: "impact-check.sh 检查"
      then: "允许通过（文档更新场景）"
    evidence:
      type: ci-status
      expected: "只改 registry → PASS（不要求改能力）"
    verification:
      type: manual
      description: "创建只改 registry 的 PR，确认 CI 通过"

  # --------------------------------------------------------------------------
  # Q2: Evidence Gate - 质检证据门控
  # --------------------------------------------------------------------------
  - id: Q2-001
    feature: Q2
    name: "Evidence 文件自动生成"
    scope: script
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [qa-gate, evidence, json]
    owner: infra
    steps:
      given: "npm run qa:gate 成功"
      when: "qa-with-gate.sh 执行完成"
      then: "自动生成 .quality-evidence.json，包含 SHA/Decision/timestamp"
    evidence:
      type: file
      path: ".quality-evidence.json"
      schema: '{"sha": "string", "audit_decision": "PASS", "qa_gate_passed": true}'
    verification:
      type: manual
      description: "本 PR 已验证（.quality-evidence.json 已提交）"

  - id: Q2-002
    feature: Q2
    name: "Evidence SHA 验证防冒用"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [evidence-gate, sha-validation, security]
    owner: infra
    steps:
      given: "PR 包含 .quality-evidence.json"
      when: "CI evidence-gate job 验证"
      then: "检查 json.sha == HEAD，如果不匹配则 CI 失败"
    evidence:
      type: ci-log
      contains: "SHA 验证通过"
    verification:
      type: manual
      description: "本 PR 会验证（CI 检查 SHA 匹配 HEAD）"

  - id: Q2-003
    feature: Q2
    name: "Evidence 字段完整性验证"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [evidence-gate, validation]
    owner: infra
    steps:
      given: ".quality-evidence.json 存在"
      when: "evidence-gate job 验证"
      then: "检查所有必需字段存在且格式正确"
    evidence:
      type: ci-log
      contains: "必需字段齐全"
    verification:
      type: manual
      description: "本 PR 会验证（CI 检查字段完整性）"

  # --------------------------------------------------------------------------
  # Q3: Anti-Bypass Contract - 远端强制兜底
  # --------------------------------------------------------------------------
  - id: Q3-001
    feature: Q3
    name: "Quality Contract 文档完整性"
    scope: doc
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [documentation, contract]
    owner: infra
    steps:
      given: "docs/contracts/QUALITY-CONTRACT.md 存在"
      when: "人工审查文档"
      then: "包含本地 vs 远端职责映射表、P0 三件套说明、Branch Protection 要求"
    evidence:
      type: doc-review
      checklist:
        - "本地 vs 远端职责映射表清晰"
        - "P0-1/P0-2/P0-3 说明完整"
        - "Branch Protection 配置要求明确"
    verification:
      type: manual
      description: "本 PR 已验证（文档已审查）"

  - id: Q3-002
    feature: Q3
    name: "职责边界清晰定义"
    scope: doc
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [contract, boundary]
    owner: infra
    steps:
      given: "QUALITY-CONTRACT.md 定义职责边界"
      when: "团队成员阅读文档"
      then: "理解本地=加速失败，远端=最终强制"
    evidence:
      type: doc-content
      contains: "本地 Hooks = 加速失败 / 远端 CI + Branch Protection = 最终强制"
    verification:
      type: manual
      description: "文档审查确认原则清晰"
  # --------------------------------------------------------------------------
  # Q5: RISK SCORE Trigger - QA Decision 自动触发机制
  # --------------------------------------------------------------------------
  - id: Q5-001
    feature: Q5
    name: "RISK SCORE 计算准确性"
    scope: script
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [qa-decision, risk-score, automation]
    owner: infra
    steps:
      given: "PR 改动文件涉及 R1-R8 规则"
      when: "执行 node scripts/qa/risk-score.cjs --base develop --head HEAD"
      then: "正确识别触发的规则，计算 RISK SCORE，≥3 分时 requiresQA: true"
    evidence:
      type: json-output
      contains: '{"riskScore": 4, "rules": ["R3", "R5", "R6", "R7"], "requiresQA": true}'
    verification:
      type: manual
      description: "本 PR 已验证（risk-score.cjs 检测到 4 个风险点）"

  - id: Q5-002
    feature: Q5
    name: "≥3 分触发 QA Node"
    scope: workflow
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [qa-decision, trigger]
    owner: infra
    steps:
      given: "RISK SCORE >= 3"
      when: "/dev 工作流 Step 3 检查风险分数"
      then: "执行完整 QA Decision Node，生成 docs/QA-DECISION.md"
    evidence:
      type: file
      path: "docs/QA-DECISION.md"
      contains: "Scope, Forbidden, Tests, RCI"
    verification:
      type: manual
      description: "本 PR 已验证（生成了 QA-DECISION.md）"

  # --------------------------------------------------------------------------
  # Q6: Structured Audit - 结构化 Audit 验证流程
  # --------------------------------------------------------------------------
  - id: Q6-001
    feature: Q6
    name: "Scope/Forbidden/Proof 验证准确性"
    scope: script
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [audit, scope, forbidden, proof]
    owner: infra
    steps:
      given: "QA-DECISION.md 定义了 Scope/Forbidden/Tests"
      when: "执行 compare-scope.cjs, check-forbidden.cjs, check-proof.cjs"
      then: "正确验证实际改动是否符合合同定义"
    evidence:
      type: json-output
      contains: '{"scopeCheck": {"pass": true}, "forbiddenCheck": {"pass": true}, "proofCheck": {"pass": true}}'
    verification:
      type: manual
      description: "本 PR 已验证（所有检查通过）"

  - id: Q6-002
    feature: Q6
    name: "AUDIT-REPORT.md 生成正确"
    scope: script
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [audit, report]
    owner: infra
    steps:
      given: "Audit 验证完成"
      when: "执行 generate-report.cjs --base develop --head HEAD"
      then: "生成结构化 AUDIT-REPORT.md，Decision 为 PASS 或 FAIL"
    evidence:
      type: file
      path: "docs/AUDIT-REPORT.md"
      contains: "Decision: PASS"
    verification:
      type: manual
      description: "本 PR 已验证（生成了 AUDIT-REPORT.md with Decision: PASS）"

  # --------------------------------------------------------------------------
  # G1: Gate Skill Family - 签名 Gate 文件机制
  # --------------------------------------------------------------------------
  - id: G1-001
    feature: G1
    name: "generate-gate-file.sh 生成签名文件"
    scope: script
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [gate, signature, generate]
    owner: infra
    steps:
      given: "Gate 审核通过（prd/dod/test/audit）"
      when: "执行 scripts/gate/generate-gate-file.sh <gate_type>"
      then: "生成 .gate-<type>-passed JSON 文件，包含签名"
    evidence:
      type: file
      path: ".gate-*-passed"
      contains: "signature"
    verification:
      type: manual
      description: "运行 generate-gate-file.sh 验证生成的文件"

  - id: G1-002
    feature: G1
    name: "verify-gate-signature.sh 验证签名"
    scope: script
    priority: P1
    trigger: [PR, Release]
    method: manual
    tags: [gate, signature, verify]
    owner: infra
    steps:
      given: ".gate-*-passed 文件存在"
      when: "执行 scripts/gate/verify-gate-signature.sh <file>"
      then: "验证签名正确、分支匹配，返回 exit 0"
    evidence:
      type: exit_code
      equals: 0
    verification:
      type: manual
      description: "运行 verify-gate-signature.sh 验证签名检查"

  - id: G1-003
    feature: G1
    name: "伪造签名被拒绝"
    scope: script
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [gate, signature, security]
    owner: infra
    steps:
      given: "伪造的 .gate-*-passed 文件（签名错误）"
      when: "执行 verify-gate-signature.sh"
      then: "返回 exit 2，输出签名无效错误"
    evidence:
      type: exit_code
      equals: 2
    verification:
      type: manual
      description: "创建伪造签名文件验证拒绝"

  - id: G1-004
    feature: G1
    name: "分支不匹配被拒绝"
    scope: script
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [gate, branch, security]
    owner: infra
    steps:
      given: ".gate-*-passed 文件分支与当前分支不同"
      when: "执行 verify-gate-signature.sh"
      then: "返回 exit 3，输出分支不匹配错误"
    evidence:
      type: exit_code
      equals: 3
    verification:
      type: manual
      description: "创建错误分支文件验证拒绝"
