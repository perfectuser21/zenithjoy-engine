# ============================================================================
# Regression Contract - ZenithJoy Engine
# ============================================================================
#
# 全量回归的唯一合法定义来源
#
# Trigger 规则：
#   - PR Gate:      跑 trigger 包含 PR 的条目
#   - Release Gate: 跑 trigger 包含 Release 的条目
#   - Nightly:      跑全部条目（忽略 trigger 过滤）
#
# Method 规则：
#   - auto:   必须有 test 字段指向自动化测试
#   - manual: 无 test 字段，需人工验证
#
# ============================================================================

version: "1.5.0"
updated: "2026-01-21"

# ============================================================================
# Hooks 回归契约
# ============================================================================
hooks:
  # --------------------------------------------------------------------------
  # H1: branch-protect
  # --------------------------------------------------------------------------
  - id: H1-001
    feature: H1
    name: "分支保护拦截 main/develop 写入"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [branch, write-protect, security]
    owner: infra
    steps:
      given: "当前在 main 或 develop 分支"
      when: "尝试写入代码文件（Write/Edit 工具）"
      then: "Hook 阻止并提示切换到 cp-* 或 feature/* 分支"
    evidence:
      type: log
      contains: "请先创建工作分支"
    test: "tests/hooks/branch-protect.test.ts"

  - id: H1-002
    feature: H1
    name: "cp-* 分支允许写入"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [branch, write-protect]
    owner: infra
    steps:
      given: "当前在 cp-* 分支"
      when: "尝试写入代码文件"
      then: "Hook 放行（exit 0）"
    evidence:
      type: exit_code
      equals: 0
    test: "tests/hooks/branch-protect.test.ts"

  - id: H1-003
    feature: H1
    name: "feature/* 分支允许写入"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [branch, write-protect]
    owner: infra
    steps:
      given: "当前在 feature/* 分支"
      when: "尝试写入代码文件"
      then: "Hook 放行（exit 0）"
    evidence:
      type: exit_code
      equals: 0
    test: "tests/hooks/branch-protect.test.ts"

  # --------------------------------------------------------------------------
  # H2: pr-gate-v2
  # --------------------------------------------------------------------------
  - id: H2-001
    feature: H2
    name: "PR Gate 拦截 gh pr create"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality]
    owner: infra
    steps:
      given: "在任意分支"
      when: "执行包含 'gh pr create' 的 Bash 命令"
      then: "Hook 运行 L1 质检"
    evidence:
      type: log
      contains: "PR GATE"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-002
    feature: H2
    name: "L1 失败阻止 PR 创建"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality]
    owner: infra
    steps:
      given: "typecheck 或 test 或 build 失败"
      when: "执行 gh pr create"
      then: "Hook 阻止并返回 exit 2"
    evidence:
      type: exit_code
      equals: 2
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-003
    feature: H2
    name: "L1 通过允许 PR 创建"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, quality]
    owner: infra
    steps:
      given: "npm run qa 全绿"
      when: "执行 gh pr create"
      then: "Hook 放行（exit 0）"
    evidence:
      type: log
      contains: "✅ PR Gate 通过"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-004
    feature: H2
    name: "双模式：--base main 触发 Release 模式"
    scope: hook
    priority: P1
    trigger: [Release]
    method: auto
    tags: [pr, gate, release]
    owner: infra
    steps:
      given: "执行 gh pr create --base main"
      when: "Hook 解析命令"
      then: "自动切换到 Release 模式，检查 L2B + L3"
    evidence:
      type: log
      contains: "Release 模式"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-005
    feature: H2
    name: "双模式：默认 PR 模式只检查 L1"
    scope: hook
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate]
    owner: infra
    steps:
      given: "执行 gh pr create（无 --base main）"
      when: "Hook 解析命令"
      then: "使用 PR 模式，只检查 L1"
    evidence:
      type: log
      contains: "PR 模式 (L1 only)"
    test: "tests/hooks/pr-gate.test.ts"

  - id: H2-006
    feature: H2
    name: "DoD 文件检查（PR 模式）"
    scope: hook
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [pr, gate, dod]
    owner: infra
    steps:
      given: "PR 模式下"
      when: ".dod.md 不存在或未更新"
      then: "Hook 报错并阻止 PR"
    evidence:
      type: log
      contains: "DoD"
    test: "tests/hooks/pr-gate.test.ts"

# ============================================================================
# Workflow 回归契约
# ============================================================================
workflow:
  # --------------------------------------------------------------------------
  # W1: /dev 11 步流程
  # --------------------------------------------------------------------------
  - id: W1-001
    feature: W1
    name: "/dev 流程可启动"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, entry]
    owner: workflow
    steps:
      given: "用户在项目根目录"
      when: "运行 /dev 或说开发需求"
      then: "Skill 加载，显示 PRD 确认步骤"
    evidence:
      type: screenshot
      description: "Skill 加载截图"

  - id: W1-002
    feature: W1
    name: "分支自动创建"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, branch]
    owner: workflow
    steps:
      given: "PRD 确认后进入 Step 3"
      when: "Claude 执行分支创建"
      then: "创建 cp-MMDDHHNN-task 格式分支"
    evidence:
      type: command
      run: "git branch --show-current"
      contains: "cp-"

  - id: W1-003
    feature: W1
    name: "DoD 自动生成"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, dod]
    owner: workflow
    steps:
      given: "分支创建后进入 Step 4"
      when: "Claude 推演 DoD"
      then: "生成 .dod.md 文件，包含验收标准"
    evidence:
      type: file
      path: ".dod.md"
      exists: true

  - id: W1-004
    feature: W1
    name: "Loop 1 循环（5→6→7）"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, loop]
    owner: workflow
    steps:
      given: "Step 7 质检失败"
      when: "发现问题"
      then: "返回 Step 5 继续修复，而非结束"
    evidence:
      type: log
      description: "对话记录显示循环"

  - id: W1-005
    feature: W1
    name: "CI 失败后循环"
    scope: workflow
    priority: P1
    trigger: [Release]
    method: manual
    tags: [dev, loop, ci]
    owner: workflow
    steps:
      given: "Step 9 CI 红"
      when: "wait-for-merge.sh 检测到失败"
      then: "返回 Step 5 重新循环"
    evidence:
      type: log
      contains: "CI 失败"

  # --------------------------------------------------------------------------
  # W3: 循环回退
  # --------------------------------------------------------------------------
  - id: W3-001
    feature: W3
    name: "质检失败触发回退"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, loop, quality]
    owner: workflow
    steps:
      given: "Step 7 质检（npm run qa）失败"
      when: "Claude 检测到失败"
      then: "自动返回 Step 5 继续修复，而非中止流程"
    evidence:
      type: log
      description: "对话记录显示循环回退"

  - id: W3-002
    feature: W3
    name: "CI 失败触发回退"
    scope: workflow
    priority: P0
    trigger: [PR, Release]
    method: manual
    tags: [dev, loop, ci]
    owner: workflow
    steps:
      given: "Step 9 CI 红"
      when: "wait-for-merge.sh 检测到 CI 失败"
      then: "自动返回 Step 5 重新循环，而非中止"
    evidence:
      type: log
      contains: "CI 失败"

  # --------------------------------------------------------------------------
  # W4: 测试任务模式
  # --------------------------------------------------------------------------
  - id: W4-001
    feature: W4
    name: "[TEST] 前缀检测"
    scope: workflow
    priority: P2
    trigger: [Release]
    method: manual
    tags: [dev, test-mode]
    owner: workflow
    steps:
      given: "PRD 标题包含 [TEST]"
      when: "进入 Step 3"
      then: "设置 git config branch.*.is-test true"
    evidence:
      type: command
      run: "git config branch.*.is-test"
      contains: "true"

  - id: W4-002
    feature: W4
    name: "测试任务跳过版本更新"
    scope: workflow
    priority: P2
    trigger: [Release]
    method: manual
    tags: [dev, test-mode, version]
    owner: workflow
    steps:
      given: "is-test = true"
      when: "进入 Step 8 PR"
      then: "跳过 CHANGELOG 和版本号更新"
    evidence:
      type: file
      path: "CHANGELOG.md"
      description: "PR 内容不含版本变更"

# ============================================================================
# CI/Release 回归契约
# ============================================================================
ci:
  # --------------------------------------------------------------------------
  # C1: version-check
  # --------------------------------------------------------------------------
  - id: C1-001
    feature: C1
    name: "PR 版本号必须递增"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, version]
    owner: infra
    steps:
      given: "PR 包含代码改动"
      when: "CI 运行 version-check job"
      then: "package.json 版本号 > develop 分支版本"
    evidence:
      type: ci_job
      name: "version-check"
      status: success
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # C2: test job
  # --------------------------------------------------------------------------
  - id: C2-001
    feature: C2
    name: "CI 运行 npm run qa"
    scope: ci
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [ci, test, l1]
    owner: infra
    steps:
      given: "PR 提交"
      when: "CI 运行 test job"
      then: "typecheck + test + build 全绿"
    evidence:
      type: ci_job
      name: "test"
      status: success
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # C3: shell syntax check
  # --------------------------------------------------------------------------
  - id: C3-001
    feature: C3
    name: "Shell 脚本语法检查"
    scope: ci
    priority: P1
    trigger: [PR, Release]
    method: auto
    tags: [ci, shell, lint]
    owner: infra
    steps:
      given: "仓库包含 .sh 文件"
      when: "CI 运行 shell-check"
      then: "所有 .sh 文件 bash -n 通过"
    evidence:
      type: ci_job
      name: "shell-check"
      status: success
    test: ".github/workflows/ci.yml"

  # --------------------------------------------------------------------------
  # C4: notify-failure
  # --------------------------------------------------------------------------
  - id: C4-001
    feature: C4
    name: "CI 失败发送 Notion 通知"
    scope: ci
    priority: P2
    trigger: [Release]
    method: manual
    tags: [ci, notify]
    owner: infra
    steps:
      given: "CI 任何 job 失败"
      when: "CI workflow 完成"
      then: "发送 Notion 通知，包含失败链接"
    evidence:
      type: external
      platform: notion
      description: "Notion 页面收到通知"

# ============================================================================
# 业务代码回归契约
# ============================================================================
business:
  # --------------------------------------------------------------------------
  # B1: calculator
  # --------------------------------------------------------------------------
  - id: B1-001
    feature: B1
    name: "Calculator 单元测试"
    scope: business
    priority: P0
    trigger: [PR, Release]
    method: auto
    tags: [business, calculator, unit-test]
    owner: business
    steps:
      given: "calculator 模块存在"
      when: "运行 npm test"
      then: "80 个测试用例全绿"
    evidence:
      type: test_output
      contains: "80 passed"
    test: "tests/calculator.test.ts"

# ============================================================================
# Export 回归契约
# ============================================================================
export:
  # --------------------------------------------------------------------------
  # E1: QA Reporting
  # --------------------------------------------------------------------------
  - id: E1-001
    feature: E1
    name: "QA 审计脚本输出合法 JSON"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, qa, json]
    owner: infra
    steps:
      given: "项目包含 regression-contract.yaml 和 FEATURES.md"
      when: "运行 bash scripts/qa-report.sh"
      then: "输出合法的 JSON 格式"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh | jq . > /dev/null && echo valid"
      contains: "valid"
    test: "scripts/qa-report.sh"

  - id: E1-002
    feature: E1
    name: "QA JSON 包含完整结构"
    scope: export
    priority: P1
    trigger: [Release]
    method: auto
    tags: [export, qa, json, schema]
    owner: infra
    steps:
      given: "运行 qa-report.sh"
      when: "解析 JSON 输出"
      then: "包含 repo, version, timestamp, summary, features, rcis, golden_paths, gates 字段"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh | jq 'keys'"
      contains: "repo"
    test: "scripts/qa-report.sh"

  - id: E1-003
    feature: E1
    name: "QA 审计 summary 计算正确"
    scope: export
    priority: P2
    trigger: [Release]
    method: auto
    tags: [export, qa, summary]
    owner: infra
    steps:
      given: "项目包含完整的 QA 基础设施"
      when: "解析 summary 字段"
      then: "meta, unit, e2e 百分比在 0-100 范围内"
    evidence:
      type: command
      run: "bash scripts/qa-report.sh | jq '.summary.overall'"
      description: "返回 0-100 的数字"
    test: "scripts/qa-report.sh"

# ============================================================================
# Golden Paths (E2E 关键链路)
# ============================================================================
#
# Golden Path = 端到端链路验证，跨多个 RCI 的组合断言
# Engine 的 GP = 流程链路（/dev → PR → CI）
# 业务 repo 的 GP = 用户链路（登录 → 操作 → 结果）
#
# ============================================================================
golden_paths:
  # --------------------------------------------------------------------------
  # GP-001: 完整开发流程
  # --------------------------------------------------------------------------
  - id: GP-001
    name: "完整开发流程"
    description: "/dev → 分支 → DoD → 循环修复 → PR Gate → CI → 合并"
    trigger: [Release]
    method: manual
    rcis:
      - W1-001  # /dev 流程可启动
      - W1-002  # 分支自动创建
      - W1-003  # DoD 自动生成
      - W3-001  # 质检失败触发回退
      - W3-002  # CI 失败触发回退
      - H2-003  # L1 通过允许 PR 创建
      - C1-001  # PR 版本号必须递增
      - C2-001  # CI 运行 npm run qa
    verification:
      type: end-to-end
      steps:
        - "运行 /dev，确认流程启动"
        - "确认 cp-* 分支自动创建"
        - "确认 .dod.md 生成"
        - "运行 npm run qa，确认通过"
        - "若失败，确认自动回退到修复循环"
        - "创建 PR，确认 PR Gate 放行"
        - "等待 CI 通过，确认可合并"

  # --------------------------------------------------------------------------
  # GP-002: 分支保护链路
  # --------------------------------------------------------------------------
  - id: GP-002
    name: "分支保护链路"
    description: "main 写 → 拦截 → cp-* 写 → 通过"
    trigger: [Release]
    method: auto
    rcis:
      - H1-001  # 分支保护拦截 main/develop 写入
      - H1-002  # cp-* 分支允许写入
    verification:
      type: end-to-end
      steps:
        - "切换到 main 分支"
        - "尝试写入代码文件，确认被 Hook 拦截"
        - "创建 cp-test 分支"
        - "尝试写入代码文件，确认 Hook 放行"
    test: "tests/hooks/branch-protect.test.ts"

  # --------------------------------------------------------------------------
  # GP-003: PR Gate 链路
  # --------------------------------------------------------------------------
  - id: GP-003
    name: "PR Gate 链路"
    description: "L1 失败 → 阻止 / L1 通过 → 放行"
    trigger: [Release]
    method: auto
    rcis:
      - H2-001  # PR Gate 拦截 gh pr create
      - H2-002  # L1 失败阻止 PR 创建
      - H2-003  # L1 通过允许 PR 创建
      - H2-005  # 默认 PR 模式只检查 L1
    verification:
      type: end-to-end
      steps:
        - "引入一个 typecheck 错误"
        - "运行 gh pr create，确认被 Hook 阻止"
        - "修复错误，npm run qa 通过"
        - "运行 gh pr create，确认 Hook 放行"
    test: "tests/hooks/pr-gate.test.ts"

  # --------------------------------------------------------------------------
  # GP-004: CI 链路
  # --------------------------------------------------------------------------
  - id: GP-004
    name: "CI 链路"
    description: "PR → 版本检查 → 测试 → Shell 检查"
    trigger: [Release]
    method: auto
    rcis:
      - C1-001  # PR 版本号必须递增
      - C2-001  # CI 运行 npm run qa
      - C3-001  # Shell 脚本语法检查
    verification:
      type: ci
      steps:
        - "创建 PR（不更新版本号）→ 确认 version-check 失败"
        - "更新版本号，推送 → 确认 version-check 通过"
        - "确认 test job 执行 typecheck + test + build"
        - "确认 shell-check job 检查所有 .sh 文件"
    test: ".github/workflows/ci.yml"
