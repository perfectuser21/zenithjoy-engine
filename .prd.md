---
id: prd-p0-security-bugs
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: P0 安全漏洞修复

## 背景

深度代码审计发现 9 个 P0 级别致命性安全漏洞：

### branch-protect.sh (4 个 P0)
1. **P0-1**: jq 缺失时 `exit 0`，完全绕过分支保护
2. **P0-2**: 无 realpath 检查，symlink 可绕过全局配置保护
3. **P0-3**: 分支正则 `^cp-[a-zA-Z0-9]` 只检查一个字符，可被绕过
4. **P0-4**: PRD/DoD 内容检查过弱（已在之前修复，需验证）

### pr-gate-v2.sh (3 个 P0)
1. **P0-1**: `--repo fake/repo` 本地找不到 → `exit 0` 绕过所有检查
2. **P0-2**: 分支正则不严格，同上
3. **P0-3**: COMMAND 变量解析存在命令注入风险（需评估）

### run-regression.sh (2 个 P0)
1. **P0-1**: `eval "$evidence_run"` 命令注入（有白名单但仍不够安全）
2. **P0-2**: `eval ls "$file_path"` 路径注入

## 功能描述

修复所有 P0 级别安全漏洞，确保：
1. Hook 不能被绕过
2. 不存在命令注入风险
3. 保持向后兼容

## 成功标准

1. 所有 P0 漏洞修复完成
2. npm run qa 通过
3. bash -n 所有 .sh 文件通过

## 范围

| 文件 | 修复内容 |
|------|----------|
| hooks/branch-protect.sh | P0-1, P0-2, P0-3 |
| hooks/pr-gate-v2.sh | P0-1, P0-2 |
| scripts/run-regression.sh | P0-1, P0-2 |

## 不做

- P1/P2 级别问题（后续 PR 处理）
- 重构整体架构
- 添加新功能
