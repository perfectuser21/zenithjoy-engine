# PRD: 实施全新 CI 分层方案

## 背景

当前 CI 体系已经很完善（L1 + L2A + Evidence + Impact + DevGate + Contract Drift），但存在三个关键缺口：

1. **PR to develop 缺少 L2B**（最大断层）
2. **本地没有快速预检**（L3-fast / ci:preflight）
3. **AI Review（L2C）未接入**（语义/影响面兜底）

## 目标

补齐三个缺口，形成完整的四层 CI 体系：

- **L1**: typecheck + unit tests + build
- **L2A**: PRD/DoD/QA/Audit 产物与字段（已有）
- **L2B**: 可复核证据（.layer2-evidence.md + 截图/命令记录）
- **L3**: 最佳实践（lint/format/结构性规则）
- **L2C**: AI Review（语义、影响面遗漏、跨文件一致性）

## 核心改动

### 1. 新增 3 个脚本

- `scripts/devgate/l2b-check.sh`
  - 检查 `.layer2-evidence.md` 存在 + 格式合规
  - 支持两种模式：`pr`（L2B-min）和 `release`（L2B-full）

- `scripts/devgate/l3-fast.sh`
  - lint/format/轻量结构规则（快、无全量回归）

- `scripts/devgate/ci-preflight.sh`
  - 本地快速预检入口（L1-fast + L3-fast + 最小 L2A）

### 2. 修改 hooks/pr-gate-v2.sh

- 增加"稳定快入口"：在 PR 模式里先跑 `ci:preflight`（快，不 build）
- PR 模式也加 L2B-min 检查（让开发者推之前就知道证据缺失）

### 3. 修改 .github/workflows/ci.yml

- 新增独立 job `l2b-check`（触发：pull_request，needs: [test]）
- 新增 job `ai-review`（needs: [ci-passed]，调用 VPS Review API）
- 将 `l2b-check` 加入 `ci-passed` 的 needs

### 4. 更新 VPS Review API 提示词

- 专注 L2C（语义/影响面），不重复 CI 已覆盖的内容
- 输出格式：语义风险 + 影响面遗漏 + 设计建议 + 补充证据建议

### 5. 新增 npm scripts

```json
"ci:preflight": "bash scripts/devgate/ci-preflight.sh",
"lint": "echo 'TODO: add eslint'",
"format:check": "echo 'TODO: add prettier check'"
```

## 三条流水

1. **本地（加速失败）**
   - 入口：`npm run ci:preflight`
   - 内容：L1-fast（typecheck + test，不 build）+ L2A（最小）+ L3-fast

2. **PR CI（权威门控）**
   - 入口：GitHub Actions `ci.yml`
   - 内容：L1 + L2A + Evidence + Impact + DevGate + Drift + **L2B-min**

3. **Release（最严格）**
   - 入口：`release-check.sh`
   - 内容：L2B-full + L3 + DoD 全勾（保持不变）

## 验收标准

- [ ] 本地运行 `npm run ci:preflight` 成功（快速）
- [ ] PR to develop 时 CI 检查 L2B-min（有 `.layer2-evidence.md` 且格式正确）
- [ ] AI Review job 在 CI 全绿后运行，发 comment
- [ ] Release 时仍然强制 L2B-full
- [ ] 所有现有测试通过

## 非目标

- ❌ 改变现有 L1/L2A/Evidence/Impact/DevGate 逻辑
- ❌ 让 AI Review 阻断 PR（初期只评论）
- ❌ 在本地运行完整 L2B-full（太重）

## 技术细节

### L2B-min vs L2B-full

| 模式 | 要求 |
|------|------|
| **L2B-min** (PR to develop) | `.layer2-evidence.md` 存在 + 最小格式 + 至少 1 条可复核证据 |
| **L2B-full** (PR to main) | 完整 Evidence + DoD 全勾 + 截图/命令记录完整 |

### AI Review 提示词（L2C 专用）

```
你是 PR 语义审查员（L2C）。CI 已覆盖 typecheck/test/build/l2a/evidence/impact/devgate。
你的任务不是重复 CI，而是指出"语义逻辑风险、影响面遗漏、跨文件契约不一致、未来维护风险"。

输入：PR diff（可能截断）。
输出格式（纯文本，不用 markdown）：

## 语义风险（高）
[若无写"无"]

## 影响面遗漏（中）
[列出可能遗漏修改的文件/测试/文档/registry/契约点]

## 设计与一致性建议（低）
[命名/结构/一致性]

## 建议的补充证据（L2B）
[建议在 .layer2-evidence.md 加什么]

## 总体结论
[OK 或 NEEDS_ATTENTION]
```

## 涉及文件

- `scripts/devgate/l2b-check.sh` - 新增
- `scripts/devgate/l3-fast.sh` - 新增
- `scripts/devgate/ci-preflight.sh` - 新增
- `hooks/pr-gate-v2.sh` - 修改
- `.github/workflows/ci.yml` - 修改
- `package.json` - 新增 scripts
- VPS `/webhook/code-review` - 更新提示词

## 里程碑

- **M1**: 新增 3 个脚本 + npm scripts
- **M2**: 修改 pr-gate-v2.sh
- **M3**: 修改 ci.yml
- **M4**: 文档更新

## 风险

- **本地 preflight 超时**：限制 120s，只跑快速检查
- **AI Review 误判**：初期不阻断，只评论
- **L2B 格式不一致**：提供模板和示例
