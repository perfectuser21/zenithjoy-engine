# PRD - 彻底修复所有 AI 停顿点（Phase 2）

## 问题描述

虽然 PR #289 添加了 SKILL.md 的顶层"强制连续执行"规则，但实际执行流程中的关键停顿点根本没改：

### 用户反馈
"我现在用的还都是会卡，就是会停下来"

### 深度搜索发现的核心问题

**🔴 最高风险停顿点（每个任务都会卡）：**

1. **Skill 调用后无强制继续**
   - `skills/dev/steps/04-dod.md` Line 31-71: QA Decision Node 完成后无"立即继续"指令
   - `skills/dev/steps/07-quality.md` Audit Node 完成后无"立即继续"指令
   - AI 完成 `/qa` 或 `/audit` Skill 调用后会停顿等待确认

2. **Skill 文件缺少"完成后立即返回"指令**
   - `skills/qa/SKILL.md`: 生成 QA-DECISION.md 后无"立即返回"指令
   - `skills/audit/SKILL.md`: 生成 AUDIT-REPORT.md 后无"立即返回"指令
   - AI 自然会停下来总结或等待

3. **Stop Hook 语义不清**
   - `hooks/stop.sh` 的 6 个 exit 2 点输出是"建议"（"你需要..."）
   - AI 不知道 Ralph Loop 会自动重试
   - 误以为需要等待用户确认下一步

**🟠 中等风险停顿点（质检失败时会卡）：**

4. **Pending 状态的等待循环**
   - `skills/dev/steps/09.5-pending-wait.md` 的 `while true; sleep 30` 会挂住 AI
   - 应该立即 exit 0，而不是循环等待

## 根本原因分析

PR #289 只修复了**表层规则**（SKILL.md 顶层文档），但**执行链路的关键节点**没有修复：

| 层级 | PR #289 修复了吗 | 问题 |
|------|-----------------|------|
| L1: SKILL.md 顶层规则 | ✅ 已修复 | 添加了"⚡ 自动执行规则" |
| L2: Step 完成后指令 | ⚠️ 部分修复 | 只改了 04/05/06/07 的最后，没改 Node |
| L3: Skill 调用点 | ❌ 未修复 | QA Node/Audit Node 后无强制继续 |
| L4: Skill 返回行为 | ❌ 未修复 | /qa、/audit 缺"立即返回"指令 |
| L5: Hook 输出语义 | ❌ 未修复 | Stop Hook 是"建议"而非"命令" |
| L6: Pending 处理 | ❌ 未修复 | while 循环挂住 AI |

**结论**：L1 修复了，但 L3/L4/L5/L6 都没修复，所以用户"还是会卡"。

## 解决方案

### Phase 1: 修复 Skill 调用停顿（最高优先级 🔴）

#### 1.1 在 QA Node 和 Audit Node 后添加强制继续指令

**文件**：`skills/dev/steps/04-dod.md`

在 Line 71 (QA Node Schema 后) 添加：

```markdown
### ⚡ QA Node 完成后的强制指令

**生成 QA-DECISION.md 后，立即进入 Step 4.3 (DoD 定稿)**：

1. **不要**输出"QA 决策已生成！"
2. **不要**停顿或等待确认
3. **立即**继续下一步：补全 DoD 的 Test 字段
```

**文件**：`skills/dev/steps/07-quality.md`

在 Audit Node 后添加：

```markdown
### ⚡ Audit Node 完成后的强制指令

**生成 AUDIT-REPORT.md 后，立即继续质检循环**：

1. **不要**输出"审计报告已生成！"
2. **不要**停顿或等待确认
3. **立即**运行 `npm run qa:gate` 进入 Blocker 检查
```

#### 1.2 在 Skill 文件中添加"完成后立即返回"指令

**文件**：`skills/qa/SKILL.md`

在文件末尾添加：

```markdown
## ⚡ 完成后行为（CRITICAL）

**生成 QA-DECISION.md 后，立即返回调用方**：

1. **不要**输出"QA 决策已生成！现在返回 /dev 流程..."
2. **不要**停顿或输出总结
3. **立即**返回，让调用方（/dev）继续执行下一步
4. **绝对不要**等待用户确认

这个 Skill 的职责是"生成决策文件"，不是"等待确认"。
```

**文件**：`skills/audit/SKILL.md` - 添加相同指令

### Phase 2: 修复 Stop Hook 语义（中优先级 🟠）

**文件**：`hooks/stop.sh`

修改所有 exit 2 的输出消息，从"建议"改为"命令"：

**位置**：Line 115-121, 134-141, 159-165 等所有 exit 2 点

**旧**（建议性）：
```bash
echo "  你需要:"
echo "    1. 调用 /audit Skill 生成审计报告"
echo "    2. 或手动创建 docs/AUDIT-REPORT.md"
```

**新**（命令性 + Ralph Loop 说明）：
```bash
echo "  ⚡ Ralph Loop 自动重试机制："
echo "    1. Hook 返回 exit 2 = 阻止会话结束"
echo "    2. 你应该立即执行修复步骤"
echo "    3. 修复后会自动重新进入此检查"
echo ""
echo "  立即执行："
echo "    → 调用 /audit Skill 生成审计报告"
```

### Phase 3: 移除 Pending 等待循环（中优先级 🟠）

**文件**：`skills/dev/steps/09.5-pending-wait.md`

**问题代码**（Line 24-70）：
```markdown
while true; do
  sleep 30
  # 检查 CI 状态
done
```

**修复后**：
```markdown
## ⚡ Pending 状态处理（立即退出）

检测到 CI 状态为 pending：

1. **不要**进入 while 循环等待
2. **立即** exit 0，结束当前会话
3. **原因**：Ralph Loop 会在 CI 完成后自动唤醒新会话

这是两阶段工作流的设计：p0 结束后不等 CI，CI 完成后事件驱动 p1。
```

## 成功标准

### 功能验收

- [ ] QA Node 完成后立即进入 DoD 定稿（添加强制继续指令）
      Test: manual:step4-qa-node-continue
- [ ] Audit Node 完成后立即运行 qa:gate（添加强制继续指令）
      Test: manual:step7-audit-node-continue
- [ ] /qa Skill 完成后立即返回调用方（添加返回指令）
      Test: manual:qa-skill-return
- [ ] /audit Skill 完成后立即返回调用方（添加返回指令）
      Test: manual:audit-skill-return
- [ ] Stop Hook 输出改为命令性且说明 Ralph Loop（修改消息）
      Test: manual:stop-hook-semantic
- [ ] Pending 状态立即退出不循环（移除 while 循环）
      Test: manual:pending-no-loop
- [ ] 文档更新：feature-registry.yml 版本号
      Test: manual:registry-update

### 测试验收

- [ ] npm run qa 通过
      Test: contract:C2-001

## 优先级

**P0** - 用户每次使用 /dev 都会遇到停顿问题

## 影响范围

- Engine 核心流程
- 所有使用 /dev 的场景（有头 + 无头 Cecelia）
- 质检循环
- CI 修复流程（p1 阶段）

## 验收方式

1. 手动测试：运行 `/dev` 完整流程，观察是否在以下位置停顿：
   - Step 4 QA Node 后
   - Step 7 Audit Node 后
   - 质检失败时
   - Pending 状态时

2. 对比修复前后：
   - 修复前：会在 Node 后停顿，需要用户催促"继续"
   - 修复后：Node 完成后立即自动继续下一步

## 备注

这是 PR #289 的 Phase 2 修复。PR #289 只修复了顶层规则（L1），本次修复执行链路的关键节点（L3/L4/L5/L6）。
