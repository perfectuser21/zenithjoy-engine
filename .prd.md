---
id: prd-phase5-learnings
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 5 - LEARNINGS 自动写回

## 背景

Phase 4/4.1 实现了 DevGate Metrics 指标面板和 L2 阈值检查，但指标只存在于 CI artifact：
- 缺乏组织记忆：指标散落在各 nightly run 中
- 无法快速回顾：要看历史需要翻 artifact
- 不可引用：周报/复盘无法直接引用

## 功能描述

**nightly 指标 → 自动追加到 LEARNINGS.md → 组织记忆闭环**

### 核心逻辑

1. 读取 `devgate-metrics.json`
2. 生成结构化 markdown 块
3. 追加到 `docs/LEARNINGS.md`
4. 幂等：同月不重复追加

### 月度报告格式

```markdown
## [2026-01] DevGate 月度报告

### 指标概览
| 指标 | 值 |
|------|-----|
| P0 PRs | 3 |
| P1 PRs | 5 |
| RCI 覆盖率 | 100% |
| 新增 RCI | 4 |
| DoD 条目 | 28 |

### Top Offenders
(无)

### 新增 RCI IDs
- H4-001: DevGate Metrics 指标计算
- C7-001: Nightly DevGate Metrics 收集

### 生成时间
2026-01-31T18:00:00Z (nightly)
```

## 成功标准

1. `node scripts/devgate/append-learnings.cjs` 正确追加报告
2. 幂等：同月重复运行不追加
3. RCI 名称从 regression-contract.yaml 读取
4. nightly 集成：自动 commit + push

## 交付物

### 新增文件
- `scripts/devgate/append-learnings.cjs` - 核心逻辑
- `tests/hooks/append-learnings.test.ts` - 测试

### 修改文件
- `.github/workflows/nightly.yml` - 集成
- `regression-contract.yaml` - 新增 RCI

## 不做

- Web UI 展示
- 推送到 Notion
- 趋势图生成

## 技术要点

- 幂等检查：grep 月份标题是否已存在
- RCI 名称：解析 regression-contract.yaml 的 id → name 映射
- commit message：`docs: DevGate 月度报告 YYYY-MM`
