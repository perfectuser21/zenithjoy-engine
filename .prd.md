# PRD - CI 补齐 L2A + develop L3 子集

## 背景

当前 Engine 的质量门控有关键缺口：

### 问题 2 (P0)：CI 完全缺失 L2A
- CI 只检查 L1 (test) + L2B (DevGate) + Evidence Gate
- **不检查** PRD/DoD/QA-DECISION.md/AUDIT-REPORT.md
- 导致 `gh pr merge --auto` 可绕过本地 Hook

### 问题 3 (P1)：PR to develop 缺失 L3
- 回归测试只在 PR to main 时跑
- develop 分支在积累风险，main 才爆

### 问题 5 (P1)：GitHub 允许 auto-merge
- `required_approving_review_count: 0`
- 任何人可以直接 auto-merge（只需 CI 绿）

## 目标

建立**远端可信防线**，堵住所有绕过路径：

```
本地 Hook（快反馈）+ Actions（不可绕过）= 闭环审计链路
```

## 方案

### P0: CI 补 L2A（立刻堵绕过）

**新增**：`scripts/devgate/l2a-check.sh`
- 支持两种模式：`pr` / `release`
- 检查 4 个文件：
  - `.prd.md`: 存在 + 至少 3 行
  - `.dod.md`: 存在 + 至少 3 行 + 包含 `QA:`
    - Release 模式：全勾选（无 `- [ ]`）
  - `docs/QA-DECISION.md`: 存在 + 包含 `Decision:`
    - Release 模式：必须 `Decision: PASS`
  - `docs/AUDIT-REPORT.md`: 存在 + 包含 `Decision: PASS`

**修改**：`.github/workflows/ci.yml`
- `test` job 增加：`bash scripts/devgate/l2a-check.sh pr`
- `release-check` job 增加：`bash scripts/devgate/l2a-check.sh release`

### P1: develop PR 跑 L3 子集

**新增**：`regression-pr` job
- 条件：`if: github.base_ref == 'develop'`
- 执行：`bash scripts/run-regression.sh pr`
- 依赖：`needs: [test]`

### P1: ci-passed 条件 needs

**修改**：`ci-passed` job
- 正确处理条件 job（避免永远 pending）
- develop PR: needs `[test, regression-pr, impact-check, evidence-gate, contract-drift-check]`
- main PR: needs `[test, release-check, impact-check, evidence-gate, contract-drift-check]`

## 收益

**问题 2 解决**：
- `gh pr merge --auto` 也会被 CI L2A 拦住
- 无 PRD/DoD/QA/Audit → CI fail → 不能 merge

**问题 3 解决**：
- develop 不再"裸奔"
- 每个 PR 都跑 L3 子集（smoke）

**问题 5 缓解**：
- 虽然不强制 approval（solo dev）
- 但 required checks 变成"机器审查"
- auto-merge 前提：L1 + L2A + L2B + L3 全绿

## 非目标

- **不**在 L2A 中重复检查 `.quality-evidence.json`（已在 evidence-gate）
- **不**引入复杂解析逻辑（保持 CI 轻量）
- **不**强制 approval（solo dev 不适用）

## 验收标准

见 `.dod.md`
