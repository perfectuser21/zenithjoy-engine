---
id: prd-phase1-devgate-closedloop
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 1 - /dev 工作流闭环改造

## 背景

当前 /dev 工作流存在严重缺陷：
1. **DoD 和 CI 断开** - DoD 说完成了，但 CI 不验证
2. **P0/P1 修复没有强制测试** - 修了漏洞但没有回归测试
3. **regression-contract.yaml 没人维护** - 定义了但不更新
4. **Hook 自己没有测试** - 改坏了 Hook 没人发现

## 功能描述

实现 Phase 1 闭环：**DoD → Test → CI 强制验证链路**

### 核心规则

1. **DoD 强制绑定 Test ID**
   - 每条 DoD 必须包含 `Test:` 字段
   - 支持三种类型：
     - `Test: tests/...` - 自动化测试文件
     - `Test: contract:<RCI_ID>` - 引用 regression-contract.yaml
     - `Test: manual:<EVIDENCE_ID>` - 手动证据链

2. **P0/P1 强制更新 regression-contract.yaml**
   - 检测 PR 优先级（label / title prefix / env）
   - P0/P1 必须更新 regression-contract.yaml
   - 其他优先级：提示但不阻断

3. **PR Gate 验证映射**
   - 检查每条 DoD 的 Test 字段
   - 验证测试文件/契约ID/证据文件存在
   - 任何缺失 → 阻止合并

## 成功标准

1. DoD 缺少 Test 字段 → PR Gate 失败
2. Test 指向不存在的文件 → PR Gate 失败
3. P0/P1 未更新 regression-contract.yaml → PR Gate 失败
4. Hook 测试覆盖核心三条规则

## 交付物

### 新增文件
- `scripts/devgate/check-dod-mapping.cjs` - DoD ↔ Test 映射检查
- `scripts/devgate/detect-priority.cjs` - PR 优先级检测
- `scripts/devgate/require-rci-update-if-p0p1.sh` - P0/P1 强制 RCI 更新
- `tests/hooks/pr-gate-phase1.test.ts` - Phase 1 规则测试
- `evidence/manual/.gitkeep` - 手动证据目录

### 修改文件
- `templates/DOD-TEMPLATE.md` - 新 DoD 模板（强制 Test 字段）
- `hooks/pr-gate-v2.sh` - 接入 Phase 1 gates
- `.github/workflows/ci.yml` - 添加 Gate step

## 技术要点

- 脚本用 `.cjs` 后缀（兼容 ESM repo）
- BASE_REF 默认 `origin/develop`（我们的主开发线）
- Hook 只做薄封装，重逻辑在 scripts/devgate/

## 不做

- Phase 2 的历史版本化（PRD/DoD 快照）
- Phase 3 的多仓库治理（hook-core 子模块）
- 流程简化（统一 devtask.yaml）

## 风险

- 过渡期旧 PR 可能不符合新规则，需要补充 Test 字段
