# PRD - 自动化质检与自我进化机制

## 问题背景

用户反馈三类重复出现的问题：
1. **PRD/DoD 残留** - develop 分支上有旧的 PRD/DoD，导致新分支带上旧文件
2. **常见错误重复** - SHA 不匹配、派生视图未更新、Priority 误识别
3. **缺少自我评估** - 完成后没有 checklist 检查，问题需要用户指出

**核心诉求**："不能让我再发现这些问题" + "建立自我进化机制"

## 目标

### 立即修复

1. 从 develop 删除 `.prd.md` 和 `.dod.md`
2. 实现自动化脚本防止问题重复

### 长期机制

3. 建立 **Post-PR Checklist** - 每次 PR 合并后自动检查
4. 建立 **Self-Evolution 机制** - 把问题固化为检查项
5. 集成到 /dev 流程 - Step 11 (Cleanup) 自动运行

## 解决方案

### 1. 立即修复 develop

```bash
# 从 develop 删除 PRD/DoD
git checkout develop
git pull origin develop
git rm .prd.md .dod.md
git commit -m "chore: remove PRD/DoD from develop (should only exist in feature branches)"
git push origin develop
```

### 2. 自动化脚本

#### 2.1 `scripts/squash-evidence.sh` - 合并 evidence commit

**功能**：自动把 "chore: update quality evidence" commit 合并到前一个 commit

**调用时机**：Step 8 (PR) 创建 PR 前

```bash
#!/usr/bin/env bash
# 自动把 evidence commit 合并到代码 commit

LAST_MSG=$(git log -1 --pretty=%s)
if [[ "$LAST_MSG" == "chore: update quality evidence"* ]]; then
  echo "检测到 evidence commit，自动合并..."
  git reset --soft HEAD~1
  git commit --amend --no-edit
  echo "✅ 已合并到代码 commit"
else
  echo "不是 evidence commit，跳过"
fi
```

#### 2.2 `scripts/auto-generate-views.sh` - 自动生成派生视图

**功能**：检测 `feature-registry.yml` 变更，自动生成派生视图

**调用时机**：
- 方案 A：Pre-commit Hook（推荐）
- 方案 B：Step 7 (Quality) 中自动检查

```bash
#!/usr/bin/env bash
# 自动检测并生成派生视图

if git diff --cached --name-only | grep -q "features/feature-registry.yml"; then
  echo "检测到 feature-registry.yml 变更，自动生成派生视图..."
  bash scripts/generate-path-views.sh
  git add docs/paths/
  echo "✅ 派生视图已生成并暂存"
fi
```

#### 2.3 `scripts/post-pr-checklist.sh` - PR 后自检

**功能**：PR 合并后自动检查常见问题

**调用时机**：Step 11 (Cleanup) 或 CI 的 post-merge hook

```bash
#!/usr/bin/env bash
# Post-PR Checklist - 自动检查常见问题

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Post-PR Checklist"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

ERRORS=0

# 检查 1: develop/main 不应该有 PRD/DoD
if [[ "$(git branch --show-current)" == "develop" || "$(git branch --show-current)" == "main" ]]; then
  if git ls-files | grep -qE "^\.(prd|dod)\.md$"; then
    echo "❌ PRD/DoD 文件不应存在于 develop/main"
    ERRORS=$((ERRORS + 1))
  else
    echo "✅ develop/main 无 PRD/DoD 残留"
  fi
fi

# 检查 2: 派生视图是否同步
if [[ -f "features/feature-registry.yml" ]]; then
  REGISTRY_VERSION=$(grep "^version:" features/feature-registry.yml | awk '{print $2}' | tr -d '"')
  OPTIMAL_VERSION=$(grep "^version:" docs/paths/OPTIMAL-PATHS.md | awk '{print $2}' | tr -d '"')

  if [[ "$REGISTRY_VERSION" != "$OPTIMAL_VERSION" ]]; then
    echo "❌ 派生视图版本不匹配 (registry: $REGISTRY_VERSION, views: $OPTIMAL_VERSION)"
    ERRORS=$((ERRORS + 1))
  else
    echo "✅ 派生视图版本同步"
  fi
fi

# 检查 3: 是否有未跟踪的临时文件
TEMP_FILES=$(git ls-files --others --exclude-standard | grep -E "\.(tmp|bak|old)$" || true)
if [[ -n "$TEMP_FILES" ]]; then
  echo "⚠️ 发现临时文件:"
  echo "$TEMP_FILES"
else
  echo "✅ 无临时文件残留"
fi

# 检查 4: 是否有未 push 的 commit
UNPUSHED=$(git log @{u}.. --oneline 2>/dev/null || true)
if [[ -n "$UNPUSHED" ]]; then
  echo "⚠️ 有未 push 的 commit:"
  echo "$UNPUSHED"
else
  echo "✅ 所有 commit 已 push"
fi

echo ""
if [[ $ERRORS -gt 0 ]]; then
  echo "❌ 发现 $ERRORS 个问题，需要修复"
  exit 1
else
  echo "✅ 所有检查通过"
  exit 0
fi
```

### 3. Priority 检测优化

修改 `scripts/devgate/detect-priority.cjs`：

```javascript
// 优先级顺序：
// 1. docs/QA-DECISION.md 的 Priority 字段（最高优先级，明确来源）
// 2. 环境变量 PR_PRIORITY
// 3. PR labels
// 4. Git config branch.*.priority

// 移除：从 commit message 和 PR title 检测（容易误识别 "p1 阶段" 等文本）
```

### 4. 集成到 /dev 流程

#### Step 7 (Quality) 改进

```markdown
1. 运行审计：/audit
2. 运行测试：npm run qa:gate
3. **自动检查派生视图**：bash scripts/auto-generate-views.sh
4. 暂存 evidence（不 commit）：git add .quality-evidence.json .quality-gate-passed .history/
```

#### Step 8 (PR) 改进

```markdown
1. **合并 evidence commit**（如果有）：bash scripts/squash-evidence.sh
2. 一次性提交：git add . && git commit -m "..." && git push
3. 创建 PR：gh pr create
```

#### Step 11 (Cleanup) 改进

```markdown
1. 切回 develop：git checkout develop && git pull
2. **运行 Post-PR Checklist**：bash scripts/post-pr-checklist.sh
3. 如果发现问题 → 立即修复 → 提交
4. 记录到 LEARNINGS.md
```

### 5. CI 防护

在 `.github/workflows/ci.yml` 添加：

```yaml
- name: Check for PRD/DoD in develop/main
  if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
  run: |
    if git ls-files | grep -E "^\.(prd|dod)\.md$"; then
      echo "❌ PRD/DoD 文件不应存在于 develop/main 分支"
      echo "这些文件应该只存在于功能分支 (cp-*, feature/*)"
      exit 1
    fi
    echo "✅ 无 PRD/DoD 残留"
```

### 6. Self-Evolution 机制

创建 `docs/SELF-EVOLUTION.md` 记录：

```markdown
# Self-Evolution Log

## 问题 → 检查项 → 自动化

### 2026-01-26: PRD/DoD 残留

**问题**：develop 分支上有 PRD/DoD 文件
**根因**：PR squash merge 时带进来
**检查项**：
- [ ] develop/main 不应有 .prd.md / .dod.md
**自动化**：
- scripts/post-pr-checklist.sh 检查
- CI 自动检测并阻止

### 2026-01-26: SHA 不匹配

**问题**：evidence commit 导致 SHA 对不上
**根因**：代码 commit 和 evidence commit 分离
**检查项**：
- [ ] evidence commit 应该被 squash 到代码 commit
**自动化**：
- scripts/squash-evidence.sh 自动合并

### 2026-01-26: 派生视图未更新

**问题**：feature-registry.yml 更新后忘记生成视图
**根因**：手动操作，容易忘记
**检查项**：
- [ ] 派生视图版本应该与 registry 同步
**自动化**：
- scripts/auto-generate-views.sh 自动生成
- post-pr-checklist.sh 检查同步
```

## 验收标准

### DoD 清单

- [ ] develop 分支上的 PRD/DoD 已删除
- [ ] `scripts/squash-evidence.sh` 已实现并测试
- [ ] `scripts/auto-generate-views.sh` 已实现并测试
- [ ] `scripts/post-pr-checklist.sh` 已实现并测试
- [ ] `detect-priority.cjs` 已优化（不再误识别文本）
- [ ] `/dev` 流程 Step 7/8/11 已更新
- [ ] CI workflow 已添加 PRD/DoD 检查
- [ ] `docs/SELF-EVOLUTION.md` 已创建并记录本次问题
- [ ] 所有自动化脚本都有可执行权限
- [ ] 本地测试通过：运行 `npm run qa`

### 测试计划

#### 单元测试

- [ ] `squash-evidence.sh` 测试：有 evidence commit 时正确合并
- [ ] `squash-evidence.sh` 测试：无 evidence commit 时跳过
- [ ] `auto-generate-views.sh` 测试：检测到 registry 变更时生成
- [ ] `post-pr-checklist.sh` 测试：检测到问题时返回 exit 1

#### 集成测试

- [ ] 完整 /dev 流程测试：p0 阶段自动化检查生效
- [ ] PR 合并后测试：develop 无 PRD/DoD 残留
- [ ] CI 测试：develop 有 PRD/DoD 时 CI 失败

## 非目标

- 不修改 Ralph Loop 机制（已经工作正常）
- 不修改 Stop Hook 逻辑（已经修复）
- 不重构整个 /dev 流程（只增强关键步骤）

## 风险

1. **squash-evidence.sh 可能影响 git 历史** - 通过测试验证
2. **auto-generate-views.sh 可能在不该生成时生成** - 加严格条件判断
3. **post-pr-checklist 可能误报** - 提供 --skip 选项

## 后续优化

1. 把 post-pr-checklist 的检查项持久化到数据库
2. 建立 metrics dashboard 展示历史问题趋势
3. AI 自动分析失败模式并生成新检查项
