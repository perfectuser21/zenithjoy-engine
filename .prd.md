---
id: prd-branch-protection
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: 分支保护自动化

## 背景

发现严重安全漏洞：
1. **zenithjoy-autopilot** 的 main/develop 分支 `enforce_admins: false`，Admin 可绕过 CI 强行合并
2. **zenithjoy-engine** 刚通过 API 修复了保护，但没有代码记录
3. 多个仓库保护配置不一致，缺乏统一标准

## 目标

1. 修复 zenithjoy-autopilot 的分支保护
2. 创建自动化脚本，统一所有仓库的保护配置
3. 将保护配置记录到代码中，可追溯可审计

## 范围

### 必须保护的仓库

| 仓库 | main | develop |
|------|------|---------|
| zenithjoy-engine | ✅ | ✅ |
| zenithjoy-autopilot | ✅ | ✅ |
| zenithjoy-core | ✅ | ✅ |

### 标准保护配置

```yaml
required_status_checks:
  strict: true
  checks:
    - context: test
enforce_admins: true          # 关键：Admin 也必须遵守
allow_force_pushes: false
allow_deletions: false
```

## 交付物

1. `scripts/setup-branch-protection.sh` - 自动化配置脚本
2. 修复 autopilot 的保护配置
3. 更新 CLAUDE.md 记录标准配置

## 不做

- 不修改 PR review 规则（单人开发场景）
- 不添加 CODEOWNERS（暂时）
- 不归档其他仓库（用户单独处理）
