---
id: prd-phase3-hook-core
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 3 - Hook Core 多仓库治理

## 背景

当前 hooks 存在于单个仓库，其他仓库需要：
1. **复制粘贴** - 每个仓库都要复制 hooks 文件
2. **版本不一致** - 各仓库 hooks 版本混乱
3. **更新困难** - 修复 bug 要逐个仓库更新

## 功能描述

将核心 hooks 抽取为可复用模块：**hook-core 目录 → 安装脚本 → 多仓库共享**

### 方案选择

**方案 A**: Git Submodule（需要新仓库）
**方案 B**: npm 包（需要发布）
**方案 C**: 本地目录 + 安装脚本（✅ 选择此方案）

选择方案 C 的原因：
- 最简单，无需创建新仓库
- 通过 `deploy.sh` 部署到全局 `~/.claude/`
- 其他项目从全局目录引用

### 核心规则

1. **hook-core 目录结构**
   ```
   hook-core/
   ├── hooks/
   │   ├── branch-protect.sh
   │   └── pr-gate-v2.sh
   ├── scripts/
   │   └── devgate/
   │       ├── check-dod-mapping.cjs
   │       └── ...
   └── VERSION
   ```

2. **安装方式**
   - `bash scripts/install-hooks.sh` - 安装到项目
   - 自动检测项目根目录
   - 创建 `.claude/settings.json` 配置

3. **版本管理**
   - hook-core/VERSION 记录版本
   - 安装时检查版本兼容性

## 成功标准

1. hook-core 目录包含所有可复用 hooks
2. install-hooks.sh 可以安装到其他项目
3. 版本检查机制工作正常
4. 测试覆盖核心功能

## 交付物

### 新增文件
- `hook-core/VERSION` - 版本文件
- `hook-core/hooks/` - 核心 hooks（符号链接或复制）
- `hook-core/scripts/devgate/` - DevGate 脚本
- `scripts/install-hooks.sh` - 安装脚本
- `tests/hooks/install-hooks.test.ts` - 安装测试

### 修改文件
- `scripts/deploy.sh` - 支持 hook-core 部署
- `regression-contract.yaml` - 新增 H3-001

## 技术要点

- hook-core 内部用符号链接指向源文件（避免重复）
- install-hooks.sh 复制文件到目标项目
- 版本格式：`MAJOR.MINOR.PATCH`

## 不做

- Git Submodule 方案
- npm 包发布
- 自动更新检查

## 风险

- 符号链接在 Windows 可能有问题（暂不支持）
