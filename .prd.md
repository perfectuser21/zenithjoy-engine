# PRD - P0 质检强制三件套

## 需求来源

质检体系跟随分支导致能力漂移，前台能力增长与后台 QA 标准不一致，本地可绕过。

**核心痛点**：
1. **能力变了但没登记**：改了 hooks/skills/scripts/ 但忘记更新 FEATURES.md、regression-contract.yaml
2. **说通过了但没证据**：Audit 说 PASS、QA Gate 说通过，但都是文本文件，AI 容易"嘴硬"
3. **本地能绕过**：手动创建 PRD/DoD 能绕过 Hook，一直焦虑"能不能 100% 防住"

**证据**：
```bash
# develop 分支 QA v1.2.0
git show develop:skills/qa/SKILL.md | grep version
# version: 1.2.0

# 旧分支 QA v1.1.0
git show 8b0e978:skills/qa/SKILL.md | grep version
# version: 1.1.0

# 结论：旧分支用旧规则，质量标准不统一
```

---

## 功能目标（最小工程化）

### P0-1: Impact Check（能力变更强制登记）

**目标**：改了核心能力文件，必须同时更新能力注册表，否则 CI 失败

**触发条件**：PR 改动命中以下任意路径
- `hooks/`
- `skills/`
- `scripts/detect-phase.sh`
- `scripts/qa-with-gate.sh`
- `features/`（核心定义）

**强制要求**：必须同时改动
- `features/feature-registry.yml`

**验证逻辑**：前向一致（forward consistency）
- 改能力 → 必须登记 ✅
- 改登记 → 不要求改能力 ✅（允许文档更新）

**实现**：
- CI job: `impact-check`
- 脚本: `scripts/devgate/impact-check.sh`（约 30 行）

---

### P0-2: Evidence Gate（质检证据门控）

**目标**：质检通过不靠口头，要有机器可验的证据文件

**证据文件**：`.quality-evidence.json`

**格式**：
```json
{
  "sha": "<current HEAD>",
  "branch": "<branch>",
  "qa_gate_passed": true,
  "audit_decision": "PASS",
  "timestamp": "2026-01-24T21:03:56+08:00",
  "evidence": {
    "typecheck": "passed",
    "tests": "186/186 passed",
    "build": "success",
    "audit_l1": 0,
    "audit_l2": 0
  }
}
```

**生成时机**：`npm run qa:gate` 成功后自动生成

**CI 验证**：
- [ ] 文件必须存在
- [ ] JSON 字段齐全
- [ ] `sha == HEAD`（防老文件冒用） ⚠️ 关键
- [ ] `qa_gate_passed == true`
- [ ] `audit_decision == "PASS"`

**实现**：
- CI job: `evidence-gate`
- 修改: `scripts/qa-with-gate.sh` 末尾生成证据
- 修改: `.gitignore` 不忽略证据文件

---

### P0-3: Anti-Bypass 口径（远端强制兜底）

**目标**：承认本地可以绕过，用远端 CI + Branch Protection 强制

**核心原则**：
```
本地 Hooks = 加速失败（提前发现问题）
远端 CI + Branch Protection = 最终强制（物理阻止合并）
```

**职责映射**：

| 质检要求 | 本地检查 | 远端强制 |
|---------|---------|---------|
| PRD/DoD 存在 | branch-protect.sh | ❌ 无（可绕过）|
| 质检通过 | stop.sh | ✅ CI: evidence-gate |
| Audit PASS | stop.sh | ✅ CI: evidence-gate |
| 能力登记 | ❌ 无 | ✅ CI: impact-check |
| 测试通过 | npm run qa:gate | ✅ CI: test |
| 合并权限 | ❌ 无 | ✅ Branch Protection |

**Branch Protection 要求**：
- Required checks: `test`, `impact-check`, `evidence-gate`, `typecheck`, `build`
- `enforce_admins: true` - Admin 也必须遵守
- `allow_force_pushes: false`

**实现**：
- 文档: `docs/contracts/QUALITY-CONTRACT.md`
- ~~脚本: `scripts/verify-branch-protection.sh`~~ ❌ **已删除**（GitHub 后端强制，脚本验证无意义）

---

## 涉及文件

### 新增

| 文件 | 类型 | 说明 |
|------|------|------|
| `features/feature-registry.yml` | 数据 | 能力注册表 |
| `scripts/devgate/impact-check.sh` | 脚本 | Impact Check 验证逻辑 |
| `.quality-evidence.json` | 产物 | 质检证据（qa:gate 生成）|
| `docs/contracts/QUALITY-CONTRACT.md` | 文档 | 质量契约（本地 vs 远端职责）|

### 修改

| 文件 | 修改点 |
|------|--------|
| `.github/workflows/ci.yml` | 添加 `impact-check` 和 `evidence-gate` jobs |
| `scripts/qa-with-gate.sh` | 末尾生成 `.quality-evidence.json` |
| `.gitignore` | 允许 `.quality-evidence.json` 提交 |

---

## 成功标准（行为型 - 机器可验）

### P0-1: Impact Check

- [ ] CI job `impact-check` 添加到 workflow
- [ ] 脚本 `scripts/devgate/impact-check.sh` 实现
- [ ] `features/feature-registry.yml` 创建并填充现有能力
- [ ] **测试**：改 `hooks/` 不改 `registry` → CI **FAIL**
- [ ] **测试**：改 `hooks/` 同时改 `registry` → CI **PASS**
- [ ] **测试**：只改 `registry` → CI **PASS**（允许文档更新）

### P0-2: Evidence Gate

- [ ] `scripts/qa-with-gate.sh` 生成 `.quality-evidence.json`
- [ ] CI job `evidence-gate` 添加到 workflow
- [ ] `.gitignore` 配置正确
- [ ] **测试**：无证据文件 → CI **FAIL**
- [ ] **测试**：JSON 字段不全 → CI **FAIL**
- [ ] **测试**：SHA 不匹配 HEAD → CI **FAIL**
- [ ] **测试**：证据完整 → CI **PASS**

### P0-3: Anti-Bypass 口径

- [ ] 文档 `docs/contracts/QUALITY-CONTRACT.md` 创建
- [ ] 包含本地 vs 远端职责映射表
- [ ] Branch Protection 配置验证（手动检查 GitHub 设置）
- [ ] `impact-check` 和 `evidence-gate` 加入 required checks

---

## 核心原则

1. **最小工程化**：总计约 1.5 小时工作量（30行×3个脚本 + 1个文档）
2. **机器可验**：不靠口头，靠 JSON + CI
3. **远端强制**：承认本地可绕过，CI + Branch Protection 兜底
4. **前向一致**：改能力必须登记，但改登记不要求改能力

---

## 预期收益

- ✅ **防止能力漂移**：改了核心文件必须登记，随时知道系统有什么能力
- ✅ **质检可验证**：有 JSON 证据，不是口头说 PASS
- ✅ **不再焦虑绕过**：清晰的本地+远端分工，远端是最终防线
- ✅ **质量标准统一**：CI 强制，所有分支必须满足相同标准

---

## 风险

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| Impact Check 误报 | 低 | 中 | 路径配置可调整 |
| Evidence 文件冲突 | 低 | 低 | JSON 格式简单 |
| SHA 校验过严 | 低 | 低 | 只在 CI 验证，本地不强制 |
| Branch Protection 配置错误 | 中 | 高 | 手动检查 GitHub 设置 |

---

## 后续优化（非 P0）

以下可以等 P0 稳定后再做：

1. **自动同步质检规则**：SessionStart hook 提醒分支落后 develop
2. **Feature 注册自动化**：从代码注释提取能力描述
3. **RCI 覆盖率可视化**：Dashboard 展示回归契约覆盖度
4. **全局配置动态化**：其他 repo 使用 `~/.claude/` 全局质检规则
