---
id: fix-stop-hook-cleanup
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 Stop Hook 跳过 Cleanup 的 Bug

## 问题描述

当前 Stop Hook (`hooks/stop.sh`) 在检测到 PR 已合并时，直接删除 `.dev-mode` 并退出，导致 Step 11 (Cleanup) 从未执行，分支遗留。

## 修改内容

### 1. 修改 hooks/stop.sh

**修改 1**: 在检查 .dev-mode 存在后，添加 cleanup_done 检测（第 47-50 行后）：

```bash
# ===== 检查 cleanup 是否已完成 =====
if grep -q "cleanup_done: true" "$DEV_MODE_FILE" 2>/dev/null; then
    rm -f "$DEV_MODE_FILE"
    exit 0
fi
```

**修改 2**: PR 合并时不直接退出，改为继续执行（第 105-116 行）：

```bash
if [[ "$PR_STATE" == "merged" ]]; then
    echo "  ✅ 条件 2: CI 通过（PR 已合并）" >&2
    echo "  ✅ 条件 3: PR 已合并" >&2
    echo "" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    echo "  ➡️  下一步: 执行 Step 11 (Cleanup)" >&2
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" >&2
    exit 2  # 继续执行 cleanup，不要直接退出
fi
```

### 2. 修改 skills/dev/scripts/cleanup.sh

在删除 .dev-mode 之前，先标记完成：

```bash
# 标记 cleanup 完成（让 Stop Hook 知道可以退出了）
echo "cleanup_done: true" >> "$DEV_MODE_FILE"
```

## 成功标准

1. PR 合并后，Stop Hook 输出 "下一步: 执行 Step 11 (Cleanup)"
2. Claude 执行 cleanup.sh 删除分支
3. cleanup.sh 标记 cleanup_done: true
4. 下次 Stop Hook 检测到标记，删除 .dev-mode 并退出

## 部署

修改后运行 `bash scripts/deploy.sh` 部署到全局。
