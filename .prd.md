---
id: prd-phase41-threshold
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 4.1 - DevGate L2 阈值检查

## 背景

Phase 4 实现了 DevGate Metrics 指标面板，但只是"看板"不是"门禁"：
- metrics.sh 只收集数据，不强制阈值
- nightly 不会因指标不达标而失败
- 缺乏"Top offenders"输出，无法追责

## 功能描述

把 DevGate Metrics 从"观测模式"升级到"L2 严格门模式"。

### L2 阈值规则

| 检查项 | 阈值 | 未达标行为 |
|--------|------|------------|
| P0/P1 RCI 覆盖率 | 100% | nightly fail + 输出 offenders |
| P0 manual tests | 0 | nightly fail |
| RCI 增长 | < 2 | 软警告（不 fail） |

### 口径定义（写死）

| 维度 | 口径 | 原因 |
|------|------|------|
| 窗口归属 | `created` 时间戳 | 反映 PR 实际完成时间 |
| PR 优先级 | meta 的 `priority` 字段 | snapshot 阶段决定，不可后改 |
| RCI 更新判定 | merged commit 文件列表含 `regression-contract.yaml` | git diff 可验证 |

## 成功标准

1. metrics.cjs 输出 `offenders` 数组（JSON）
2. metrics.cjs 输出 `p0_manual_tests` 单独计数
3. nightly.yml 有 L2 阈值检查步骤
4. P0/P1 RCI < 100% 或 P0 manual > 0 时 nightly fail

## 交付物

### 修改文件
- `scripts/devgate/metrics.cjs` - 添加 offenders、p0_manual_tests
- `.github/workflows/nightly.yml` - 添加 L2 阈值检查步骤

## 不做

- L1 / L3 模式切换（后续考虑）
- 自动 hotfix ticket 创建
- 飞书/Slack 实时告警

## 技术要点

- offenders 在 JSON 中为数组，human 输出时逐行显示
- p0_manual_tests 独立于 manual_tests（后者包含 P0+P1+NONE）
- L2 检查在 metrics 收集之后，artifact 上传之前
