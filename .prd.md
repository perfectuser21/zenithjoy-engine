# PRD - 深度扫描 Bug 批量修复

**需求来源**: 5 个并行 subagent 深度扫描发现的 P0/P1 问题

---

## 一、脚本逻辑 Bug (8 个)

### P0 - 立即修复

**1. pr-gate-v2.sh:290 - 漏改的硬编码 develop**
```bash
# 当前（错误）
PRD_MODIFIED=$(git diff develop --name-only ...)
# 应该
PRD_MODIFIED=$(git diff "$BASE_BRANCH" --name-only ...)
```

**2. run-regression.sh:186 - eval 命令注入**
```bash
# 当前（危险）
output=$(cd "$PROJECT_ROOT" && eval "$evidence_run" 2>&1)
# 应该：使用数组执行或白名单验证
```

**3. run-regression.sh:227 - Word splitting**
```bash
# 当前（错误）
if ls $PROJECT_ROOT/$file_path ...
# 应该
if ls "$PROJECT_ROOT/$file_path" ...
```

**4. generate-report.sh:152 - JSON 特殊字符未转义**
```bash
# 当前：文件名含 " 或 \ 会破坏 JSON
# 应该：使用 jq 转义
```

### P1 - 尽快修复

**5. rc-filter.sh:35-39 - paste 假设 5 行一组**
- 多行 YAML 字段会破坏对齐

**6. branch-protect.sh:178-182 - BASE_BRANCH 未验证存在**
```bash
# 应该先验证
git rev-parse "$BASE_BRANCH" >/dev/null 2>&1 || BASE_BRANCH=develop
```

**7. multi-feature.sh:103-104 - 变量未初始化**
```bash
AHEAD_FILTERED="${AHEAD_FILTERED:-0}"
```

**8. cleanup.sh:97 - MERGE_HEAD 相对路径**
```bash
# 当前
if [[ -f "$(git rev-parse --git-dir)/MERGE_HEAD" ]]
# 应该
if [[ -f "$(git rev-parse --git-path MERGE_HEAD)" ]]
```

---

## 二、配置问题 (4 个)

### P0

**9. package-lock.json 版本不一致**
- package.json: 8.3.0
- package-lock.json: 8.1.1
- 修复：`npm install`

### P1

**10. README.md 遗漏 yq 依赖**
- Prerequisites 缺少 yq

**11. package.json 缺少 engines 字段**
```json
"engines": { "node": ">=18.0.0" }
```

**12. .gitignore 过宽**
- `.env*` → `.env` + `.env.local`

---

## 三、安全问题 (4 个)

### P0 (与上面重复，已列出)
- run-regression.sh:186 eval 注入
- run-regression.sh:227 word splitting

### P1

**13. run-regression.sh:218 - yq 变量注入**
```bash
# $id 直接插入 yq 查询，应转义
```

**14. deploy.sh:130 - rm -rf 前置检查**
```bash
[[ -n "$target_skill" ]] && [[ -d "$target_skill" ]] && rm -rf "$target_skill"
```

**15. cleanup.sh:43 - /tmp 敏感日志**
```bash
# 使用 mktemp 替代硬编码路径
REPORT_ERROR_LOG=$(mktemp)
```

**16. run-regression.sh:334-335 - trap 中变量未引用**
```bash
trap "rm -f \"$RCI_RAW_FILE\" \"$RCI_LIST_FILE\"" EXIT
```

---

## 四、垃圾清理 (3 个)

**17. 删除重复模板**
- 删除 `templates/dod.md`（保留 `DOD-TEMPLATE.md`）

**18. 删除死代码**
- 删除 `scripts/deploy.sh`（无引用）

**19. 清理 .dev-runs/**
- 删除历史报告文件

---

## 成功标准

- [ ] pr-gate-v2.sh 所有 develop 硬编码已替换
- [ ] run-regression.sh 安全问题已修复
- [ ] generate-report.sh JSON 转义正确
- [ ] package-lock.json 版本一致
- [ ] README 包含 yq 依赖
- [ ] npm run qa 通过
- [ ] shell 脚本语法检查通过
