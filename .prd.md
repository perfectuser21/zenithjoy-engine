# PRD - P1 阶段改为挂着轮询 + 自动修复循环

## 需求来源

用户反馈：当前 P1 阶段是"事件驱动"模式（push 后退出，等唤醒），但这样用户需要不停问"怎么样了"。

**问题**：
- 现在：PR 创建 → 退出 → 用户问 → 检查 CI → 修复 → 退出 → 用户又问...
- 期望：PR 创建 → **挂着轮询** → CI 失败 → 修复 → **继续轮询** → CI 成功 → 自动合并

## 功能描述

### 两阶段三状态

```
P0 阶段：本地质检 → 创建 PR → 进入 P1

P1 阶段（无限循环，直到成功）：
  ┌─────────────────┐
  │ 状态1: 运行中   │ → 挂着轮询（sleep 30s 循环检查）
  └────────┬────────┘
           ↓
  ┌─────────────────┐
  │ 状态2: 失败     │ → 修复错误 → 推送 ──┐
  └─────────────────┘                    │
                                         │
  ┌─────────────────┐                    │
  │ 状态3: 成功     │ → 合并 → 完成      │
  └─────────────────┘                    │
           ↑                              │
           └──────────────────────────────┘
          （失败后修复，重新进入状态1）
```

### 核心改动

#### 1. Step 8 (PR 创建后)

**旧行为**：
```bash
gh pr create ...
echo "✅ PR 创建完成，退出"
# Stop Hook: exit 0（允许结束）
```

**新行为**：
```bash
gh pr create ...
echo "✅ PR 已创建，进入 P1 阶段 CI 轮询..."

# 直接调用 Step 9
# 注意：这里是在同一个会话中继续，不退出
```

#### 2. Step 9 改名为 09-ci-polling.md（CI 轮询 + 自动修复）

**核心逻辑**：

```bash
# 获取 PR 号
PR_NUMBER=$(gh pr view --json number -q '.number')

# 无限循环，直到 CI 成功
while true; do
  # 获取 CI 状态
  CI_STATUS=$(gh pr checks "$PR_NUMBER" --json conclusion -q '.[0].conclusion' 2>/dev/null || echo "PENDING")

  case "$CI_STATUS" in
    "SUCCESS")
      # 自动合并
      gh pr merge "$PR_NUMBER" --squash --delete-branch
      break  # 退出循环
      ;;

    "FAILURE")
      # 获取失败详情并修复
      gh run view <run-id> --log-failed
      # 修复代码...
      git push
      sleep 60  # 等待 CI 启动
      ;;

    *)
      # 运行中，等待
      sleep 30
      ;;
  esac
done
```

#### 3. Stop Hook 调整

P1 阶段不再由 Stop Hook 控制退出：
- Step 8 创建 PR 后**不退出**
- 直接进入 Step 9 的 while 循环
- 只有 CI 成功并合并后才退出

### 超时保护

添加超时机制（1 小时）避免无限挂起。

## 涉及文件

修改：
- skills/dev/steps/08-pr.md - PR 创建后进入轮询
- skills/dev/steps/09-ci.md → 09-ci-polling.md - 改为轮询 + 自动修复循环
- skills/dev/SKILL.md - 更新流程说明

## 成功标准

- [ ] PR 创建后不退出，进入 CI 轮询
- [ ] CI 运行中：每 30 秒检查一次状态
- [ ] CI 失败：显示失败日志，修复后推送，继续轮询
- [ ] CI 成功：自动合并 PR，删除分支，退出
- [ ] 超时保护：1 小时后超时退出
- [ ] 用户不需要主动问"怎么样了"
