# 质检策略全图

## 质检体系概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        质检体系 5 大类                          │
├─────────────────────────────────────────────────────────────────┤
│  1. 测试类型 (L1-L6)     — 项目能跑什么测试                     │
│  2. 质检三层 (Layer 1/2/3) — 每次开发要做的检查                 │
│  3. 测试范围             — 增量 vs 全量                         │
│  4. 审计                 — 事后深度检查                         │
│  5. Code Review          — 人工审查                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1. 测试类型 (L1-L6)

项目支持的测试能力，不是每个项目都有全部。

| 层级 | 名称 | 内容 | 工具示例 |
|------|------|------|----------|
| L1 | 静态分析 | typecheck, lint, format | tsc, eslint, prettier |
| L2 | 单元测试 | 函数/模块级别测试 | vitest, jest |
| L3 | 集成测试 | 多模块协作测试 | vitest, supertest |
| L4 | E2E 测试 | 端到端用户流程 | playwright, cypress |
| L5 | 性能测试 | 速度、内存、负载 | benchmark, k6 |
| L6 | 安全测试 | 漏洞扫描、依赖审计 | npm audit, snyk |

**项目能力检测**：`.project-info.json` 记录项目支持 L1-L6 中的哪些。

---

## 2. 质检三层 (Layer 1/2/3)

每次开发（每个 PR）要做的检查。

| 层 | 名称 | 内容 | 谁做 |
|----|------|------|------|
| Layer 1 | 自动化测试 | 跑 L1-L6 中项目支持的 | 机器 (CI) |
| Layer 2 | 效果验证 | 截图、curl、实际执行看效果 | Agent 或人 |
| Layer 3 | 需求验收 | 对照 DoD 逐项确认 | Agent 或人 |

**输出**：`.quality-report.json`

```json
{
  "branch": "cp-xxx",
  "layers": {
    "L1_automated": { "status": "pass" },
    "L2_verification": { "status": "pass" },
    "L3_acceptance": { "status": "pass" }
  },
  "overall": "pass"
}
```

---

## 3. 测试范围

| 范围 | 说明 | 何时用 |
|------|------|--------|
| 增量测试 | 只跑改动相关的测试 | 本地开发时（快） |
| 全量测试 | 跑整个项目所有测试 | CI（防回归） |

**回归问题**：Feature 3 破坏 Feature 1 → 全量测试能发现。

---

## 4. 审计

事后的深度检查，不是每次 PR 都跑。

| 审计项 | 内容 |
|--------|------|
| 代码质量 | 可读性、复杂度、重复代码 |
| 最佳实践 | 是否遵循规范 |
| 潜在 bug | 边界情况、错误处理 |
| 测试覆盖 | 哪些代码没被测试覆盖 |
| 安全漏洞 | 依赖漏洞、代码漏洞 |

**工具**：`/audit` skill

---

## 5. Code Review

人工审查，用于重要功能或发布前。

| 审查项 | 内容 |
|--------|------|
| 逻辑正确性 | 代码逻辑对不对 |
| 设计合理性 | 架构设计好不好 |
| 安全性 | 有没有安全漏洞 |
| 可维护性 | 后续好不好改 |

---

## 开发流程与质检频次

### 流程图

```
┌─────────────────────────────────────────────────────────────────┐
│  每次开发 (每个 PR)                                              │
│                                                                 │
│  PRD → DoD → 写代码 → 写测试                                    │
│                          ↓                                      │
│              ┌─── 质检三层 ───┐                                 │
│              │ Layer 1: 自动化 │  ← 跑 L1-L6 中项目有的         │
│              │ Layer 2: 效果   │  ← 截图/curl 验证              │
│              │ Layer 3: 验收   │  ← 对照 DoD                    │
│              └────────────────┘                                 │
│                          ↓                                      │
│                     创建 PR                                     │
│                          ↓                                      │
│              ┌─── CI 全量测试 ───┐                              │
│              │ 跑所有 L1-L4 测试  │  ← 防回归                   │
│              │ (项目支持的)       │                             │
│              └───────────────────┘                              │
│                          ↓                                      │
│                    CI 绿 → 合并                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  定期 (每天/每周)                                                │
│                                                                 │
│              ┌─── 审计 ───┐                                     │
│              │ 代码质量    │                                    │
│              │ 测试覆盖    │  → 发现问题 → 生成 issue           │
│              │ 安全漏洞    │                                    │
│              └────────────┘                                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  发布前 / 重要功能                                               │
│                                                                 │
│              ┌─── Code Review ───┐                              │
│              │ 人工审查           │                             │
│              │ 架构评审           │                             │
│              │ 安全评审           │                             │
│              └───────────────────┘                              │
│                          ↓                                      │
│              ┌─── 性能/安全测试 ───┐                            │
│              │ L5 性能测试         │                            │
│              │ L6 安全测试         │                            │
│              └────────────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
```

### 频次表

| 质检类型 | 频次 | 触发条件 |
|----------|------|----------|
| **Layer 1-3 质检** | 每次 PR | PR 创建前 |
| **CI 全量测试** | 每次 PR | PR 创建后自动 |
| **审计** | 每天/每周 | 定时任务或手动 |
| **Code Review** | 重要功能 | 手动触发 |
| **L5 性能测试** | 发布前/性能相关 | 手动触发 |
| **L6 安全测试** | 发布前/每周 | 定时或手动 |

### 按任务类型的质检要求

| 任务类型 | Layer 1 | Layer 2 | Layer 3 | CI | 审计 | Review |
|----------|---------|---------|---------|-----|------|--------|
| 普通功能 | ✅ | ✅ | ✅ | ✅ | 定期 | 可选 |
| Bug 修复 | ✅ | ✅ | ✅ | ✅ | - | 可选 |
| 文档修改 | ✅ | - | ✅ | ✅ | - | - |
| 重构 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 安全相关 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 性能相关 | ✅ | ✅ | ✅ | ✅ | L5 | ✅ |
| 发布 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 实际执行

### 每次 PR（必须）

```bash
# 1. 写完代码后，Agent 执行三层质检

# Layer 1: 自动化测试
npm run typecheck  # L1
npm test           # L2
npm run build      # 构建验证

# Layer 2: 效果验证
# - 截图看页面（如果是前端）
# - curl 测试 API（如果是后端）
# - 实际执行验证功能

# Layer 3: 需求验收
# - 对照 DoD 逐项确认

# 2. 创建 PR → CI 自动跑全量测试
```

### 定期审计（每天/每周）

```bash
# 晚上或空闲时，启动审计 Agent
claude -p "/audit 检查最近的代码变更"

# 或者用 N8N 定时触发
```

### 发布前（重要节点）

```bash
# 1. 跑完整测试套件
npm run test:all
npm run test:e2e    # L4
npm run benchmark   # L5
npm audit           # L6

# 2. 人工 Code Review
# 3. 安全评审
```

---

## 防线层次

```
┌─────────────────────────────────────────────────────────────────┐
│  第一层：本地质检（Agent 自检）                                  │
│  → 三层质检 (Layer 1/2/3)                                       │
│  → 可能被绕过，但有引导作用                                     │
├─────────────────────────────────────────────────────────────────┤
│  第二层：PR Gate（pr-gate.sh）                                  │
│  → 检查质检报告、跑测试                                         │
│  → 本地强制，但仍可伪造报告                                     │
├─────────────────────────────────────────────────────────────────┤
│  第三层：CI 全量测试                                             │
│  → 独立环境，无法伪造                                           │
│  → 真正的强制防线                                               │
├─────────────────────────────────────────────────────────────────┤
│  第四层：审计                                                    │
│  → 事后发现问题                                                 │
│  → 补漏网之鱼                                                   │
├─────────────────────────────────────────────────────────────────┤
│  第五层：Code Review                                            │
│  → 人工最终把关                                                 │
│  → 重要功能/发布前                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 总结

| 问题 | 答案 |
|------|------|
| 每次 PR 要做什么？ | 三层质检 + CI 全量测试 |
| 怎么防回归？ | CI 跑全量测试 |
| 怎么保证代码质量？ | 定期审计 |
| 重要功能怎么办？ | 加 Code Review |
| 什么是强制的？ | CI 全量测试 |
| 什么是引导的？ | 本地质检、审计 |
