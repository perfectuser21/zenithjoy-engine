---
id: phase2-cross-repo-worktree
version: 1.0.0
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.0: 初始版本
---

# Phase 2: 跨仓库兼容性 + Worktree 支持

## 背景

深度分析发现 12 个跨仓库问题和 11 个 Worktree 问题。当前代码假设：
- 只在 zenithjoy-engine 仓库运行
- 只使用普通 git clone（非 worktree）
- develop 分支一定存在

这些假设导致在其他仓库或 worktree 环境中工作时出错。

## 目标

修复跨仓库和 Worktree 兼容性问题，使工具链能在任意仓库和 worktree 环境中正常工作。

## 验收标准

### T-001: 移除硬编码路径 | code | none

**问题**: `branch-protect.sh:86` 硬编码 `/home/xx/dev/zenithjoy-engine`

**修复**: 使用相对路径或动态检测项目根目录

**验收**:
- [ ] 无硬编码绝对路径
- [ ] 在其他仓库运行不报错

### T-002: .git 目录检测兼容 worktree | code | none

**问题**: `pr-gate-v2.sh:144` 使用 `[[ -d ".git" ]]` 检查，worktree 中 `.git` 是文件

**修复**: 使用 `git rev-parse --is-inside-work-tree`

**验收**:
- [ ] 在 worktree 中正确检测 git 仓库
- [ ] 普通 clone 仍然正常工作

### T-003: 项目根目录检测兼容 worktree | code | T-002

**问题**: `git rev-parse --show-toplevel` 在 worktree 中返回主仓库路径

**修复**: 使用 `git rev-parse --show-toplevel` 但理解 worktree 语义

**验收**:
- [ ] worktree 中正确获取工作目录
- [ ] 状态文件存储在正确位置

### T-004: develop 分支存在性检查 | code | none

**问题**: 假设 develop 分支存在，某些仓库可能只有 main

**修复**: 检测默认分支（main 或 develop）

**验收**:
- [ ] 自动检测 main/develop 作为 base 分支
- [ ] 无 develop 时不报错

### T-005: cleanup.sh worktree 安全检查 | code | T-003

**问题**: cleanup 删除分支时可能影响其他 worktree

**修复**: 删除前检查是否有 worktree 关联

**验收**:
- [ ] 有 worktree 关联时跳过删除
- [ ] 输出警告信息

## 技术方案

### 影响范围

| 文件 | 修改内容 |
|------|---------|
| hooks/branch-protect.sh | T-001, T-004 |
| hooks/pr-gate-v2.sh | T-002, T-003 |
| skills/dev/scripts/cleanup.sh | T-005 |

### 风险评估

- **中风险**: 涉及 git 检测逻辑，需要在多环境测试
- **测试覆盖**: 现有测试 + worktree 环境手动验证

## 非目标

以下问题留到后续 Phase 处理：
- 状态机 Promise 统一（Phase 3）
- 文档矛盾清理（Phase 4）
