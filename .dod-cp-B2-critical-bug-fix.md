# DoD - Critical Bug Fix (16 个 CRITICAL 级别)

QA: docs/QA-DECISION.md

**RepoType**: Engine
**Priority**: P0
**Decision**: MUST_ADD_RCI

## 验收标准

### P0 - 立即修复（阻塞工作流）

#### Bug #1: Stop Hook 条件 3 永远失败
- [ ] PR 未合并时：block 并提示合并
      Test: manual:测试 Stop Hook 在 PR 未合并时的行为
- [ ] PR 已合并但 Step 11 未完成：block 并触发 Step 11
      Test: manual:测试 Stop Hook 在 PR 合并后的清理逻辑
- [ ] PR 已合并且 Step 11 完成：删除 .dev-mode，允许退出
      Test: manual:测试 Stop Hook 在完成后允许退出

#### Bug #6: .dev-mode 竞态条件
- [ ] Step 3 执行过程中 Write 操作不被阻塞
      Test: manual:在 Step 3 执行期间尝试 Write 操作
- [ ] Step 3 完成后，未创建 tasks 的 Write 被阻塞
      Test: manual:测试 tasks_created 检查逻辑

#### Bug #7: PR Gate QA/Audit 软阻塞
- [ ] 缺少 QA-DECISION.md → exit 2（阻止 PR）
      Test: manual:运行 pr-gate-v2.sh 在缺少 QA-DECISION.md 时
- [ ] 缺少 AUDIT-REPORT.md → exit 2（阻止 PR）
      Test: manual:运行 pr-gate-v2.sh 在缺少 AUDIT-REPORT.md 时

### P1 - 尽快修复（影响质量）

#### Bug #2: HEAD~10 fallback
- [ ] 新仓库（1-5 commits）不报错
      Test: manual:创建新 repo 测试 branch-protect.sh
- [ ] 仓库有 10+ commits 时正常工作
      Test: manual:在现有 repo 测试 branch-protect.sh
- [ ] 空仓库时有合理 fallback
      Test: manual:空 repo 测试

#### Bug #3: retry_count 竞态条件
- [ ] 并发测试：2 个会话同时触发 Stop Hook
      Test: manual:并发测试
- [ ] retry_count 严格递增，无重复或丢失
      Test: manual:检查 retry_count 一致性

#### Bug #4: gate:dod & gate:qa 并行执行模型未定义
- [ ] 文档有可执行的 Skill 调用示例
      Test: manual:文档检查
- [ ] 冲突解决规则明确
      Test: manual:文档检查
- [ ] 超时机制定义
      Test: manual:文档检查

#### Bug #5: 分支保护 Hook 与 Step 03 规范矛盾
- [ ] `cp-W6-task` 通过（W6 在 FEATURES.md）
      Test: manual:测试合法分支
- [ ] `cp-random-task` 被拒绝（无 Feature ID）
      Test: manual:测试非法分支
- [ ] `cp-Z9-task` 被拒绝（Z9 不存在）
      Test: manual:测试不存在的 Feature ID

#### Bug #11: deploy.sh 错误恢复
- [ ] main 分支不存在 → 停止部署，不切换分支
      Test: manual:测试 deploy.sh 错误处理
- [ ] git pull 失败 → 停止部署，切回原分支
      Test: manual:测试 git pull 失败场景
- [ ] 部署成功 → 切回原分支
      Test: manual:测试正常部署流程

### P2 - 重要修复（安全和稳定性）

#### Bug #13: 命令注入漏洞
- [ ] `npm test` 正常执行
      Test: manual:测试正常命令
- [ ] `npm test && echo pwned` 被拒绝
      Test: manual:测试恶意命令
- [ ] `bash -c 'npm test'` 被拒绝
      Test: manual:测试嵌套 bash

#### Bug #12: API 错误抑制
- [ ] API 成功 → 显示成功
      Test: manual:测试 API 成功场景
- [ ] API 失败（403） → 显示错误，返回非 0
      Test: manual:测试 API 权限错误
- [ ] 网络错误 → 显示错误，返回非 0
      Test: manual:测试网络错误

#### Bug #14: 符号链接漏洞
- [ ] 项目内符号链接正常复制
      Test: manual:测试合法符号链接
- [ ] 指向外部的符号链接被拒绝
      Test: manual:测试恶意符号链接
- [ ] 不泄露敏感文件
      Test: manual:安全验证

### P3 - 优化修复（完善性）

#### Bug #8: 文档矛盾
- [ ] SKILL.md 和 CHANGELOG 描述一致
      Test: manual:文档检查
- [ ] 07-quality.md 明确说明是否调用 gate:quality
      Test: manual:文档检查

#### Bug #9: checklist 检查精度
- [ ] 正确格式 `step_1_prd: done` 识别为 done
      Test: manual:测试正确格式
- [ ] 错误格式 `step_1_pending: done` 不被误判
      Test: manual:测试错误格式
- [ ] 有 tab 分隔符时仍然正确解析
      Test: manual:测试 tab 分隔符

#### Bug #10: CI 条件复杂
- [ ] PR to develop: 所有必需 jobs 运行
      Test: contract:CI 运行验证
- [ ] PR to main: 所有必需 jobs 运行
      Test: contract:CI 运行验证
- [ ] PR to feature/*: 合理的 jobs 运行
      Test: contract:CI 运行验证
- [ ] ci-passed 总是运行并报告正确状态
      Test: contract:CI 运行验证

#### Bug #15: 目录检查
- [ ] hook-core/ 存在 → 更新 VERSION
      Test: manual:测试目录存在场景
- [ ] hook-core/ 不存在 → 跳过，不报错
      Test: manual:测试目录不存在场景

#### Bug #16: 版本同步
- [ ] 三个文件版本号一致
      Test: manual:检查 package.json, VERSION, .hook-core-version
- [ ] 有自动检查脚本防止再次不同步
      Test: manual:验证版本同步脚本

### 回归测试
- [ ] 确保修复没有破坏现有功能
      Test: contract:C2-001 (npm run qa)
- [ ] 运行 regression-contract.yaml 中的所有测试
      Test: contract:完整回归测试

### 部署验收
- [ ] 更新 CHANGELOG.md 记录修复
      Test: manual:文档检查
- [ ] 更新版本号（11.26.0 → 11.27.0 或 11.26.1）
      Test: manual:版本号检查
- [ ] 部署到全局并验证
      Test: manual:部署验证
