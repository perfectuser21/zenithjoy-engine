---
id: prd-consistency-fixes
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# PRD: CI 一致性修复（第三批）

## 背景

深度审查发现本地 Hooks 和远端 CI 之间存在一致性问题，以及测试覆盖率不足。

## 问题清单

### P2-1: Gate 文件检查不一致

**位置**: `hooks/pr-gate-v2.sh` vs `.github/workflows/ci.yml`

**问题**:
- 本地 Hook 对 `.gate-*-passed` 文件做硬检查
- CI 中如果文件不存在则跳过检查
- 攻击者可以绕过本地检查后在 CI 中通过

**修复方案**:
- CI 中也应强制检查 gate 文件存在
- 或统一使用 evidence 机制替代 gate 文件

### P2-2: PRD/DoD 验证规则不一致

**位置**: `hooks/branch-protect.sh` vs `ci/scripts/l2a-check.sh`

**问题**:
- 本地要求 PRD 至少 3 行且包含关键字段
- CI 的 L2A 检查有不同的验证逻辑
- 可能导致本地通过但 CI 失败，或反之

**修复方案**:
- 统一验证逻辑到共享脚本
- 或明确文档化两处的差异和原因

### P2-3: 版本检查缺失

**位置**: `hooks/pr-gate-v2.sh`

**问题**:
- 本地 hooks 不检查版本号是否递增
- 只有 CI 的 version-check job 会检查
- 开发者可能忘记更新版本号直到 CI 失败

**修复方案**:
- 在 pr-gate-v2.sh 中添加版本检查
- 与 develop 分支比较版本号

### P3-1: RCI 自动化覆盖率低

**位置**: `regression-contract.yaml`

**问题**:
- 41 个 RCIs 标记为 manual 测试（44%）
- 部分 manual RCI 实际可以自动化
- 高 manual 比例降低回归测试可靠性

**修复方案**:
- 审查每个 manual RCI
- 将可自动化的转为 auto
- 为无法自动化的添加明确说明

### P3-2: metrics.test.ts 时间窗口测试不稳定

**位置**: `tests/hooks/metrics.test.ts` L401

**问题**:
- `describe.skip('metrics.sh 时间窗口')` 被跳过
- 原因是临时目录残留导致不稳定
- 缺失的测试覆盖影响指标计算可靠性

**修复方案**:
- 修复临时目录清理逻辑
- 或重写测试使用 mock 时间

## 验收标准

- [ ] Gate 文件检查逻辑统一
- [ ] PRD/DoD 验证逻辑统一或文档化差异
- [ ] 本地 hooks 添加版本检查
- [ ] 审查 manual RCIs 并提高自动化率
- [ ] 修复或记录 metrics 时间窗口测试

## 影响范围

- `hooks/pr-gate-v2.sh`
- `hooks/branch-protect.sh`
- `.github/workflows/ci.yml`
- `ci/scripts/l2a-check.sh`
- `regression-contract.yaml`
- `tests/hooks/metrics.test.ts`

## 风险评估

**中风险**：修改验证逻辑可能导致现有流程中断。
需要充分测试各场景。
