# DoD: 实施全新 CI 分层方案

## QA 决策参考

参见 `docs/QA-DECISION.md` - Minimal 测试策略（Golden Path 测试）

## 必要项（全部完成才算完成）

### M1: 新增脚本

- [ ] `scripts/devgate/l2b-check.sh` 创建并可执行
  - [ ] 支持 `pr` 模式（L2B-min）
  - [ ] 支持 `release` 模式（L2B-full）
  - [ ] 检查 `.layer2-evidence.md` 存在
  - [ ] 检查必需字段（## 手动验证、## 自动化测试）
  - [ ] L2B-min：至少 1 条可复核证据
  - [ ] L2B-full：完整证据 + DoD 全勾

- [ ] `scripts/devgate/l3-fast.sh` 创建并可执行
  - [ ] lint 检查（TODO: 占位符）
  - [ ] format 检查（TODO: 占位符）
  - [ ] 执行时间 < 10s

- [ ] `scripts/devgate/ci-preflight.sh` 创建并可执行
  - [ ] 运行 L1-fast（typecheck + test，不 build）
  - [ ] 运行 L3-fast
  - [ ] 运行 L2A-min（可选）
  - [ ] 总时间 < 120s（hook 超时限制）

### M2: 修改 hook

- [ ] `hooks/pr-gate-v2.sh` 增加 preflight 支持
  - [ ] PR 模式先跑 `npm run ci:preflight`
  - [ ] 增加 L2B-min 检查（调用 `l2b-check.sh pr`）
  - [ ] 保持现有逻辑不变

### M3: 修改 CI

- [ ] `.github/workflows/ci.yml` 增加 jobs
  - [ ] 新增 `l2b-check` job
    - [ ] 触发条件：`pull_request`
    - [ ] `needs: [test]`
    - [ ] 运行 `bash scripts/devgate/l2b-check.sh pr`
  - [ ] 新增 `ai-review` job
    - [ ] 触发条件：`pull_request`
    - [ ] `needs: [ci-passed]`
    - [ ] 获取 PR diff
    - [ ] 调用 VPS `/webhook/code-review`
    - [ ] 发送 PR comment
    - [ ] 失败不阻断（`continue-on-error: true`）
  - [ ] `ci-passed` 的 `needs` 加入 `l2b-check`

### M4: npm scripts

- [ ] `package.json` 新增 scripts
  - [ ] `ci:preflight`
  - [ ] `lint`（占位符）
  - [ ] `format:check`（占位符）

### M5: 文档

- [ ] `.layer2-evidence.md` 模板创建
- [ ] VPS Review API 提示词更新（L2C 专用）

## 质量门控

- [ ] 所有现有测试通过（不影响现有功能）
- [ ] 本地运行 `npm run ci:preflight` 成功
- [ ] Audit Decision: PASS

## 完成度检查

- [ ] 所有必要项勾选
- [ ] 所有测试通过
- [ ] CI 通过
