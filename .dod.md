# DoD: 实施全新 CI 分层方案

QA: docs/QA-DECISION.md

## 必要项（全部完成才算完成）

### M1: 新增脚本

- [x] `scripts/devgate/l2b-check.sh` 创建并可执行
  Test: manual:L2B-evidence-check
  - [x] 支持 `pr` 模式（L2B-min）
    Test: manual:L2B-pr-mode
  - [x] 支持 `release` 模式（L2B-full）
    Test: manual:L2B-release-mode
  - [x] 检查 `.layer2-evidence.md` 存在
    Test: manual:L2B-file-exists
  - [x] 检查必需字段（## 手动验证、## 自动化测试）
    Test: manual:L2B-required-sections
  - [x] L2B-min：至少 1 条可复核证据
    Test: manual:L2B-min-evidence
  - [x] L2B-full：完整证据 + DoD 全勾
    Test: manual:L2B-full-evidence

- [x] `scripts/devgate/l3-fast.sh` 创建并可执行
  Test: manual:L3-fast-script
  - [x] lint 检查（TODO: 占位符）
    Test: manual:L3-lint-placeholder
  - [x] format 检查（TODO: 占位符）
    Test: manual:L3-format-placeholder
  - [x] 执行时间 < 10s
    Test: manual:L3-fast-timing

- [x] `scripts/devgate/ci-preflight.sh` 创建并可执行
  Test: manual:preflight-script
  - [x] 运行 L1-fast（typecheck + test，不 build）
    Test: manual:preflight-l1-fast
  - [x] 运行 L3-fast
    Test: manual:preflight-l3-fast
  - [x] 运行 L2A-min（可选）
    Test: manual:preflight-l2a-min
  - [x] 总时间 < 120s（hook 超时限制）
    Test: manual:preflight-timing

### M2: 修改 hook

- [x] `hooks/pr-gate-v2.sh` 增加 preflight 支持
  Test: manual:hook-preflight
  - [x] PR 模式先跑 `npm run ci:preflight`
    Test: manual:hook-preflight-call
  - [x] 增加 L2B-min 检查（调用 `l2b-check.sh pr`）
    Test: manual:hook-l2b-check
  - [x] 保持现有逻辑不变
    Test: tests/hooks/pr-gate.test.ts

### M3: 修改 CI

- [x] `.github/workflows/ci.yml` 增加 jobs
  Test: manual:ci-yml-changes
  - [x] 新增 `l2b-check` job
    Test: manual:ci-l2b-job
    - [x] 触发条件：`pull_request`
      Test: manual:ci-l2b-trigger
    - [x] `needs: [test]`
      Test: manual:ci-l2b-needs
    - [x] 运行 `bash scripts/devgate/l2b-check.sh pr`
      Test: manual:ci-l2b-run
  - [x] 新增 `ai-review` job
    Test: manual:ci-ai-review-job
    - [x] 触发条件：`pull_request`
      Test: manual:ci-ai-review-trigger
    - [x] `needs: [ci-passed]`
      Test: manual:ci-ai-review-needs
    - [x] 获取 PR diff
      Test: manual:ci-ai-review-diff
    - [x] 调用 VPS `/webhook/code-review`
      Test: manual:ci-ai-review-api
    - [x] 发送 PR comment
      Test: manual:ci-ai-review-comment
    - [x] 失败不阻断（`continue-on-error: true`）
      Test: manual:ci-ai-review-continue
  - [x] `ci-passed` 的 `needs` 加入 `l2b-check`
    Test: manual:ci-passed-needs

### M4: npm scripts

- [x] `package.json` 新增 scripts
  Test: manual:package-json-scripts
  - [x] `ci:preflight`
    Test: manual:npm-ci-preflight
  - [x] `lint`（占位符）
    Test: manual:npm-lint
  - [x] `format:check`（占位符）
    Test: manual:npm-format-check

### M5: 文档

- [x] `.layer2-evidence.md` 模板创建
  Test: manual:evidence-template
- [x] VPS Review API 提示词更新（L2C 专用）
  Test: manual:ai-review-prompt

## 质量门控

- [x] 所有现有测试通过（不影响现有功能）
  Test: tests/
- [x] 本地运行 `npm run ci:preflight` 成功
  Test: manual:preflight-local-run
- [x] Audit Decision: PASS
  Test: docs/AUDIT-REPORT.md

## 完成度检查

- [x] 所有必要项勾选
  Test: manual:dod-completion
- [x] 所有测试通过
  Test: tests/
- [x] CI 通过
  Test: manual:ci-pending
