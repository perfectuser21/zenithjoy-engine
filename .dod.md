# DoD - CI 补齐 L2A + develop L3 子集

QA: docs/QA-DECISION.md

## 验收标准

### P0: scripts/devgate/l2a-check.sh 实现

- [x] 脚本存在并可执行
  Test: tests/devgate/l2a-check.test.ts

- [x] 支持 pr 模式（默认）
  Test: tests/devgate/l2a-check.test.ts

- [x] 支持 release 模式（更严格）
  Test: tests/devgate/l2a-check.test.ts

- [x] pr 模式检查 .prd.md（存在 + 至少 3 行）
  Test: tests/devgate/l2a-check.test.ts

- [x] pr 模式检查 .dod.md（存在 + 至少 3 行 + 包含 QA:）
  Test: tests/devgate/l2a-check.test.ts

- [x] pr 模式检查 docs/QA-DECISION.md（存在 + 包含 Decision:）
  Test: tests/devgate/l2a-check.test.ts

- [x] pr 模式检查 docs/AUDIT-REPORT.md（存在 + Decision: PASS）
  Test: tests/devgate/l2a-check.test.ts

- [x] release 模式 .dod.md 全勾选（无 - [ ]）
  Test: tests/devgate/l2a-check.test.ts

- [x] release 模式 docs/QA-DECISION.md 必须 Decision: PASS
  Test: tests/devgate/l2a-check.test.ts

- [x] 输出格式规范（L2A_PASS / L2A_FAIL 前缀）
  Test: tests/devgate/l2a-check.test.ts

- [x] Exit code 正确（0=通过, 2=L2A失败, 1=异常）
  Test: tests/devgate/l2a-check.test.ts

### P0: .github/workflows/ci.yml 修改

- [x] test job 增加 l2a-check.sh pr 调用
  Test: manual:check-ci-yml-test-job

- [x] l2a-check 在 npm run qa 之后
  Test: manual:check-ci-yml-test-job

- [x] release-check job 增加 l2a-check.sh release 调用
  Test: manual:check-ci-yml-release-job

- [x] l2a-check release 在回归测试之前
  Test: manual:check-ci-yml-release-job

### P1: regression-pr job 实现

- [x] 新增 regression-pr job
  Test: manual:check-ci-yml-regression-pr-job

- [x] 条件：if: github.base_ref == 'develop'
  Test: manual:check-ci-yml-regression-pr-job

- [x] 依赖：needs: [test]
  Test: manual:check-ci-yml-regression-pr-job

- [x] 执行：bash scripts/run-regression.sh pr
  Test: manual:check-ci-yml-regression-pr-job

### P1: ci-passed 条件 needs

- [x] ci-passed job 使用条件 needs（避免 pending）
  Test: manual:check-ci-yml-ci-passed-needs

- [x] develop PR needs 包含 regression-pr
  Test: manual:check-ci-yml-ci-passed-needs

- [x] main PR needs 包含 release-check
  Test: manual:check-ci-yml-ci-passed-needs

- [x] 使用 always() 正确处理条件 job
  Test: manual:check-ci-yml-ci-passed-needs

### RCI 更新

- [x] 新增 C2-002: CI L2A Gate (pr mode)
  Test: manual:check-regression-contract-yaml

- [x] 新增 C2-003: CI L2A Gate (release mode)
  Test: manual:check-regression-contract-yaml

- [x] 新增 C4-001: develop PR regression
  Test: manual:check-regression-contract-yaml

- [x] 更新 C2-001: CI test job（添加 l2a-check 说明）
  Test: manual:check-regression-contract-yaml

### 质量检查

- [x] typecheck 通过
  Test: manual:typecheck-passed

- [x] test 通过（包括新增测试）
  Test: manual:test-passed
  Note: 189/191 passed. 2 pre-existing failures in pr-gate-phase1.test.ts (unrelated to L2A changes)

- [x] build 通过
  Test: manual:build-passed

### 上线

- [ ] PR 创建
  Test: manual:pr-link

- [ ] CI 通过
  Test: manual:ci-check

- [ ] PR 合并
  Test: manual:pr-merged
