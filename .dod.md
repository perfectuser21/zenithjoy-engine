---
id: dod-fix-stop-hook-cleanup
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# DoD: 修复 Stop Hook 跳过 Cleanup 的 Bug

## 验收清单

### 必要项

- [x] hooks/stop.sh 添加 cleanup_done 检测逻辑（在 .dev-mode 存在检查后）
  Test: tests/hooks/stop-hook.test.ts
- [x] hooks/stop.sh PR 合并时输出 "下一步: 执行 Step 11 (Cleanup)" 并 exit 2
  Test: manual:code-review
- [x] skills/dev/scripts/cleanup.sh 在最后添加 "cleanup_done: true" 到 .dev-mode
  Test: manual:code-review
- [x] 单元测试覆盖新逻辑
  Test: tests/hooks/stop-hook.test.ts

### QA 决策

QA: docs/QA-DECISION.md

## 测试计划

1. 模拟 PR 已合并场景，验证 Stop Hook 输出 "下一步: 执行 Step 11"
2. 验证 cleanup.sh 执行后 .dev-mode 包含 cleanup_done: true
3. 验证 Stop Hook 检测到 cleanup_done 后正常退出

## 成功标准

1. PR 合并后，Stop Hook 不再直接删除 .dev-mode 并退出
2. Stop Hook 返回 exit 2，提示执行 Cleanup
3. Cleanup 完成后标记 cleanup_done，下次 Stop Hook 检测到后正常退出
