---
id: dod-h7-tty-session-isolation
version: 1.1.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.1.0: gate:dod 反馈修复 - 具体化测试步骤
  - 1.0.0: 初始版本
---

# DoD - Stop Hook TTY 会话隔离

QA: docs/QA-DECISION.md

## 验收标准

### 功能验收
- [x] `.dev-mode` 文件包含 `tty: /dev/pts/N` 字段（有头模式）
      Test: tests/hooks/stop-hook.test.ts
      验证：写入 .dev-mode 时 tty 字段值为当前 `tty` 命令输出（如 /dev/pts/3）
- [x] Stop hook 读取 `tty:` 字段，当前 TTY 不匹配时 exit 0
      Test: tests/hooks/stop-hook.test.ts
      验证：mock .dev-mode 含 tty: /dev/pts/99，实际 TTY 不同，stop.sh exit 0
- [x] 当前 TTY 匹配时正常执行完成条件检查（exit 2）
      Test: tests/hooks/stop-hook.test.ts
      验证：mock .dev-mode 含与当前进程匹配的 tty，stop.sh exit 2
- [x] 无头模式（`CECELIA_HEADLESS=true`）行为不变
      Test: tests/hooks/stop-hook.test.ts
      验证：CECELIA_HEADLESS=true 时 stop.sh exit 0，不执行 TTY 检查
- [x] `CLAUDE_SESSION_ID` 逻辑保持不变作为 fallback
      Test: tests/hooks/stop-hook.test.ts
      验证：无 tty 字段时，session_id 不匹配仍 exit 0

### 向后兼容
- [x] 现有无 `tty:` 字段的 `.dev-mode` 文件不影响流程
      Test: tests/hooks/stop-hook.test.ts
      验证：.dev-mode 无 tty 行，stop.sh 跳过 TTY 检查，继续 session_id 检查

### 回归契约
- [x] regression-contract.yaml 新增 H7-008
      Test: contract:H7-008

### 测试验收
- [x] npm run qa 通过
      Test: contract:C2-001
