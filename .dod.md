---
id: dod-baseline-verification
version: 1.0.0
created: 2026-01-24
updated: 2026-01-24
changelog:
  - 1.0.0: 深度基线验证 DoD
---

# DoD - 深度基线验证 (Deep Baseline Verification)

关联 PRD: `.prd.md` (id: prd-baseline-verification)

QA: docs/QA-DECISION.md

---

## 核心验收清单

### Phase 1: 工作流完整性验证

- [ ] **测试脚本创建**: `tests/workflow-integrity.test.sh` 存在且可执行
  Test: manual:bash
  Evidence: 脚本文件 + 执行输出

- [ ] **new 模式测试**: 从 develop 创建新分支 → PRD → DoD → 代码 → PR → 通过
  Test: tests:workflow-integrity
  Evidence: `docs/WORKFLOW-TEST-REPORT.md` (new mode section)

- [ ] **continue 模式测试**: 在现有 cp-* 分支继续开发 → 通过
  Test: tests:workflow-integrity
  Evidence: `docs/WORKFLOW-TEST-REPORT.md` (continue mode section)

- [ ] **fix 模式测试**: PR 存在 + CI 失败 → 修复 → 通过
  Test: tests:workflow-integrity
  Evidence: `docs/WORKFLOW-TEST-REPORT.md` (fix mode section)

- [ ] **merge 模式测试**: PR 存在 + CI 成功 → 合并 → 通过
  Test: tests:workflow-integrity
  Evidence: `docs/WORKFLOW-TEST-REPORT.md` (merge mode section)

- [ ] **测试报告**: `docs/WORKFLOW-TEST-REPORT.md` 存在且包含所有 4 种模式的证据
  Test: manual:file-check
  Evidence: 报告文件存在 + 包含 4 个 mode sections

**验收标准**: 4/4 modes passed

---

### Phase 2: 绕过测试

#### 2.1 阻止场景 (12 tests)

- [ ] Test 1: 直接 push main → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/01-direct-push-main.log`

- [ ] Test 2: 直接 push develop → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/02-direct-push-develop.log`

- [ ] Test 3: Force push main → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/03-force-push-main.log`

- [ ] Test 4: Force push develop → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/04-force-push-develop.log`

- [ ] Test 5: Delete branch main → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/05-delete-main.log`

- [ ] Test 6: Delete branch develop → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/06-delete-develop.log`

- [ ] Test 7: gh CLI 绕过 (`gh pr merge --admin`) → ❌ 拒绝或要求 CI
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/07-gh-cli-bypass.log`

- [ ] Test 8: API 绕过 (merge) → ❌ HTTP 405/422
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/08-api-merge.log`

- [ ] Test 9: API 绕过 (update ref) → ❌ HTTP 422
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/09-api-update-ref.log`

- [ ] Test 10: Git 内部绕过 (`git update-ref`) → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/10-git-update-ref.log`

- [ ] Test 11: 无 PR 直接 push → ❌ HTTP 403
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/11-no-pr-push.log`

- [ ] Test 12: 绕过 CI 合并 → ❌ 要求 CI
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/12-bypass-ci.log`

#### 2.2 合法场景 (2 tests)

- [ ] Test 13: 正常 PR 流程 → ✅ CI 绿 → 可合并
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/13-normal-pr.log`

- [ ] Test 14: /dev 完整流程 → ✅ 全流程通过
  Test: tests:bypass-prevention
  Evidence: `evidence/bypass-tests/14-dev-workflow.log`

#### 证据要求

- [ ] **测试脚本**: `tests/bypass-prevention.test.sh` 存在且可执行
  Test: manual:bash
  Evidence: 脚本文件 + 执行输出

- [ ] **测试报告**: `docs/BYPASS-TEST-REPORT.md` 包含全部 14 个测试的详细结果
  Test: manual:file-check
  Evidence: 报告包含 14 个 test sections

- [ ] **证据文件**: `evidence/bypass-tests/` 目录包含每个测试的日志/截图
  Test: manual:file-count
  Evidence: 目录包含 14 个日志文件

**验收标准**: 14/14 tests passed (12 blocked + 2 passed)

---

### Phase 3: 三层防御验证

#### 3.1 Layer 1 - Local Hook

- [ ] 在 main/develop 执行 Write → ❌ 被阻止 + `[SKILL_REQUIRED: dev]` 提示
  Test: tests:three-layer-defense
  Evidence: `evidence/defense-layer-tests/hook-layer-1.log`

- [ ] 在 cp-* 无 PRD 执行 Write → ❌ 被阻止 + 提示创建 PRD
  Test: tests:three-layer-defense
  Evidence: `evidence/defense-layer-tests/hook-layer-2.log`

- [ ] 在 cp-* 有 PRD 执行 Write → ✅ 通过
  Test: tests:three-layer-defense
  Evidence: `evidence/defense-layer-tests/hook-layer-3.log`

- [ ] Hook 日志输出正确
  Test: tests:three-layer-defense
  Evidence: 上述 3 个日志文件

#### 3.2 Layer 2 - GitHub Branch Protection

- [ ] `enforce_admins: true` 已配置且生效
  Test: manual:gh-api
  Evidence: `evidence/defense-layer-tests/github-protection-config.json`

- [ ] `required_pull_request_reviews.required_approving_review_count: 0` 已配置且生效
  Test: manual:gh-api
  Evidence: `evidence/defense-layer-tests/github-protection-config.json`

- [ ] `required_status_checks` 已配置且生效
  Test: manual:gh-api
  Evidence: `evidence/defense-layer-tests/github-protection-config.json`

- [ ] `allow_force_pushes: false` 已配置且生效
  Test: manual:gh-api
  Evidence: `evidence/defense-layer-tests/github-protection-config.json`

- [ ] `allow_deletions: false` 已配置且生效
  Test: manual:gh-api
  Evidence: `evidence/defense-layer-tests/github-protection-config.json`

- [ ] API 查询返回正确配置
  Test: manual:gh-api
  Evidence: API 响应 JSON 文件

#### 3.3 Layer 3 - CI (GitHub Actions)

- [ ] PR 创建后自动触发 CI
  Test: manual:github-pr
  Evidence: 截图/日志

- [ ] CI 包含 `npm run qa` 测试
  Test: manual:ci-yml
  Evidence: `.github/workflows/ci.yml` 文件内容

- [ ] CI 失败时无法合并（手动测试验证）
  Test: manual:github-pr
  Evidence: `evidence/defense-layer-tests/ci-fail-merge-blocked.png`

- [ ] CI 成功后允许合并（手动测试验证）
  Test: manual:github-pr
  Evidence: `evidence/defense-layer-tests/ci-pass-merge-allowed.png`

#### 证据要求

- [ ] **测试脚本**: `tests/three-layer-defense.test.sh` 存在且可执行
  Test: manual:bash
  Evidence: 脚本文件 + 执行输出

- [ ] **测试报告**: `docs/DEFENSE-LAYER-REPORT.md` 包含每层的详细验证结果
  Test: manual:file-check
  Evidence: 报告包含 3 个 layer sections

- [ ] **证据文件**: `evidence/defense-layer-tests/` 包含 API 响应和日志
  Test: manual:file-count
  Evidence: 目录包含所有证据文件

**验收标准**: 3/3 layers verified

---

### Phase 4: 压力测试

#### 4.1 并发场景

- [ ] 多个 PR 同时存在（测试通过）
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (concurrent PRs section)

- [ ] 并发合并（测试通过）
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (concurrent merge section)

- [ ] Worktree 并发（测试通过）
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (worktree section)

#### 4.2 冲突场景

- [ ] Merge conflict 处理正确
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (conflict handling section)

- [ ] PR 过时处理正确
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (stale PR section)

- [ ] CI 失败修复流程正确
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (CI fix section)

#### 4.3 边界情况

- [ ] PRD 文件为空 → Hook 阻止
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (empty PRD section)

- [ ] DoD 文件缺失 → 工作流提示
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (missing DoD section)

- [ ] Audit Report 为 FAIL → 质检门控阻止
  Test: tests:stress-test
  Evidence: `docs/STRESS-TEST-REPORT.md` (audit fail section)

#### 证据要求

- [ ] **测试脚本**: `tests/stress-test.test.sh` 存在且可执行
  Test: manual:bash
  Evidence: 脚本文件 + 执行输出

- [ ] **测试报告**: `docs/STRESS-TEST-REPORT.md` 包含所有场景的结果
  Test: manual:file-check
  Evidence: 报告包含全部 8 个 scenario sections

- [ ] **证据文件**: `evidence/stress-tests/` 包含相关日志
  Test: manual:file-count
  Evidence: 目录包含证据文件

**验收标准**: 8/8 scenarios passed

---

### Phase 5: 对比分析

- [ ] **A- 能力矩阵**: 文档明确列出当前 A- 的所有防护项
  Test: manual:file-check
  Evidence: `docs/A-MINUS-VS-A-PLUS.md` (capability matrix)

- [ ] **A+ 对比**: 文档明确说明 A- 和 A+ 的差异
  Test: manual:file-check
  Evidence: `docs/A-MINUS-VS-A-PLUS.md` (comparison table)

- [ ] **风险评估**: 文档评估 A- 对单人自动化开发的适用性
  Test: manual:file-check
  Evidence: `docs/RISK-ASSESSMENT.md` (risk analysis)

- [ ] **最终建议**: 文档明确建议是否需要升级到 A+
  Test: manual:file-check
  Evidence: `docs/RISK-ASSESSMENT.md` (recommendation section)

#### 交付物

- [ ] `docs/A-MINUS-VS-A-PLUS.md` 存在且内容完整
  Test: manual:file-check
  Evidence: 文件存在 + 包含所有必要章节

- [ ] `docs/RISK-ASSESSMENT.md` 存在且内容完整
  Test: manual:file-check
  Evidence: 文件存在 + 包含风险评估和建议

---

## 总控验收

### 总控脚本

- [ ] `tests/baseline-verification.sh` 存在且可执行
  Test: manual:bash
  Evidence: 脚本文件 + 执行权限

- [ ] 总控脚本调用所有 Phase 测试
  Test: manual:code-review
  Evidence: 脚本内容调用 4 个 Phase 脚本

- [ ] 总控脚本生成统一的汇总报告
  Test: manual:bash
  Evidence: 执行输出包含汇总

### 总报告

- [ ] `docs/BASELINE-VERIFICATION-REPORT.md` 存在
  Test: manual:file-check
  Evidence: 文件存在

- [ ] 报告包含所有 Phase 的汇总结果
  Test: manual:file-check
  Evidence: 报告包含 5 个 Phase sections

- [ ] 报告明确回答 4 个核心问题：
  - /dev 工作流是否 100% 可用？
  - A- (95%) 保护是否真正有效？
  - 已知的 bypass 手段是否全部阻止？
  - 是否需要升级到 A+ (100%)？
  Test: manual:file-check
  Evidence: 报告包含明确答案的 conclusions section

### 最终输出

- [ ] 运行 `bash tests/baseline-verification.sh` 必须输出符合预期的汇总
  Test: manual:bash
  Evidence: 脚本输出 `29/29 tests passed` + `A- (95%) VERIFIED`

---

## 质量门控

### QA 决策

- [ ] QA 决策已创建或更新
  Test: manual:file-check
  Evidence: `docs/QA-DECISION.md` 存在

- [ ] 决策明确测试范围
  Test: manual:file-check
  Evidence: `docs/QA-DECISION.md` 包含测试范围说明

- [ ] 决策明确自动化程度
  Test: manual:file-check
  Evidence: `docs/QA-DECISION.md` 包含自动化策略

### Audit Node

- [ ] 代码审计通过（如有新增代码）
  Test: manual:audit
  Evidence: `docs/AUDIT-REPORT.md` (Decision: PASS)

- [ ] 测试脚本代码质量符合标准
  Test: manual:code-review
  Evidence: 脚本使用 shellcheck 检查通过

- [ ] 无安全风险
  Test: manual:security-review
  Evidence: 审计报告确认无安全问题

---

## 证据完整性

### 目录结构验证

```
tests/
├── workflow-integrity.test.sh       ✅ 存在
├── bypass-prevention.test.sh        ✅ 存在
├── three-layer-defense.test.sh      ✅ 存在
├── stress-test.test.sh              ✅ 存在
└── baseline-verification.sh         ✅ 存在

docs/
├── BASELINE-VERIFICATION-REPORT.md  ✅ 存在
├── WORKFLOW-TEST-REPORT.md          ✅ 存在
├── BYPASS-TEST-REPORT.md            ✅ 存在
├── DEFENSE-LAYER-REPORT.md          ✅ 存在
├── STRESS-TEST-REPORT.md            ✅ 存在
├── A-MINUS-VS-A-PLUS.md             ✅ 存在
└── RISK-ASSESSMENT.md               ✅ 存在

evidence/
├── bypass-tests/                    ✅ 包含 14 个日志文件
├── workflow-tests/                  ✅ 包含 4 个日志文件
├── defense-layer-tests/             ✅ 包含 API 响应和日志
└── stress-tests/                    ✅ 包含场景测试日志
```

- [ ] 目录结构完整
  Test: manual:file-tree
  Evidence: `tree tests/ docs/ evidence/` 输出

---

## 非功能性要求

### 自动化程度

- [ ] 所有测试可通过单一命令执行
  Test: manual:bash
  Evidence: `bash tests/baseline-verification.sh` 成功执行

- [ ] 测试结果自动生成报告
  Test: manual:bash
  Evidence: 执行后自动生成 `docs/BASELINE-VERIFICATION-REPORT.md`

- [ ] 证据文件自动收集
  Test: manual:file-check
  Evidence: `evidence/` 目录自动填充

### 可重复性

- [ ] 测试可在干净环境重复执行
  Test: manual:bash
  Evidence: 多次执行结果一致

- [ ] 测试后自动清理临时数据
  Test: manual:file-check
  Evidence: 无临时文件残留

- [ ] 测试不影响现有代码和历史
  Test: manual:git-status
  Evidence: `git status` 显示无意外修改

### 文档质量

- [ ] 所有报告使用 Markdown 格式
  Test: manual:file-extension
  Evidence: 所有报告文件扩展名为 `.md`

- [ ] 所有报告包含 frontmatter
  Test: manual:file-check
  Evidence: 每个报告文件前 5 行包含 `---` frontmatter

- [ ] 所有关键结论有证据支撑
  Test: manual:content-review
  Evidence: 报告中每个结论都引用证据文件

---

## 完成标准

### 必要条件（全部满足）

1. ✅ 所有测试脚本创建且可执行
2. ✅ 所有测试通过（29/29）
3. ✅ 所有报告生成且内容完整
4. ✅ 所有证据文件收集完整
5. ✅ 总控脚本输出符合预期
6. ✅ 4 个核心问题全部明确回答

### 交付清单

- [ ] 5 个测试脚本（workflow, bypass, defense, stress, baseline）
- [ ] 7 个文档报告（baseline, workflow, bypass, defense, stress, A-minus-vs-plus, risk）
- [ ] 证据目录（4 个子目录，包含所有日志/截图/API 响应）
- [ ] QA 决策文档
- [ ] 通过所有 Hook 检查

---

## 时间约束

**预计完成时间**: ~2.5 小时

**阻塞条件**: 无（所有依赖已就绪）

---

## 成功标志

当满足以下条件时，任务视为成功完成：

1. 运行 `bash tests/baseline-verification.sh` 输出 `29/29 PASSED`
2. `docs/BASELINE-VERIFICATION-REPORT.md` 明确结论：**CURRENT BASELINE IS SUFFICIENT**
3. 所有证据文件完整保存
4. 用户确认理解了 A- (95%) 的实际防护能力和适用场景
