# DoD: CI 安全性提升到 100%

## P0: Known-Failures 文件保护

- [ ] 创建 `known-failures-protection` CI job
- [ ] 检测 `ci/known-failures.json` 变更
- [ ] 要求 PR title 包含 `[INFRA]` 标记
- [ ] 验证文件内容合法性（最多 3 项、需 ticket、需 expires）
- [ ] 测试用例：修改文件不带标记会失败
- [ ] 测试用例：修改文件带标记且合法会通过
- [ ] 回归契约更新：添加 H-KF-001, H-KF-002

## P1: L2B Evidence 真实性验证

- [ ] 增强 `scripts/devgate/l2b-check.sh` 检查逻辑
- [ ] 验证证据中的 commit SHA 匹配当前 HEAD
- [ ] 验证证据中的 CI run ID 真实性（可选字段）
- [ ] 验证截图时间戳在合理范围（可选字段）
- [ ] 测试用例：假 SHA 的证据会失败
- [ ] 测试用例：真实证据会通过
- [ ] 回归契约更新：添加 L2B-001, L2B-002

## P1: DevGate 脚本存在性强制检查

- [ ] 在 DevGate checks 前增加脚本存在性检查
- [ ] 检查 3 个必需脚本：check-dod-mapping.cjs, scan-rci-coverage.cjs, require-rci-update-if-p0p1.sh
- [ ] 脚本缺失时直接失败（不允许 skipping）
- [ ] 测试用例：删除脚本会失败
- [ ] 回归契约更新：添加 DG-001

## P1: 关键配置文件变更审计

- [ ] 创建 `config-audit` CI job
- [ ] 检测关键配置文件变更：ci.yml, regression-contract.yaml, known-failures.json
- [ ] 要求 PR title 包含 `[CONFIG]` 或 `[INFRA]` 标记
- [ ] 输出明确的变更通知
- [ ] 测试用例：修改配置文件有通知
- [ ] 回归契约更新：添加 CA-001

## 分支合并流程检查

### feature/cp-* → develop

- [ ] 强化 ci-passed job 条件逻辑
- [ ] 确保 regression-pr 不能被 skipped 绕过（必须 success）
- [ ] 测试用例：修改条件尝试绕过会失败

### develop → main

- [ ] 强化 ci-passed job 条件逻辑
- [ ] 确保 release-check 不能被 skipped 绕过（必须 success）
- [ ] 测试用例：修改条件尝试绕过会失败

## 文档更新

- [ ] 更新 docs/LEARNINGS.md 记录 CI 安全加固经验
- [ ] 更新 regression-contract.yaml 添加所有新测试用例
- [ ] 更新 CHANGELOG.md 记录本次变更

## 质量检查

- [ ] 本地测试：所有修改的脚本语法正确
- [ ] 本地测试：新增的 CI job 逻辑正确
- [ ] TypeCheck 通过
- [ ] Build 通过
- [ ] 所有测试通过

## 版本更新

- [ ] package.json 版本更新（semver: feat → minor +0.1.0）
- [ ] VERSION 文件同步
- [ ] .hook-core-version 同步
- [ ] hook-core/VERSION 同步
