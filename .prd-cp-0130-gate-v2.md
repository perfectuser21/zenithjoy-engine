---
id: prd-gate-v2
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
---

# PRD: Gate 机制方案 A 改造

## 功能描述

按方案 A 改造 Gate 机制：Gate 文件是本地工作流的"自我约束"，CI 是"真正裁判"。

## 改造内容

### 1. Gate 文件增加防误用字段

- `head_sha`: 当前 commit SHA
- `generated_at`: 生成时间 (ISO8601)
- `task_id`: 任务 ID（从分支名提取）
- `tool_version`: 工具版本

### 2. Verify 脚本 Exit Code 分层

| Exit Code | 含义 |
|-----------|------|
| 0 | 验证通过 |
| 2 | 策略拦截（阻止型） |
| 3 | 验证器缺失/配置错误 |
| 4 | 输入格式错误/JSON 解析失败 |
| 5 | 签名/校验失败 |
| 6 | 分支/任务不匹配 |

### 3. 脚本不存在时硬失败

- pr-gate-v2.sh: verify 脚本不存在 → exit 2
- 明确报错，不静默跳过

## 成功标准

1. generate-gate-file.sh 输出包含新字段
2. verify-gate-signature.sh 返回分层 exit code
3. pr-gate-v2.sh 脚本缺失时硬失败

## 需求来源

深度审核发现的 P0-002/P1-001/P1-002 问题修复。
