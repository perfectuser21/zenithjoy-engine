---
id: dod-gate-v2
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
---

# DoD: Gate 机制方案 A 改造

## 验收清单

### Gate 文件新字段

- [x] `generate-gate-file.sh`: 添加 `head_sha` 字段（当前 commit SHA）
  Test: manual:运行脚本验证输出包含 head_sha ✅

- [x] `generate-gate-file.sh`: 添加 `generated_at` 字段（ISO8601 格式）
  Test: manual:验证时间格式正确 ✅

- [x] `generate-gate-file.sh`: 添加 `task_id` 字段（从分支名提取）
  Test: manual:验证 task_id 与分支名匹配 ✅

- [x] `generate-gate-file.sh`: 添加 `tool_version` 字段
  Test: manual:验证版本号存在 ✅

- [x] `verify-gate-signature.sh`: 验证新字段存在
  Test: manual:缺少字段时返回错误 ✅

### Exit Code 分层

- [x] `verify-gate-signature.sh`: exit 0 = 验证通过
  Test: manual:正常文件返回 0 ✅

- [x] `verify-gate-signature.sh`: exit 4 = 格式错误
  Test: manual:无效 JSON 返回 4 ✅

- [x] `verify-gate-signature.sh`: exit 5 = 签名校验失败
  Test: manual:伪造签名返回 5 ✅

- [x] `verify-gate-signature.sh`: exit 6 = 分支不匹配
  Test: manual:错误分支返回 6 ✅

### 硬失败机制

- [x] `pr-gate-v2.sh`: verify 脚本不存在时 exit 2
  Test: manual:code-review ✅

- [x] `pr-gate-v2.sh`: 区分不同 exit code 给出具体错误提示
  Test: manual:code-review ✅

## 质量参考

QA: docs/QA-DECISION-cp-0130-gate-v2.md
