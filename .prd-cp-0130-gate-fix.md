---
id: prd-gate-fix
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
---

# PRD: Gate 签名算法修复

## 功能描述

修复 Gate 签名机制的三个问题：
1. head_sha 字段不在签名中，可被篡改
2. decision 字段缺少 null 检查
3. 参数命名不一致（timestamp vs generated_at）

## 改造内容

### 1. 签名算法增加 head_sha

旧算法：
```
sha256("{gate}:{decision}:{generated_at}:{branch}:{secret}")
```

新算法：
```
sha256("{gate}:{decision}:{generated_at}:{branch}:{head_sha}:{secret}")
```

### 2. 验证脚本增加 decision null 检查

```bash
if [[ -z "$decision" || "$decision" == "null" ]]; then
    exit 4
fi
```

### 3. 统一参数命名

`generate_signature()` 函数参数名从 `timestamp` 改为 `generated_at`。

## 成功标准

1. 修改 head_sha 后签名验证失败
2. decision 为 null 时返回 exit 4
3. 代码中无 timestamp 参数名

## 需求来源

深度审计发现的 P0 级别问题。
