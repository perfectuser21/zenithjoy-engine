# PRD: /dev 工作流 v3 重构

## 需求来源
用户反馈当前流程存在问题：
1. Audit 在 Test 之后，改代码可能破坏已通过的测试
2. Gate/Quality/CI 职责混淆
3. Subagent 没有并行利用

## 功能描述

### 1. 三层职责分离

| 层 | 位置 | 类型 | 职责 |
|---|------|------|------|
| **Gate** | 本地 | 阻止型 | 过程卡口，FAIL 就停 |
| **Quality** | 本地 | 汇总型 | 打包结账单，不做判定 |
| **CI** | 远端 | 复核型 | 最终裁判，硬门禁 |

### 2. 流程重排

```
旧流程：
1-PRD → 2-Detect → 3-Branch → 4-DoD+QA → 5-Code → 6-Test → 7-Quality+Audit → 8-PR

新流程：
1-PRD → gate:prd (subagent)
2-Detect → 3-Branch
4-DoD → gate:dod + QA (并行 subagents)
5-Code → audit loop (subagent, 循环直到 PASS)
6-Test → gate:test (subagent)
7-Quality (只汇总，不判定)
8-PR → 9-CI → 10-Learning (subagent) → 11-Cleanup
```

### 3. Subagent 并行

| Subagent | 时机 | 类型 | 可并行 |
|----------|------|------|--------|
| gate:prd | PRD 后 | 阻止型 | - |
| gate:dod | DoD 后 | 阻止型 | 和 QA 并行 |
| QA | DoD 后 | 阻止型 | 和 gate:dod 并行 |
| audit | Code 后 | 阻止型（循环） | - |
| gate:test | Test 后 | 阻止型 | - |
| Learning | PR 合并后 | 循环型 | - |

### 4. Quality 只汇总

Quality 不再做审计，只输出 `quality-summary.json`：
```json
{
  "branch": "cp-xxx",
  "head_sha": "abc123",
  "timestamp": "...",
  "commands": {
    "test": { "status": "pass", "duration": "12s" },
    "typecheck": { "status": "pass", "duration": "3s" },
    "build": { "status": "pass", "duration": "8s" }
  },
  "gates": {
    "prd": { "status": "pass", "time": "..." },
    "dod": { "status": "pass", "time": "..." },
    "audit": { "status": "pass", "time": "..." },
    "test": { "status": "pass", "time": "..." }
  }
}
```

## 成功标准

1. Audit 在 Test 之前执行，改代码后不会破坏测试
2. gate:dod 和 QA 能并行执行
3. Quality 只汇总不判定
4. Learning 用 subagent 循环直到写好

## 影响范围

- `skills/dev/SKILL.md` - 流程总览
- `skills/dev/steps/01-prd.md` - 加 gate:prd
- `skills/dev/steps/04-dod.md` - gate:dod + QA 并行
- `skills/dev/steps/05-code.md` - 加 audit loop
- `skills/dev/steps/06-test.md` - 加 gate:test
- `skills/dev/steps/07-quality.md` - 改成只汇总
- `skills/dev/steps/10-learning.md` - 加 subagent
- 新增 `runtime/quality-summary.schema.json`
