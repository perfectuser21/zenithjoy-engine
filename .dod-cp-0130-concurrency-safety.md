# DoD: 并发安全与 CI 硬化

QA: docs/QA-DECISION-cp-0130-concurrency-safety.md

## 验收清单

### P0-2: Stop Hook 竞态条件修复
- [ ] stop.sh 加 flock 锁防止并发
  Test: manual:concurrent-session-test
- [ ] .dev-mode 写入使用原子替换 (mktemp + mv)
  Test: manual:atomic-write-test

### P0-3: pr-gate 超时保护
- [ ] pr-gate-v2.sh 引入 run_with_timeout 函数
  Test: tests/hooks/pr-gate.test.ts
- [ ] verify-gate-signature.sh 调用有超时保护
  Test: manual:timeout-test
- [ ] ci-preflight.sh 调用有超时保护
  Test: manual:timeout-test

### P0-4: CI known-failures 白名单
- [ ] 创建 ci/known-failures.json 权威清单
  Test: tests/ci/known-failures.test.ts
- [ ] CI 中加 schema 校验步骤
  Test: manual:ci-validation-test
- [ ] 非法输入直接 CI fail
  Test: manual:ci-validation-test

### P1-6: branch-protect skills 正则修复
- [ ] 使用 grep -Eq 强锚点匹配
  Test: tests/hooks/branch-protect.test.ts
- [ ] Engine skills 路径正确保护
  Test: tests/hooks/branch-protect.test.ts

## 技术方案

1. **hooks/stop.sh**: flock + 原子写
2. **hooks/pr-gate-v2.sh**: run_with_timeout 封装
3. **ci/known-failures.json**: 白名单定义
4. **.github/workflows/ci.yml**: schema 校验
5. **hooks/branch-protect.sh**: 正则修复
