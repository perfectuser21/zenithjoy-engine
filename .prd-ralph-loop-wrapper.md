# PRD: Ralph Loop Wrapper 修复

> Type: Enhancement
> Priority: P0

---

## 背景

v2.0 中 AI 应该在 /dev 内部调用 Ralph Loop，但总是跳过，导致 Step 4 和 Step 7 停顿。

---

## 目标

改为用户直接调用 Ralph Loop 包装 /dev，不依赖 AI 自觉性。

---

## 功能描述

### 1. 创建便捷命令

文件：`/home/xx/bin/dev-with-loop`

功能：
- 检测阶段（p0/p1/p2/pending/unknown）
- 根据阶段调用 Ralph Loop 包装 /dev
- p0: `/ralph-loop "/dev .prd.md" --completion-promise "DONE" --max-iterations 20`
- p1: `/ralph-loop "/dev" --completion-promise "DONE" --max-iterations 10`

### 2. 修改 skills/dev/SKILL.md

变更：
- 版本号：2.0.0 → 2.1.0
- 删除内部 Ralph Loop 调用逻辑
- 添加使用警告（不要直接调用 /dev）
- 简化职责：只负责流程编排
- 完成信号：QUALITY_GATE_PASSED/CI_PASSED → DONE

### 3. 更新 ~/.claude/CLAUDE.md

变更：
- Ralph Loop 自动调用规则 → Ralph Loop 使用规则
- AI 内部调用 → 用户直接调用
- 完成信号统一为 DONE

---

## 成功标准

- [x] `/home/xx/bin/dev-with-loop` 命令已创建且可执行
- [x] `skills/dev/SKILL.md` 已修改（v2.1.0）
- [x] `~/.claude/CLAUDE.md` 已更新
- [ ] 测试验证：调用 dev-with-loop 不会在 Step 4/7 停顿
- [ ] 文档已更新（CHANGELOG、FEATURES）

---

## 测试计划

### 手动验证

**M1：dev-with-loop 命令可用**
- 验证：`which dev-with-loop` 返回路径
- 验证：`dev-with-loop --help` 或直接执行显示启动信息

**M2：修改生效**
- 验证：`skills/dev/SKILL.md` 包含使用警告
- 验证：`~/.claude/CLAUDE.md` 包含用户调用规则

---

## 技术细节

### 职责分离

```
用户 → Ralph Loop（循环框架）
         ↓
       /dev（流程编排）
         ↓
       Step 1-8（具体步骤）
```

### 完成条件检查

AI 在每次 Ralph Loop 迭代结束时检查：
- p0: Audit PASS？质检通过？PR 创建？
- p1: CI 通过？PR 合并？

条件满足 → 输出 `<promise>DONE</promise>` → 结束
条件未满足 → 不输出 promise → 继续

---

## 相关文件

- `/home/xx/bin/dev-with-loop` - 便捷命令（新建）
- `skills/dev/SKILL.md` - /dev 主入口（修改）
- `~/.claude/CLAUDE.md` - 全局规则（修改）
- `docs/CONTRADICTION_ANALYSIS.md` - 矛盾分析报告（新建）
- `docs/FIX_PLAN.md` - 详细修复方案（新建）
- `docs/RALPH_LOOP_WRAPPER.md` - Wrapper 方案文档（新建）
