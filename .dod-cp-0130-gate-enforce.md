# DoD: Gate 强制执行机制

## 验收清单

### 核心功能

- [ ] 创建 `scripts/gate/generate-gate-file.sh`，生成带签名的 gate 文件
  Test: manual:运行generate-gate-file.sh生成.gate-xxx-passed文件

- [ ] 创建 `scripts/gate/verify-gate-signature.sh`，验证 gate 文件签名
  Test: manual:运行verify-gate-signature.sh验证签名正确

- [ ] 修改 `hooks/pr-gate-v2.sh`，检查 `.gate-prd-passed`、`.gate-dod-passed`、`.gate-test-passed`、`.gate-audit-passed` 四个文件
  Test: manual:code-review

### 失败场景

- [ ] Gate 文件不存在时，输出 `❌ 必须先通过 gate:xxx 审核` 并 exit 2
  Test: manual:删除gate文件后运行pr-gate验证报错

- [ ] 签名验证失败时，输出 `❌ gate 文件签名无效（expected: xxx, got: yyy）` 并 exit 2
  Test: manual:创建伪造签名文件运行verify验证拒绝

- [ ] 分支名不匹配时，输出 `❌ gate 文件分支不匹配（file: cp-aaa, current: cp-bbb）` 并 exit 2
  Test: manual:创建错误分支文件运行verify验证拒绝

### Secret 管理

- [ ] 首次运行时自动生成 `~/.claude/.gate-secret`（32 字节随机，64 字符 hex）
  Test: manual:删除~/.claude/.gate-secret后运行generate-gate-file.sh验证文件自动生成且长度64字符

- [ ] Secret 文件权限设为 600（仅 owner 可读写）
  Test: manual:ls-la验证权限为-rw-------

### 清理

- [ ] `.gate-*-passed` 加入 `.gitignore`
  Test: manual:grep验证.gitignore包含.gate-*-passed

## 质量参考

QA: docs/QA-DECISION-cp-0130-gate-enforce.md

## 非目标（v11.7.0）

- branch-protect.sh 基于 step 的 gate 检查（后续再加）
- cleanup.sh 自动清理 gate 文件（后续再加）
