# Layer 2 效果验证证据

## 代码证据

### C1: 文件存在检查
```bash
$ ls -la FEATURES.md package.json

-rw-r--r-- 1 xx xx 2847 Jan 20 ... FEATURES.md
-rw-r--r-- 1 xx xx  508 Jan 20 ... package.json

$ grep "qa" package.json
    "qa": "npm run typecheck && npm run test && npm run build"

HTTP_STATUS: 200
```

### C2: Hook 测试通过
```bash
$ npm test -- tests/hooks/

 ✓ tests/hooks/project-detect.test.ts (8 tests) 24ms
 ✓ tests/hooks/pr-gate.test.ts (5 tests) 395ms
 ✓ tests/hooks/branch-protect.test.ts (6 tests) 1278ms

 Test Files  3 passed (3)
      Tests  19 passed (19)

HTTP_STATUS: 200
```

### C3: PR Gate 双模式
```bash
$ echo '{"tool_name":"Bash","tool_input":{"command":"echo"}}' | PR_GATE_MODE=pr bash hooks/pr-gate-v2.sh
# 成功，无输出

$ echo '{"tool_name":"Bash","tool_input":{"command":"echo"}}' | PR_GATE_MODE=release bash hooks/pr-gate-v2.sh
# 成功，无输出

HTTP_STATUS: 200
```

### C4: 旧 Hook 已删除
```bash
$ ls hooks/pr-gate.sh hooks/subagent-quality-gate.sh 2>&1
ls: cannot access 'hooks/pr-gate.sh': No such file or directory
ls: cannot access 'hooks/subagent-quality-gate.sh': No such file or directory

HTTP_STATUS: 200
```

### C5: Settings 无 subagent 配置
```bash
$ grep -c "subagent" .claude/settings.json
0

HTTP_STATUS: 200
```

### C6: 文档更新验证
```bash
$ grep -c "Subagent" skills/dev/SKILL.md
0  # 已移除 Subagent 相关内容

$ grep "双模式" skills/dev/steps/07-quality.md
## 双模式质检

HTTP_STATUS: 200
```

### C7: 版本号检查
```bash
$ grep '"version"' package.json
  "version": "8.0.0",

$ grep "## \[8.0.0\]" CHANGELOG.md
## [8.0.0] - 2026-01-20

HTTP_STATUS: 200
```

### C8: npm run qa 通过
```bash
$ npm run qa

> zenithjoy-engine@8.0.0 qa
> npm run typecheck && npm run test && npm run build

# typecheck ✅
# test ✅ (107 passed)
# build ✅

HTTP_STATUS: 200
```

### C9: Evidence 引用格式修复
```bash
$ grep "Evidence:" .dod.md | head -3
- [x] /dev 流程集成 Ralph Loop 插件 Evidence: `C1`
- [x] 四种模式自动检测 Evidence: `C1`
- [x] 清理步骤状态机残留 Evidence: `C2`

# 格式从 `Evidence: C1` 改为 Evidence: `C1`
# release-check.sh 要求 ID 在 backticks 内

HTTP_STATUS: 200
```

### C10: qa-report.sh v3 输出验证
```bash
$ bash scripts/qa-report.sh --fast | jq '.features[0]'
{
  "id": "H1",
  "name": "branch-protect",
  "description": "禁止在 main/develop 直接写代码，强制走分支",
  "status": "Committed",
  "scope": "hook",
  "rci_count": 3,
  "rcis": ["H1-001", "H1-002", "H1-003"],
  "in_golden_paths": ["GP-002"]
}

$ bash scripts/qa-report.sh --fast | jq '.golden_paths[0]'
{
  "id": "GP-001",
  "name": "完整开发流程",
  "rcis": ["W1-001", "W1-002", "W1-003", "H2-003", "C1-001", "C2-001"],
  "covers_features": ["C1", "W1", "C2", "H2"]
}

$ bash scripts/qa-report.sh --fast | jq '.rcis.total'
26

HTTP_STATUS: 200
```

### C11: QA 系统清理验证
```bash
$ bash scripts/rc-filter.sh stats | grep "总 RCI"
  总 RCI 数量:    26

$ bash scripts/rc-filter.sh stats | grep "Golden Paths"
  Golden Paths:   4

$ grep "Committed Features" FEATURES.md
- **Committed Features**: 11（H1-H2, W1/W3/W4, C1-C4, B1, E1）

$ grep "W3-001" regression-contract.yaml | head -1
      - W3-001  # 质检失败触发回退

HTTP_STATUS: 200
```

### C12: rc-filter.sh awk bug 修复
```bash
$ bash scripts/rc-filter.sh release | grep -c "^  [A-Z]"
26

$ bash scripts/rc-filter.sh pr | grep -c "^  [A-Z]"
16

$ bash scripts/rc-filter.sh nightly | grep -c "^  [A-Z]"
26

# 修复前 Release 模式输出 0 条
# 原因：awk `/- id:/` 中的 `-` 需要转义为 `/\- id:/`

HTTP_STATUS: 200
```

### C13: 删除废弃 Features (B1/C4/W4)
```bash
$ grep "~~B1~~" FEATURES.md
| ~~B1~~ | ~~calculator~~ | **Deprecated** | - | v8.0.21 删除，示例代码不需要 |

$ grep "~~C4~~" FEATURES.md
| ~~C4~~ | ~~notify-failure~~ | **Deprecated** | - | v8.0.21 删除，改用 n8n/飞书通知 |

$ grep "~~W4~~" FEATURES.md
| ~~W4~~ | ~~测试任务模式~~ | **Deprecated** | - | v8.0.21 删除，功能不需要 |

$ grep -c "B1-001\|C4-001\|W4-001\|W4-002" regression-contract.yaml
0

$ ls src/calculator 2>&1
ls: cannot access 'src/calculator': No such file or directory

$ bash scripts/rc-filter.sh stats | grep "总 RCI"
  总 RCI 数量:    22

$ npm run qa
 Test Files  4 passed (4)
      Tests  19 passed (19)

HTTP_STATUS: 200
```

### C14: QA 清理 - Bug 修复
```bash
$ grep "base\[=\[:space:\]\]" hooks/pr-gate-v2.sh
    BASE_BRANCH=$(echo "$COMMAND" | sed -n 's/.*--base[=[:space:]]\+\([^[:space:]]\+\).*/\1/p' | head -1)

# 修复前只支持 --base value，现在也支持 --base=value

$ grep "version" FEATURES.md | head -1
version: 1.9.0

HTTP_STATUS: 200
```

### C15: rc-filter.sh stats 修复
```bash
$ bash scripts/rc-filter.sh stats | head -15
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  Regression Contract 统计
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  总 RCI 数量:    30
  Golden Paths:   5

# 修复：使用 awk 精确排除 GP-* 条目

HTTP_STATUS: 200
```

### C16: W4 [TEST] 模式清理
```bash
$ grep -c "\[TEST\]" skills/dev/steps/01-prd.md
0

# 移除了测试任务检测代码块（W4 已废弃）

HTTP_STATUS: 200
```

### C17: 孤儿测试清理
```bash
$ ls test-automation.* 2>&1
ls: cannot access 'test-automation.*': No such file or directory

# 删除了 test-automation.txt 和 test-automation.test.ts
# 这些是 W4 测试任务模式的遗留文件

HTTP_STATUS: 200
```

### C18: L3 回归测试脚本验证
```bash
$ bash scripts/run-regression.sh pr --dry-run | grep -c "trigger:"
18

$ bash scripts/run-regression.sh release --dry-run | grep -c "trigger:"
31

$ bash scripts/run-regression.sh pr 2>&1 | grep "Regression Test 通过"
  ✅ Regression Test 通过

HTTP_STATUS: 200
```
