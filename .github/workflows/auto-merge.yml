name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

# æ¯ä¸ª PR åªå…è®¸ä¸€ä¸ªåˆå¹¶å·¥ä½œæµè¿è¡Œ
concurrency:
  group: merge-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number }}
  cancel-in-progress: false

jobs:
  auto-merge:
    # åªåœ¨ PR approved ä¸” CI é€šè¿‡æ—¶æ‰åˆå¹¶
    if: |
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # check_suite äº‹ä»¶éœ€è¦ä» API è·å– PR å·
            PR_NUMBER=$(echo '${{ toJSON(github.event.check_suite.pull_requests) }}' | jq -r '.[0].number // empty')
            if [ -z "$PR_NUMBER" ]; then
              echo "No PR associated with this check suite"
              exit 0
            fi
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Check PR status
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          if [ -z "$PR_NUMBER" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # è·å– PR è¯¦æƒ…
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)

          # æ£€æŸ¥ PR çŠ¶æ€
          STATE=$(echo "$PR_DATA" | jq -r '.state')
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGED=$(echo "$PR_DATA" | jq -r '.merged')

          echo "PR #$PR_NUMBER status:"
          echo "  State: $STATE"
          echo "  Mergeable: $MERGEABLE"
          echo "  Merged: $MERGED"

          # å¦‚æœå·²ç»åˆå¹¶æˆ–å…³é—­ï¼Œè·³è¿‡
          if [ "$STATE" != "open" ] || [ "$MERGED" = "true" ]; then
            echo "PR is not open or already merged"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ approved review
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews --jq '[.[] | select(.state == "APPROVED")] | length')

          if [ "$REVIEWS" -eq 0 ]; then
            echo "No approved reviews yet"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥ CI çŠ¶æ€
          CI_STATUS=$(gh api repos/${{ github.repository }}/commits/$(echo "$PR_DATA" | jq -r '.head.sha')/status --jq '.state')

          echo "  Reviews: $REVIEWS"
          echo "  CI Status: $CI_STATUS"

          # å¿…é¡»åŒæ—¶æ»¡è¶³ï¼šæœ‰ approval + CI é€šè¿‡
          if [ "$CI_STATUS" = "success" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "CI not passed yet"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge PR
        if: steps.check.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ¤– Auto Merge PR #$PR_NUMBER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… CI passed"
          echo "âœ… Review approved"
          echo ""
          echo "Merging..."

          # ä½¿ç”¨ squash mergeï¼ˆä¿æŒå†å²ç®€æ´ï¼‰
          gh pr merge $PR_NUMBER --squash --auto

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… PR #$PR_NUMBER merged"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
