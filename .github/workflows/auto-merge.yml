name: Auto Merge

on:
  pull_request_review:
    types: [submitted]
  # SECURITY FIX: ç§»é™¤ check_suite è§¦å‘å™¨
  # åŸå› : check_suite äº‹ä»¶å¯è¢«å¤–éƒ¨ CI ç³»ç»Ÿè§¦å‘ï¼Œå…è®¸ç»•è¿‡ approval ç›´æ¥åˆå¹¶
  # ä¿®å¤: åªåœ¨ pull_request_review approved æ—¶è§¦å‘ï¼ŒCI çŠ¶æ€åœ¨åç»­æ­¥éª¤ä¸­éªŒè¯

# æ¯ä¸ª PR åªå…è®¸ä¸€ä¸ªåˆå¹¶å·¥ä½œæµè¿è¡Œ
concurrency:
  group: merge-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  auto-merge:
    # SECURITY FIX: åªåœ¨ PR approved æ—¶è§¦å‘ï¼ˆCI çŠ¶æ€åœ¨ Check PR status æ­¥éª¤éªŒè¯ï¼‰
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr
        run: |
          # SECURITY FIX: åªæ”¯æŒ pull_request_review äº‹ä»¶
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Check PR status
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          if [ -z "$PR_NUMBER" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # è·å– PR è¯¦æƒ…
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)

          # æ£€æŸ¥ PR çŠ¶æ€
          STATE=$(echo "$PR_DATA" | jq -r '.state')
          MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
          MERGED=$(echo "$PR_DATA" | jq -r '.merged')

          echo "PR #$PR_NUMBER status:"
          echo "  State: $STATE"
          echo "  Mergeable: $MERGEABLE"
          echo "  Merged: $MERGED"

          # å¦‚æœå·²ç»åˆå¹¶æˆ–å…³é—­ï¼Œè·³è¿‡
          if [ "$STATE" != "open" ] || [ "$MERGED" = "true" ]; then
            echo "PR is not open or already merged"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ approved review
          REVIEWS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews --jq '[.[] | select(.state == "APPROVED")] | length')

          if [ "$REVIEWS" -eq 0 ]; then
            echo "No approved reviews yet"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ£€æŸ¥ CI çŠ¶æ€ï¼ˆä½¿ç”¨ check-runs API æ›¿ä»£å·²è¿‡æ—¶çš„ commit status APIï¼‰
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          # è·å– check-runs çš„ç»¼åˆçŠ¶æ€
          CHECK_RUNS=$(gh api "repos/${{ github.repository }}/commits/$HEAD_SHA/check-runs" --jq '.check_runs')
          TOTAL_CHECKS=$(echo "$CHECK_RUNS" | jq 'length')
          COMPLETED_CHECKS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.status == "completed")] | length')
          SUCCESS_CHECKS=$(echo "$CHECK_RUNS" | jq '[.[] | select(.conclusion == "success")] | length')

          # åˆ¤æ–­ CI çŠ¶æ€
          if [[ "$TOTAL_CHECKS" -eq 0 ]]; then
            CI_STATUS="pending"
          elif [[ "$COMPLETED_CHECKS" -lt "$TOTAL_CHECKS" ]]; then
            CI_STATUS="pending"
          elif [[ "$SUCCESS_CHECKS" -eq "$TOTAL_CHECKS" ]]; then
            CI_STATUS="success"
          else
            CI_STATUS="failure"
          fi

          echo "  Reviews: $REVIEWS"
          echo "  CI Status: $CI_STATUS"

          # å¿…é¡»åŒæ—¶æ»¡è¶³ï¼šæœ‰ approval + CI é€šè¿‡
          if [ "$CI_STATUS" = "success" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "CI not passed yet"
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge PR
        # Bug fix: åŒæ—¶æ£€æŸ¥ ready=true ä¸” skip!=trueï¼Œç¡®ä¿ skip çŠ¶æ€è¢«æ­£ç¡®å¤„ç†
        if: steps.check.outputs.ready == 'true' && steps.check.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  ğŸ¤– Auto Merge PR #$PR_NUMBER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… CI passed"
          echo "âœ… Review approved"
          echo ""
          echo "Merging..."

          # ä½¿ç”¨ squash mergeï¼ˆä¿æŒå†å²ç®€æ´ï¼‰
          gh pr merge $PR_NUMBER --squash --auto

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… PR #$PR_NUMBER merged"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
