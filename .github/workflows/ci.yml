name: CI

on:
  pull_request:
    branches: [main, develop, 'feature/*', 'cp-*']
  push:
    branches: [main, develop, 'feature/*', 'cp-*']

# å·¥ä½œæµçº§å¹¶å‘æ§åˆ¶ï¼šåŒä¸€ ref çš„å¤šæ¬¡ push åªä¿ç•™æœ€æ–°
# æ³¨æ„ï¼šauto-merge job æœ‰è‡ªå·±çš„å¹¶å‘ç»„ï¼ˆmerge-*ï¼‰ï¼Œä¸å—æ­¤å½±å“
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package.json version updated
        run: |
          set -e
          if [ ! -f package.json ]; then
            echo "â„¹ï¸ No package.json found, skipping version check"
            exit 0
          fi

          echo "ğŸ” Checking if package.json version was updated..."

          # Get base branch version using jq (more reliable than sed)
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json 2>/dev/null | jq -r '.version' || echo "")

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" = "null" ]; then
            echo "âš ï¸ Could not read base branch version, skipping check"
            exit 0
          fi

          # Get current version
          CURRENT_VERSION=$(jq -r '.version' package.json)

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Validate semver format (MAJOR.MINOR.PATCH)
          SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+$'
          if ! [[ "$CURRENT_VERSION" =~ $SEMVER_REGEX ]]; then
            echo "âŒ Invalid version format: $CURRENT_VERSION"
            echo "Version must follow semver format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
            exit 1
          fi

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "âŒ Version not updated in package.json"
            echo "Please update the version according to semver rules"
            exit 1
          else
            echo "âœ… Version updated: $BASE_VERSION â†’ $CURRENT_VERSION"
          fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # DevGate éœ€è¦å®Œæ•´å†å²æ¥ diff base åˆ†æ”¯

      - name: Detect project type
        id: detect
        # æ³¨æ„ï¼šPython/Go æ£€æµ‹æ˜¯ä¸ºå¤šè¯­è¨€ä»“åº“é¢„ç•™çš„
        # å½“å‰ zenithjoy-engine æ˜¯ npm é¡¹ç›®ï¼Œä½†æ­¤æ£€æµ‹å¯å¤ç”¨äºå…¶ä»–ä»“åº“
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
            # æ£€æµ‹ Python ç‰ˆæœ¬è¦æ±‚
            if [ -f .python-version ]; then
              echo "python_version=$(cat .python-version)" >> $GITHUB_OUTPUT
            else
              echo "python_version=3.11" >> $GITHUB_OUTPUT
            fi
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
            # ä» go.mod è¯»å– Go ç‰ˆæœ¬ï¼ˆhead -1 ç¡®ä¿åªå–ç¬¬ä¸€ä¸ªåŒ¹é…ï¼‰
            GO_VERSION=$(grep '^go ' go.mod | head -1 | awk '{print $2}' || echo "1.21")
            echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install & Test (npm)
        if: steps.detect.outputs.type == 'npm'
        run: |
          set -e
          npm ci
          # DoD æ£€æŸ¥é¡¹ï¼ˆæŒ‰é¡ºåºï¼‰
          npm run typecheck --if-present   # ç±»å‹æ£€æŸ¥
          npm run test --if-present        # å•å…ƒæµ‹è¯•
          npm run build --if-present       # æ„å»ºéªŒè¯

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || { echo "âŒ pip install failed"; exit 1; }
          elif [ -f pyproject.toml ]; then
            pip install -e . || { echo "âŒ pip install failed"; exit 1; }
          fi
          if [ -f pytest.ini ] || [ -d tests ] || [ -d test ]; then
            pytest -v
          else
            echo "â„¹ï¸ No pytest config or tests directory found, skipping tests"
          fi

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.detect.outputs.go_version }}

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - always syntax check (hooks exist in all project types)
      - name: Check shell scripts
        run: |
          echo "Checking shell scripts..."
          FAILED=0
          FOUND=0
          # ä½¿ç”¨ find + while read éå†æ‰€æœ‰ .sh æ–‡ä»¶
          # -print0 + read -d '' å¤„ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦
          while IFS= read -r -d '' f; do
            FOUND=1
            # æ•è· stderr ä»¥ä¾¿æ˜¾ç¤ºå…·ä½“é”™è¯¯
            ERROR_OUTPUT=$(bash -n "$f" 2>&1)
            if [ $? -eq 0 ]; then
              echo "  [OK] $f"
            else
              echo "  [FAIL] $f"
              echo "$ERROR_OUTPUT" | sed 's/^/     /'
              FAILED=1
            fi
          done < <(find . -name "*.sh" -type f -not -path "./node_modules/*" -print0)
          if [ "$FOUND" -eq 0 ]; then
            echo "No .sh files found"
          fi
          exit $FAILED

      # Phase 1: DevGate æ£€æŸ¥ï¼ˆDoD æ˜ å°„ + P0/P1 RCI æ›´æ–° + RCI è¦†ç›–ç‡ï¼‰
      # æ³¨æ„ï¼šå½“å‰åªå¯¹ npm é¡¹ç›®å¯ç”¨ï¼Œé npm é¡¹ç›®è·³è¿‡æ­¤æ£€æŸ¥
      # TODO: æœªæ¥å¯æ‰©å±•åˆ°å…¶ä»–é¡¹ç›®ç±»å‹
      - name: DevGate checks
        if: steps.detect.outputs.type == 'npm'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Phase 1: DevGate æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # DoD æ˜ å°„æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/check-dod-mapping.cjs" ]; then
            echo ""
            echo "  [DoD â†” Test æ˜ å°„æ£€æŸ¥]"
            node scripts/devgate/check-dod-mapping.cjs || exit 1
          else
            echo "â„¹ï¸ check-dod-mapping.cjs not found, skipping"
          fi

          # P0/P1 RCI æ›´æ–°æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/require-rci-update-if-p0p1.sh" ]; then
            echo ""
            echo "  [P0/P1 RCI æ›´æ–°æ£€æŸ¥]"
            # ä» PR title æˆ– labels è®¾ç½®ç¯å¢ƒå˜é‡
            export PR_TITLE="${{ github.event.pull_request.title }}"
            # CI ä¸­éœ€è¦ä½¿ç”¨ origin/ å‰ç¼€
            export BASE_REF="origin/${{ github.base_ref || 'develop' }}"
            bash scripts/devgate/require-rci-update-if-p0p1.sh || exit 1
          else
            echo "â„¹ï¸ require-rci-update-if-p0p1.sh not found, skipping"
          fi

          # RCI è¦†ç›–ç‡æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          # æ–°å¢ä¸šåŠ¡å…¥å£å¿…é¡»æ·»åŠ å¯¹åº”çš„ RCI æ¡ç›®
          if [ -f "scripts/devgate/scan-rci-coverage.cjs" ]; then
            echo ""
            echo "  [RCI è¦†ç›–ç‡æ£€æŸ¥]"
            node scripts/devgate/scan-rci-coverage.cjs || {
              echo ""
              echo "âŒ RCI è¦†ç›–ç‡æ£€æŸ¥å¤±è´¥"
              echo "   æ–°å¢çš„ä¸šåŠ¡å…¥å£æ²¡æœ‰å¯¹åº”çš„ RCI æ¡ç›®"
              echo "   è¯·åœ¨ contracts/regression-contract.yaml ä¸­æ·»åŠ è¦†ç›–"
              echo ""
              echo "   è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦æƒ…ï¼š"
              echo "   npm run coverage:rci -- --explain"
              exit 1
            }
          else
            echo "â„¹ï¸ scan-rci-coverage.cjs not found, skipping"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… DevGate æ£€æŸ¥é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Contract Drift Check - é˜²æ­¢æ´¾ç”Ÿè§†å›¾æ¼‚ç§»
  contract-drift-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Generate path views from registry
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Contract Drift Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "æ£€æŸ¥ feature-registry.yml å’Œæ´¾ç”Ÿè§†å›¾æ˜¯å¦åŒæ­¥"
          echo ""

          # ç”Ÿæˆæ´¾ç”Ÿè§†å›¾
          bash scripts/generate-path-views.sh

      - name: Check for drift
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if ! git diff --exit-code docs/paths/; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âŒ Contract Drift æ£€æµ‹åˆ°"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "features/feature-registry.yml å·²å˜æ›´ï¼Œä½†æ´¾ç”Ÿè§†å›¾æœªæ›´æ–°ï¼"
            echo ""
            echo "ä¿®å¤æ–¹æ³•ï¼š"
            echo "  1. åœ¨æœ¬åœ°è¿è¡Œ: bash scripts/generate-path-views.sh"
            echo "  2. æäº¤ç”Ÿæˆçš„è§†å›¾æ–‡ä»¶:"
            echo "     git add docs/paths/"
            echo "     git commit -m 'docs: æ›´æ–°æ´¾ç”Ÿè§†å›¾ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰'"
            echo ""
            echo "å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only docs/paths/
            echo ""
            exit 1
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… Contract Drift Check é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "feature-registry.yml å’Œæ´¾ç”Ÿè§†å›¾å·²åŒæ­¥"

  # Impact Check - èƒ½åŠ›å˜æ›´å¼ºåˆ¶ç™»è®°ï¼ˆP0-1ï¼‰
  impact-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥ diff base åˆ†æ”¯

      - name: Run Impact Check
        run: |
          # CI ä¸­éœ€è¦ä½¿ç”¨ origin/ å‰ç¼€
          export BASE_REF="origin/${{ github.base_ref || 'develop' }}"
          bash scripts/devgate/impact-check.sh

  # Evidence Gate - è´¨æ£€è¯æ®é—¨æ§ï¼ˆP0-2ï¼‰
  evidence-gate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 2  # éœ€è¦çˆ¶æäº¤æ¥éªŒè¯è¯æ® SHA

      - name: Verify Quality Evidence
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Evidence Gate: è´¨æ£€è¯æ®éªŒè¯"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          EVIDENCE_FILE=".quality-evidence.json"

          # 1. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
          if [[ ! -f "$EVIDENCE_FILE" ]]; then
            echo "âŒ è¯æ®æ–‡ä»¶ä¸å­˜åœ¨: $EVIDENCE_FILE"
            echo ""
            echo "è¯·åœ¨æœ¬åœ°è¿è¡Œ 'npm run qa:gate' ç”Ÿæˆè¯æ®æ–‡ä»¶"
            exit 1
          fi

          echo "âœ“ è¯æ®æ–‡ä»¶å­˜åœ¨"

          # 2. æ£€æŸ¥ JSON æ ¼å¼æœ‰æ•ˆ
          if ! jq empty "$EVIDENCE_FILE" 2>/dev/null; then
            echo "âŒ è¯æ®æ–‡ä»¶æ ¼å¼æ— æ•ˆï¼ˆé JSONï¼‰"
            exit 1
          fi

          echo "âœ“ JSON æ ¼å¼æœ‰æ•ˆ"

          # 3. æ£€æŸ¥å¿…éœ€å­—æ®µ
          REQUIRED_FIELDS=("sha" "branch" "qa_gate_passed" "audit_decision" "timestamp")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if ! jq -e ".$field" "$EVIDENCE_FILE" > /dev/null 2>&1; then
              echo "âŒ ç¼ºå°‘å¿…éœ€å­—æ®µ: $field"
              exit 1
            fi
          done

          echo "âœ“ å¿…éœ€å­—æ®µé½å…¨"

          # 4. éªŒè¯ SHA åŒ¹é… HEAD~1ï¼ˆé˜²è€æ–‡ä»¶å†’ç”¨ï¼‰âš ï¸ å…³é”®
          # ä¸¤é˜¶æ®µæäº¤ï¼šcommit 1 = ä»£ç å˜æ›´, commit 2 = è¯æ®æ–‡ä»¶
          # checkout ä½¿ç”¨ PR head (é merge commit)ï¼Œæ‰€ä»¥ HEAD~1 å°±æ˜¯çˆ¶æäº¤
          PARENT_SHA=$(git rev-parse HEAD~1)
          EVIDENCE_SHA=$(jq -r '.sha' "$EVIDENCE_FILE")

          if [[ "$EVIDENCE_SHA" != "$PARENT_SHA" ]]; then
            echo "âŒ SHA ä¸åŒ¹é…ï¼"
            echo "   è¯æ® SHA: $EVIDENCE_SHA"
            echo "   HEAD~1: $PARENT_SHA (æœŸæœ›)"
            echo ""
            echo "è¯æ®æ–‡ä»¶åº”è¯¥å¼•ç”¨ä»£ç å˜æ›´çš„ commit (HEAD~1)"
            exit 1
          fi

          echo "âœ“ SHA éªŒè¯é€šè¿‡: $EVIDENCE_SHA"

          # 5. éªŒè¯ qa_gate_passed == true
          QA_GATE_PASSED=$(jq -r '.qa_gate_passed' "$EVIDENCE_FILE")
          if [[ "$QA_GATE_PASSED" != "true" ]]; then
            echo "âŒ qa_gate_passed != true"
            exit 1
          fi

          echo "âœ“ QA Gate å·²é€šè¿‡"

          # 6. éªŒè¯ audit_decision == "PASS"
          AUDIT_DECISION=$(jq -r '.audit_decision' "$EVIDENCE_FILE")
          if [[ "$AUDIT_DECISION" != "PASS" ]]; then
            echo "âŒ Audit Decision: $AUDIT_DECISION (æœŸæœ› PASS)"
            exit 1
          fi

          echo "âœ“ Audit Decision: PASS"

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… Evidence Gate é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Release æ£€æŸ¥ï¼ˆä»… develop â†’ main çš„ PRï¼‰
  release-check:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: L3 Regression Tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Release Check: L3 å›å½’æµ‹è¯•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash scripts/run-regression.sh release

      - name: L4 Evidence Check
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  L4: æ–‡æ¡£ & éªŒæ”¶æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          FAILED=0

          # L4a: æ£€æŸ¥ .layer2-evidence.md
          echo "  [Evidence æ–‡ä»¶]"
          if [ -f ".layer2-evidence.md" ]; then
            echo "  .layer2-evidence.md... âœ…"
          else
            echo "  .layer2-evidence.md... âŒ (ä¸å­˜åœ¨)"
            FAILED=1
          fi

          # L4b: æ£€æŸ¥ .dod.md
          echo ""
          echo "  [DoD éªŒæ”¶]"
          if [ -f ".dod.md" ]; then
            echo "  .dod.md... âœ…"

            # æ£€æŸ¥æ˜¯å¦å…¨å‹¾
            # æ³¨æ„ï¼šgrep -c æ‰¾åˆ° 0 åŒ¹é…æ—¶è¾“å‡º "0" ä½† exit 1ï¼Œä¸èƒ½ç”¨ || echo "0"
            UNCHECKED=$(grep -c '\- \[ \]' .dod.md 2>/dev/null) || true
            CHECKED=$(grep -c '\- \[x\]' .dod.md 2>/dev/null) || true
            UNCHECKED=${UNCHECKED:-0}
            CHECKED=${CHECKED:-0}

            if [ "$UNCHECKED" -eq 0 ] && [ "$CHECKED" -gt 0 ]; then
              echo "  éªŒæ”¶é¡¹... âœ… ($CHECKED é¡¹å…¨éƒ¨å®Œæˆ)"
            else
              echo "  éªŒæ”¶é¡¹... âŒ ($UNCHECKED é¡¹æœªå®Œæˆ)"
              FAILED=1
            fi
          else
            echo "  .dod.md... âŒ (ä¸å­˜åœ¨)"
            FAILED=1
          fi

          echo ""
          if [ "$FAILED" -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âŒ Release Check å¤±è´¥"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âœ… Release Check é€šè¿‡"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

  # CI é€šè¿‡åé€šçŸ¥ï¼ˆä¸è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰
  # æ³¨æ„ï¼šæ­¤ job åªåœ¨ pull_request äº‹ä»¶æ—¶è¿è¡Œï¼Œpush äº‹ä»¶æ—¶è·³è¿‡
  # A4 fix: PR to main æ—¶å¿…é¡»ç­‰ release-check å®Œæˆ
  ci-passed:
    needs: [version-check, test, impact-check, evidence-gate, release-check]
    if: |
      github.event_name == 'pull_request' &&
      needs.test.result == 'success' &&
      (needs.version-check.result == 'success' || needs.version-check.result == 'skipped') &&
      (needs.impact-check.result == 'success' || needs.impact-check.result == 'skipped') &&
      (needs.evidence-gate.result == 'success' || needs.evidence-gate.result == 'skipped') &&
      (needs.release-check.result == 'success' || needs.release-check.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: CI Passed
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… CI é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR #${{ github.event.pull_request.number }} CI æ£€æŸ¥é€šè¿‡"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "  1. æ‰‹åŠ¨ reviewï¼ˆå¦‚æœ‰éœ€è¦ï¼‰"
          echo "  2. æ‰‹åŠ¨åˆå¹¶ PR"
          echo ""
          echo "ä¸å†è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é€šè¿‡åæ‰‹åŠ¨æ“ä½œ"

  # CI å¤±è´¥æ—¶é€šçŸ¥ Notionï¼ˆversion-check æˆ– test å¤±è´¥éƒ½é€šçŸ¥ï¼‰
  notify-failure:
    needs: [version-check, test]
    if: always() && (needs.version-check.result == 'failure' || needs.test.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # CRITICAL ä¿®å¤: æ˜¾å¼å£°æ˜æœ€å°æƒé™
    permissions:
      contents: read
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
          VERSION_CHECK_RESULT: ${{ needs.version-check.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âš ï¸ Notion secrets not configured, skipping notification"
            exit 0
          fi

          # ç¡®å®šå¤±è´¥åŸå› 
          FAILURE_REASON=""
          if [ "$VERSION_CHECK_RESULT" = "failure" ]; then
            FAILURE_REASON="version-check"
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON + test"
            else
              FAILURE_REASON="test"
            fi
          fi

          # ç¡®å®š PR URL æˆ– Action URL
          PR_URL="${{ github.event.pull_request.html_url }}"
          if [ -z "$PR_URL" ]; then
            PR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          # CRITICAL ä¿®å¤: ä½¿ç”¨ jq å®‰å…¨ç”Ÿæˆ JSONï¼Œé˜²æ­¢æ³¨å…¥
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          JSON_PAYLOAD=$(jq -n \
            --arg db_id "$NOTION_DATABASE_ID" \
            --arg name "âŒ CI Failed ($FAILURE_REASON): ${{ github.repository }}" \
            --arg branch "${{ github.head_ref || github.ref_name }}" \
            --arg pr_url "$PR_URL" \
            --arg timestamp "$TIMESTAMP" \
            '{
              parent: {database_id: $db_id},
              properties: {
                Name: {title: [{text: {content: $name}}]},
                Status: {select: {name: "Failed"}},
                Branch: {rich_text: [{text: {content: $branch}}]},
                PR: {url: $pr_url},
                Time: {date: {start: $timestamp}}
              }
            }')

          curl -s --fail -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "$JSON_PAYLOAD"
          echo "ğŸ“¨ Notification sent to Notion (failed: $FAILURE_REASON)"
