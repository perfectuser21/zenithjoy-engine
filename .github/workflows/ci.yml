name: CI

on:
  pull_request:
    branches: [main, 'feature/*']
  push:
    branches: [main, 'feature/*']

# Â∑•‰ΩúÊµÅÁ∫ßÂπ∂ÂèëÊéßÂà∂ÔºöÂêå‰∏Ä ref ÁöÑÂ§öÊ¨° push Âè™‰øùÁïôÊúÄÊñ∞
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package.json version updated
        run: |
          if [ ! -f package.json ]; then
            echo "‚ÑπÔ∏è No package.json found, skipping version check"
            exit 0
          fi

          echo "üîç Checking if package.json version was updated..."

          # Get base branch version
          git fetch origin ${{ github.base_ref }}
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"version": "\(.*\)".*/\1/' || echo "")

          if [ -z "$BASE_VERSION" ]; then
            echo "‚ö†Ô∏è Could not read base branch version, skipping check"
            exit 0
          fi

          # Get current version
          CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": "\(.*\)".*/\1/')

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "‚ùå Version not updated in package.json"
            echo "Please update the version according to semver rules"
            exit 1
          else
            echo "‚úÖ Version updated: $BASE_VERSION ‚Üí $CURRENT_VERSION"
          fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Test (npm)
        if: steps.detect.outputs.type == 'npm'
        run: |
          npm ci
          npm run test --if-present
          npm run build --if-present

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            pip install -e .
          fi
          if [ -f pytest.ini ] || [ -d tests ] || [ -d test ]; then
            pytest -v
          else
            echo "‚ÑπÔ∏è No pytest config or tests directory found, skipping tests"
          fi

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - always syntax check (hooks exist in all project types)
      - name: Check shell scripts
        run: |
          echo "üîç Checking shell scripts..."
          FAILED=0
          FOUND=0
          while IFS= read -r -d '' f; do
            FOUND=1
            if bash -n "$f" 2>&1; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f (see error above)"
              FAILED=1
            fi
          done < <(find . -name "*.sh" -type f -print0)
          if [ "$FOUND" -eq 0 ]; then
            echo "‚ÑπÔ∏è No .sh files found"
          fi
          exit $FAILED

  # Ëá™Âä®ÂêàÂπ∂ PRÔºàCI ÈÄöËøáÂêéÔºâ
  # Ê≥®ÊÑèÔºöversion-check Âè™Âú® PR Êó∂ËøêË°åÔºåpush Êó∂‰∏∫ skipped
  auto-merge:
    needs: [version-check, test]
    if: github.event_name == 'pull_request' && !failure() && !cancelled() && (needs.version-check.result == 'success' || needs.version-check.result == 'skipped')
    runs-on: ubuntu-latest
    # Âπ∂Âèë‰øùÊä§ÔºöÂêå‰∏Ä‰∏™ base ÂàÜÊîØÁöÑ PR ÊéíÈòüÂêàÂπ∂ÔºåÈÅøÂÖçÂÜ≤Á™Å
    concurrency:
      group: merge-${{ github.base_ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Auto merge PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "‚úÖ CI passed, merging PR #${{ github.event.pull_request.number }}"
          if gh pr merge ${{ github.event.pull_request.number }} \
            --squash \
            --delete-branch \
            --body "Auto-merged after CI passed"; then
            echo "üéâ PR merged successfully"
          else
            echo "‚ö†Ô∏è Auto-merge failed (might need manual merge due to conflicts)"
            exit 0  # Don't fail CI, just notify
          fi

  # CI Â§±Ë¥•Êó∂ÈÄöÁü• NotionÔºàversion-check Êàñ test Â§±Ë¥•ÈÉΩÈÄöÁü•Ôºâ
  notify-failure:
    needs: [version-check, test]
    if: always() && (needs.version-check.result == 'failure' || needs.test.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "‚ö†Ô∏è Notion secrets not configured, skipping notification"
            exit 0
          fi

          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": {"database_id": "'"$NOTION_DATABASE_ID"'"},
              "properties": {
                "Name": {"title": [{"text": {"content": "‚ùå CI Failed: ${{ github.repository }}"}}]},
                "Status": {"select": {"name": "Failed"}},
                "Branch": {"rich_text": [{"text": {"content": "${{ github.head_ref || github.ref_name }}"}}]},
                "PR": {"url": "${{ github.event.pull_request.html_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}"},
                "Time": {"date": {"start": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}}
              }
            }'
          echo "üì® Notification sent to Notion"
