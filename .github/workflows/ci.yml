name: CI

on:
  pull_request:
    branches: [main, develop, 'feature/*']
  push:
    branches: [main, develop, 'feature/*']

# Â∑•‰ΩúÊµÅÁ∫ßÂπ∂ÂèëÊéßÂà∂ÔºöÂêå‰∏Ä ref ÁöÑÂ§öÊ¨° push Âè™‰øùÁïôÊúÄÊñ∞
# Ê≥®ÊÑèÔºöauto-merge job ÊúâËá™Â∑±ÁöÑÂπ∂ÂèëÁªÑÔºàmerge-*ÔºâÔºå‰∏çÂèóÊ≠§ÂΩ±Âìç
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package.json version updated
        run: |
          set -e
          if [ ! -f package.json ]; then
            echo "‚ÑπÔ∏è No package.json found, skipping version check"
            exit 0
          fi

          echo "üîç Checking if package.json version was updated..."

          # Get base branch version using jq (more reliable than sed)
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json 2>/dev/null | jq -r '.version' || echo "")

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" = "null" ]; then
            echo "‚ö†Ô∏è Could not read base branch version, skipping check"
            exit 0
          fi

          # Get current version
          CURRENT_VERSION=$(jq -r '.version' package.json)

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Validate semver format (MAJOR.MINOR.PATCH)
          SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+$'
          if ! [[ "$CURRENT_VERSION" =~ $SEMVER_REGEX ]]; then
            echo "‚ùå Invalid version format: $CURRENT_VERSION"
            echo "Version must follow semver format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
            exit 1
          fi

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "‚ùå Version not updated in package.json"
            echo "Please update the version according to semver rules"
            exit 1
          else
            echo "‚úÖ Version updated: $BASE_VERSION ‚Üí $CURRENT_VERSION"
          fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
            # Ê£ÄÊµã Python ÁâàÊú¨Ë¶ÅÊ±Ç
            if [ -f .python-version ]; then
              echo "python_version=$(cat .python-version)" >> $GITHUB_OUTPUT
            else
              echo "python_version=3.11" >> $GITHUB_OUTPUT
            fi
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
            # ‰ªé go.mod ËØªÂèñ Go ÁâàÊú¨Ôºàhead -1 Á°Æ‰øùÂè™ÂèñÁ¨¨‰∏Ä‰∏™ÂåπÈÖçÔºâ
            GO_VERSION=$(grep '^go ' go.mod | head -1 | awk '{print $2}' || echo "1.21")
            echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install & Test (npm)
        if: steps.detect.outputs.type == 'npm'
        run: |
          set -e
          npm ci
          # DoD Ê£ÄÊü•È°πÔºàÊåâÈ°∫Â∫èÔºâ
          npm run typecheck --if-present   # Á±ªÂûãÊ£ÄÊü•
          npm run lint --if-present        # ‰ª£Á†ÅËßÑËåÉ
          npm run format:check --if-present # Ê†ºÂºèÊ£ÄÊü•
          npm run test --if-present        # ÂçïÂÖÉÊµãËØï
          npm run build --if-present       # ÊûÑÂª∫È™åËØÅ

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || { echo "‚ùå pip install failed"; exit 1; }
          elif [ -f pyproject.toml ]; then
            pip install -e . || { echo "‚ùå pip install failed"; exit 1; }
          fi
          if [ -f pytest.ini ] || [ -d tests ] || [ -d test ]; then
            pytest -v
          else
            echo "‚ÑπÔ∏è No pytest config or tests directory found, skipping tests"
          fi

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.detect.outputs.go_version }}

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - always syntax check (hooks exist in all project types)
      - name: Check shell scripts
        run: |
          echo "üîç Checking shell scripts..."
          FAILED=0
          FOUND=0
          while IFS= read -r -d '' f; do
            FOUND=1
            # ÊçïËé∑ stderr ‰ª•‰æøÊòæÁ§∫ÂÖ∑‰ΩìÈîôËØØ
            ERROR_OUTPUT=$(bash -n "$f" 2>&1)
            if [ $? -eq 0 ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå $f"
              echo "$ERROR_OUTPUT" | sed 's/^/     /'
              FAILED=1
            fi
          done < <(find . -name "*.sh" -type f -not -path "./node_modules/*" -print0)
          if [ "$FOUND" -eq 0 ]; then
            echo "‚ÑπÔ∏è No .sh files found"
          fi
          exit $FAILED

  # CI ÈÄöËøáÂêéÈÄöÁü•Ôºà‰∏çËá™Âä®ÂêàÂπ∂ÔºåÈúÄË¶ÅÊâãÂä®Á°ÆËÆ§Ôºâ
  ci-passed:
    needs: [version-check, test]
    if: github.event_name == 'pull_request' && needs.test.result == 'success' && (needs.version-check.result == 'success' || needs.version-check.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: CI Passed
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  ‚úÖ CI ÈÄöËøá"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "PR #${{ github.event.pull_request.number }} CI Ê£ÄÊü•ÈÄöËøá"
          echo ""
          echo "‰∏ã‰∏ÄÊ≠•Ôºö"
          echo "  1. Á≠âÂæÖ Codex reviewÔºàÂ¶ÇÊûúÈÖçÁΩÆ‰∫ÜÔºâ"
          echo "  2. ÊâãÂä®ÂêàÂπ∂ PR"
          echo ""
          echo "‰∏çÂÜçËá™Âä®ÂêàÂπ∂ÔºåÈúÄË¶ÅÁ°ÆËÆ§ÊâÄÊúâÊ£ÄÊü•ÈÄöËøáÂêéÊâãÂä®Êìç‰Ωú"

  # CI Â§±Ë¥•Êó∂ÈÄöÁü• NotionÔºàversion-check Êàñ test Â§±Ë¥•ÈÉΩÈÄöÁü•Ôºâ
  notify-failure:
    needs: [version-check, test]
    if: always() && (needs.version-check.result == 'failure' || needs.test.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
          VERSION_CHECK_RESULT: ${{ needs.version-check.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "‚ö†Ô∏è Notion secrets not configured, skipping notification"
            exit 0
          fi

          # Á°ÆÂÆöÂ§±Ë¥•ÂéüÂõ†
          FAILURE_REASON=""
          if [ "$VERSION_CHECK_RESULT" = "failure" ]; then
            FAILURE_REASON="version-check"
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON + test"
            else
              FAILURE_REASON="test"
            fi
          fi

          # Á°ÆÂÆö PR URL Êàñ Action URL
          PR_URL="${{ github.event.pull_request.html_url }}"
          if [ -z "$PR_URL" ]; then
            PR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": {"database_id": "'"$NOTION_DATABASE_ID"'"},
              "properties": {
                "Name": {"title": [{"text": {"content": "‚ùå CI Failed ('"$FAILURE_REASON"'): ${{ github.repository }}"}}]},
                "Status": {"select": {"name": "Failed"}},
                "Branch": {"rich_text": [{"text": {"content": "${{ github.head_ref || github.ref_name }}"}}]},
                "PR": {"url": "'"$PR_URL"'"},
                "Time": {"date": {"start": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}}
              }
            }'
          echo "üì® Notification sent to Notion (failed: $FAILURE_REASON)"
