name: CI

on:
  pull_request:
    branches: [main, develop, 'feature/*']
  push:
    branches: [main, develop, 'feature/*']

# å·¥ä½œæµçº§å¹¶å‘æ§åˆ¶ï¼šåŒä¸€ ref çš„å¤šæ¬¡ push åªä¿ç•™æœ€æ–°
# æ³¨æ„ï¼šauto-merge job æœ‰è‡ªå·±çš„å¹¶å‘ç»„ï¼ˆmerge-*ï¼‰ï¼Œä¸å—æ­¤å½±å“
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package.json version updated
        run: |
          set -e
          if [ ! -f package.json ]; then
            echo "â„¹ï¸ No package.json found, skipping version check"
            exit 0
          fi

          echo "ğŸ” Checking if package.json version was updated..."

          # Get base branch version using jq (more reliable than sed)
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json 2>/dev/null | jq -r '.version' || echo "")

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" = "null" ]; then
            echo "âš ï¸ Could not read base branch version, skipping check"
            exit 0
          fi

          # Get current version
          CURRENT_VERSION=$(jq -r '.version' package.json)

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Validate semver format (MAJOR.MINOR.PATCH)
          SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+$'
          if ! [[ "$CURRENT_VERSION" =~ $SEMVER_REGEX ]]; then
            echo "âŒ Invalid version format: $CURRENT_VERSION"
            echo "Version must follow semver format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
            exit 1
          fi

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "âŒ Version not updated in package.json"
            echo "Please update the version according to semver rules"
            exit 1
          else
            echo "âœ… Version updated: $BASE_VERSION â†’ $CURRENT_VERSION"
          fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
            # æ£€æµ‹ Python ç‰ˆæœ¬è¦æ±‚
            if [ -f .python-version ]; then
              echo "python_version=$(cat .python-version)" >> $GITHUB_OUTPUT
            else
              echo "python_version=3.11" >> $GITHUB_OUTPUT
            fi
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
            # ä» go.mod è¯»å– Go ç‰ˆæœ¬ï¼ˆhead -1 ç¡®ä¿åªå–ç¬¬ä¸€ä¸ªåŒ¹é…ï¼‰
            GO_VERSION=$(grep '^go ' go.mod | head -1 | awk '{print $2}' || echo "1.21")
            echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install & Test (npm)
        if: steps.detect.outputs.type == 'npm'
        run: |
          set -e
          npm ci
          # DoD æ£€æŸ¥é¡¹ï¼ˆæŒ‰é¡ºåºï¼‰
          npm run typecheck --if-present   # ç±»å‹æ£€æŸ¥
          npm run lint --if-present        # ä»£ç è§„èŒƒ
          npm run format:check --if-present # æ ¼å¼æ£€æŸ¥
          npm run test --if-present        # å•å…ƒæµ‹è¯•
          npm run build --if-present       # æ„å»ºéªŒè¯

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || { echo "âŒ pip install failed"; exit 1; }
          elif [ -f pyproject.toml ]; then
            pip install -e . || { echo "âŒ pip install failed"; exit 1; }
          fi
          if [ -f pytest.ini ] || [ -d tests ] || [ -d test ]; then
            pytest -v
          else
            echo "â„¹ï¸ No pytest config or tests directory found, skipping tests"
          fi

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.detect.outputs.go_version }}

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - always syntax check (hooks exist in all project types)
      - name: Check shell scripts
        run: |
          echo "ğŸ” Checking shell scripts..."
          FAILED=0
          FOUND=0
          while IFS= read -r -d '' f; do
            FOUND=1
            # æ•è· stderr ä»¥ä¾¿æ˜¾ç¤ºå…·ä½“é”™è¯¯
            ERROR_OUTPUT=$(bash -n "$f" 2>&1)
            if [ $? -eq 0 ]; then
              echo "  âœ… $f"
            else
              echo "  âŒ $f"
              echo "$ERROR_OUTPUT" | sed 's/^/     /'
              FAILED=1
            fi
          done < <(find . -name "*.sh" -type f -not -path "./node_modules/*" -print0)
          if [ "$FOUND" -eq 0 ]; then
            echo "â„¹ï¸ No .sh files found"
          fi
          exit $FAILED

      # Phase 1: DevGate æ£€æŸ¥ï¼ˆDoD æ˜ å°„ + P0/P1 RCI æ›´æ–°ï¼‰
      - name: DevGate checks
        if: steps.detect.outputs.type == 'npm'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Phase 1: DevGate æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # DoD æ˜ å°„æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/check-dod-mapping.cjs" ]; then
            echo ""
            echo "  [DoD â†” Test æ˜ å°„æ£€æŸ¥]"
            node scripts/devgate/check-dod-mapping.cjs || exit 1
          else
            echo "â„¹ï¸ check-dod-mapping.cjs not found, skipping"
          fi

          # P0/P1 RCI æ›´æ–°æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/require-rci-update-if-p0p1.sh" ]; then
            echo ""
            echo "  [P0/P1 RCI æ›´æ–°æ£€æŸ¥]"
            # ä» PR title æˆ– labels è®¾ç½®ç¯å¢ƒå˜é‡
            export PR_TITLE="${{ github.event.pull_request.title }}"
            # labels éœ€è¦ä» API è·å–ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
            bash scripts/devgate/require-rci-update-if-p0p1.sh || exit 1
          else
            echo "â„¹ï¸ require-rci-update-if-p0p1.sh not found, skipping"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… DevGate æ£€æŸ¥é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Release æ£€æŸ¥ï¼ˆä»… develop â†’ main çš„ PRï¼‰
  release-check:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: L3 Regression Tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Release Check: L3 å›å½’æµ‹è¯•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash scripts/run-regression.sh release

      - name: L4 Evidence Check
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  L4: æ–‡æ¡£ & éªŒæ”¶æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          FAILED=0

          # L4a: æ£€æŸ¥ .layer2-evidence.md
          echo "  [Evidence æ–‡ä»¶]"
          if [ -f ".layer2-evidence.md" ]; then
            echo "  .layer2-evidence.md... âœ…"
          else
            echo "  .layer2-evidence.md... âŒ (ä¸å­˜åœ¨)"
            FAILED=1
          fi

          # L4b: æ£€æŸ¥ .dod.md
          echo ""
          echo "  [DoD éªŒæ”¶]"
          if [ -f ".dod.md" ]; then
            echo "  .dod.md... âœ…"

            # æ£€æŸ¥æ˜¯å¦å…¨å‹¾
            # æ³¨æ„ï¼šgrep -c æ‰¾åˆ° 0 åŒ¹é…æ—¶è¾“å‡º "0" ä½† exit 1ï¼Œä¸èƒ½ç”¨ || echo "0"
            UNCHECKED=$(grep -c '\- \[ \]' .dod.md 2>/dev/null) || true
            CHECKED=$(grep -c '\- \[x\]' .dod.md 2>/dev/null) || true
            UNCHECKED=${UNCHECKED:-0}
            CHECKED=${CHECKED:-0}

            if [ "$UNCHECKED" -eq 0 ] && [ "$CHECKED" -gt 0 ]; then
              echo "  éªŒæ”¶é¡¹... âœ… ($CHECKED é¡¹å…¨éƒ¨å®Œæˆ)"
            else
              echo "  éªŒæ”¶é¡¹... âŒ ($UNCHECKED é¡¹æœªå®Œæˆ)"
              FAILED=1
            fi
          else
            echo "  .dod.md... âŒ (ä¸å­˜åœ¨)"
            FAILED=1
          fi

          echo ""
          if [ "$FAILED" -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âŒ Release Check å¤±è´¥"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âœ… Release Check é€šè¿‡"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

  # CI é€šè¿‡åé€šçŸ¥ï¼ˆä¸è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰
  ci-passed:
    needs: [version-check, test]
    if: github.event_name == 'pull_request' && needs.test.result == 'success' && (needs.version-check.result == 'success' || needs.version-check.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: CI Passed
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… CI é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR #${{ github.event.pull_request.number }} CI æ£€æŸ¥é€šè¿‡"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "  1. æ‰‹åŠ¨ reviewï¼ˆå¦‚æœ‰éœ€è¦ï¼‰"
          echo "  2. æ‰‹åŠ¨åˆå¹¶ PR"
          echo ""
          echo "ä¸å†è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é€šè¿‡åæ‰‹åŠ¨æ“ä½œ"

  # CI å¤±è´¥æ—¶é€šçŸ¥ Notionï¼ˆversion-check æˆ– test å¤±è´¥éƒ½é€šçŸ¥ï¼‰
  notify-failure:
    needs: [version-check, test]
    if: always() && (needs.version-check.result == 'failure' || needs.test.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
          VERSION_CHECK_RESULT: ${{ needs.version-check.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âš ï¸ Notion secrets not configured, skipping notification"
            exit 0
          fi

          # ç¡®å®šå¤±è´¥åŸå› 
          FAILURE_REASON=""
          if [ "$VERSION_CHECK_RESULT" = "failure" ]; then
            FAILURE_REASON="version-check"
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON + test"
            else
              FAILURE_REASON="test"
            fi
          fi

          # ç¡®å®š PR URL æˆ– Action URL
          PR_URL="${{ github.event.pull_request.html_url }}"
          if [ -z "$PR_URL" ]; then
            PR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": {"database_id": "'"$NOTION_DATABASE_ID"'"},
              "properties": {
                "Name": {"title": [{"text": {"content": "âŒ CI Failed ('"$FAILURE_REASON"'): ${{ github.repository }}"}}]},
                "Status": {"select": {"name": "Failed"}},
                "Branch": {"rich_text": [{"text": {"content": "${{ github.head_ref || github.ref_name }}"}}]},
                "PR": {"url": "'"$PR_URL"'"},
                "Time": {"date": {"start": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}}
              }
            }'
          echo "ğŸ“¨ Notification sent to Notion (failed: $FAILURE_REASON)"
