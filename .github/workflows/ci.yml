name: CI

on:
  pull_request:
    branches: [main, develop, 'feature/*', 'cp-*']
  push:
    branches: [main, develop, 'feature/*', 'cp-*']

# å·¥ä½œæµçº§å¹¶å‘æ§åˆ¶ï¼šåŒä¸€ ref çš„å¤šæ¬¡ push åªä¿ç•™æœ€æ–°
# æ³¨æ„ï¼šauto-merge job æœ‰è‡ªå·±çš„å¹¶å‘ç»„ï¼ˆmerge-*ï¼‰ï¼Œä¸å—æ­¤å½±å“
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  version-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check package.json version updated
        if: |
          !startsWith(github.event.pull_request.title, 'chore:') &&
          !startsWith(github.event.pull_request.title, 'docs:') &&
          !startsWith(github.event.pull_request.title, 'test:')
        run: |
          set -e
          if [ ! -f package.json ]; then
            echo "â„¹ï¸ No package.json found, skipping version check"
            exit 0
          fi

          echo "ğŸ” Checking if package.json version was updated..."

          # Get base branch version using jq (more reliable than sed)
          BASE_VERSION=$(git show origin/${{ github.base_ref }}:package.json 2>/dev/null | jq -r '.version' || echo "")

          if [ -z "$BASE_VERSION" ] || [ "$BASE_VERSION" = "null" ]; then
            echo "âš ï¸ Could not read base branch version, skipping check"
            exit 0
          fi

          # Get current version
          CURRENT_VERSION=$(jq -r '.version' package.json)

          echo "Base branch version: $BASE_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Validate semver format (MAJOR.MINOR.PATCH)
          SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+$'
          if ! [[ "$CURRENT_VERSION" =~ $SEMVER_REGEX ]]; then
            echo "âŒ Invalid version format: $CURRENT_VERSION"
            echo "Version must follow semver format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
            exit 1
          fi

          if [ "$BASE_VERSION" = "$CURRENT_VERSION" ]; then
            echo "âŒ Version not updated in package.json"
            echo "Please update the version according to semver rules"
            exit 1
          else
            echo "âœ… Version updated: $BASE_VERSION â†’ $CURRENT_VERSION"
          fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # DevGate éœ€è¦å®Œæ•´å†å²æ¥ diff base åˆ†æ”¯

      - name: Detect project type
        id: detect
        # æ³¨æ„ï¼šPython/Go æ£€æµ‹æ˜¯ä¸ºå¤šè¯­è¨€ä»“åº“é¢„ç•™çš„
        # å½“å‰ zenithjoy-engine æ˜¯ npm é¡¹ç›®ï¼Œä½†æ­¤æ£€æµ‹å¯å¤ç”¨äºå…¶ä»–ä»“åº“
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
            # æ£€æµ‹ Python ç‰ˆæœ¬è¦æ±‚
            if [ -f .python-version ]; then
              echo "python_version=$(cat .python-version)" >> $GITHUB_OUTPUT
            else
              echo "python_version=3.11" >> $GITHUB_OUTPUT
            fi
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
            # ä» go.mod è¯»å– Go ç‰ˆæœ¬ï¼ˆhead -1 ç¡®ä¿åªå–ç¬¬ä¸€ä¸ªåŒ¹é…ï¼‰
            GO_VERSION=$(grep '^go ' go.mod | head -1 | awk '{print $2}' || echo "1.21")
            echo "go_version=$GO_VERSION" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (npm)
        if: steps.detect.outputs.type == 'npm'
        run: npm ci

      # L1-1: TypeCheck
      - name: TypeCheck
        if: steps.detect.outputs.type == 'npm'
        id: typecheck
        run: |
          set -e
          if npm run typecheck --if-present; then
            echo "âœ… TypeCheck é€šè¿‡"
            bash ci/scripts/write-check-result.sh typecheck true 0 "npm run typecheck"
          else
            EXIT_CODE=$?
            echo "âŒ TypeCheck å¤±è´¥"
            bash ci/scripts/write-check-result.sh typecheck false $EXIT_CODE "npm run typecheck" "TypeCheck failed"
            exit $EXIT_CODE
          fi

      # L1-2: Unit Tests
      - name: Unit Tests
        if: steps.detect.outputs.type == 'npm'
        id: test
        run: |
          set -e
          # å•å…ƒæµ‹è¯• - P0-4 ä¿®å¤ï¼šä¸¥æ ¼çš„å·²çŸ¥å¤±è´¥ç™½åå•æ ¡éªŒ
          if npm run test --if-present; then
            echo "âœ… æµ‹è¯•é€šè¿‡"
            bash ci/scripts/write-check-result.sh test true 0 "npm run test"
          else
            TEST_EXIT_CODE=$?
            echo "âš ï¸ æµ‹è¯•å¤±è´¥ï¼ˆé€€å‡ºç : $TEST_EXIT_CODEï¼‰"

            # P0-4 ä¿®å¤ï¼šä¸¥æ ¼æ ¡éªŒ known-failuresï¼Œä¸æ¥å—ä»»æ„å­—ç¬¦ä¸²
            if [ -f .quality-evidence.json ] && [ -f ci/known-failures.json ]; then
              # å¿…é¡»åŒ…å« known_failure_keys æ•°ç»„å­—æ®µ
              if ! jq -e '.known_failure_keys | type == "array"' .quality-evidence.json >/dev/null 2>&1; then
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼š.quality-evidence.json ç¼ºå°‘æœ‰æ•ˆçš„ known_failure_keys æ•°ç»„"
                bash ci/scripts/write-check-result.sh test false $TEST_EXIT_CODE "npm run test" "ç¼ºå°‘æœ‰æ•ˆçš„ known_failure_keys æ•°ç»„"
                exit $TEST_EXIT_CODE
              fi

              # æå–è¯·æ±‚è·³è¿‡çš„ keys
              REQUESTED_KEYS=$(jq -r '.known_failure_keys[]' .quality-evidence.json 2>/dev/null || echo "")
              if [ -z "$REQUESTED_KEYS" ]; then
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼šknown_failure_keys ä¸ºç©º"
                bash ci/scripts/write-check-result.sh test false $TEST_EXIT_CODE "npm run test" "known_failure_keys ä¸ºç©º"
                exit $TEST_EXIT_CODE
              fi

              # æ£€æŸ¥æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š 3 ä¸ªï¼‰
              KEY_COUNT=$(echo "$REQUESTED_KEYS" | wc -l)
              MAX_SKIP=$(jq -r '.rules.max_skip_count // 3' ci/known-failures.json)
              if [ "$KEY_COUNT" -gt "$MAX_SKIP" ]; then
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼šè¯·æ±‚è·³è¿‡ $KEY_COUNT é¡¹ï¼Œè¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_SKIP"
                bash ci/scripts/write-check-result.sh test false $TEST_EXIT_CODE "npm run test" "è¯·æ±‚è·³è¿‡ $KEY_COUNT é¡¹ï¼Œè¶…è¿‡æœ€å¤§é™åˆ¶ $MAX_SKIP"
                exit $TEST_EXIT_CODE
              fi

              # éªŒè¯æ¯ä¸ª key éƒ½åœ¨ç™½åå•ä¸­
              ALLOWED_KEYS=$(jq -r '.allowed | keys[]' ci/known-failures.json)
              INVALID_KEYS=""
              while IFS= read -r key; do
                if ! echo "$ALLOWED_KEYS" | grep -qx "$key"; then
                  INVALID_KEYS="$INVALID_KEYS $key"
                fi
              done <<< "$REQUESTED_KEYS"

              if [ -n "$INVALID_KEYS" ]; then
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼šä»¥ä¸‹ known_failure_keys ä¸åœ¨ç™½åå•ä¸­ï¼š$INVALID_KEYS"
                echo "   å…è®¸çš„ keys: $ALLOWED_KEYS"
                bash ci/scripts/write-check-result.sh test false $TEST_EXIT_CODE "npm run test" "known_failure_keys ä¸åœ¨ç™½åå•ä¸­ï¼š$INVALID_KEYS"
                exit $TEST_EXIT_CODE
              fi

              echo "âœ… å·²çŸ¥å¤±è´¥æ ¡éªŒé€šè¿‡ï¼ˆ$KEY_COUNT é¡¹å·²ç™»è®°ï¼‰"
              echo "   è·³è¿‡çš„æµ‹è¯•ï¼š"
              echo "$REQUESTED_KEYS" | sed 's/^/     - /'
              bash ci/scripts/write-check-result.sh test true 0 "npm run test" "å·²çŸ¥å¤±è´¥æ ¡éªŒé€šè¿‡ï¼ˆ$KEY_COUNT é¡¹å·²ç™»è®°ï¼‰"
            else
              echo "âŒ æµ‹è¯•å¤±è´¥ä¸”æ— æœ‰æ•ˆçš„ known-failures é…ç½®"
              bash ci/scripts/write-check-result.sh test false $TEST_EXIT_CODE "npm run test" "æµ‹è¯•å¤±è´¥ä¸”æ— æœ‰æ•ˆçš„ known-failures é…ç½®"
              exit $TEST_EXIT_CODE
            fi
          fi

      # L1-3: Build
      - name: Build
        if: steps.detect.outputs.type == 'npm'
        id: build
        run: |
          set -e
          if npm run build --if-present; then
            echo "âœ… Build é€šè¿‡"
            bash ci/scripts/write-check-result.sh build true 0 "npm run build"
          else
            EXIT_CODE=$?
            echo "âŒ Build å¤±è´¥"
            bash ci/scripts/write-check-result.sh build false $EXIT_CODE "npm run build" "Build failed"
            exit $EXIT_CODE
          fi

      # L2A: PRD/DoD/QA/Audit è¿œç«¯æ£€æŸ¥
      # PRD/DoD Gate: é˜»æ­¢ PRD/DoD æ–‡ä»¶è¿›å…¥ develop/main PRï¼ˆå‰ç§»æ£€æŸ¥ï¼‰
      - name: Block PRD/DoD in PR to develop/main
        if: |
          github.event_name == 'pull_request' &&
          steps.detect.outputs.type == 'npm' &&
          (github.base_ref == 'develop' || github.base_ref == 'main')
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  PRD/DoD Gate (PR to ${{ github.base_ref }})"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # æ£€æŸ¥ PR ä¸­æ˜¯å¦åŒ…å« PRD/DoD æ–‡ä»¶
          PRD_DOD_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^\.(prd|dod)(-[^/]+)?\.md$' || true)

          if [ -n "$PRD_DOD_FILES" ]; then
            echo "âŒ PRD/DoD æ–‡ä»¶ä¸åº”å‡ºç°åœ¨ PR to ${{ github.base_ref }} ä¸­"
            echo ""
            echo "å‘ç°çš„æ–‡ä»¶ï¼š"
            echo "$PRD_DOD_FILES" | sed 's/^/  - /'
            echo ""
            echo "è¯·åœ¨ merge å‰åˆ é™¤è¿™äº›æ–‡ä»¶ï¼š"
            echo "  git rm \$PRD_DOD_FILES"
            echo "  git commit --amend"
            echo ""
            echo "è¯´æ˜: PRD/DoD æ˜¯åŠŸèƒ½åˆ†æ”¯çš„å·¥ä½œæ–‡æ¡£ï¼Œä¸åº”è¿›å…¥ develop/main"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "âœ… æ—  PRD/DoD æ–‡ä»¶"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: L2A Check
        if: |
          github.event_name == 'pull_request' &&
          steps.detect.outputs.type == 'npm' &&
          github.base_ref != 'main' &&
          !startsWith(github.event.pull_request.title, 'chore:')
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  L2A: PRD/DoD/QA/Audit æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          # L2A check åœ¨ L1 ä¹‹åã€DevGate ä¹‹å‰ï¼ˆåªå¯¹ PR to developï¼‰
          if [ -f "scripts/devgate/l2a-check.sh" ]; then
            bash scripts/devgate/l2a-check.sh pr || exit 1
          else
            echo "âš ï¸ l2a-check.sh not found, skipping"
            echo "   (ä»“åº“å¯èƒ½è¿˜æœªå‡çº§åˆ° L2A è¿œç«¯æ£€æŸ¥)"
          fi

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.detect.outputs.python_version }}

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || { echo "âŒ pip install failed"; exit 1; }
          elif [ -f pyproject.toml ]; then
            pip install -e . || { echo "âŒ pip install failed"; exit 1; }
          fi
          if [ -f pytest.ini ] || [ -d tests ] || [ -d test ]; then
            pytest -v
          else
            echo "â„¹ï¸ No pytest config or tests directory found, skipping tests"
          fi

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.detect.outputs.go_version }}

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - always syntax check (hooks exist in all project types)
      - name: Check shell scripts
        id: shell_check
        run: |
          echo "Checking shell scripts..."
          FAILED=0
          FOUND=0
          FAIL_LIST=""
          # ä½¿ç”¨ find + while read éå†æ‰€æœ‰ .sh æ–‡ä»¶
          # -print0 + read -d '' å¤„ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦
          while IFS= read -r -d '' f; do
            FOUND=1
            # æ•è· stderr ä»¥ä¾¿æ˜¾ç¤ºå…·ä½“é”™è¯¯
            ERROR_OUTPUT=$(bash -n "$f" 2>&1)
            if [ $? -eq 0 ]; then
              echo "  [OK] $f"
            else
              echo "  [FAIL] $f"
              echo "$ERROR_OUTPUT" | sed 's/^/     /'
              FAILED=1
              FAIL_LIST="$FAIL_LIST $f"
            fi
          done < <(find . -name "*.sh" -type f -not -path "./node_modules/*" -print0)
          if [ "$FOUND" -eq 0 ]; then
            echo "No .sh files found"
          fi

          # å†™å…¥ check ç»“æœ
          if [ "$FAILED" -eq 0 ]; then
            bash ci/scripts/write-check-result.sh shell-check true 0 "bash -n *.sh"
          else
            bash ci/scripts/write-check-result.sh shell-check false 1 "bash -n *.sh" "Failed:$FAIL_LIST"
            exit 1
          fi

      # Evidence ç”Ÿæˆï¼ˆCI-onlyï¼ŒSSOTï¼‰- å¿…é¡»åœ¨æ‰€æœ‰ check æ­¥éª¤ä¹‹å
      - name: Generate Evidence
        if: steps.detect.outputs.type == 'npm'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Evidence ç”Ÿæˆï¼ˆCI-onlyï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash ci/scripts/generate-evidence.sh

      - name: Evidence Gate
        if: steps.detect.outputs.type == 'npm'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Evidence Gate æ ¡éªŒ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash ci/scripts/evidence-gate.sh

      # Phase 1: DevGate æ£€æŸ¥ï¼ˆDoD æ˜ å°„ + P0/P1 RCI æ›´æ–° + RCI è¦†ç›–ç‡ï¼‰
      # æ³¨æ„ï¼šå½“å‰åªå¯¹ npm é¡¹ç›®å¯ç”¨ï¼Œé npm é¡¹ç›®è·³è¿‡æ­¤æ£€æŸ¥
      # chore/docs/test/release PR è·³è¿‡ï¼ˆè¿™äº›ä¸éœ€è¦ DoDï¼‰
      - name: DevGate checks
        if: |
          github.event_name == 'pull_request' &&
          steps.detect.outputs.type == 'npm' &&
          !startsWith(github.event.pull_request.title, 'chore:') &&
          !startsWith(github.event.pull_request.title, 'docs:') &&
          !startsWith(github.event.pull_request.title, 'test:') &&
          !startsWith(github.event.pull_request.title, 'release:')
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Phase 1: DevGate æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # DoD æ˜ å°„æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/check-dod-mapping.cjs" ]; then
            echo ""
            echo "  [DoD â†” Test æ˜ å°„æ£€æŸ¥]"
            node scripts/devgate/check-dod-mapping.cjs || exit 1
          else
            echo "â„¹ï¸ check-dod-mapping.cjs not found, skipping"
          fi

          # P0/P1 RCI æ›´æ–°æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          if [ -f "scripts/devgate/require-rci-update-if-p0p1.sh" ]; then
            echo ""
            echo "  [P0/P1 RCI æ›´æ–°æ£€æŸ¥]"
            # ä» PR title æˆ– labels è®¾ç½®ç¯å¢ƒå˜é‡
            export PR_TITLE="${{ github.event.pull_request.title }}"
            # CI ä¸­éœ€è¦ä½¿ç”¨ origin/ å‰ç¼€
            export BASE_REF="origin/${{ github.base_ref || 'develop' }}"
            bash scripts/devgate/require-rci-update-if-p0p1.sh || exit 1
          else
            echo "â„¹ï¸ require-rci-update-if-p0p1.sh not found, skipping"
          fi

          # RCI è¦†ç›–ç‡æ£€æŸ¥ï¼ˆå¦‚æœè„šæœ¬å­˜åœ¨ï¼‰
          # æ–°å¢ä¸šåŠ¡å…¥å£å¿…é¡»æ·»åŠ å¯¹åº”çš„ RCI æ¡ç›®
          if [ -f "scripts/devgate/scan-rci-coverage.cjs" ]; then
            echo ""
            echo "  [RCI è¦†ç›–ç‡æ£€æŸ¥]"
            node scripts/devgate/scan-rci-coverage.cjs || {
              echo ""
              echo "âŒ RCI è¦†ç›–ç‡æ£€æŸ¥å¤±è´¥"
              echo "   æ–°å¢çš„ä¸šåŠ¡å…¥å£æ²¡æœ‰å¯¹åº”çš„ RCI æ¡ç›®"
              echo "   è¯·åœ¨ regression-contract.yaml ä¸­æ·»åŠ è¦†ç›–"
              echo ""
              echo "   è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è¯¦æƒ…ï¼š"
              echo "   npm run coverage:rci -- --explain"
              exit 1
            }
          else
            echo "â„¹ï¸ scan-rci-coverage.cjs not found, skipping"
          fi

          # Gate æ–‡ä»¶æ£€æŸ¥ï¼ˆv20: æç¤ºå‹ï¼Œgate æ–‡ä»¶ä¸æäº¤åˆ°ä»“åº“ï¼‰
          # æœ¬åœ° Hook å¼ºåˆ¶æ£€æŸ¥ï¼ŒCI åªæç¤ºï¼ˆgate æ–‡ä»¶åœ¨ .gitignore ä¸­ï¼‰
          if [ -f "scripts/gate/verify-gate-signature.sh" ]; then
            echo ""
            echo "  [Gate å®¡æ ¸æ–‡ä»¶æ£€æŸ¥ - æç¤ºå‹]"
            echo "  â„¹ï¸ Gate æ–‡ä»¶ä¸æäº¤åˆ°ä»“åº“ï¼ˆåœ¨ .gitignore ä¸­ï¼‰"
            echo "  â„¹ï¸ æœ¬åœ° Hook å·²å¼ºåˆ¶æ£€æŸ¥ï¼ŒCI æ­¤å¤„ä»…æç¤º"
          else
            echo "â„¹ï¸ verify-gate-signature.sh not found, skipping gate check"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… DevGate æ£€æŸ¥é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Contract Drift Check - é˜²æ­¢æ´¾ç”Ÿè§†å›¾æ¼‚ç§»
  contract-drift-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Generate path views from registry
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Contract Drift Check"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "æ£€æŸ¥ feature-registry.yml å’Œæ´¾ç”Ÿè§†å›¾æ˜¯å¦åŒæ­¥"
          echo ""

          # ç”Ÿæˆæ´¾ç”Ÿè§†å›¾
          bash scripts/generate-path-views.sh

      - name: Check for drift
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„å˜æ›´
          if ! git diff --exit-code docs/paths/; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âŒ Contract Drift æ£€æµ‹åˆ°"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "features/feature-registry.yml å·²å˜æ›´ï¼Œä½†æ´¾ç”Ÿè§†å›¾æœªæ›´æ–°ï¼"
            echo ""
            echo "ä¿®å¤æ–¹æ³•ï¼š"
            echo "  1. åœ¨æœ¬åœ°è¿è¡Œ: bash scripts/generate-path-views.sh"
            echo "  2. æäº¤ç”Ÿæˆçš„è§†å›¾æ–‡ä»¶:"
            echo "     git add docs/paths/"
            echo "     git commit -m 'docs: æ›´æ–°æ´¾ç”Ÿè§†å›¾ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰'"
            echo ""
            echo "å˜æ›´çš„æ–‡ä»¶:"
            git diff --name-only docs/paths/
            echo ""
            exit 1
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… Contract Drift Check é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "feature-registry.yml å’Œæ´¾ç”Ÿè§†å›¾å·²åŒæ­¥"

  # Impact Check - èƒ½åŠ›å˜æ›´å¼ºåˆ¶ç™»è®°ï¼ˆP0-1ï¼‰
  impact-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²æ¥ diff base åˆ†æ”¯

      - name: Run Impact Check
        run: |
          # CI ä¸­éœ€è¦ä½¿ç”¨ origin/ å‰ç¼€
          export BASE_REF="origin/${{ github.base_ref || 'develop' }}"
          bash scripts/devgate/impact-check.sh

  # develop PR çš„ L3 å­é›†ï¼ˆé˜²æ­¢ develop åˆ†æ”¯è…çƒ‚ï¼‰
  regression-pr:
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: L3 Regression Tests (PR subset)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  L3: PR å›å½’æµ‹è¯•ï¼ˆå­é›†ï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "é˜²æ­¢ develop åˆ†æ”¯ç§¯ç´¯å›å½’é£é™©"
          echo "è·‘ trigger åŒ…å« PR çš„ RCI å­é›†"
          echo ""
          bash scripts/run-regression.sh pr

  # Release æ£€æŸ¥ï¼ˆä»… develop â†’ main çš„ PRï¼‰
  release-check:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Check PR source branch
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  PR æ¥æºåˆ†æ”¯æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ç›®æ ‡åˆ†æ”¯: main"
          echo "æ¥æºåˆ†æ”¯: ${{ github.head_ref }}"
          echo ""

          if [[ "${{ github.head_ref }}" != "develop" ]]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âŒ PR to main åªèƒ½æ¥è‡ª develop åˆ†æ”¯"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "å½“å‰æ¥æº: ${{ github.head_ref }}"
            echo ""
            echo "æ­£ç¡®æµç¨‹:"
            echo "  1. åŠŸèƒ½åˆ†æ”¯ (cp-*/feature/*) â†’ develop"
            echo "  2. develop â†’ main (release)"
            echo ""
            echo "è¯·å…ˆå°†ä»£ç åˆå¹¶åˆ° developï¼Œå†ä» develop åˆ›å»º PR åˆ° main"
            exit 1
          fi

          echo "âœ… æ¥æºåˆ†æ”¯æ­£ç¡®: develop â†’ main"
          echo ""

      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      # Release åªéœ€è¦ L1+L3ï¼Œä¸éœ€è¦ L2A/L2B/L4ï¼ˆåŠŸèƒ½éªŒæ”¶åœ¨åŠŸèƒ½åˆ†æ”¯å·²å®Œæˆï¼‰

      - name: L3 Regression Tests
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Release Check: L3 å›å½’æµ‹è¯•ï¼ˆå…¨é‡ï¼‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          bash scripts/run-regression.sh release

      - name: CHANGELOG Check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Release Check: CHANGELOG æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # è·å–å½“å‰ç‰ˆæœ¬
          VERSION=$(jq -r '.version' package.json)
          echo "å½“å‰ç‰ˆæœ¬: $VERSION"
          echo ""

          # æ£€æŸ¥ CHANGELOG.md æ˜¯å¦åŒ…å«å½“å‰ç‰ˆæœ¬
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ CHANGELOG.md ä¸å­˜åœ¨"
            exit 1
          fi

          if grep -q "## \[$VERSION\]" CHANGELOG.md || grep -q "## $VERSION" CHANGELOG.md; then
            echo "âœ… CHANGELOG.md åŒ…å« $VERSION ç‰ˆæœ¬æ¡ç›®"
          else
            echo "âŒ CHANGELOG.md ç¼ºå°‘ $VERSION ç‰ˆæœ¬æ¡ç›®"
            echo ""
            echo "è¯·åœ¨ CHANGELOG.md ä¸­æ·»åŠ æœ¬æ¬¡å‘å¸ƒçš„å˜æ›´è®°å½•"
            exit 1
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… Release Check é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # L2B Check - å¯å¤æ ¸è¯æ®ï¼ˆåªå¯¹ PR to developï¼Œrelease ä¸éœ€è¦ï¼‰
  l2b-check:
    if: github.event_name == 'pull_request' && github.base_ref != 'main'
    needs: [test]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: L2B Evidence Check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  L2B: å¯å¤æ ¸è¯æ®æ£€æŸ¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          if [ -f "scripts/devgate/l2b-check.sh" ]; then
            bash scripts/devgate/l2b-check.sh pr || exit 1
          else
            echo "âš ï¸ l2b-check.sh not found, skipping"
            echo "   (ä»“åº“å¯èƒ½è¿˜æœªå‡çº§åˆ° L2B æ£€æŸ¥)"
          fi

  # CI é€šè¿‡åé€šçŸ¥ï¼ˆä¸è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰
  # æ³¨æ„ï¼šæ­¤ job åªåœ¨ pull_request äº‹ä»¶æ—¶è¿è¡Œï¼Œpush äº‹ä»¶æ—¶è·³è¿‡
  # v10.5.0: ä¿®å¤æ¡ä»¶ needsï¼Œæ­£ç¡®å¤„ç† regression-pr å’Œ release-check
  # v10.6.0: å¢åŠ  l2b-check ä¾èµ–
  # cleanup-prd-dod job å·²åˆ é™¤
  # PRD/DoD ç°åœ¨é€šè¿‡ PR Gate é˜»æ­¢è¿›å…¥ develop/mainï¼Œä¸å†éœ€è¦ push åæ¸…ç†

  ci-passed:
    needs: [version-check, test, contract-drift-check, impact-check, l2b-check, regression-pr, release-check]
    # SECURITY FIX: æ ¹æ®ç›®æ ‡åˆ†æ”¯è¦æ±‚å¯¹åº”æ£€æŸ¥å¿…é¡»æˆåŠŸï¼ˆä¸å…è®¸ skippedï¼‰
    # - PR åˆ° develop: regression-pr å¿…é¡»æˆåŠŸ
    # - PR åˆ° main: release-check å¿…é¡»æˆåŠŸ
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.test.result == 'success' &&
      needs.contract-drift-check.result == 'success' &&
      (needs.version-check.result == 'success' || needs.version-check.result == 'skipped') &&
      (needs.impact-check.result == 'success' || needs.impact-check.result == 'skipped') &&
      (needs.l2b-check.result == 'success' || needs.l2b-check.result == 'skipped') &&
      (github.base_ref != 'develop' || needs.regression-pr.result == 'success') &&
      (github.base_ref != 'main' || needs.release-check.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: CI Passed
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… CI é€šè¿‡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR #${{ github.event.pull_request.number }} CI æ£€æŸ¥é€šè¿‡"
          echo ""
          echo "å·²é€šè¿‡çš„æ£€æŸ¥ï¼š"
          echo "  âœ… test (L1 + DevGate)"
          if [ "${{ needs.l2b-check.result }}" = "success" ]; then
            echo "  âœ… l2b-check (L2B è¯æ®)"
          fi
          echo "  âœ… contract-drift-check"
          if [ "${{ needs.regression-pr.result }}" = "success" ]; then
            echo "  âœ… regression-pr (L3 å­é›†)"
          fi
          if [ "${{ needs.release-check.result }}" = "success" ]; then
            echo "  âœ… release-check (L3 å…¨é‡ + CHANGELOG)"
          fi
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "  1. æ‰‹åŠ¨ reviewï¼ˆå¦‚æœ‰éœ€è¦ï¼‰"
          echo "  2. æ‰‹åŠ¨åˆå¹¶ PR"
          echo ""
          echo "ä¸å†è‡ªåŠ¨åˆå¹¶ï¼Œéœ€è¦ç¡®è®¤æ‰€æœ‰æ£€æŸ¥é€šè¿‡åæ‰‹åŠ¨æ“ä½œ"

  # CI å¤±è´¥æ—¶é€šçŸ¥ Notionï¼ˆversion-check æˆ– test å¤±è´¥éƒ½é€šçŸ¥ï¼‰
  notify-failure:
    needs: [version-check, test]
    if: always() && (needs.version-check.result == 'failure' || needs.test.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # CRITICAL ä¿®å¤: æ˜¾å¼å£°æ˜æœ€å°æƒé™
    permissions:
      contents: read
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
          VERSION_CHECK_RESULT: ${{ needs.version-check.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âš ï¸ Notion secrets not configured, skipping notification"
            exit 0
          fi

          # ç¡®å®šå¤±è´¥åŸå› 
          FAILURE_REASON=""
          if [ "$VERSION_CHECK_RESULT" = "failure" ]; then
            FAILURE_REASON="version-check"
          fi
          if [ "$TEST_RESULT" = "failure" ]; then
            if [ -n "$FAILURE_REASON" ]; then
              FAILURE_REASON="$FAILURE_REASON + test"
            else
              FAILURE_REASON="test"
            fi
          fi

          # ç¡®å®š PR URL æˆ– Action URL
          PR_URL="${{ github.event.pull_request.html_url }}"
          if [ -z "$PR_URL" ]; then
            PR_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          # CRITICAL ä¿®å¤: ä½¿ç”¨ jq å®‰å…¨ç”Ÿæˆ JSONï¼Œé˜²æ­¢æ³¨å…¥
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          JSON_PAYLOAD=$(jq -n \
            --arg db_id "$NOTION_DATABASE_ID" \
            --arg name "âŒ CI Failed ($FAILURE_REASON): ${{ github.repository }}" \
            --arg branch "${{ github.head_ref || github.ref_name }}" \
            --arg pr_url "$PR_URL" \
            --arg timestamp "$TIMESTAMP" \
            '{
              parent: {database_id: $db_id},
              properties: {
                Name: {title: [{text: {content: $name}}]},
                Status: {select: {name: "Failed"}},
                Branch: {rich_text: [{text: {content: $branch}}]},
                PR: {url: $pr_url},
                Time: {date: {start: $timestamp}}
              }
            }')

          curl -s --fail -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d "$JSON_PAYLOAD"
          echo "ğŸ“¨ Notification sent to Notion (failed: $FAILURE_REASON)"

  # AI Review (L2C) - è¯­ä¹‰/å½±å“é¢å®¡æŸ¥
  # åœ¨ CI å…¨ç»¿åè¿è¡Œï¼Œä¸é˜»æ–­ PRï¼ˆåˆæœŸï¼‰
  ai-review:
    if: github.event_name == 'pull_request'
    needs: [ci-passed]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: write  # éœ€è¦å†™æƒé™æ¥å‘ comment
    # SECURITY FIX: ç§»é™¤ continue-on-errorï¼Œè®© AI review å¤±è´¥æ­£ç¡®æŠ¥å‘Š
    # å¦‚æœ VPS_REVIEW_URL æœªé…ç½®ï¼Œè„šæœ¬ä¼šä¼˜é›…è·³è¿‡è€Œéå¤±è´¥
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # è·å– PR diffï¼ˆé™åˆ¶å¤§å°ï¼Œé˜²æ­¢è¶…é•¿ï¼‰
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

          # é™åˆ¶ diff å¤§å°ï¼ˆæœ€å¤š 50KBï¼Œçº¦ 1000 è¡Œä»£ç ï¼‰
          DIFF_SIZE=$(wc -c < pr.diff)
          if [ "$DIFF_SIZE" -gt 51200 ]; then
            echo "âš ï¸ PR diff è¿‡å¤§ (${DIFF_SIZE} bytes)ï¼Œæˆªæ–­åˆ° 50KB"
            head -c 51200 pr.diff > pr.diff.truncated
            mv pr.diff.truncated pr.diff
            echo "truncated=true" >> $GITHUB_OUTPUT
          else
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi

      - name: Call AI Review API
        id: review
        env:
          VPS_REVIEW_URL: ${{ secrets.VPS_REVIEW_URL }}
        run: |
          if [ -z "$VPS_REVIEW_URL" ]; then
            echo "âš ï¸ VPS_REVIEW_URL not configured, skipping AI review"
            echo "review_result=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æ„å»º JSON payload
          DIFF_CONTENT=$(jq -Rs . < pr.diff)
          JSON_PAYLOAD=$(jq -n \
            --arg pr_number "${{ github.event.pull_request.number }}" \
            --arg repo "${{ github.repository }}" \
            --argjson diff "$DIFF_CONTENT" \
            '{pr_number: $pr_number, repo: $repo, diff: $diff}')

          # è°ƒç”¨ VPS Review API
          RESPONSE=$(curl -s -X POST "$VPS_REVIEW_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # ä¿å­˜å“åº”
          echo "$RESPONSE" > review.json
          echo "review_result=success" >> $GITHUB_OUTPUT

      - name: Post comment
        if: steps.review.outputs.review_result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));

            const truncated = '${{ steps.diff.outputs.truncated }}' === 'true';
            let comment = '## ğŸ¤– AI Review (L2C - è¯­ä¹‰/å½±å“é¢å®¡æŸ¥)\n\n';

            if (truncated) {
              comment += 'âš ï¸ **PR diff å·²æˆªæ–­åˆ° 50KB**ï¼Œå®¡æŸ¥å¯èƒ½ä¸å®Œæ•´\n\n';
            }

            comment += review.content || 'æ— å®¡æŸ¥ç»“æœ';

            comment += '\n\n---\n';
            comment += '*è¿™æ˜¯ AI è‡ªåŠ¨å®¡æŸ¥ï¼Œä¸é˜»æ–­ PR åˆå¹¶ã€‚ä»…ä¾›å‚è€ƒã€‚*';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
