name: CI

on:
  pull_request:
    branches: [main, 'feature/*']
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect project type
        id: detect
        run: |
          if [ -f package.json ]; then
            echo "type=npm" >> $GITHUB_OUTPUT
          elif [ -f requirements.txt ] || [ -f pyproject.toml ]; then
            echo "type=python" >> $GITHUB_OUTPUT
          elif [ -f go.mod ]; then
            echo "type=go" >> $GITHUB_OUTPUT
          else
            echo "type=shell" >> $GITHUB_OUTPUT
          fi

      # Node.js
      - name: Setup Node.js
        if: steps.detect.outputs.type == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Test (npm)
        if: steps.detect.outputs.type == 'npm'
        run: |
          npm ci
          npm run test --if-present
          npm run build --if-present

      # Python
      - name: Setup Python
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install & Test (python)
        if: steps.detect.outputs.type == 'python'
        run: |
          pip install -r requirements.txt 2>/dev/null || pip install -e . 2>/dev/null || true
          pytest -v 2>/dev/null || echo "No tests"

      # Go
      - name: Setup Go
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Test (go)
        if: steps.detect.outputs.type == 'go'
        run: go test -v ./...

      # Shell scripts - just syntax check
      - name: Check shell scripts
        if: steps.detect.outputs.type == 'shell'
        run: |
          shopt -s nullglob
          files=$(find . -name "*.sh" -type f)
          if [ -z "$files" ]; then
            echo "â„¹ï¸ No .sh files found"
            exit 0
          fi
          for f in $files; do
            bash -n "$f" && echo "âœ… $f"
          done

  # è‡ªåŠ¨åˆå¹¶ PRï¼ˆCI é€šè¿‡åï¼‰
  auto-merge:
    needs: [test]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    # å¹¶å‘ä¿æŠ¤ï¼šåŒä¸€ä¸ª base åˆ†æ”¯çš„ PR æ’é˜Ÿåˆå¹¶ï¼Œé¿å…å†²çª
    concurrency:
      group: merge-${{ github.base_ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Auto merge PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "âœ… CI passed, merging PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} \
            --squash \
            --delete-branch \
            --body "Auto-merged after CI passed"

  # CI å¤±è´¥æ—¶é€šçŸ¥ Notion
  notify-failure:
    needs: [test]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_CI_DATABASE_ID }}
        run: |
          if [ -z "$NOTION_TOKEN" ] || [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âš ï¸ Notion secrets not configured, skipping notification"
            exit 0
          fi

          curl -s -X POST "https://api.notion.com/v1/pages" \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -d '{
              "parent": {"database_id": "'"$NOTION_DATABASE_ID"'"},
              "properties": {
                "Name": {"title": [{"text": {"content": "âŒ CI Failed: ${{ github.repository }}"}}]},
                "Status": {"select": {"name": "Failed"}},
                "Branch": {"rich_text": [{"text": {"content": "${{ github.head_ref || github.ref_name }}"}}]},
                "PR": {"url": "${{ github.event.pull_request.html_url || format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}"},
                "Time": {"date": {"start": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}}
              }
            }'
          echo "ğŸ“¨ Notification sent to Notion"
