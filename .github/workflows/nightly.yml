name: Nightly Regression

on:
  schedule:
    # æ¯å¤© UTC 18:00 (åŒ—äº¬æ—¶é—´ 02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: 'nightly'
        type: choice
        options:
          - nightly
          - release
          - pr

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          set -euo pipefail

          EVENT_NAME="${{ github.event_name }}"

          echo "Event: $EVENT_NAME"

          # åªåœ¨ schedule æˆ– workflow_dispatch æ—¶è¿è¡Œï¼Œä¸åœ¨ push æ—¶è¿è¡Œ
          if [[ "$EVENT_NAME" != "push" ]]; then
            echo "âœ… è§¦å‘æ¡ä»¶æ»¡è¶³ï¼šschedule æˆ– workflow_dispatch"
            echo "should-run=true" >> "$GITHUB_OUTPUT"
          else
            echo "â­ï¸ è·³è¿‡ï¼šå½“å‰æ˜¯ push äº‹ä»¶ï¼ˆåªæ”¯æŒ schedule/workflow_dispatchï¼‰"
            echo "should-run=false" >> "$GITHUB_OUTPUT"
          fi

  regression:
    needs: [check-trigger]
    if: needs.check-trigger.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read  # P1 fix: ä¸å† pushï¼Œåªè¯»æƒé™å³å¯

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run Regression Tests
        run: |
          MODE="${{ github.event.inputs.mode || 'nightly' }}"
          bash scripts/run-regression.sh "$MODE"

      - name: DevGate Metrics
        id: metrics
        run: |
          # æ”¶é›†æœ¬æœˆ DevGate æŒ‡æ ‡
          MONTH=$(date +%Y-%m)
          echo "Collecting DevGate Metrics for $MONTH"

          # ç”Ÿæˆ JSON æŠ¥å‘Šï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼ŒåŒæ—¶ç”Ÿæˆ JSON å’Œäººç±»å¯è¯»è¾“å‡ºï¼‰
          if bash scripts/devgate/metrics.sh --month "$MONTH" --format json > devgate-metrics.json 2>&1; then
            echo "JSON report generated"
            # æ˜¾ç¤ºäººç±»å¯è¯»æ‘˜è¦ï¼ˆä» JSON è§£æï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
            if [ -f devgate-metrics.json ]; then
              jq -r '"RCI Coverage: \(.rci_coverage.pct // 0)%, P0/P1 PRs: \(.prs.total_p0p1 // 0)"' devgate-metrics.json 2>/dev/null || true
            fi
          else
            echo "Warning: metrics.sh failed, creating empty report"
            echo '{}' > devgate-metrics.json
          fi

          # ä¸Šä¼ ä¸º artifact
          echo "metrics_month=$MONTH" >> "$GITHUB_OUTPUT"

      - name: DevGate Threshold Check (L2)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  DevGate Threshold Check (L2 Strict Gate)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # è¯»å– JSON æŠ¥å‘Š
          if [ ! -f devgate-metrics.json ]; then
            echo "âš ï¸ No metrics file found, skipping threshold check"
            exit 0
          fi

          json=$(cat devgate-metrics.json)

          # æå–æŒ‡æ ‡ï¼ˆä½¿ç”¨ // æä¾›é»˜è®¤å€¼é˜²æ­¢ nullï¼‰
          pct=$(echo "$json" | jq '.rci_coverage.pct // 0')
          p0p1=$(echo "$json" | jq '.prs.total_p0p1 // 0')
          p0_manual=$(echo "$json" | jq '.dod.p0_manual_tests // 0')
          offenders=$(echo "$json" | jq -r '.rci_coverage.offenders[]? | "  - PR #\(.pr) (\(.priority)) sha:\(.sha)"' 2>/dev/null || true)
          rci_growth=$(echo "$json" | jq '.rci_growth.new_ids_count // 0')

          fail=0

          # æ£€æŸ¥ 1: P0/P1 RCI è¦†ç›–ç‡ = 100%
          echo "[Check 1] P0/P1 RCI Coverage"
          if [ "$p0p1" -gt 0 ] && [ "$pct" -lt 100 ]; then
            echo "âŒ RCI Coverage < 100% ($pct%)"
            if [ -n "$offenders" ]; then
              echo "Missing RCI updates:"
              echo "$offenders"
            fi
            fail=1
          else
            echo "âœ… RCI Coverage: $pct% (P0/P1: $p0p1)"
          fi
          echo ""

          # æ£€æŸ¥ 2: P0 ä¸å…è®¸ manual tests
          echo "[Check 2] P0 Manual Tests"
          if [ "$p0_manual" -gt 0 ]; then
            echo "âŒ P0 manual tests detected ($p0_manual)"
            echo "P0 PRs should have automated tests, not manual evidence."
            fail=1
          else
            echo "âœ… P0 manual tests: 0"
          fi
          echo ""

          # è½¯è­¦å‘Š: RCI å¢é•¿ < 2
          echo "[Info] RCI Growth"
          if [ "$rci_growth" -lt 2 ]; then
            echo "âš ï¸ Low RCI Growth ($rci_growth). Consider reviewing regression gaps."
          else
            echo "âœ… New RCI IDs: $rci_growth"
          fi
          echo ""

          # æœ€ç»ˆç»“æœ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "$fail" -eq 1 ]; then
            echo "âŒ DevGate Threshold Check FAILED (L2 Mode)"
            exit 1
          fi
          echo "âœ… DevGate Threshold Check PASSED (L2 Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: devgate-metrics-${{ steps.metrics.outputs.metrics_month }}
          path: devgate-metrics.json
          retention-days: 90

      - name: Generate LEARNINGS Report
        if: github.event_name == 'schedule'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Generate DevGate Report for LEARNINGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ£€æŸ¥æŒ‡æ ‡æ–‡ä»¶
          if [ ! -f devgate-metrics.json ]; then
            echo "âš ï¸ No metrics file found, skipping"
            exit 0
          fi

          # è¿½åŠ åˆ° LEARNINGS (æœ¬åœ°ç”Ÿæˆ)
          node scripts/devgate/append-learnings.cjs \
            --metrics devgate-metrics.json \
            --learnings docs/LEARNINGS.md \
            --contract regression-contract.yaml

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet docs/LEARNINGS.md; then
            echo "â„¹ï¸ No changes to LEARNINGS.md"
          else
            echo "âœ… LEARNINGS.md updated (will be uploaded as artifact)"
          fi

      - name: Upload LEARNINGS Report
        if: github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          name: learnings-report-${{ steps.metrics.outputs.metrics_month }}
          path: docs/LEARNINGS.md
          retention-days: 90

  notify:
    needs: [regression]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # CRITICAL ä¿®å¤: æ˜¾å¼å£°æ˜æœ€å°æƒé™
    permissions:
      contents: read

    steps:
      - name: Notify Result
        env:
          REGRESSION_RESULT: ${{ needs.regression.result }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "âš ï¸ FEISHU_WEBHOOK not configured, skipping notification"
            exit 0
          fi

          if [ "$REGRESSION_RESULT" = "success" ]; then
            TITLE="âœ… Nightly Regression é€šè¿‡"
            COLOR="green"
          else
            TITLE="âŒ Nightly Regression å¤±è´¥"
            COLOR="red"
          fi

          # CRITICAL ä¿®å¤: ä½¿ç”¨ jq å®‰å…¨ç”Ÿæˆ JSONï¼Œé˜²æ­¢æ³¨å…¥
          CONTENT="**Repo**: ${{ github.repository }}\n**Branch**: ${{ github.ref_name }}\n**Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg color "$COLOR" \
            --arg content "$CONTENT" \
            '{
              msg_type: "interactive",
              card: {
                header: {
                  title: {tag: "plain_text", content: $title},
                  template: $color
                },
                elements: [
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: $content
                    }
                  }
                ]
              }
            }')

          curl -s --fail -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

          echo "ğŸ“¨ Notification sent to Feishu"
