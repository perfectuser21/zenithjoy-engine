name: Nightly Regression

on:
  schedule:
    # æ¯å¤© UTC 18:00 (åŒ—äº¬æ—¶é—´ 02:00)
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: false
        default: 'nightly'
        type: choice
        options:
          - nightly
          - release
          - pr

jobs:
  regression:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Regression Tests
        run: |
          MODE="${{ github.event.inputs.mode || 'nightly' }}"
          bash scripts/run-regression.sh "$MODE"

      - name: DevGate Metrics
        id: metrics
        run: |
          # æ”¶é›†æœ¬æœˆ DevGate æŒ‡æ ‡
          MONTH=$(date +%Y-%m)
          echo "ğŸ“Š Collecting DevGate Metrics for $MONTH"

          # ç”Ÿæˆ JSON æŠ¥å‘Š
          bash scripts/devgate/metrics.sh --month "$MONTH" --format json > devgate-metrics.json || true

          # è¾“å‡ºäººç±»å¯è¯»æ ¼å¼
          bash scripts/devgate/metrics.sh --month "$MONTH" || true

          # ä¸Šä¼ ä¸º artifact
          echo "metrics_month=$MONTH" >> "$GITHUB_OUTPUT"

      - name: DevGate Threshold Check (L2)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  DevGate Threshold Check (L2 Strict Gate)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # è¯»å– JSON æŠ¥å‘Š
          if [ ! -f devgate-metrics.json ]; then
            echo "âš ï¸ No metrics file found, skipping threshold check"
            exit 0
          fi

          json=$(cat devgate-metrics.json)

          # æå–æŒ‡æ ‡
          pct=$(echo "$json" | jq '.rci_coverage.pct')
          p0p1=$(echo "$json" | jq '.prs.total_p0p1')
          p0_manual=$(echo "$json" | jq '.dod.p0_manual_tests')
          offenders=$(echo "$json" | jq -r '.rci_coverage.offenders[]? | "  - PR #\(.pr) (\(.priority)) sha:\(.sha)"')
          rci_growth=$(echo "$json" | jq '.rci_growth.new_ids_count')

          fail=0

          # æ£€æŸ¥ 1: P0/P1 RCI è¦†ç›–ç‡ = 100%
          echo "[Check 1] P0/P1 RCI Coverage"
          if [ "$p0p1" -gt 0 ] && [ "$pct" -lt 100 ]; then
            echo "âŒ RCI Coverage < 100% ($pct%)"
            if [ -n "$offenders" ]; then
              echo "Missing RCI updates:"
              echo "$offenders"
            fi
            fail=1
          else
            echo "âœ… RCI Coverage: $pct% (P0/P1: $p0p1)"
          fi
          echo ""

          # æ£€æŸ¥ 2: P0 ä¸å…è®¸ manual tests
          echo "[Check 2] P0 Manual Tests"
          if [ "$p0_manual" -gt 0 ]; then
            echo "âŒ P0 manual tests detected ($p0_manual)"
            echo "P0 PRs should have automated tests, not manual evidence."
            fail=1
          else
            echo "âœ… P0 manual tests: 0"
          fi
          echo ""

          # è½¯è­¦å‘Š: RCI å¢é•¿ < 2
          echo "[Info] RCI Growth"
          if [ "$rci_growth" -lt 2 ]; then
            echo "âš ï¸ Low RCI Growth ($rci_growth). Consider reviewing regression gaps."
          else
            echo "âœ… New RCI IDs: $rci_growth"
          fi
          echo ""

          # æœ€ç»ˆç»“æœ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "$fail" -eq 1 ]; then
            echo "âŒ DevGate Threshold Check FAILED (L2 Mode)"
            exit 1
          fi
          echo "âœ… DevGate Threshold Check PASSED (L2 Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: devgate-metrics-${{ steps.metrics.outputs.metrics_month }}
          path: devgate-metrics.json
          retention-days: 90

      - name: Append to LEARNINGS
        if: github.event_name == 'schedule'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Append DevGate Report to LEARNINGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # æ£€æŸ¥æŒ‡æ ‡æ–‡ä»¶
          if [ ! -f devgate-metrics.json ]; then
            echo "âš ï¸ No metrics file found, skipping"
            exit 0
          fi

          # è¿½åŠ åˆ° LEARNINGS
          node scripts/devgate/append-learnings.cjs \
            --metrics devgate-metrics.json \
            --learnings docs/LEARNINGS.md \
            --contract regression-contract.yaml

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet docs/LEARNINGS.md; then
            echo "â„¹ï¸ No changes to LEARNINGS.md"
            exit 0
          fi

          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æäº¤å¹¶æ¨é€
          MONTH=$(date +%Y-%m)
          git add docs/LEARNINGS.md
          git commit -m "docs: DevGate æœˆåº¦æŠ¥å‘Š $MONTH

è‡ªåŠ¨ç”Ÿæˆçš„ DevGate æŒ‡æ ‡æŠ¥å‘Š

Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          git push

          echo "âœ… LEARNINGS.md updated and pushed"

  notify:
    needs: [regression]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Notify Result
        env:
          REGRESSION_RESULT: ${{ needs.regression.result }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "âš ï¸ FEISHU_WEBHOOK not configured, skipping notification"
            exit 0
          fi

          if [ "$REGRESSION_RESULT" = "success" ]; then
            TITLE="âœ… Nightly Regression é€šè¿‡"
            COLOR="green"
          else
            TITLE="âŒ Nightly Regression å¤±è´¥"
            COLOR="red"
          fi

          curl -s -X POST "$FEISHU_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {"tag": "plain_text", "content": "'"$TITLE"'"},
                  "template": "'"$COLOR"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**Repo**: ${{ github.repository }}\n**Branch**: ${{ github.ref_name }}\n**Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                    }
                  }
                ]
              }
            }'

          echo "ğŸ“¨ Notification sent to Feishu"
