---
id: dod-ralph-loop-fix
version: 1.0.0
created: 2026-01-27
prd: .prd-ralph-loop-fix.md
qa: docs/QA-DECISION-ralph-loop-fix.md
---

# DoD - Ralph Loop 自动调用修复

QA: docs/QA-DECISION-ralph-loop-fix.md

## 验收标准

### 文档修复验收

#### SKILL.md 修改
- [ ] SKILL.md 开头添加 Ralph Loop 强制调用规则（L34 之前）
      Test: manual:检查文件内容
- [ ] SKILL.md 删除所有"结束对话"、"允许结束"描述
      Test: manual:检查无此类关键词
- [ ] SKILL.md 修改流程图，删除"结束对话"节点
      Test: manual:检查流程图内容

#### Step 8 修改
- [ ] Step 8 删除"立即结束对话，不等待 CI"描述
      Test: manual:检查 skills/dev/steps/08-pr.md
- [ ] Step 8 修改为 Ralph Loop 完成条件检查说明
      Test: manual:检查文件内容

#### Step 9 重写
- [ ] Step 9 完全重写，改为 Ralph Loop 启动指令
      Test: manual:检查 skills/dev/steps/09-ci.md
- [ ] Step 9 删除所有 `while true` bash 循环示例
      Test: manual:检查无 while true 代码块

#### Step 7 修改
- [ ] Step 7 开头添加 Ralph Loop 循环提示
      Test: manual:检查 skills/dev/steps/07-quality.md

#### Step 9.5 清理
- [ ] 删除或归档 09.5-pending-wait.md 文件
      Test: manual:检查文件不存在或在 .archive

#### CLAUDE.md 修改
- [ ] CLAUDE.md 添加 Ralph Loop 全局调用规则
      Test: manual:检查 ~/.claude/CLAUDE.md

#### hooks/stop.sh 修改
- [ ] hooks/stop.sh 修复注释（删除"exit 0 退出等唤醒"）
      Test: manual:检查注释内容
- [ ] hooks/stop.sh 修改 p0 阶段的输出信息
      Test: manual:检查输出信息

### 测试验收

#### 端到端测试
- [ ] 创建测试 PR 验证完整流程：/dev → Ralph Loop → PR 创建 → promise → 结束
      Test: manual:实际运行测试
- [ ] p1 阶段测试：模拟 CI fail → Ralph Loop → 修复 → CI pass → 合并
      Test: manual:实际运行测试
- [ ] 中途接管测试：模拟用户说"继续修复" → 检测阶段 → 调用 Ralph Loop
      Test: manual:实际运行测试

### 版本管理验收

- [ ] 更新 CHANGELOG.md 记录变更
      Test: manual:检查 CHANGELOG.md
- [ ] 更新 package.json 版本号（遵循 semver）
      Test: manual:检查版本号

### 质量验收

- [ ] npm run qa 通过
      Test: contract:全局质检
- [ ] Audit Decision: PASS
      Test: manual:检查 AUDIT-REPORT.md
