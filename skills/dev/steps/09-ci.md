# Step 9: CI 监控与合并

> 等待 CI 通过，然后合并 PR
> **Stop Hook 控制：CI 未通过或 PR 未合并时阻止会话结束（exit 2）**

---

## 流程

```
PR 创建 → 等待 CI → CI 失败？修复 → CI 通过 → 合并 PR → 完成
                          ↑                              ↓
                    Stop Hook exit 2              Stop Hook exit 0
                    （继续执行）                  （允许结束）
```

---

## 9.1 检查 CI 状态

```bash
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# 等待 CI 启动
sleep 30

# 查询 CI 状态
RUN_INFO=$(gh run list --branch "$BRANCH_NAME" --limit 1 --json status,conclusion,databaseId)
CI_STATUS=$(echo "$RUN_INFO" | jq -r '.[0].status')
CI_CONCLUSION=$(echo "$RUN_INFO" | jq -r '.[0].conclusion')

echo "CI 状态: $CI_STATUS"
echo "CI 结论: $CI_CONCLUSION"
```

---

## 9.2 CI 状态处理

| CI 状态 | 动作 |
|---------|------|
| queued / in_progress | 等待，继续检查 |
| failure | 查看日志，修复代码，push |
| success | 继续合并 PR |

### CI 失败修复

```bash
# 获取失败日志
RUN_ID=$(echo "$RUN_INFO" | jq -r '.[0].databaseId')
gh run view "$RUN_ID" --log-failed

# 分析失败原因并修复代码
# ...

# 提交修复
git add -A
git commit -m "fix: CI 失败修复

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

git push origin HEAD
```

**修复后继续等待 CI**，Stop Hook 会在会话尝试结束时检查条件。

---

## 9.3 合并 PR

CI 通过后，合并 PR：

```bash
PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number -q '.[0].number')

gh pr merge "$PR_NUMBER" --squash --delete-branch

echo "✅ PR #$PR_NUMBER 已合并"
```

---

## 9.4 Stop Hook 完成条件

Stop Hook 检查以下条件决定是否允许会话结束：

| 条件 | 状态 | Stop Hook 行为 |
|------|------|---------------|
| PR 未创建 | ❌ | exit 2（继续创建 PR）|
| CI 失败 | ❌ | exit 2（继续修复）|
| CI 进行中 | ⏳ | exit 2（继续等待）|
| CI 通过但未合并 | ❌ | exit 2（继续合并）|
| **PR 已合并** | ✅ | exit 0（完成！）|

**只有 PR 合并后，Stop Hook 才允许会话结束。**

---

## 禁止行为

- ❌ CI 失败后停止不管
- ❌ PR 创建后就结束
- ❌ 等待用户手动处理

## 正确行为

- ✅ CI 失败 → 查看日志 → 修复代码 → push → 继续等待
- ✅ CI 通过 → 合并 PR
- ✅ PR 合并 → 继续 Step 10/11

---

## 完成后

**继续 → Step 10 (Learning)**

记录开发过程中的经验教训。
