# Step 9: CI 修复（p1 阶段）

> **p1 阶段由 Ralph Loop 控制循环，持续检查 CI 直到成功并合并**

---

## ⚡ Ralph Loop 启动（进入 Step 9 第一件事）

**检测到 p1 阶段后，立即调用 Ralph Loop：**

```bash
# 获取 PR 编号
PR_NUMBER=$(gh pr list --head $(git rev-parse --abbrev-ref HEAD) --json number -q '.[0].number')

if [[ -z "$PR_NUMBER" ]]; then
    echo "❌ 错误：未找到 PR"
    exit 1
fi

# 调用 Ralph Loop 启动 CI 修复循环
/ralph-loop "修复 PR #$PR_NUMBER 的 CI 失败，CI 通过并合并后输出 <promise>DONE</promise>" \
    --completion-promise "DONE"
```

**Ralph Loop 会自动循环，直到检测到 `<promise>DONE</promise>` 才结束。**

---

## AI 在 Ralph Loop 中的职责

### 每次迭代检查以下条件：

#### 1. 质检有效性检查

代码修改后，质检可能过期：

```bash
# 检查 .quality-gate-passed 是否比最新代码修改更新
GATE_FILE=".quality-gate-passed"
LATEST_CODE_COMMIT=$(git log -1 --format=%H -- ":(exclude)docs/" ":(exclude)*.md")

if [[ -f "$GATE_FILE" ]]; then
    GATE_COMMIT=$(cat "$GATE_FILE" | grep "commit:" | awk '{print $2}')

    if [[ "$GATE_COMMIT" != "$LATEST_CODE_COMMIT" ]]; then
        echo "质检过期，重新运行..."
        npm run qa:gate
        # 不输出 promise，Ralph Loop 继续
    fi
fi
```

#### 2. CI 状态检查

```bash
CI_STATUS=$(gh pr checks "$PR_NUMBER" --json state,conclusion -q '.[0]')

case "$CI_STATUS":
    PENDING/QUEUED/IN_PROGRESS:
        # CI 运行中，等待
        # 不输出 promise，Ralph Loop 继续（轮询效果）

    FAILURE:
        # 分析失败原因
        gh run view <id> --log-failed

        # 修复代码
        # ... 修复逻辑 ...

        # 提交并 push
        git add -A
        git commit -m "fix: CI 失败修复"
        /usr/bin/git push origin HEAD

        # 不输出 promise，Ralph Loop 继续

    SUCCESS:
        # 继续下一步（合并检查）
```

#### 3. PR 合并检查

```bash
# 合并 PR
gh pr merge "$PR_NUMBER" --squash --delete-branch

# 全部完成 → 输出 promise
echo "<promise>DONE</promise>"
# Ralph Loop 检测到 promise → 结束循环 ✅
```

---

## 禁止行为

- ❌ 自己写 `while true` 循环
- ❌ 手动查询 CI 状态后就停止
- ❌ 修复一次就退出
- ❌ 输出"结束对话"、"等待外部唤醒"

## 正确行为

- ✅ Ralph Loop 自动循环
- ✅ AI 检查条件并执行修复
- ✅ 条件未满足 → 不输出 promise → 继续
- ✅ 条件全部满足 → 输出 promise → 结束

---

## CI 状态查询

**推荐命令**：

```bash
# 查询 PR 的 checks 状态
gh pr checks "$PR_NUMBER" --json state,conclusion,name -q '.[]'

# 查询最新 workflow run
gh run list --repo $(gh repo view --json nameWithOwner -q .nameWithOwner) \
    --branch "$BRANCH_NAME" --limit 1 \
    --json databaseId,status,conclusion,name
```

**注意**：
- 使用 `gh pr checks` 最简单，但需要正确权限
- CI pending 时不要退出，继续循环等待

---

## CI 失败修复流程

1. **获取失败日志**
   ```bash
   RUN_ID=$(gh run list --branch "$BRANCH_NAME" --limit 1 --json databaseId -q '.[0].databaseId')
   gh run view "$RUN_ID" --log-failed
   ```

2. **分析失败原因**
   - 语法错误？→ 修复代码
   - 测试失败？→ 修复逻辑或更新测试
   - Lint 错误？→ 修复格式

3. **修复并提交**
   ```bash
   # 修复代码
   # ...

   # 提交
   git add -A
   git commit -m "fix: CI 失败修复 - <具体问题>"

   # Push
   /usr/bin/git push origin HEAD
   ```

4. **不输出 promise**
   - 修复后不要输出 `<promise>DONE</promise>`
   - Ralph Loop 会自动继续下一次迭代
   - 继续检查 CI 状态

---

## p2 阶段（CI pass）

如果检测到 CI 已通过，说明任务已完成：

```bash
# 检查 CI 状态
CI_STATUS=$(gh run list --branch "$BRANCH" --limit 1 --json conclusion -q '.[0].conclusion' 2>/dev/null)

if [[ "$CI_STATUS" == "success" ]]; then
    echo "✅ CI 已通过，任务完成"
    # 合并 PR
    gh pr merge --squash --delete-branch
    exit 0
fi
```

**CI 通过后直接合并，不需要额外循环。**

---

## 完成后

**继续 → Step 10 (Learning)**

记录开发过程中的经验教训。
