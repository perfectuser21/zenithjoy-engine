# Step 9: CI 通过与合并

> 等待 CI 通过，合并；失败则进入 Loop 2 修复

---

## CI 流程

```
PR 创建（Step 8）
    │
    ▼
┌─────────────────────────────────────┐
│  等待 CI：                          │
│    • version-check                  │
│    • test                           │
│    • shell scripts check            │
└─────────────────────────────────────┘
    │
    ├── CI 绿 → 合并 → Learning → Cleanup
    │
    └── CI 红 → Loop 2: CI 修复
```

---

## Loop 2: CI 修复

```
┌─────────────────────────────────────┐
│  1. 读取 CI 错误                    │
│     gh pr checks $PR_NUMBER         │
│     gh run view --log-failed        │
│                                     │
│  2. 修复代码                        │
│                                     │
│  3. commit + push                   │
│                                     │
│  4. 等待 CI 重跑                    │
│     gh pr checks $PR_NUMBER --watch │
│                                     │
│  5. CI 红 → 重复 1-4                │
│     CI 绿 → 退出 Loop               │
│                                     │
│  告警：20 轮未通过 →                │
│        输出 NEED_HUMAN_HELP         │
└─────────────────────────────────────┘
```

---

## 使用轮询脚本

```bash
bash skills/dev/scripts/wait-for-merge.sh "$PR_URL"
```

**退出码**：
- `0` = PR 已合并
- `1` = 需要修复
- `2` = 超时

---

## 合并逻辑

**CI 通过后合并**：
- GitHub Actions 检查全部通过
- 使用 squash merge
- 合并后删除分支

---

## 注意

- **CI 绿是唯一完成标准**
- 失败后进入 Loop 2，自动修复
- 不要手动合并，等待 CI
