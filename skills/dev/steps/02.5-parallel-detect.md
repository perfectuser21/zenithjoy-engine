# Step 2.5: å¹¶è¡Œå¼€å‘æ£€æµ‹

> æ£€æµ‹æ´»è·ƒåˆ†æ”¯ï¼Œæä¾› worktree éš”ç¦»é€‰é¡¹

---

## æ£€æµ‹é€»è¾‘

```bash
# è·å–æ´»è·ƒçš„åŠŸèƒ½åˆ†æ”¯ï¼ˆæ’é™¤å½“å‰åˆ†æ”¯ï¼‰
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
ACTIVE_BRANCHES=$(git branch --list "cp-*" "feature/*" 2>/dev/null | grep -v "^\*" | sed 's/^[ ]*//')
ACTIVE_COUNT=$(echo "$ACTIVE_BRANCHES" | grep -c . 2>/dev/null || echo 0)

# æ£€æµ‹æ˜¯å¦åœ¨ worktree ä¸­
IS_WORKTREE=false
GIT_DIR=$(git rev-parse --git-dir 2>/dev/null)
if [[ "$GIT_DIR" == *"worktrees"* ]]; then
    IS_WORKTREE=true
fi

# è·å–ä¸»å·¥ä½œåŒºè·¯å¾„
MAIN_WORKTREE=$(git worktree list 2>/dev/null | head -1 | awk '{print $1}')
```

---

## å†³ç­–æµ

| æ¡ä»¶ | åŠ¨ä½œ |
|------|------|
| æ— æ´»è·ƒåˆ†æ”¯ (`ACTIVE_COUNT == 0`) | æ­£å¸¸ç»§ç»­ Step 3 |
| åœ¨ worktree ä¸­ | æç¤ºå½“å‰ç¯å¢ƒï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­ |
| æœ‰æ´»è·ƒåˆ†æ”¯ | æ˜¾ç¤ºåˆ—è¡¨ï¼Œæä¾›é€‰é¡¹ |

---

## åœºæ™¯å¤„ç†

### åœºæ™¯ 1: æ— æ´»è·ƒåˆ†æ”¯

```bash
if [[ "$ACTIVE_COUNT" -eq 0 ]]; then
    echo "âœ… æ— æ´»è·ƒåŠŸèƒ½åˆ†æ”¯ï¼Œç»§ç»­åˆ›å»ºæ–°åˆ†æ”¯"
    # â†’ ç›´æ¥è¿›å…¥ Step 3
fi
```

### åœºæ™¯ 2: åœ¨ worktree ä¸­

```bash
if [[ "$IS_WORKTREE" == "true" ]]; then
    echo "ğŸ“ å½“å‰åœ¨ worktree ä¸­å·¥ä½œ"
    echo "   è·¯å¾„: $(pwd)"
    echo "   ä¸»å·¥ä½œåŒº: $MAIN_WORKTREE"
    echo ""
    echo "é€‰é¡¹:"
    echo "  [C] ç»§ç»­åœ¨æ­¤ worktree å¼€å‘"
    echo "  [M] è¿”å›ä¸»å·¥ä½œåŒºåˆ›å»ºæ–°ä»»åŠ¡"
    # â†’ æ ¹æ®ç”¨æˆ·é€‰æ‹©å¤„ç†
fi
```

### åœºæ™¯ 3: æœ‰æ´»è·ƒåˆ†æ”¯

```bash
if [[ "$ACTIVE_COUNT" -gt 0 ]]; then
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚  æ£€æµ‹åˆ°å¹¶è¡Œå¼€å‘                              â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚  æ´»è·ƒåˆ†æ”¯:                                  â”‚"

    # æ˜¾ç¤ºæ¯ä¸ªåˆ†æ”¯åŠå…¶çŠ¶æ€
    while IFS= read -r branch; do
        [[ -z "$branch" ]] && continue
        # è·å–åˆ†æ”¯ä¿¡æ¯
        AHEAD=$(git rev-list --count "$CURRENT_BRANCH..$branch" 2>/dev/null || echo "?")
        PR_NUM=$(gh pr list --head "$branch" --state open --json number -q '.[0].number' 2>/dev/null || echo "")

        if [[ -n "$PR_NUM" ]]; then
            echo "â”‚    â€¢ $branch (PR #$PR_NUM)   â”‚"
        else
            echo "â”‚    â€¢ $branch ($AHEAD commits ahead)   â”‚"
        fi
    done <<< "$ACTIVE_BRANCHES"

    echo "â”‚                                             â”‚"
    echo "â”‚  é€‰é¡¹:                                      â”‚"
    echo "â”‚    [C] ç»§ç»­ç°æœ‰åˆ†æ”¯                         â”‚"
    echo "â”‚    [W] åˆ›å»º worktree å¼€å§‹æ–°åŠŸèƒ½             â”‚"
    echo "â”‚    [N] åœ¨ä¸»å·¥ä½œåŒºåˆ›å»ºæ–°åˆ†æ”¯                 â”‚"
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
fi
```

---

## ç”¨æˆ·é€‰é¡¹å¤„ç†

### é€‰é¡¹ C: ç»§ç»­ç°æœ‰åˆ†æ”¯

```bash
echo "é€‰æ‹©è¦ç»§ç»­çš„åˆ†æ”¯:"
select branch in $ACTIVE_BRANCHES; do
    if [[ -n "$branch" ]]; then
        git checkout "$branch"
        echo "âœ… å·²åˆ‡æ¢åˆ° $branch"
        # â†’ è·³åˆ° Step 4 æˆ–ç»§ç»­å½“å‰ä»»åŠ¡
        break
    fi
done
```

### é€‰é¡¹ W: åˆ›å»º worktree

```bash
# è°ƒç”¨ worktree ç®¡ç†è„šæœ¬
TASK_NAME="<ç”¨æˆ·æä¾›çš„ä»»åŠ¡å>"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../scripts" && pwd)"
WORKTREE_PATH=$(bash "$SCRIPT_DIR/worktree-manage.sh" create "$TASK_NAME")

if [[ -n "$WORKTREE_PATH" ]]; then
    echo "âœ… Worktree å·²åˆ›å»º: $WORKTREE_PATH"
    echo ""
    echo "âš ï¸  è¯·åœ¨æ–°ç»ˆç«¯ä¸­è¿›å…¥ worktree ç›®å½•ç»§ç»­å¼€å‘:"
    echo "   cd $WORKTREE_PATH"
    echo "   claude"
fi
```

### é€‰é¡¹ N: åœ¨ä¸»å·¥ä½œåŒºåˆ›å»ºæ–°åˆ†æ”¯

```bash
echo "âš ï¸  å°†åœ¨ä¸»å·¥ä½œåŒºåˆ›å»ºæ–°åˆ†æ”¯"
echo "   å½“å‰æ´»è·ƒåˆ†æ”¯çš„æ”¹åŠ¨ä¸ä¼šä¸¢å¤±"
echo ""
# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤æ”¹åŠ¨
UNCOMMITTED=$(git status --porcelain 2>/dev/null | grep -v "node_modules" || true)
if [[ -n "$UNCOMMITTED" ]]; then
    echo "âŒ æœ‰æœªæäº¤çš„æ”¹åŠ¨ï¼Œè¯·å…ˆæäº¤æˆ– stash:"
    echo "$UNCOMMITTED" | head -5 | sed 's/^/   /'
    exit 1
fi
# â†’ ç»§ç»­ Step 3 åˆ›å»ºæ–°åˆ†æ”¯
```

---

## Worktree ç›®å½•å‘½åè§„åˆ™

```
{é¡¹ç›®ç›®å½•}-wt-{ä»»åŠ¡å}[-åºå·]

ç¤ºä¾‹:
/home/xx/dev/zenithjoy-engine/              # ä¸»å·¥ä½œåŒº
/home/xx/dev/zenithjoy-engine-wt-login/     # worktree for login
/home/xx/dev/zenithjoy-engine-wt-export/    # worktree for export
/home/xx/dev/zenithjoy-engine-wt-login-2/   # é‡åæ—¶è¿½åŠ åºå·
```

---

## è¾¹ç•Œæƒ…å†µ

| åœºæ™¯ | å¤„ç† |
|------|------|
| ç”¨æˆ·åœ¨ worktree ä¸­è¿è¡Œ `/dev new` | æç¤ºå½“å‰ç¯å¢ƒï¼Œæä¾›è¿”å›ä¸»å·¥ä½œåŒºé€‰é¡¹ |
| Worktree ç›®å½•å·²å­˜åœ¨ | è¿½åŠ åºå·ï¼š`project-wt-login-2` |
| ä¸»å·¥ä½œåŒºæœ‰æœªæäº¤æ”¹åŠ¨ | é˜»æ­¢åˆ‡æ¢ï¼Œæç¤ºå…ˆæäº¤æˆ– stash |
| æ´»è·ƒåˆ†æ”¯æœ‰æœªæ¨é€çš„ commit | æ˜¾ç¤ºè­¦å‘Šï¼Œä½†å…è®¸ç»§ç»­ |

---

## å®Œæˆå

```bash
echo "âœ… Step 2.5 å®Œæˆ (å¹¶è¡Œå¼€å‘æ£€æµ‹)"
```

ç»§ç»­ â†’ Step 3 åˆ›å»ºåˆ†æ”¯
