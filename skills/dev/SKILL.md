---
name: dev
description: |
  统一开发工作流入口。v9: Ralph Loop 集成。

  触发条件：
  - 用户说任何开发相关的需求
  - 用户说 /dev
  - Hook 输出 [SKILL_REQUIRED: dev]
---

# /dev - 统一开发工作流 (v9)

## 四种模式（自动检测）

```
/dev 入口
    │
    ├── 在 develop/main + 有 PRD → 新任务模式
    │
    └── 在 cp-*/feature/*
            │
            ├── 无 PR → 继续开发模式
            │
            └── 有 PR
                    │
                    ├── CI 绿 → 合并模式
                    │
                    └── CI 红 → 修复模式
```

### 模式检测规则

| 条件 | 模式 | 动作 |
|------|------|------|
| 分支 = develop/main + 用户有 PRD | 新任务 | 创建分支 → DoD → Loop 1 → PR → Loop 2 → Merge |
| 分支 = cp-*/feature/* + 无 PR | 继续开发 | 直接进入 Loop 1 |
| 分支 = cp-*/feature/* + PR 存在 + CI 红 | 修复 | 直接进入 Loop 2 |
| 分支 = cp-*/feature/* + PR 存在 + CI 绿 | 合并 | Learning → Cleanup → Merge |

---

## 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│  /dev 入口                                                   │
│      │                                                      │
│      ▼                                                      │
│  自动检测模式                                                │
│      │                                                      │
│      ├── 新任务 ──────────────────────────┐                 │
│      │                                    │                 │
│      ├── 继续开发 ────────────────────────┤                 │
│      │                                    ▼                 │
│      │                            ┌──────────────┐          │
│      │                            │  PRD + DoD   │          │
│      │                            └──────┬───────┘          │
│      │                                   │                  │
│      │                                   ▼                  │
│      │                            ┌──────────────┐          │
│      │                            │  创建分支    │          │
│      │                            │  (如果需要)  │          │
│      │                            └──────┬───────┘          │
│      │                                   │                  │
│      │                                   ▼                  │
│      │                     ┌─────────────────────────┐      │
│      │                     │  Loop 1: 本地 QA        │      │
│      │                     │  npm run qa 直到通过    │      │
│      │                     │  20 轮告警              │      │
│      │                     └───────────┬─────────────┘      │
│      │                                 │                    │
│      │                                 ▼                    │
│      │                          gh pr create                │
│      │                                 │                    │
│      │                                 ▼                    │
│      │                              CI 跑                   │
│      │                                 │                    │
│      ├── 修复 ─────────────────────────┤                    │
│      │                                 │                    │
│      │         ┌───────────────────────┴───────┐            │
│      │         │                               │            │
│      │         ▼                               ▼            │
│      │      CI 红                           CI 绿           │
│      │         │                               │            │
│      │         ▼                               │            │
│      │  ┌─────────────────────────┐            │            │
│      │  │  Loop 2: CI 修复        │            │            │
│      │  │  修复 → push → 等 CI    │            │            │
│      │  │  20 轮告警              │            │            │
│      │  └───────────┬─────────────┘            │            │
│      │              │                          │            │
│      │              └──────────────────────────┤            │
│      │                                         │            │
│      └── 合并 ─────────────────────────────────┤            │
│                                                ▼            │
│                                         ┌──────────────┐    │
│                                         │  Merge       │    │
│                                         │  + Learning  │    │
│                                         │  + Cleanup   │    │
│                                         └──────────────┘    │
│                                                │            │
│                                                ▼            │
│                                             完成            │
└─────────────────────────────────────────────────────────────┘
```

---

## Loop 1: 本地 QA

**目标**：`npm run qa` 通过

```
┌─────────────────────────────────┐
│  写代码                         │
│      ↓                          │
│  npm run qa                     │
│      │                          │
│      ├── 失败 → 修复 → 重跑     │
│      │                          │
│      └── 通过 → 退出 Loop       │
│                                 │
│  告警：20 轮未通过 →            │
│        输出 NEED_HUMAN_HELP     │
└─────────────────────────────────┘
```

**执行方式**：
1. 写代码完成 DoD
2. 运行 `npm run qa`
3. 如果失败，读取错误信息，修复，重跑
4. 如果通过，输出 `LOCAL_QA_PASSED`
5. 如果 20 轮还没过，输出 `NEED_HUMAN_HELP`

---

## Loop 2: CI 修复

**目标**：CI 全绿

```
┌─────────────────────────────────┐
│  读取 CI 错误                   │
│      ↓                          │
│  修复代码                       │
│      ↓                          │
│  commit + push                  │
│      ↓                          │
│  等待 CI                        │
│      │                          │
│      ├── 失败 → 重新循环        │
│      │                          │
│      └── 通过 → 退出 Loop       │
│                                 │
│  告警：20 轮未通过 →            │
│        输出 NEED_HUMAN_HELP     │
└─────────────────────────────────┘
```

**执行方式**：
1. 运行 `gh pr checks $PR_NUMBER` 获取失败信息
2. 读取 CI 日志，分析错误原因
3. 修复代码
4. commit + push
5. 运行 `gh pr checks $PR_NUMBER --watch` 等待 CI
6. 如果通过，输出 `CI_ALL_GREEN`
7. 如果 20 轮还没过，输出 `NEED_HUMAN_HELP`

---

## 有头 vs 无头

| | 有头 | 无头 (Cecilia) |
|---|---|---|
| PRD 来源 | 用户说 | prompt 传入 |
| 告警处理 | Claude 问用户 | 输出 NEED_HUMAN_HELP，N8N 发通知 |
| 超时 | 无 | N8N 设 1 小时告警 |
| 流程 | **完全一样** | **完全一样** |

---

## 核心规则

1. **只在 cp-* 或 feature/* 分支写代码** - Hook 引导
2. **develop 是主开发线** - PR 合并回 develop
3. **main 始终稳定** - 只在里程碑时从 develop 合并
4. **CI 是唯一强制检查** - 其他都是引导
5. **Loop 自动处理失败** - 不需要手动触发修复

---

## 版本号规则 (semver)

| commit 类型 | 版本变化 |
|-------------|----------|
| fix: | patch (+0.0.1) |
| feat: | minor (+0.1.0) |
| feat!: / BREAKING: | major (+1.0.0) |

---

## 加载策略

```
skills/dev/
├── SKILL.md        ← 你在这里（入口）
├── VALIDATION.md   ← 质检规则
├── steps/          ← 每步详情（按需加载）
│   ├── 01-prd.md
│   ├── 02-detect.md
│   ├── 03-branch.md
│   ├── 04-dod.md
│   ├── 05-code.md
│   ├── 06-test.md
│   ├── 07-quality.md
│   ├── 08-pr.md
│   ├── 09-ci.md
│   ├── 10-learning.md
│   └── 11-cleanup.md
└── scripts/        ← 辅助脚本
    ├── cleanup.sh
    ├── check.sh
    └── ...
```

---

## 快速修复模式

**适用条件**（全部满足）：
- `fix:` 类型修复
- 单文件或少量改动
- 需求明确

**简化流程**：PRD 快速确认 → Loop 1 → PR → Loop 2 → Merge

---

## 完成度检查

**Cleanup 后运行**：

```bash
bash skills/dev/scripts/check.sh "$BRANCH_NAME" "$BASE_BRANCH"
```
