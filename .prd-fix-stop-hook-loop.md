---
id: prd-fix-stop-hook-loop
version: 1.0.0
created: 2026-02-01
type: bug-fix
priority: P0
---

# PRD: 修复 Stop Hook 循环机制和流程控制

## 问题背景

**现象**：AI 在执行 /dev 流程时，容易在中途停下来（特别是 Step 5-7 之间），导致 11 步流程不完整。

**根本原因分析**：

通过深度调查发现，Stop Hook 存在严重的设计缺陷：

1. **重试次数错误**：stop_hook_active 只允许重试 1 次，而不是设计的 20 次
2. **提前退出漏洞**：PR 合并后直接 exit 0，绕过 Step 10-11
3. **缺少 checklist**：没有检查 11 步是否全部完成
4. **分支不匹配泄漏**：.dev-mode 文件无法清理，污染后续会话

### 问题严重程度

| 问题 | 严重程度 | 影响 |
|------|---------|------|
| stop_hook_active 只重试 1 次 | 🔴 Critical | 主流程被迫中断 |
| PR 合并后提前退出 | 🔴 Critical | Step 10-11 不执行 |
| 缺少 11 步 checklist | 🔴 Critical | 无法确保流程完整 |
| 分支不匹配泄漏 .dev-mode | 🟡 Medium | 干扰后续会话 |
| Cleanup 遗漏 gate 文件 | 🟡 Medium | 文件污染 |

---

## 优化目标

### 核心目标

**Stop Hook 必须确保 11 步流程完整执行，只有一个正确的退出条件：`cleanup_done: true`**

### 设计原则

1. **统一循环次数**：主线和 Subagent 都是 20 次限制
2. **单一退出条件**：只有 `cleanup_done: true` 才允许退出
3. **11 步 checklist**：追踪每一步的完成状态
4. **完整清理**：不留任何临时文件

---

## 技术方案

### 1. 修复 Stop Hook 循环机制

#### 1.1 删除 stop_hook_active 检查

**当前代码**（`hooks/stop.sh` Line 84-96）：
```bash
STOP_HOOK_ACTIVE=$(echo "$HOOK_INPUT" | jq -r '.stop_hook_active // false')

if [[ "$STOP_HOOK_ACTIVE" == "true" ]]; then
    echo "已重试过一次，允许会话结束"
    exit 0  # ❌ 只允许重试 1 次
fi
```

**修改为 20 次计数器**：
```bash
# 从 .dev-mode 读取重试次数
RETRY_COUNT=$(grep "^retry_count:" "$DEV_MODE_FILE" 2>/dev/null | cut -d' ' -f2 || echo "0")

if [[ $RETRY_COUNT -ge 20 ]]; then
    echo "❌ 已重试 20 次，任务失败"
    # 上报失败状态
    bash skills/dev/scripts/track.sh fail "Stop Hook 重试 20 次后仍未完成"
    rm -f "$DEV_MODE_FILE"
    exit 0
fi

# 增加重试次数（原子写入）
if [[ -f "$DEV_MODE_FILE" ]]; then
    # 删除旧的 retry_count 行
    sed -i "/^retry_count:/d" "$DEV_MODE_FILE"
    # 追加新的计数
    echo "retry_count: $((RETRY_COUNT + 1))" >> "$DEV_MODE_FILE"
fi
```

#### 1.2 删除所有提前退出漏洞

**删除 PR 合并后的提前退出**（Line 197-233）：
```bash
# ❌ 删除这段代码
if [[ "$PR_STATE" == "merged" ]]; then
    # 自动 cleanup
    exit 0
fi
```

**修改分支不匹配逻辑**（Line 130-133）：
```bash
# 当前：分支不匹配直接退出（导致 .dev-mode 泄漏）
if [[ -n "$BRANCH_IN_FILE" && "$BRANCH_IN_FILE" != "$CURRENT_BRANCH" ]]; then
    exit 0  # ❌ 导致泄漏
fi

# 修改为：分支不匹配时强制清理
if [[ -n "$BRANCH_IN_FILE" && "$BRANCH_IN_FILE" != "$CURRENT_BRANCH" ]]; then
    # 检查 PR 是否已合并
    PR_STATE=$(gh pr list --head "$BRANCH_IN_FILE" --state merged --json number -q '.[0].number' 2>/dev/null || echo "")

    if [[ -n "$PR_STATE" ]]; then
        # PR 已合并，强制清理 .dev-mode
        echo "⚠️  检测到旧任务已完成，清理 .dev-mode"
        rm -f "$DEV_MODE_FILE"
    fi

    exit 0
fi
```

#### 1.3 统一退出条件

**保留唯一的正确退出条件**：
```bash
# 只有这一个条件允许退出
if grep -q "cleanup_done: true" "$DEV_MODE_FILE" 2>/dev/null; then
    rm -f "$DEV_MODE_FILE"
    exit 0
fi

# 其他所有情况：exit 2（强制继续）
exit 2
```

---

### 2. 实现 11 步 Checklist 机制

#### 2.1 .dev-mode 文件格式扩展

**当前格式**：
```
dev
branch: cp-xxx
prd: .prd.md
started: 2026-02-01T...
tasks_created: true
```

**扩展为**：
```
dev
branch: cp-xxx
prd: .prd.md
started: 2026-02-01T...
tasks_created: true
retry_count: 0

# 11 步 checklist
step_1_prd: done
step_2_detect: done
step_3_branch: done
step_4_dod: done
step_5_code: done
step_6_test: done
step_7_quality: done
step_8_pr: done
step_9_ci: done
step_10_learning: done
step_11_cleanup: done

cleanup_done: true
```

#### 2.2 每个 Step 完成时追加状态

在每个 `skills/dev/steps/*.md` 的末尾添加：

```bash
# 追加完成标记
echo "step_N_xxx: done" >> .dev-mode
```

#### 2.3 Stop Hook 检查 checklist

```bash
# 检查所有 11 步是否完成
ALL_STEPS_DONE=true
for step_num in {1..11}; do
    if ! grep -q "^step_${step_num}_.*: done" "$DEV_MODE_FILE" 2>/dev/null; then
        ALL_STEPS_DONE=false
        break
    fi
done

if [[ "$ALL_STEPS_DONE" == "true" ]] && grep -q "cleanup_done: true" "$DEV_MODE_FILE"; then
    # 全部完成，允许退出
    rm -f "$DEV_MODE_FILE"
    exit 0
fi

# 未完成，继续执行
exit 2
```

---

### 3. 优化步骤末尾提示

#### 3.1 统一格式

所有 `skills/dev/steps/*.md` 末尾统一改为：

```markdown
**Task Checkpoint**: `TaskUpdate({ taskId: "N", status: "completed" })`

---

## ⚡ 立即执行下一步（CRITICAL）

**完成本步骤后，立即执行以下操作，不要停顿、不要等待、不要输出总结**：

1. **追加完成标记**：
   ```bash
   echo "step_N_xxx: done" >> .dev-mode
   ```

2. **读取下一步文件**：
   ```bash
   Read({ file_path: "skills/dev/steps/{N+1}-yyy.md" })
   ```

3. **立即开始执行**下一步的内容

4. **不要**输出"Step N 已完成，现在继续 Step N+1"之类的总结

---

**下一步**：`skills/dev/steps/{N+1}-yyy.md`
```

---

### 4. 完善 Cleanup 清理

#### 4.1 扩展清理文件列表

**当前清理**（`skills/dev/scripts/cleanup.sh` Line 349-362）：
```bash
RUNTIME_FILES=(
    ".quality-report.json"
    ".prd.md"
    ".dod.md"
    # ... 其他文件
)
```

**扩展为**：
```bash
RUNTIME_FILES=(
    # 现有文件
    ".quality-report.json"
    ".prd.md"
    ".dod.md"
    ".prd-${CP_BRANCH}.md"
    ".dod-${CP_BRANCH}.md"
    ".quality-gate-passed"
    ".quality-gate-passed-${CP_BRANCH}"
    ".cecelia-run-id"
    ".cecelia-run-id-${CP_BRANCH}"
    ".layer2-evidence.md"
    ".l3-analysis.md"
    ".quality-evidence.json"

    # 新增：gate 文件
    ".gate-prd-passed"
    ".gate-dod-passed"
    ".gate-audit-passed"
    ".gate-test-passed"
    ".gate-learning-passed"

    # 新增：.dev-mode（显式清理）
    ".dev-mode"
)
```

#### 4.2 Cleanup 完成后设置标记

**确保最后一步设置 cleanup_done**（已有，确认正确）：
```bash
if [[ -f "$DEV_MODE_FILE" ]]; then
    echo "cleanup_done: true" >> "$DEV_MODE_FILE"
fi
```

---

## 验收标准 (DoD)

### 必要项

- [ ] **Stop Hook 重试机制**
  - [ ] 删除 stop_hook_active 检查（Line 84-96）
  - [ ] 实现 20 次计数器（retry_count）
  - [ ] 20 次后上报失败，不再重试

- [ ] **Stop Hook 退出条件**
  - [ ] 删除 PR 合并后的提前退出（Line 197-233）
  - [ ] 修复分支不匹配时的 .dev-mode 泄漏（Line 130-133）
  - [ ] 只保留 cleanup_done: true 作为唯一退出条件

- [ ] **11 步 Checklist**
  - [ ] .dev-mode 文件包含 step_1-11 状态字段
  - [ ] 每个 Step 完成时追加 `step_N_xxx: done`
  - [ ] Stop Hook 检查所有步骤是否完成

- [ ] **步骤提示优化**
  - [ ] 所有 steps/*.md 末尾统一格式
  - [ ] 明确指示：读取下一步文件、立即执行、不要停顿

- [ ] **Cleanup 完善**
  - [ ] 清理所有 gate 文件（.gate-*-passed）
  - [ ] 显式清理 .dev-mode 文件
  - [ ] 设置 cleanup_done: true 标记

### 可选项

- [ ] Stop Hook 检查超时（超过 24 小时自动失败）
- [ ] 步骤执行时间统计（记录到 .dev-mode）
- [ ] 失败时自动生成诊断报告

---

## 测试计划

### 单元测试

1. **测试 Stop Hook 重试计数**
   ```bash
   # 模拟多次停顿，验证计数器正确
   # 验证 20 次后退出
   ```

2. **测试 11 步 checklist**
   ```bash
   # 模拟部分步骤完成
   # 验证 Stop Hook 正确检测未完成的步骤
   ```

3. **测试 Cleanup 清理**
   ```bash
   # 创建所有临时文件
   # 运行 cleanup.sh
   # 验证所有文件被删除
   ```

### 集成测试

1. **完整流程测试**
   - 运行 /dev 从 Step 1 到 Step 11
   - 验证每步都正确执行
   - 验证 .dev-mode 被正确清理

2. **中断恢复测试**
   - 在 Step 5 后强制中断
   - 验证 Stop Hook 强制继续
   - 验证流程从中断处恢复

3. **失败场景测试**
   - 模拟重试 20 次仍失败
   - 验证任务被标记为失败
   - 验证失败状态正确上报

---

## 回归风险

### 高风险

- ❌ Stop Hook 逻辑改动较大，可能影响现有流程
- ❌ .dev-mode 格式变更，可能导致旧任务识别失败

### 中风险

- ⚠️ Cleanup 清理列表扩展，可能误删有用文件

### 缓解措施

1. **向后兼容**：
   - 新的 checklist 字段为可选
   - 旧的 .dev-mode 格式仍能识别

2. **备份机制**：
   - Cleanup 前备份 .dev-mode 到 `.dev-mode.backup`
   - 失败时可恢复

3. **充分测试**：
   - 先在测试分支验证
   - 通过后再部署到全局

---

## 实施计划

### Phase 1: 核心修复（本次 PR）

1. 修复 Stop Hook 重试机制（删除 stop_hook_active，添加计数器）
2. 删除提前退出漏洞（PR 合并后、分支不匹配）
3. 实现 11 步 checklist 追踪
4. 优化步骤末尾提示

**预计工作量**：1-2 小时

### Phase 2: 完善清理（后续 PR）

1. 扩展 Cleanup 清理列表
2. 添加 .dev-mode 备份机制
3. 实现失败诊断报告

**预计工作量**：1 小时

### Phase 3: 监控优化（可选）

1. 添加步骤执行时间统计
2. 添加超时自动失败机制
3. 优化失败通知

**预计工作量**：1 小时

---

## 影响范围

### 修改文件

| 文件 | 修改类型 | 风险 |
|------|---------|------|
| `hooks/stop.sh` | 重构 | 高 |
| `skills/dev/steps/*.md` | 扩展 | 中 |
| `skills/dev/scripts/cleanup.sh` | 扩展 | 低 |

### 依赖项

- 无新增依赖
- 使用现有工具（sed, grep, bash）

---

## 成功指标

### 定量指标

- Stop Hook 重试次数从 1 次提升到 20 次
- .dev-mode 泄漏率从 100% 降到 0%
- 11 步完整执行率从 ~60% 提升到 ~95%

### 定性指标

- AI 不再在中途停顿
- 流程执行更稳定、可预测
- 临时文件污染消失

---

## 参考资料

- 问题分析文档：`docs/LEARNINGS.md` v1.7.0
- Stop Hook 源码：`hooks/stop.sh`
- /dev 流程定义：`skills/dev/SKILL.md`
