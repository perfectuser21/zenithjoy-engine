# PRD: 硬拦截 --admin 参数

## 需求来源

- **发现问题**：在 v11.23.0 release 过程中，使用了 `gh pr merge --admin` 绕过分支保护和 CI，违反了工程规范
- **触发场景**：develop → main 合并冲突时，为了快速解决问题使用了 --admin 绕过检查
- **问题分析**：CLAUDE.md 文档约束不足以防止 AI 和人类开发者违反规则

## 背景

当前 CLAUDE.md 中只是文档禁止使用 `--admin`，但：
- AI 可能忽略文档规则
- 人类开发者也可能违反
- 缺乏技术手段强制执行

## 目标

**技术手段强制阻止 `--admin` 使用**

## 方案

### 1. Hook 拦截（本次实现）✅

在 `hooks/pr-gate-v2.sh` 开头添加检测：
- 检测任何包含 `--admin` 的命令
- exit 2 阻止执行
- 输出清晰的错误提示

### 2. Branch Protection 验证（后续）

确保所有仓库启用 `enforce_admins: true`：
- 即使是 Admin 也必须遵守 CI
- 运行检查脚本验证配置

## 成功标准

- ✅ Hook 能检测并阻止包含 `--admin` 的命令
- ✅ 提供清晰的错误提示和正确做法
- ✅ 不影响正常的 gh 命令使用

## 非目标

- 不修改 GitHub 权限（仍然允许用户是 Admin）
- 不影响其他非 `--admin` 的 gh 命令

## 影响范围

### 受影响组件
- `hooks/pr-gate-v2.sh`：新增 --admin 检测逻辑（在命令检测开头添加）

### 受影响用户
- 所有使用 gh 命令的开发者（AI + 人类）
- 所有创建/合并 PR 的场景

### 受影响流程
- PreToolUse:Bash Hook 执行流程
- gh pr merge、gh pr create 等命令执行前的检查
