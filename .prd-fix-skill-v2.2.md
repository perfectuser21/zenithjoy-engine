# PRD - 修复 /dev Skill v2.2（删除阶段 + 强制 Task Checkpoint）

## 背景

v2.1.0 的 /dev SKILL.md 存在严重问题：

1. **还在用错误的阶段检测**
   - 仍然有 p0/p1/p2 阶段划分
   - 第 82-115 行：p0/p1 阶段完成条件
   - 第 159-290 行：整段阶段检测和流程图
   - 导致 AI 在 PR 创建后就错误地输出 DONE

2. **完全没用官方 Task Checkpoint**
   - SKILL.md 里根本没提到 TaskCreate/TaskUpdate
   - AI 执行时没有追踪进度
   - 用户看不到实时进度（哪一步 in_progress）
   - 中断后无法恢复

3. **这次测试暴露的问题**
   - AI 在 PR 创建后就输出 `<promise>DONE</promise>`
   - 没有继续等 CI、修复、合并
   - Ralph Loop 没有真正循环（只跑了 1 次就停了）

## 目标

修复 SKILL.md 到 v2.2.0：

1. **删除所有阶段检测逻辑**
   - ❌ 删除 p0/p1/p2 阶段
   - ❌ 删除 detect-phase.sh 调用
   - ✅ 改为统一完成条件：PR 创建 + CI 通过 + PR 合并 = DONE

2. **强制使用官方 Task Checkpoint**
   - ✅ 开始时：TaskCreate 创建所有步骤
   - ✅ 执行中：TaskUpdate(N, in_progress/completed)
   - ✅ 让用户实时看到进度

3. **正确的 Ralph Loop 循环逻辑**
   - ✅ 从头到尾一直执行
   - ✅ 不在 PR 创建后停止
   - ✅ 继续等 CI、修复、合并
   - ✅ 全部完成才输出 DONE

## 具体改动

### 1. SKILL.md frontmatter

```yaml
version: 2.1.0 → 2.2.0
v2.2.0 变更：
  - 删除阶段检测（不再分 p0/p1/p2）
  - 统一完成条件：PR 创建 + CI 通过 + PR 合并 = DONE
  - 强制使用官方 Task checkpoint 追踪进度
```

### 2. 删除错误的阶段相关内容

删除以下章节：

- 第 82-115 行：`### p0 阶段完成条件` 和 `### p1 阶段完成条件`
- 第 146-148 行：Ralph Loop 结束条件中的阶段判断
- 第 159-290 行：`## 入口：阶段检测（两阶段）` 整个章节
- 第 159-290 行：`## 流程节点（两阶段分离）` 整个章节
- 第 294-310 行：`## 核心规则（v2.0）` 中的两阶段描述

### 3. 新增统一完成条件

```markdown
## 统一完成条件（AI 职责）

**AI 在每次 Ralph Loop 迭代结束时，必须检查完成条件并决定是否输出 promise。**

### 唯一完成条件

```
1. PR 已创建？
   ❌ → 继续执行到创建 PR → 不输出 promise → 继续

2. CI 状态？
   - PENDING/QUEUED/IN_PROGRESS → 等待 → 不输出 promise → 继续
   - FAILURE → 分析失败 → 修复代码 → push → 不输出 promise → 继续
   - SUCCESS → 继续下一步

3. PR 已合并？
   ❌ → gh pr merge --squash --delete-branch → 不输出 promise → 继续

✅ 全部满足 → 输出 <promise>DONE</promise> → Ralph Loop 结束
```

**不再分阶段**：
- ❌ 不再有 p0/p1/p2 阶段
- ❌ 不再运行 detect-phase.sh
- ✅ 从头到尾一直执行，直到 PR 合并
```

### 4. 新增 Task Checkpoint 使用规范

```markdown
## Task Checkpoint 追踪（CRITICAL）

**必须使用官方 Task 工具追踪进度**，让用户实时看到执行状态。

### 任务创建（开始时）

在 /dev 开始时，创建所有步骤的 Task：

```
TaskCreate({ subject: "PRD 确认", description: "确认 PRD 文件存在且有效", activeForm: "确认 PRD" })
TaskCreate({ subject: "环境检测", description: "检测项目环境和配置", activeForm: "检测环境" })
TaskCreate({ subject: "分支创建", description: "创建或切换到功能分支", activeForm: "创建分支" })
TaskCreate({ subject: "DoD 定稿", description: "生成 DoD 并调用 QA 决策", activeForm: "定稿 DoD" })
TaskCreate({ subject: "写代码", description: "根据 PRD 实现功能", activeForm: "写代码" })
TaskCreate({ subject: "写测试", description: "为功能编写测试", activeForm: "写测试" })
TaskCreate({ subject: "质检", description: "代码审计 + 自动化测试", activeForm: "质检中" })
TaskCreate({ subject: "提交 PR", description: "版本号更新 + 创建 PR", activeForm: "提交 PR" })
TaskCreate({ subject: "CI 监控", description: "等待 CI 通过并修复失败", activeForm: "监控 CI" })
TaskCreate({ subject: "Learning 记录", description: "记录开发经验", activeForm: "记录经验" })
TaskCreate({ subject: "清理", description: "清理临时文件", activeForm: "清理中" })
```

### 任务更新（执行中）

```
// 开始某个步骤时
TaskUpdate({ taskId: "1", status: "in_progress" })

// 完成某个步骤时
TaskUpdate({ taskId: "1", status: "completed" })

// 如果失败需要重试
// 不要 delete，保留状态为 in_progress，继续重试
```

### 查看进度

```
// AI 可以随时查看当前进度
TaskList()

// 输出示例：
// ✅ 1. PRD 确认 (completed)
// ✅ 2. 环境检测 (completed)
// ✅ 3. 分支创建 (completed)
// 🚧 4. DoD 定稿 (in_progress)
// ⏸️  5. 写代码 (pending)
// ...
```
```

### 5. 更新执行流程图

删除 p0/p1/p2 三个流程图，改为一个统一的流程图（见上面"新增统一完成条件"章节）。

### 6. 更新核心规则

```markdown
## 核心规则

### 1. 统一流程（不分阶段）✅

```
开始 → Step 1-11 → PR 创建 → CI 监控 → PR 合并 → DONE
```

**不再有**：
- ❌ p0/p1/p2 阶段
- ❌ detect-phase.sh 阶段检测
- ❌ "发 PR 后就结束" 的错误逻辑

### 2. Task Checkpoint 追踪 ✅

```
每个步骤：
  开始 → TaskUpdate(N, in_progress)
  完成 → TaskUpdate(N, completed)
  失败重试 → 保持 in_progress，继续执行
```
```

## 验收标准

- [ ] skills/dev/SKILL.md 版本号更新为 2.2.0
- [ ] 所有 p0/p1/p2 阶段相关内容已删除
- [ ] detect-phase.sh 调用已删除
- [ ] 新增"统一完成条件"章节
- [ ] 新增"Task Checkpoint 追踪"章节，详细说明 TaskCreate/TaskUpdate 使用方法
- [ ] 执行流程图改为单一流程（不分阶段）
- [ ] 核心规则更新为统一流程
- [ ] 版本号、registry、CHANGELOG 已同步更新
- [ ] 测试：用 dev-with-loop 跑一个任务，验证：
  - 使用了 TaskCreate/TaskUpdate
  - 不会在 PR 创建后停止
  - 一直执行到 PR 合并
  - 用户能看到实时进度

## 技术细节

### Task Checkpoint 是官方工具

使用 Claude Code 官方的 Task 工具：
- TaskCreate - 创建任务
- TaskUpdate - 更新任务状态
- TaskList - 查看任务列表
- TaskGet - 获取任务详情

**不是**自己实现的追踪系统。

### 删除的行数范围

精确定位需要删除的内容：

1. 第 82-115 行（34 行）：p0/p1 阶段完成条件
2. 第 159-290 行（132 行）：阶段检测 + 流程节点
3. 第 296-310 行（15 行）：核心规则中的两阶段描述

总共删除约 181 行，新增约 150 行（Task Checkpoint + 统一完成条件）。

### 不影响的部分

- Step 1-11 的具体实现（steps/ 目录）不变
- track.sh（Core/Notion 同步）不变
- 分支策略不变
- 产物门控不变
- semver 规则不变

## 风险

### 低风险

这次改动只是修正文档，不涉及代码逻辑：
- ✅ 删除错误的阶段检测逻辑
- ✅ 补充遗漏的 Task Checkpoint 使用说明
- ✅ 统一完成条件

### 测试方案

用 dev-with-loop 跑一个真实任务（比如这个修复任务本身），验证：
1. AI 是否使用了 TaskCreate/TaskUpdate
2. 是否能看到实时进度（Task 列表）
3. PR 创建后是否继续执行（不停止）
4. CI 失败时是否自动修复并重试
5. 最终是否等到 PR 合并才输出 DONE

## 关联

- 问题来源：v2.1.0 测试（Ralph Loop Wrapper 修复）暴露的问题
- 修复目标：v2.2.0 彻底删除阶段 + 强制 Task Checkpoint
- 下一步：测试验证 v2.2.0 是否正确
