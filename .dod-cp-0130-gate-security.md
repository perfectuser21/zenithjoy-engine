# DoD: Gate 安全机制修复

QA: docs/QA-DECISION-cp-0130-gate-security.md

## 验收清单

### P0-4: Gate 文件过期 + HEAD 绑定
- [ ] Gate 文件添加 version 字段 (v3)
  Test: tests/gate-signature.test.ts
- [ ] Gate 文件添加 expires_at 字段 (30 分钟 TTL)
  Test: tests/gate-signature.test.ts
- [ ] Gate 文件添加 tree_sha 字段
  Test: tests/gate-signature.test.ts
- [ ] Gate 文件添加 repo_id 字段
  Test: tests/gate-signature.test.ts
- [ ] 验证时检查过期（硬失败）
  Test: tests/gate-signature.test.ts
- [ ] 验证时检查 HEAD 绑定（commit + tree）
  Test: tests/gate-signature.test.ts
- [ ] Secret 读取支持 env/keychain/文件三种方式
  Test: manual:check-secret-sources

### P0-1: 验证器缺失改软警告
- [ ] pr-gate-v2.sh 验证器缺失时不 exit 2
  Test: manual:new-repo-pr-test

### P0-2: Stop Hook 自动 Cleanup
- [ ] PR merged 后自动删除 .dev-mode
  Test: manual:pr-merge-cleanup-test
- [ ] PR merged 后 exit 0（不是 exit 2）
  Test: manual:pr-merge-cleanup-test

## 技术方案

1. **generate-gate-file.sh**: 升级到 v3 格式，添加 TTL、tree_sha、repo_id
2. **verify-gate-signature.sh**: 添加过期检查、HEAD 绑定验证
3. **hooks/pr-gate-v2.sh**: 验证器缺失改软警告
4. **hooks/stop.sh**: merged 后自动 cleanup
