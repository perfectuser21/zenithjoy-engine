---
id: prd-evidence-ci-ssot
version: 2.0.0
created: 2026-01-27
priority: P0
status: FINAL
---

# PRD - Evidence CI 化（SSOT）+ Ralph Loop 自愈循环（无人值守 & 零漂移）

## 1. 背景与问题

当前存在严重问题：

**本地检查和 CI 检查不一致** → 本地全绿、CI 连挂、重复修复

| 检查项 | 本地 | CI | 备注 |
|--------|------|-----|------|
| typecheck | ✅ | ✅ | 一致 |
| lint | ✅ | ✅ | 一致 |
| test | ❌ | ✅ | 本地不跑、CI 跑 |
| build | ❌ | ✅ | 本地不跑、CI 跑 |
| VERSION Check | ❌ | ✅ | 差异 |
| Evidence Gate | ❌ | ✅ | 差异 |
| RCI Coverage | ❌ | ✅ | 差异 |

**真实事故（PR #305）**：
- 本地 Quality 全部通过
- CI 连续失败 3 次，原因均为 "Evidence / SHA 漂移 / VERSION" 等 CI 专属契约项

**根因**：

Evidence 由本地产生 → commit → SHA 漂移 → CI 校验不一致

---

## 2. 总体目标（Single Source of Truth）

让 CI 成为唯一真相（SSOT）：
- Evidence 只在 CI 生成
- Evidence 只在 CI 校验
- Evidence 不 commit、不 push、不进入 git
- 本地只做 Fast Fail（10 秒级）
- Ralph Loop 自动修复 CI 失败
- 最终 merge 的代码质量 = CI 质量（100%）

---

## 3. 方案概述

### 3.1 Evidence CI 化（核心）
- 文件名：`.quality-evidence.<sha>.json`
- 生成位置：CI workspace（临时）
- 交付方式：Artifact（可选）
- 永不 push 回 repo
- Gate 校验：基于 CI 的 HEAD SHA

### 3.2 本地只做 Fast Fail（快速质量检查）
- typecheck
- lint
- audit 报告（不作为契约）

### 3.3 CI 做完整验证
- qa（typecheck + test + build）
- evidence 生成
- version check
- evidence gate
- rci coverage check
- 必须全部通过

### 3.4 Ralph Loop 自愈循环（无人值守）
- 分析 CI 日志
- 自动修复：VERSION / Tests / RCI / Audit
- push
- 重跑 CI
- 直到成功
- 自动 merge PR
- 输出 `<promise>CI_PASSED</promise>`

---

## 4. Evidence CI 化（最终实现方案）

### 4.1 文件命名规则（固定）

```
.quality-evidence.<HEAD_SHA>.json
```

示例：
```
.quality-evidence.c08d80c4bd.json
```

---

### 4.2 Evidence 生成（CI Step）

文件：`ci/scripts/generate-evidence.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail

HEAD_SHA=$(git rev-parse HEAD)
OUT=".quality-evidence.${HEAD_SHA}.json"

echo "Generating Evidence for $HEAD_SHA"

cat > "$OUT" <<EOF
{
  "sha": "${HEAD_SHA}",
  "branch": "${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}",
  "ci_run_id": "${GITHUB_RUN_ID}",
  "timestamp": "$(date -Iseconds)",
  "qa_gate_passed": true,
  "audit_decision": "PASS"
}
EOF

echo "Evidence file generated: $OUT"
```

---

### 4.3 Evidence Gate（CI Step）

文件：`ci/scripts/evidence-gate.sh`

```bash
#!/usr/bin/env bash
set -euo pipefail

HEAD_SHA=$(git rev-parse HEAD)
FILE=".quality-evidence.${HEAD_SHA}.json"

if [[ ! -f "$FILE" ]]; then
  echo "❌ Evidence not found: $FILE"
  exit 1
fi

# 校验 JSON 格式
jq empty "$FILE" || {
  echo "❌ Evidence invalid JSON"
  exit 1
}

# 校验 SHA
E_SHA=$(jq -r '.sha' "$FILE")
if [[ "$E_SHA" != "$HEAD_SHA" ]]; then
  echo "❌ Evidence SHA mismatch"
  exit 1
fi

# 校验字段
for key in sha ci_run_id timestamp qa_gate_passed audit_decision; do
  jq -e ".$key" "$FILE" >/dev/null || {
    echo "❌ Missing field: $key"
    exit 1
  }
done

echo "✅ Evidence Gate Passed"
```

---

### 4.4 CI Workflow（完整 YAML）

```yaml
jobs:
  qa:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install
        run: npm ci

      - name: QA (full)
        run: npm run qa

      - name: Generate Evidence
        run: ci/scripts/generate-evidence.sh

      - name: Evidence Gate
        run: ci/scripts/evidence-gate.sh

      - name: Version Check
        run: ci/scripts/version-check.sh

      - name: RCI Coverage
        run: ci/scripts/rci-check.sh
```

---

## 5. 本地 Quality（Fast Fail）

Step 7（重写）

```bash
npm run qa:local
```

package.json:

```json
{
  "scripts": {
    "qa:local": "npm run typecheck && npm run lint",
    "qa": "npm run typecheck && npm run test && npm run build"
  }
}
```

不再本地生成或校验 evidence，不跑 test/build。

---

## 6. Ralph Loop 自愈循环（最终版）

文件：`skills/dev/steps/09-ci.md`（重写）

### 6.1 启动

```bash
PR=$(gh pr view --json number -q '.number')
/ralph-loop "修复 PR #$PR 的 CI 失败" \
  --completion-promise "CI_PASSED" \
  --max-iterations 20
```

---

### 6.2 自愈逻辑（框架）

Ralph Loop 内部伪代码：

```python
loop:
    ci = get_ci_status()

    if ci == success:
        merge_pr()
        return "<promise>CI_PASSED</promise>"

    if ci == pending:
        sleep(30)
        continue

    log = get_ci_logs()

    if "version" in log:
        bump_version()
        push_fixup()
        continue

    if "Evidence" in log:
        # 不用修
        push_fixup()  # retrigger CI
        continue

    if "test" in log:
        fix_tests(log)
        push_fixup()
        continue

    if "RCI" in log:
        fix_rci()
        push_fixup()
        continue

    # fallback
    ai_fix_generic(log)
    push_fixup()
```

---

### 6.3 完成条件

```
ci_status == success
AND pr.merged == true
```

---

### 6.4 合并策略

```bash
gh pr merge $PR --squash --delete-branch
```

保证所有 fixup commit 合并为 1 条干净记录。

---

## 7. 验收标准（DoD）

### Evidence CI 化
- ✅ CI 生成 `.quality-evidence.<sha>.json`
- ✅ Evidence 不写入 git
- ✅ Gate 校验 SHA = HEAD_SHA
- ✅ Artifact 自动保存（可选）

### 本地 Quality
- ✅ 只保留 typecheck/lint
- ✅ 删除本地 evidence/test/build/check

### CI 完整检查
- ✅ qa（test/build）
- ✅ evidence gate
- ✅ version check
- ✅ rci coverage

### Ralph Loop
- ✅ 自动修复 version mismatch
- ✅ 自动修复 tests
- ✅ 自动修复 rci
- ✅ evidence mismatch 能自愈
- ✅ 最终自动 merge PR

---

## 8. 关键原则总结

### SSOT：CI 是唯一真相

本地只负责 "快反馈"（Syntax/Type/Style）。

### Evidence 不进 git，不 push，不漂移

把漂移问题永远消灭。

### 契约类检查（Version/Evidence/RCI）只在 CI 做

本地运行它没有意义。

### Ralph Loop 自动修复

无人值守，代码能自动 merge。

---

## 9. 变更记录

### v2.0.0
- 删除 CI commit/push evidence（解决 SHA 漂移 & 自触发）
- 采用 evidence artifact（CI 内消费）
- 本地 Fast Fail 完整重写
- Ralph Loop 自愈逻辑标准化
- CI 作为唯一真相（SSOT）
