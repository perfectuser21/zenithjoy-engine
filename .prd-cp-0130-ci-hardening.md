# PRD: CI 硬化 - 修复 Evidence 和 Manual 后门

## 背景

深度审计发现 CI 存在严重漏洞：

1. **Evidence 硬编码**：`generate-evidence.sh` 生成的 `qa_gate_passed: true` 是硬编码的，无论测试是否通过
2. **Manual 后门**：`check-dod-mapping.cjs` 中 `manual:*` 直接返回 `valid: true`，完全绕过验证
3. **L2A/L2B 只查字符串**：只检查文件存在和简单格式，不检查内容质量
4. **RCI 覆盖率宽松匹配**：名字有交集就算覆盖，造成误判

## 目标

将 CI 从"纸门"升级为"真门"，所有检查必须验证"事实"而非"格式"。

## 范围

### P0-1: Evidence 改为汇总真实 checks 产物
- 修改 CI 各步骤输出 check 结果 JSON 到 `ci/out/checks/`
- 重写 `generate-evidence.sh` 汇总计算 `qa_gate_passed`
- 升级 `evidence-gate.sh` 验证"事实"（包括文件 hash）

### P0-2: 移除 manual: bypass
- 修改 `check-dod-mapping.cjs`，`manual:` 不再直接放行
- 必须在 evidence 中有对应的 `manual_verifications` 记录
- 记录必须包含 actor/timestamp/evidence path

### P1-1: 加强 L2A/L2B 内容验证
- PRD 必须包含至少 3 个 section，每个 >=2 行
- DoD 必须有验收项且每项有 Test 映射
- Evidence 必须有可复现命令或证据路径

### P1-2: RCI coverage 收紧
- 禁止 name/includes 误判
- 只允许精确路径匹配或显式 covers 字段

## 验收标准

- [ ] 故意让 npm run test 失败：`qa_gate_passed` 必须变成 false，CI 必须拦截
- [ ] 删除某个 `ci/out/checks/*.json`：CI 必须 FAIL
- [ ] DoD 用 `manual:` 但无 `manual_verifications`：CI 必须 FAIL
- [ ] 提交 3 行水文 PRD/DoD：CI 必须 FAIL
- [ ] 脚本名字与 RCI 有交集但未显式 covers：不算覆盖

## 技术方案

### Check 结果 JSON 格式

```json
{
  "name": "typecheck",
  "ok": true,
  "exit_code": 0,
  "timestamp": "2026-01-30T09:00:00Z",
  "details": {
    "command": "npm run typecheck",
    "summary": "..."
  }
}
```

### Manual Verification 格式

```json
{
  "manual_verifications": [
    {
      "id": "concurrent-session-test",
      "ok": true,
      "actor": "alex",
      "timestamp": "2026-01-30T09:12:00Z",
      "evidence": ["ci/out/manual/concurrent-session-test.log"]
    }
  ]
}
```

## 优先级

P0 - 安全关键修复
