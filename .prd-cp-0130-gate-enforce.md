# PRD: Gate 强制执行机制

## 背景

Gate Skill 家族已实现（v11.6.0），但调用是可选的。主 Agent 可以跳过 gate 审核直接继续。需要强制执行 gate 审核。

## 需求

在关键步骤后强制调用 gate 审核，审核通过才能继续。

## 成功标准

### 正常流程

1. Step 1 (PRD) 完成后，必须有 `.gate-prd-passed` 文件才能进入 Step 2
2. Step 4 (DoD) 完成后，必须有 `.gate-dod-passed` 文件才能进入 Step 5
3. Step 6 (Test) 完成后，必须有 `.gate-test-passed` 文件才能进入 Step 7
4. Step 7 (Audit) 完成后，必须有 `.gate-audit-passed` 文件才能创建 PR

### 失败场景

5. Gate 文件不存在时，Hook 输出 `❌ 必须先通过 gate:xxx 审核` 并 exit 2
6. 签名验证失败时，输出 `❌ gate 文件签名无效（expected: xxx, got: yyy）` 并 exit 2
7. 分支名不匹配时，输出 `❌ gate 文件分支不匹配（file: cp-aaa, current: cp-bbb）` 并 exit 2

## 技术方案

### Step-Gate 映射表

| Step | 名称 | 完成后需要的 gate 文件 | 检查时机 |
|------|------|----------------------|---------|
| 1 | PRD | .gate-prd-passed | branch-protect.sh 检测到 step >= 2 |
| 4 | DoD | .gate-dod-passed | branch-protect.sh 检测到 step >= 5 |
| 6 | Test | .gate-test-passed | branch-protect.sh 检测到 step >= 7 |
| 7 | Audit | .gate-audit-passed | pr-gate-v2.sh 在创建 PR 时 |

**检查触发机制**：
- `branch-protect.sh` 读取 `git config branch.xxx.step` 获取当前 step
- Hook 在 Write/Edit 操作时触发，检查对应的 gate 文件

### Gate 通过文件格式

```json
{
  "gate": "prd|dod|test|audit",
  "decision": "PASS",
  "timestamp": "2026-01-30T12:00:00Z",
  "branch": "cp-xxx",
  "signature": "abc123..."
}
```

### 签名机制

```python
# 签名算法
content = f"{gate}:{decision}:{timestamp}:{branch}:{secret}"
signature = sha256(content.encode()).hexdigest()

# 验证：重算签名并比对
expected = sha256(f"{file.gate}:{file.decision}:{file.timestamp}:{file.branch}:{secret}").hexdigest()
valid = (expected == file.signature) and (file.branch == current_branch)
```

**设计决策**：
- 无时间过期限制（同一分支内 gate 文件持续有效）
- 分支名必须完全匹配（防止跨分支复用）

### Secret 管理

- 位置：`~/.claude/.gate-secret`
- 首次运行时自动生成：`openssl rand -hex 32`
- 权限：600（仅 owner 可读写）

### 文件生命周期

- `.gate-*-passed` 加入 `.gitignore`
- `cleanup.sh`（Step 11）删除所有 `.gate-*-passed` 文件
- 新分支自动获得干净状态（每次重新审核）

## 非目标

- gate:code（后续再加）
- 远程签名验证
- timestamp 过期检查（同一分支内持续有效即可）
