# PRD: CI 安全性提升到 100%

## 背景

当前 CI 评分 80/100，存在 3 个关键安全漏洞：

1. **P0**: Known-Failures 白名单可被恶意修改（风险：高）
2. **P1**: L2B Evidence 可伪造（风险：中）
3. **P1**: DevGate 脚本可被删除绕过检查（风险：中）

## 目标

将 CI 作为最后一道防线的安全性提升到 100%，确保即使没有人工 PR Review，CI 也能阻止所有恶意代码合并。

## 核心需求

### 1. Known-Failures 文件保护（P0）

**问题**：
- 当前 `ci/known-failures.json` 可以被任意修改
- 攻击者可以添加白名单条目跳过测试失败
- CI 不检查该文件的变更

**解决方案**：
- 在 CI 中增加 `known-failures-protection` job
- 检测该文件是否被修改
- 如果被修改，要求 PR title 包含 `[INFRA]` 标记
- 并检查文件内容的合法性（最多 3 项，需要 ticket 和 expires）

**验收标准**：
- ✅ 修改 `known-failures.json` 时，不带 `[INFRA]` 标记的 PR 会被阻止
- ✅ 带 `[INFRA]` 标记但内容不合法的 PR 会被阻止
- ✅ 带 `[INFRA]` 标记且内容合法的 PR 可以通过

### 2. L2B Evidence 真实性验证（P1）

**问题**：
- 当前 `.layer2-evidence.md` 只需要有命令或 SHA 就通过
- 可以写假证据（复制粘贴命令）
- 没有验证证据与 PR 的关联

**解决方案**：
- 增强 `scripts/devgate/l2b-check.sh` 的检查逻辑
- 验证证据中的 commit SHA 是否匹配当前 HEAD
- 验证证据中的 CI run ID 是否存在
- 验证截图的时间戳是否在合理范围内（PR 创建后）

**验收标准**：
- ✅ 证据中的 SHA 必须匹配当前 HEAD
- ✅ 证据中的 CI run ID（如果有）必须是真实的
- ✅ 证据的时间戳不能早于 PR 创建时间

### 3. DevGate 脚本存在性强制检查（P1）

**问题**：
- DevGate 脚本不存在时，CI 会跳过检查（`skipping`）
- 攻击者可以删除脚本绕过检查

**解决方案**：
- 在 DevGate checks 步骤前增加脚本存在性检查
- 必需脚本包括：
  - `scripts/devgate/check-dod-mapping.cjs`
  - `scripts/devgate/scan-rci-coverage.cjs`
  - `scripts/devgate/require-rci-update-if-p0p1.sh`
- 如果脚本不存在，直接失败（不允许 skipping）

**验收标准**：
- ✅ 删除任一必需脚本，CI 会失败
- ✅ 错误信息清晰指出哪个脚本缺失

### 4. 关键配置文件变更审计（P1）

**问题**：
- 关键配置文件（`ci.yml`, `regression-contract.yaml`, `known-failures.json`）可以被静默修改
- 没有明确的审计机制

**解决方案**：
- 在 CI 中增加 `config-audit` job
- 检测关键配置文件是否被修改
- 如果被修改，要求 PR title 包含 `[CONFIG]` 或 `[INFRA]` 标记
- 输出明确的变更通知

**验收标准**：
- ✅ 修改关键配置文件时，不带标记的 PR 会被警告（但不阻止，P2 级别）
- ✅ 变更会在 CI 日志中明确输出

## 分支合并流程检查

### 5. feature/cp-* → develop 安全性

**检查项**：
- ✅ 必须通过 test job（L1 + DevGate + Evidence Gate）
- ✅ 必须通过 regression-pr job（L3 子集，82 条约）
- ✅ 必须通过 l2b-check job（可复核证据）
- ✅ 必须通过 version-check job（semver）
- ✅ 必须通过 impact-check job（能力变更登记）
- ✅ 必须通过 contract-drift-check job（feature-registry 同步）

**问题**：
- 当前 regression-pr 条件检查可能被 skipped 绕过

**解决方案**：
- 强化 ci-passed job 的条件逻辑
- 确保 `github.base_ref == 'develop'` 时，`regression-pr.result == 'success'` 不能是 skipped

### 6. develop → main 安全性

**检查项**：
- ✅ 必须通过 test job
- ✅ 必须通过 release-check job（L3 全量，112 条约 + CHANGELOG）
- ✅ 必须来自 develop 或 release/* 分支
- ✅ 如果来自 release/* 分支，必须包含 develop 的所有提交（merge-base 检查）

**问题**：
- 当前 release-check 条件检查可能被 skipped 绕过

**解决方案**：
- 强化 ci-passed job 的条件逻辑
- 确保 `github.base_ref == 'main'` 时，`release-check.result == 'success'` 不能是 skipped

## 非功能性需求

- 所有新增检查不应增加 CI 时间超过 1 分钟
- 错误信息清晰，帮助开发者理解为什么被阻止
- 向后兼容：不影响现有合法的 PR

## 成功指标

- CI 安全性评分从 80% 提升到 100%
- 所有 P0/P1 漏洞修复
- 分支合并流程无法被绕过
- CI 可以作为唯一的代码合并门禁（不依赖人工 Review）
