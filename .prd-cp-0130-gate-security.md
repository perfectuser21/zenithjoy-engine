# PRD: Gate 安全机制修复 (P0-4/P0-1/P0-2)

## 背景

深度审计发现 /dev 工作流存在 3 个 P0 级安全问题：

### P0-4: Gate 文件可被复用绕过

**漏洞**：
1. Gate 文件无过期机制 - 永久有效
2. 只绑定 commit_sha，不绑定 tree_sha - amend 后可复用
3. 无 repo_id - 可跨仓库复用
4. Secret 明文存储在固定路径

**攻击场景**：
```bash
# 在 commit A 通过 gate:audit
# 然后在 commit B 改代码（引入新风险）
# 但重用 commit A 的 .gate-audit-passed
# Hook 无法检测
```

### P0-1: 验证器缺失导致死锁

**漏洞**：
- `pr-gate-v2.sh` 要求 `verify-gate-signature.sh` 必须存在
- 新项目克隆后该脚本可能不存在
- 导致任何 PR 都无法创建（配置依赖死锁）

### P0-2: Stop Hook 循环控制漏洞

**漏洞**：
- PR 合并后只输出提示然后 exit 2
- 没有实际执行 cleanup
- 会话悬空，用户不知道下一步

## 功能描述

### P0-4 修复：Gate 文件 v3 格式

**新增字段**：
```json
{
  "version": 3,
  "expires_at": "2026-01-30T10:30:00Z",
  "tree_sha": "abc123",
  "repo_id": "sha256(remote_url)"
}
```

**验证逻辑**：
1. 检查 version（兼容 v2，拒绝 v1）
2. 检查 expires_at（超过 30 分钟失败）
3. 检查 tree_sha 与当前 HEAD^{tree} 一致
4. 检查 repo_id 与当前仓库一致
5. 检查 commit_sha 与当前 HEAD 一致

**Secret 读取优先级**：
1. 环境变量 `$GATE_SECRET`
2. macOS Keychain（如果可用）
3. 文件 `~/.config/cecelia/gate-secret`（新路径）
4. 旧路径 `~/.claude/.gate-secret`（兼容）

### P0-1 修复：验证器缺失改软警告

```bash
if [[ ! -f "$GATE_VERIFY_SCRIPT" ]]; then
    echo "WARN: verify-gate-signature.sh 缺失，跳过 Gate 验证"
    echo "建议: 运行 generate-gate-file.sh 初始化"
    # 不 exit 2，继续执行
fi
```

### P0-2 修复：merged 后自动 cleanup

```bash
if [[ "$PR_STATE" == "merged" ]]; then
    # 自动执行 cleanup
    rm -f .dev-mode
    git checkout develop
    git pull
    # 删除分支等
    exit 0  # 完成，不是 exit 2
fi
```

## 成功标准

1. [x] Gate 文件 30 分钟后过期
2. [x] Gate 文件绑定 commit_sha + tree_sha
3. [x] Gate 文件绑定 repo_id
4. [x] 验证器缺失时不阻断 PR
5. [x] PR 合并后自动 cleanup

## 优先级

P0 - 安全漏洞
