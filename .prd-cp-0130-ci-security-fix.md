---
id: prd-ci-security-fix
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# PRD: CI 安全漏洞修复

## 背景

深度审查发现 CI 系统存在多个安全漏洞，可能导致：
1. 绕过 approval 直接合并 PR
2. 关键检查被静默跳过
3. 失败被隐藏

## 问题清单

### P0-1: auto-merge check_suite 触发漏洞

**位置**: `.github/workflows/auto-merge.yml`

**问题**:
- `on.check_suite.types: [completed]` 触发器允许外部 CI 系统触发合并
- 攻击者可以通过创建一个 `conclusion: success` 的 check_suite 绕过 approval

**修复**:
- 移除 check_suite 触发器
- 只保留 pull_request_review 触发器

### P0-2: ci-passed 跳过逻辑漏洞

**位置**: `.github/workflows/ci.yml` L711-723

**问题**:
```yaml
(needs.regression-pr.result == 'success' || needs.regression-pr.result == 'skipped') &&
(needs.release-check.result == 'success' || needs.release-check.result == 'skipped')
```

当 PR 到 develop 时，regression-pr 应该必须成功，不能允许 skipped。
当 PR 到 main 时，release-check 应该必须成功，不能允许 skipped。

**修复**:
- 根据 base_ref 条件判断：PR 到 develop 时 regression-pr 必须成功
- 根据 base_ref 条件判断：PR 到 main 时 release-check 必须成功

### P1-1: ai-review continue-on-error 隐藏失败

**位置**: `.github/workflows/ci.yml` L831

**问题**:
- `continue-on-error: true` 导致 AI review 失败被静默忽略
- 工作流显示成功但实际 review 可能未执行

**修复**:
- 移除 continue-on-error
- 添加适当的错误处理和 fallback

## 验收标准

- [ ] auto-merge.yml 不再有 check_suite 触发器
- [ ] ci-passed 条件正确检查 regression-pr（PR 到 develop 时）
- [ ] ci-passed 条件正确检查 release-check（PR 到 main 时）
- [ ] ai-review 不再有 continue-on-error: true
- [ ] 所有修改通过 CI 测试

## 影响范围

- `.github/workflows/auto-merge.yml`
- `.github/workflows/ci.yml`

## 风险评估

**高风险**：这些是安全相关修复，必须谨慎测试。
修改范围有限，只涉及 CI 配置文件。

## 测试计划

1. 创建 PR 到 develop，验证 regression-pr 必须成功
2. 验证 auto-merge 只在 approval + CI pass 时触发
3. 验证 ai-review 失败会正确报告
