{
  "name": "Cecilia Dev Loop - 完整开发循环",
  "active": true,
  "nodes": [
    {
      "id": "webhook-start",
      "name": "接收任务",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "cecilia-dev",
        "responseMode": "responseNode",
        "options": {}
      }
    },
    {
      "id": "init",
      "name": "初始化任务",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [400, 300],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "task_id", "name": "task_id", "value": "={{ $json.body.task_id || 'T-' + $now.format('yyyyMMdd-HHmmss') }}", "type": "string"},
            {"id": "project", "name": "project", "value": "={{ $json.body.project }}", "type": "string"},
            {"id": "work_dir", "name": "work_dir", "value": "={{ $json.body.work_dir || '/home/xx/dev/' + $json.body.project }}", "type": "string"},
            {"id": "prd", "name": "prd", "value": "={{ $json.body.prd || '' }}", "type": "string"},
            {"id": "max_retries", "name": "max_retries", "value": "={{ $json.body.max_retries || 3 }}", "type": "number"},
            {"id": "retry_count", "name": "retry_count", "value": "=0", "type": "number"},
            {"id": "previous_result", "name": "previous_result", "value": "={{ $json.body.previous_result || null }}", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "respond-accepted",
      "name": "返回任务ID",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [600, 200],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, task_id: $json.task_id, message: 'Task accepted' }) }}"
      }
    },
    {
      "id": "build-prompt",
      "name": "构建提示词",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 400],
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nlet prompt = `你正在执行无头模式任务。\n\n## 项目信息\n- 项目: ${data.project}\n- 工作目录: ${data.work_dir}\n- 任务 ID: ${data.task_id}\n`;\n\n// 如果有上次结果\nif (data.previous_result) {\n  const prev = typeof data.previous_result === 'string' \n    ? JSON.parse(data.previous_result) \n    : data.previous_result;\n  prompt += `\n## 上次执行结果\n- 状态: ${prev.status}\n- PR: ${prev.pr_url || 'N/A'}\n- CI 状态: ${prev.ci_status || 'unknown'}\n- 错误信息: ${prev.error || '无'}\n\n你需要根据上次的结果继续工作。如果 CI 失败，请修复问题。\n`;\n}\n\n// 如果有 PRD\nif (data.prd) {\n  prompt += `\n## PRD 内容\n${data.prd}\n`;\n}\n\nprompt += `\n## 核心要求\n\n**你必须使用 /dev skill 来执行此任务。** 这是强制性的。\n\n执行步骤：\n1. 运行 /dev skill\n2. /dev 会自动检测模式（new/continue/fix/merge）\n3. 按照 /dev 的流程完成任务\n4. 完成后输出结构化 JSON 结果\n\n## 输出格式\n\n完成后，你必须输出以下 JSON 格式（用 \\`\\`\\`json 包裹）：\n\n\\`\\`\\`json\n{\n  \"success\": true|false,\n  \"task_id\": \"${data.task_id}\",\n  \"status\": \"completed|failed|need_human_help\",\n  \"mode\": \"new|continue|fix|merge\",\n  \"pr_url\": \"https://github.com/.../pull/123\",\n  \"pr_number\": 123,\n  \"ci_status\": \"green|red|pending\",\n  \"branch\": \"cp-xxx\",\n  \"commit_sha\": \"abc123\",\n  \"error\": \"如果失败，填写错误信息\",\n  \"next_action\": \"merge|fix_ci|wait_review|none\"\n}\n\\`\\`\\`\n\n## 注意\n\n- 不要跳过 /dev skill，它是流程的核心\n- 如果遇到需要人工介入的情况，设置 status 为 \"need_human_help\"\n- 确保输出的 JSON 是完整的，N8N 会解析它来决定下一步\n`;\n\nreturn {\n  ...data,\n  prompt: prompt\n};"
      }
    },
    {
      "id": "call-cecilia",
      "name": "调用 Cecilia",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 400],
      "parameters": {
        "method": "POST",
        "url": "http://localhost:8899/execute",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ prompt: $json.prompt, work_dir: $json.work_dir, task_id: $json.task_id }) }}",
        "options": {
          "timeout": 1800000
        }
      }
    },
    {
      "id": "parse-result",
      "name": "解析结果",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 400],
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst initData = $('init').first().json;\n\n// 尝试从响应中提取 JSON\nlet result = null;\nconst output = response.output || response.result || '';\n\n// 匹配 ```json ... ``` 块\nconst jsonMatch = output.match(/```json\\s*([\\s\\S]*?)```/);\nif (jsonMatch) {\n  try {\n    result = JSON.parse(jsonMatch[1].trim());\n  } catch (e) {\n    // 解析失败\n  }\n}\n\n// 如果没找到，尝试直接解析整个输出\nif (!result && typeof output === 'string') {\n  try {\n    result = JSON.parse(output);\n  } catch (e) {\n    // 解析失败\n  }\n}\n\n// 如果还是没有，构造默认结果\nif (!result) {\n  result = {\n    success: false,\n    task_id: initData.task_id,\n    status: 'failed',\n    error: 'Failed to parse Cecilia output',\n    raw_output: output.substring(0, 1000)\n  };\n}\n\nreturn {\n  ...initData,\n  result: result,\n  retry_count: initData.retry_count\n};"
      }
    },
    {
      "id": "check-status",
      "name": "检查状态",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [1200, 400],
      "parameters": {
        "rules": {
          "rules": [
            {
              "value": "completed",
              "output": 0,
              "operation": {"type": "string", "operation": "equals", "left": "={{ $json.result.status }}"}
            },
            {
              "value": "need_human_help",
              "output": 1,
              "operation": {"type": "string", "operation": "equals", "left": "={{ $json.result.status }}"}
            },
            {
              "value": "green",
              "output": 2,
              "operation": {"type": "string", "operation": "equals", "left": "={{ $json.result.ci_status }}"}
            }
          ],
          "fallbackOutput": 3
        }
      }
    },
    {
      "id": "task-completed",
      "name": "任务完成",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1400, 200],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "final_status", "name": "final_status", "value": "completed", "type": "string"},
            {"id": "message", "name": "message", "value": "任务成功完成", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "need-human",
      "name": "需要人工介入",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1400, 350],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "final_status", "name": "final_status", "value": "need_human_help", "type": "string"},
            {"id": "message", "name": "message", "value": "任务需要人工介入", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "ci-green",
      "name": "CI 通过待合并",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1400, 500],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "final_status", "name": "final_status", "value": "ci_green", "type": "string"},
            {"id": "message", "name": "message", "value": "CI 通过，等待合并", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "check-retry",
      "name": "检查重试次数",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1400, 650],
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "retry-limit",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": "={{ $json.max_retries }}",
              "operator": {"type": "number", "operation": "lt"}
            }
          ],
          "combinator": "and"
        }
      }
    },
    {
      "id": "prepare-retry",
      "name": "准备重试",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1600, 600],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "retry_count", "name": "retry_count", "value": "={{ $json.retry_count + 1 }}", "type": "number"},
            {"id": "previous_result", "name": "previous_result", "value": "={{ JSON.stringify($json.result) }}", "type": "string"},
            {"id": "prd", "name": "prd", "value": "", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "max-retry-reached",
      "name": "超过重试上限",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1600, 750],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "final_status", "name": "final_status", "value": "max_retry_reached", "type": "string"},
            {"id": "message", "name": "message", "value": "超过最大重试次数", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "notify-feishu",
      "name": "通知飞书",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1800, 400],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.FEISHU_WEBHOOK || '' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ msg_type: 'interactive', card: { header: { title: { tag: 'plain_text', content: 'Cecilia 任务通知' } }, elements: [{ tag: 'div', text: { tag: 'lark_md', content: '**任务ID**: ' + $json.task_id + '\\n**状态**: ' + ($json.final_status || $json.result?.status) + '\\n**消息**: ' + ($json.message || '') + '\\n**PR**: ' + ($json.result?.pr_url || 'N/A') } }] } }) }}"
      }
    },
    {
      "id": "save-result",
      "name": "保存结果",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 400],
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// 构建最终结果\nconst finalResult = {\n  task_id: data.task_id,\n  project: data.project,\n  status: data.final_status || data.result?.status || 'unknown',\n  message: data.message || '',\n  result: data.result || {},\n  retry_count: data.retry_count || 0,\n  timestamp: new Date().toISOString()\n};\n\nreturn finalResult;"
      }
    }
  ],
  "connections": {
    "webhook-start": {
      "main": [[{"node": "init", "type": "main", "index": 0}]]
    },
    "init": {
      "main": [
        [
          {"node": "respond-accepted", "type": "main", "index": 0},
          {"node": "build-prompt", "type": "main", "index": 0}
        ]
      ]
    },
    "build-prompt": {
      "main": [[{"node": "call-cecilia", "type": "main", "index": 0}]]
    },
    "call-cecilia": {
      "main": [[{"node": "parse-result", "type": "main", "index": 0}]]
    },
    "parse-result": {
      "main": [[{"node": "check-status", "type": "main", "index": 0}]]
    },
    "check-status": {
      "main": [
        [{"node": "task-completed", "type": "main", "index": 0}],
        [{"node": "need-human", "type": "main", "index": 0}],
        [{"node": "ci-green", "type": "main", "index": 0}],
        [{"node": "check-retry", "type": "main", "index": 0}]
      ]
    },
    "task-completed": {
      "main": [[{"node": "notify-feishu", "type": "main", "index": 0}]]
    },
    "need-human": {
      "main": [[{"node": "notify-feishu", "type": "main", "index": 0}]]
    },
    "ci-green": {
      "main": [[{"node": "notify-feishu", "type": "main", "index": 0}]]
    },
    "check-retry": {
      "main": [
        [{"node": "prepare-retry", "type": "main", "index": 0}],
        [{"node": "max-retry-reached", "type": "main", "index": 0}]
      ]
    },
    "prepare-retry": {
      "main": [[{"node": "build-prompt", "type": "main", "index": 0}]]
    },
    "max-retry-reached": {
      "main": [[{"node": "notify-feishu", "type": "main", "index": 0}]]
    },
    "notify-feishu": {
      "main": [[{"node": "save-result", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
